sap.ui.define(["sap/ui/core/mvc/Controller",'sap/ushell/renderers/fiori2/search/SearchResultListFormatter',"sap/ui/export/Spreadsheet"],function(C,S,c){"use strict";return C.extend("sap.ui.export.sample.table.Spreadsheet",{onExport:function(){var t=this;t.exportData={columns:[],rows:[]};if(t.table===undefined){t.table=sap.ui.getCore().byId('ushell-search-result-table');t.model=t.table.getModel();}t._parseColumns();if(t.exportData.columns.length===0){return;}sap.ui.getCore().byId('dataExportButton').setEnabled(false);var e=t.model.query.clone();e.setCalculateFacets(false);e.setTop(1000);var s=function(b){var f=new S();var n=f.format(b,e.filter.searchTerm,{suppressHighlightedValues:true});t._parseRows(n);t._doExport();};var a=function(b){t.model.normalSearchErrorHandling(b);sap.ui.getCore().byId('dataExportButton').setEnabled(true);};if(t.model.getProperty("/boCount")>1000){sap.m.MessageBox.information(sap.ushell.resources.i18n.getText("exportDataInfo"),{actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(A){if(A==sap.m.MessageBox.Action.OK){e.getResultSetAsync().then(s,a);}if(A==sap.m.MessageBox.Action.CANCEL){sap.ui.getCore().byId('dataExportButton').setEnabled(true);}}});}else{e.getResultSetAsync().then(s,a);}},_parseColumns:function(){var t=this;var m=t.model.getProperty("/tableColumns");var e=[];if(t.model.getProperty("/resultToDisplay")==="searchResultTable"){var u=t.table.getColumns();u.sort(function(a,b){if(a.getOrder()<b.getOrder())return-1;if(a.getOrder()>b.getOrder())return 1;return 0;});u.forEach(function(a){m.forEach(function(b){if(b.key===a.getId()&&a.getVisible()&&b.attributeId!=="SEARCH_APPS_AS_ID"){e.push(t._buildColumn(b));}});});}else{var i=0;m.forEach(function(a){if(i<=12&&a.attributeId!=="SEARCH_APPS_AS_ID"){e.push(t._buildColumn(a));i++;}});}t.exportData.columns=e;},_buildColumn:function(m){var t=this;var a={label:m.name,property:m.attributeId,type:'string'};if(m.attributeId==="SEARCH_DATASOURCE_AS_ID"){return a;}if(t.attributeMap==undefined){t.attributeMap=t.model.sinaNext.dataSourceMap[t.model.getDataSource().id].attributeMetadataMap;}if(t.attributeMap[m.attributeId]!==undefined){switch(t.attributeMap[m.attributeId].type){case t.model.sinaNext.AttributeType.Double:a.type='number';a.scale=2;break;case t.model.sinaNext.AttributeType.Integer:a.type='number';a.scale=0;break;}}return a;},_parseRows:function(s){var t=this;var e=[];s.forEach(function(r){var a=r.itemattributes;var b={};b["SEARCH_DATASOURCE_AS_ID"]=r.title;t.exportData.columns.forEach(function(d){a.forEach(function(f){if(f.key===d.property){b[d.property]=f.valueRaw;}});});e.push(b);});t.exportData.rows=e;},_doExport:function(){var t=this;var s={workbook:{columns:t.exportData.columns},dataSource:t.exportData.rows};new c(s).build().then(function(){sap.ui.getCore().byId('dataExportButton').setEnabled(true);},function(){sap.ui.getCore().byId('dataExportButton').setEnabled(true);});}});});
