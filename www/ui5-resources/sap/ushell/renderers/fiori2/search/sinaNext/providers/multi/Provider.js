sinaDefine(['../../core/core','../../sina/sinaFactory'],function(c,s){"use strict";return c.defineClass({id:'multi',_initAsync:function(p){this.sina=p.sina;this.multiSina=[];this.multiDataSourceMap={};this.sina.dataSourceMap[this.sina.allDataSource.id]=this.sina.allDataSource;var d=function(a){if(a>=p.subProviders.length){if(this.multiSina.length<1){return c.Promise.reject(new c.Exception('sina creation by trial failed'));}else{return undefined;}}var b=p.subProviders[a];return s.createAsync(b).then(function(e){for(var i=0;i<e.dataSources.length;i++){var f=e.dataSources[i];var m=this.updateId(f.id,e.provider.id);this.sina._createDataSource({id:m,label:this.updateLabel(f.label,e.provider.id),labelPlural:this.updateLabel(f.labelPlural,e.provider.id),type:f.type,hidden:f.hidden,attributesMetadata:f.attributesMetadata});this.multiDataSourceMap[m]=f;}this.multiSina.push(e);return d(a+1);}.bind(this),function(){return d(a+1);}.bind(this));}.bind(this);return d(0);},executeSearchQuery:function(q){var t=this;t.searchResultSet=this.sina._createSearchResultSet({title:'Search Multi Result List',query:q,items:[],totalCount:0,facets:[]});if(q.filter.dataSource===this.sina.allDataSource){var m=1;t.searchResultSet.title='Search Multi Result List';t.searchResultSet.facets.push(this.sina._createDataSourceResultSet({title:q.filter.dataSource.label,items:[],query:q}));var d=function(i){if(i>=t.multiSina.length){t.searchResultSet.items=t.searchResultSet.items.slice(0,q.top);return t.searchResultSet;}var b=t.multiSina[i].createSearchQuery({dataSource:t.multiSina[i].allDataSource,searchTerm:q.getSearchTerm(),top:q.top});return b.getResultSetAsync().then(function(e){t.searchResultSet.items=t.mergeMultiResults(t.searchResultSet.items,e.items,m);t.searchResultSet.totalCount+=e.totalCount;var a=t.sina.getDataSource(t.updateId(e.query.filter.dataSource.id,e.sina.provider.id));t.searchResultSet.facets[0].items.push(t.sina._createDataSourceResultSetItem({dataSource:a,dimensionValueFormatted:t.updateLabel(e.query.filter.dataSource.label,e.sina.provider.id),measureValue:e.totalCount,measureValueFormatted:e.totalCount}));m++;return d(i+1);});};return d(0);}else{var a=t.multiDataSourceMap[q.filter.dataSource.id];var b=a.sina.createSearchQuery({calculateFacets:q.calculateFacets,multiSelectFacets:q.multiSelectFacets,dataSource:a,searchTerm:q.getSearchTerm(),rootCondition:q.getRootCondition(),top:q.top,skip:q.skip,sortOrder:q.sortOrder});return b.getResultSetAsync().then(function(e){t.searchResultSet.items=e.items;t.searchResultSet.totalCount=e.totalCount;for(var i=0;i<t.searchResultSet.items.length;i++){var r=t.searchResultSet.items[i];var f=t.updateId(r.dataSource.id,r.sina.provider.id);t.updateAttributesMetadata(r.dataSource,t.sina.dataSourceMap[f]);r.dataSource=t.sina.dataSourceMap[f];}var g=[];if(e.facets.length===1&&e.facets[0].items[0].dataSource){g=e.facets;for(var j=0;j<e.facets[0].items.length;j++){var h=e.facets[0].items[j];if(h.dataSource){var l=t.updateId(h.dataSource.id,h.sina.provider.id);if(!t.multiDataSourceMap[l]){t.sina._createDataSource({id:l,label:t.updateLabel(h.dataSource.label,h.sina.provider.id),labelPlural:t.updateLabel(h.dataSource.labelPlural,h.sina.provider.id),type:h.dataSource.type,hidden:h.dataSource.hidden,attributesMetadata:h.dataSource.attributesMetadata});t.multiDataSourceMap[l]=h.dataSource;}h.dataSource=t.sina.dataSourceMap[l];g[0].title=t.updateLabel(e.facets[0].title,e.facets[0].sina.provider.id);}}}else{g=[];for(var k=0;k<e.facets.length;k++){var n=e.facets[k];g.push(t._createMultiChartResultSet(n));}}t.searchResultSet.facets=g;return t.searchResultSet;});}},executeChartQuery:function(q){var t=this;var a=t.multiDataSourceMap[q.filter.dataSource.id];var b=a.sina.createChartQuery({dimension:q.dimension,dataSource:a,searchTerm:q.getSearchTerm(),rootCondition:q.getRootCondition(),top:q.top,skip:q.skip,sortOrder:q.sortOrder});return b.getResultSetAsync().then(function(d){return t._createMultiChartResultSet(d);});},mergeMultiResults:function(f,a,m){if(m<1){return[];}if(m===1){return a;}var b=f.length;var d=a.length;for(var i=0;i<b;i++){if(i>=d){break;}f.splice(m*(i+1)-1,0,a[i]);}if(d>b){f=f.concat(a.slice(b-d));}return f;},updateLabel:function(l,i){return l+' ('+i+')';},updateId:function(i,a){return a+'_'+i;},updateAttributesMetadata:function(d,a){a.attributesMetadata=d.attributesMetadata;a.attributeMetadataMap=d.attributeMetadataMap;},_createMultiChartResultSet:function(a){var t=this;var m=t.sina._createChartResultSet({id:a.id,items:[],query:a.query,title:a.title});for(var i=0;i<a.items.length;i++){var b=a.items[i];var d=t.sina.parseConditionFromJson(b.filterCondition.toJson());m.items.push(t.sina._createChartResultSetItem({filterCondition:d,dimensionValueFormatted:b.dimensionValueFormatted,measureValue:b.measureValue,measureValueFormatted:b.measureValueFormatted}));}return m;}});});
