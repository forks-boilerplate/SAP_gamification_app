sinaDefine(['../../core/core','../../core/util','./typeConverter','../tools/fiori/FioriIntentsResolver','../../sina/NavigationTarget'],function(c,u,t,I,N){"use strict";return c.defineClass({_init:function(p){this.provider=p;this.sina=p.sina;this.intentsResolver=this.sina._createFioriIntentsResolver();this.suvNavTargetResolver=this.sina._createSuvNavTargetResolver();},parse:function(s,d){if(d.ResultList.SearchResults===null){return Promise.resolve([]);}var i=d.ResultList.SearchResults.results;return this.parseItems(i);},parseItems:function(a){var b=[];for(var i=0;i<a.length;++i){var d=a[i];var e=this.parseItem(d);b.push(e);}return Promise.all(b);},parseItem:function(a){var b={};var d=[];var e=[];var f={};var g=[];var h=[];var s={};var w=[];var l=[];var n;var o=this.sina.getDataSource(a.DataSourceId);var p,q,r,v;for(var j=0;j<a.Attributes.results.length;j++){p=a.Attributes.results[j];q=o.getAttributeMetadata(p.Id);r=this.sina._createSearchResultSetItemAttribute({id:p.Id,label:q.label,value:t.odata2Sina(q.type,p.Value),valueFormatted:p.ValueFormatted||p.Value,valueHighlighted:p.Snippet||p.ValueFormatted||p.Value,isHighlighted:p.Snippet.indexOf("<b>")>-1&&p.Snippet.indexOf("</b>")>-1,metadata:q});if(q.isUnitOfMeasure||q.isCurrency){f[p.Id]=r;continue;}if(q.unitOfMeasureAttribute){var x=f[q.unitOfMeasureAttribute.id];if(x){r.unitOfMeasure=x;}else{g.push(r);}}if(q.descriptionAttribute){var y=b[q.descriptionAttribute.id];if(y){r.description=y;}else{h.push(r);}}if(q.suvUrlAttribute&&q.suvMimeTypeAttribute){var z=b[q.suvUrlAttribute]||q.suvUrlAttribute.id;var A=b[q.suvMimeTypeAttribute]||q.suvMimeTypeAttribute.id;s[p.Id]={suvThumbnailAttribute:r,suvTargetUrlAttribute:z,suvTargetMimeTypeAttribute:A};}if(q.usage.Title){d.push(r);}if(q.usage.Detail){e.push(r);}if(!q.usage.Title&&!q.usage.Detail&&!q.isDescription&&(r.isHighlighted||(r.descriptionAttribute&&r.descriptionAttribute.isHighlighted))){w.push(r);}if(q.usage.Navigation){if(q.usage.Navigation.mainNavigation){n=this.sina._createNavigationTarget({label:r.value,targetUrl:r.value});}}b[r.id]=r;v=o.attributeMetadataMap[r.id].semanticObjectType;if(v.length>0){l.push({name:v,value:r.value,type:r.metadata.type});}}for(var i=0;i<g.length;i++){r=g[i];q=o.getAttributeMetadata(r.id);if(q.unitOfMeasureAttribute){var x=f[q.unitOfMeasureAttribute.id];if(x){r.unitOfMeasure=x;}}}for(var i=0;i<h.length;i++){r=h[i];q=o.getAttributeMetadata(r.id);if(q.descriptionAttribute){var y=b[q.descriptionAttribute.id];if(y){r.description=y;}}}for(var B in s){var C=s[B];if(typeof C.suvTargetUrlAttribute=="string"){C.suvTargetUrlAttribute=b[C.suvTargetUrlAttribute];}if(typeof C.suvTargetMimeTypeAttribute=="string"){C.suvTargetMimeTypeAttribute=b[C.suvTargetMimeTypeAttribute];}if(!(C.suvTargetUrlAttribute||C.suvTargetMimeTypeAttribute)){delete s[B];}}this.suvNavTargetResolver.resolveSuvNavTargets(o,s);d.sort(function(J,K){return J.metadata.usage.Title.displayOrder-K.metadata.usage.Title.displayOrder;});e.sort(function(J,K){return J.metadata.usage.Detail.displayOrder-K.metadata.usage.Detail.displayOrder;});if(a.HitAttributes!==null){for(var k=0;k<a.HitAttributes.results.length;k++){p=a.HitAttributes.results[k];q=o.getAttributeMetadata(p.Id);r=this.sina._createSearchResultSetItemAttribute({id:p.Id,label:q.label,value:t.odata2Sina(q.type,u.filterString(p.Snippet,['<b>','</b>'])),valueFormatted:p.Snippet,valueHighlighted:p.Snippet,isHighlighted:p.Snippet.indexOf("<b>")>-1&&p.Snippet.indexOf("</b>")>-1,metadata:q});w.push(r);}}e=e.concat(w);var D=[];var E=[];for(var m=0;m<d.length;m++){var F=d[m];D.push(F.valueFormatted);E.push(F.valueHighlighted);}D=D.join(' ');E=E.join(' ');v=o.sematicObjectType;var G=o.system;var H=o.client;return this.intentsResolver.resolveIntents({semanticObjectType:v,semanticObjectTypeAttributes:l,systemId:G,client:H,fallbackDefaultNavigationTarget:n}).then(function(J){var K=J&&J.defaultNavigationTarget;var L=J&&J.navigationTargets;return this.sina._createSearchResultSetItem({dataSource:o,title:D,titleHighlighted:E,titleAttributes:d,detailAttributes:e,defaultNavigationTarget:K,navigationTargets:L});}.bind(this));}});});
