// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/GenericTile","sap/m/GenericTileMode","sap/ushell/resources","sap/ushell/utils/utilsCdm","sap/ushell/utils","sap/ushell/navigationMode","sap/ushell/EventHub","sap/ushell/Config"],function(G,g,r,u,U,n,E,C){"use strict";var l=jQuery.sap.log.getLogger("sap/ushell/adapters/cdm/LaunchPageAdapter"),L=jQuery.sap.log.Level;function a(o,p,A){var _,s="sap.ushell.components.tiles.cdm.applauncher",d="sap.ushell.components.tiles.cdm.applauncherdynamic";this._mResolvedTiles={};this._mResolvedCatalogTiles={};this._mCatalogTilePromises={};this._mFailedResolvedCatalogTiles={};this._mFailedResolvedTiles={};this._mContentProviders={};this.TileType={Tile:"tile",Link:"link"};this.getGroups=function(){var D=new jQuery.Deferred();this._assureLoaded().done(function(e){U.setPerformanceMark("FLP - homepage groups processed");D.resolve(e);}).fail(function(){D.resolve([]);});return D.promise();};this._getTileFromHashInContextOfSite=function(R,e,I){var D=new jQuery.Deferred(),v=e[I];if(!v){v=R(I);e[I]=v;}v.done(function(T){var w={tileIntent:I,tileResolutionResult:T};D.resolve(w);}).fail(function(w){D.reject("Hash '"+I+"' could not be resolved to a tile. "+w);});return D.promise();};this._getTileFromHash=function(I){var e=sap.ushell.Container.getService("ClientSideTargetResolution");var R=e.resolveTileIntent.bind(e);return this._getTileFromHashInContextOfSite(R,this._mCatalogTilePromises,I);};this._getTileFromHashFromSite=function(S,I){var e=sap.ushell.Container.getService("ClientSideTargetResolution");var v=u.formatSite(S);var R=e.resolveTileIntentInContext.bind(e,v);var w={};return this._getTileFromHashInContextOfSite(R,w,I);};this._getTileForUrl=function(T){var e=T.indicatorDataSource?"#Shell-dynamicTile":"#Shell-staticTile";return{tileIntent:"#",tileResolutionResult:{tileComponentLoadInfo:e,isCustomTile:false}};};this._assureGroupItemsResolved=function(e,S){var P=[],R,v;if(e.payload&&e.payload.tiles){R=this._assureGroupTilesResolved(e.payload.tiles,S);Array.prototype.push.apply(P,R);}if(e.payload&&e.payload.links){v=this._assureGroupLinksResolved(e.payload.links,S);Array.prototype.push.apply(P,v);}return P;};this._assureGroupTilesResolved=function(e,S){return(e||[]).map(function(T,I){return this._resolveGroupTile(T,S).then(function(R){R.isLink=false;return R;});},this);};this._assureGroupLinksResolved=function(e,S){return(e||[]).map(function(v,I){return this._resolveGroupTile(v,S).then(function(R){R.isLink=true;return R;});},this);};this._resolveGroupTile=function(T,S){var e=this._mResolvedTiles;var F=this._mFailedResolvedTiles;var R;function v(x){e[T.id]=x;if(F[T.id]){delete F[T.id];}return x;}function w(T){var x=T.target;return x&&x.semanticObject==="Shell"&&x.action==="launchURL";}if(e[T.id]){return(new jQuery.Deferred()).resolve(e[T.id]).promise();}if(T.target&&T.target.url){R=jQuery.when(this._getTileForUrl(T));}else if(T.isBookmark){R=this._resolveTileByIntent(T,S);}else if(w(T)){R=this._resolveTileByIntent(T,S);}else{R=this._resolveTileByAppId(T,S);}R.done(function(x){v(x);}).fail(function(x){F[T.id]=x;});return R;};this._resolveTileByAppId=function(T,S){var e,v,I,w,H;function x(F,J){return new jQuery.Deferred().reject({logLevel:F,message:J}).promise();}if(!jQuery.isPlainObject(T)){return x(L.ERROR,"Cannot resolve tile: oTile must be an object");}if(!jQuery.isPlainObject(S)){return x(L.ERROR,"Cannot resolve tile: oSite must be an object");}e=T.appId||T.appIDHint;if(!e){return x(L.ERROR,["Cannot resolve tile '",T.id,"': either appId or appIDHint must be specified"].join(""));}v=S.applications&&S.applications[e];if(!v){return x(L.INFO,["Tile '",T.id,"' filtered from result: no app found for appId '",e,"' (dangling app reference)"].join(""));}I=this._getFirstInbound(v);if(!I){return x(L.ERROR,["Cannot resolve tile '",T.id,"': app '",e,"' has no navigation inbound"].join(""));}var M=u.mapOne(I.key,I.inbound,v),y=M.resolutionResult.applicationType,z=M.resolutionResult.additionalInformation,B=C.last("/core/navigation/enableInPlaceForClassicUIs"),D=B?B[y]:false;w=M.tileResolutionResult;w.navigationMode=n.computeNavigationModeForHomepageTiles(y,z,D);w.isLink=false;if(!this._isFormFactorSupported(w)){return x(L.INFO,["Tile '",T.id,"' filtered from result: form factor not supported"].join(""));}H=this._toHashFromInbound(I.inbound);return jQuery.when({tileResolutionResult:w,tileIntent:H});};this._isFormFactorSupported=function(e){var v=U.getFormFactor();return e.deviceTypes&&e.deviceTypes[v];};this._getFirstInbound=function(e){var F=Object.keys(e["sap.app"].crossNavigation.inbounds).shift(),I=e["sap.app"].crossNavigation.inbounds[F];return{key:F,inbound:I};};this._resolveTileByIntent=function(T,S){var H=this._prepareTileHash(T);return this._getTileFromHash(H);};this._prepareTileHash=function(T){var e=sap.ushell.Container.getService("URLParsing"),P={},v,R;if(this._isCatalogTile(T)){return T.tileIntent;}if(this._isGroupTile(T)){R=T.target.parameters||[];R.forEach(function(w){if(w.name&&w.value){P[w.name]=[w.value];}});v={target:{semanticObject:T.target.semanticObject,action:T.target.action},params:P,appSpecificRoute:T.target.appSpecificRoute};return"#"+e.constructShellHash(v);}return undefined;};this._allPromisesDone=function(P){var D=new jQuery.Deferred(),e;if(P.length===0){D.resolve([]);}else{var N=P.map(function(v){e=new jQuery.Deferred();v.always(e.resolve.bind(e));return e.promise();});jQuery.when.apply(this,N).done(function(){var v=Array.prototype.slice.call(arguments);D.resolve(v);});}return D.promise();};this._generateDefaultGroup=function(){var e,v,D=new jQuery.Deferred(),w=sap.ushell.Container.getService("CommonDataModel");w.getSite().done(function(S){e=U.generateUniqueId(S.site.payload.groupsOrder);v={"identification":{"id":e,"namespace":"","title":"Home"},"payload":{"isDefaultGroup":true,"locked":false,"tiles":[],"links":[],"groups":[]}};_=v;S.groups[e]=v;S.site.payload.groupsOrder.unshift(e);D.resolve(v);}).fail(function(x){D.reject("Failed to access site. "+x);});return D.promise();};this._assureLoaded=function(){var e=this,v=sap.ushell.Container.getService("CommonDataModel"),D,w=[],x;if(this._assureLoadedDeferred){return this._assureLoadedDeferred.promise();}x=new jQuery.Deferred();this._assureLoadedDeferred=x;v.getSite().done(function(S){var I=[];S.site.payload.groupsOrder.forEach(function(y,z){var B=S.groups[y];if(B){B.payload=B.payload||{};if(B.payload.hasOwnProperty("isDefaultGroup")){_=B;}w.push(B);I=e._assureGroupItemsResolved(B,S).concat(I);}});if(_===undefined){D=e._generateDefaultGroup();I.push(D);D.done(function(y){w.unshift(y);}).fail(function(y){jQuery.sap.log.error("Delivering hompage groups failed - "+y);e._assureLoadedDeferred.resolve([]);});}e._allPromisesDone(I).done(function(){e._assureLoadedDeferred.resolve(w);delete e._assureLoadedDeferred;e._logTileResolutionFailures(e._mFailedResolvedTiles);});}).fail(function(y){jQuery.sap.log.error("Delivering hompage groups failed - "+y);e._assureLoadedDeferred.resolve([]);delete e._assureLoadedDeferred;});return x.promise();};this._logTileResolutionFailures=function(F){var M={};if(!F){return;}Object.keys(L).filter(function(e){var v=L[e];return v>=L.FATAL&&v<=L.ALL;}).forEach(function(e){M[L[e]]="";});Object.keys(F).forEach(function(e){var v=F[e];if(v.logLevel){M[v.logLevel]=M[v.logLevel].concat(v.message).concat("\n");}});if(M[L.FATAL]){l.fatal(M[L.FATAL]);}if(M[L.ERROR]){l.error(M[L.ERROR]);}if(M[L.WARNING]){l.warning(M[L.WARNING]);}if(M[L.INFO]){l.info(M[L.INFO]);}if(M[L.DEBUG]){l.debug(M[L.DEBUG]);}if(M[L.TRACE]){l.trace(M[L.TRACE]);}};this.getDefaultGroup=function(){var D=new jQuery.Deferred(),e;if(!_){e=this._assureLoaded();}if(e){e.done(function(){D.resolve(_);}).fail(function(M){D.reject("Failed to access default group. "+M);});}else{D.resolve(_);}return D.promise();};this._isValidTitle=function(T){if(typeof T!=='string'||!T){return false;}return true;};this._isGroupPreset=function(e){if(!e.payload.hasOwnProperty("isPreset")){return true;}return!!e.payload.isPreset;};this._isGroupLocked=function(e){return!!e.payload.locked;};this.addGroup=function(T){var D=new jQuery.Deferred(),e=sap.ushell.Container.getService("CommonDataModel"),v,w,x,y=this;if(!this._isValidTitle(T)){return D.reject("No valid group title").promise();}x="Failed to add the group with title '"+T+"' to the homepage. ";e.getSite().done(function(S){w=U.generateUniqueId(S.site.payload.groupsOrder);v={"identification":{"id":w,"namespace":"","title":T},"payload":{"locked":false,"isPreset":false,"tiles":[],"links":[],"groups":[]}};S.groups[w]=v;S.site.payload.groupsOrder.push(v.identification.id);e.save().done(function(){delete y._assureLoadedDeferred;D.resolve(S.groups[w],w);}).fail(function(z){D.reject(z);});}).fail(function(z){D.reject(x+z);});return D.promise();};this.getGroupTitle=function(e){return e.identification.title;};this.setGroupTitle=function(e,N){var v=this,D=new jQuery.Deferred(),w=sap.ushell.Container.getService("CommonDataModel"),O,x;if(typeof e!=='object'||!e.identification||!e.identification.id){return D.reject("Unexpected group value").promise();}if(!v._isValidTitle(N)){return D.reject("Unexpected oGroup title value").promise();}x="Failed to set new title for group with id '"+e.identification.id+"'. ";O=e.identification.title;w.getSite().done(function(S){if(S.groups[e.identification.id]){S.groups[e.identification.id].identification.title=N;}w.save().done(function(){D.resolve();}).fail(function(y){jQuery.sap.log.error(y);D.reject(O);});}).fail(function(y){D.reject(O,x+y);});return D.promise();};this.getGroupId=function(e){return e.identification.id;};this.hideGroups=function(H){var D=new jQuery.Deferred(),e=sap.ushell.Container.getService("CommonDataModel"),v;if(H&&jQuery.isArray(H)){v="Failed to hide group. ";e.getSite().done(function(S){if(H.length>0){Object.keys(S.groups).forEach(function(w){if(jQuery.inArray(S.groups[w].identification.id,H)>-1){S.groups[w].identification.isVisible=false;}else{delete S.groups[w].identification.isVisible;}});}if(H.length===0){Object.keys(S.groups).forEach(function(w){delete S.groups[w].identification.isVisible;});}e.save().done(function(){D.resolve();}).fail(function(w){D.reject("Hiding of groups did not work as expected - "+w);});}).fail(function(w){D.reject(v+w);});}else{D.reject("Invalid input parameter aHiddenGroupIds. Please pass a valid input parameter.");}return D.promise();};this.isGroupVisible=function(e){if(e.identification.isVisible===undefined||e.identification.isVisible===true){return true;}else{return false;}};this.moveGroup=function(e,v){var D=new jQuery.Deferred(),w=sap.ushell.Container.getService("CommonDataModel"),x,y;if(!e||!e.identification||!e.identification.id||v<0){return D.reject("Unable to move groups - invalid parameters").promise();}y="Failed to move group with id '"+e.identification.id+"'. ";w.getSite().done(function(S){if(!S.site.payload.groupsOrder){return D.reject("groupsOrder not found - abort operation of adding a group.");}else if(S.site.payload.groupsOrder.indexOf(e.identification.id)===v){return D.resolve();}x=U.moveElementInsideOfArray(S.site.payload.groupsOrder,S.site.payload.groupsOrder.indexOf(e.identification.id),v);if(!x){return D.reject("invalid move group operation - abort.");}w.save().done(function(){D.resolve();}).fail(function(z){D.reject(z);});}).fail(function(z){D.reject(y+z);});return D.promise();};this.removeGroup=function(e){var D=new jQuery.Deferred(),v=sap.ushell.Container.getService("CommonDataModel"),w;if(!e||typeof e!=="object"||!e.identification||!e.identification.id){return D.reject("no valid input parameter for 'oGroup'").promise();}w="Failed to remove group with id '"+e.identification.id+"'. ";v.getSite().done(function(S){if(S&&S.groups&&S.groups[e.identification.id]){delete S.groups[e.identification.id];}if(S&&S.site&&S.site.payload&&S.site.payload.groupsOrder){S.site.payload.groupsOrder=jQuery.grep(S.site.payload.groupsOrder,function(x){return x!==e.identification.id;});}v.save().done(function(){D.resolve();}).fail(function(x){D.reject(x);});}).fail(function(x){D.reject(w+x);});return D.promise();};this.resetGroup=function(e){var D=new jQuery.Deferred(),v=sap.ushell.Container.getService("CommonDataModel"),S={},w=this,x;if(e&&typeof e==="object"&&e.identification&&e.identification.id){x="Failed to reset group with id '"+e.identification.id+"'. ";v.getSite().done(function(y){jQuery.extend(true,S,y.groups);if(w.isGroupRemovable(e)===false){v.getGroupFromOriginalSite(e.identification.id).done(function(z){if(y&&typeof y==="object"&&y.groups&&y.groups[e.identification.id]){y.groups[e.identification.id]=z;}v.save().done(function(){D.resolve(z);}).fail(function(B){D.reject("Group could not be reset - "+B,S);});}).fail(function(z){D.reject("Group could not be reset - "+z,S);});}else{D.reject("Group could not be reset as it was created by the user",S);}}).fail(function(y){D.reject(x+y,S);});}return D.promise();};this.getTileTitle=function(T){var R;if(T&&T.isBookmark){return T.title;}R=this._mResolvedTiles[T.id];if(R){return T.title||R.tileResolutionResult.title;}else{return undefined;}};this.getTileSubtitle=function(T){var R;if(T.isBookmark){return T.subTitle;}R=this._mResolvedTiles[T.id];if(R){return T.subTitle||R.tileResolutionResult.subTitle;}else{return undefined;}};this.getTileIcon=function(T){var R;if(T.isBookmark){return T.icon;}R=this._mResolvedTiles[T.id];if(R){return T.icon||R.tileResolutionResult.icon;}else{return undefined;}};this.getTileInfo=function(T){var R;if(T.isBookmark){return T.info;}R=this._mResolvedTiles[T.id];return T.info||R.tileResolutionResult.info;};this.getTileIndicatorDataSource=function(T){var R=this._mResolvedTiles[T.id],e={},v;if(T.indicatorDataSource){e.indicatorDataSource=T.indicatorDataSource;if(T.dataSource){e.dataSource=T.dataSource;}return e;}if(!R){return e;}v=R.tileResolutionResult;if(v.indicatorDataSource){e.indicatorDataSource=v.indicatorDataSource;if(v.indicatorDataSource.hasOwnProperty("dataSource")){var D=v.indicatorDataSource.dataSource,w=v.dataSources;if(w&&w.hasOwnProperty(D)){e.dataSource=w[D];}else{jQuery.sap.log.warning("datasource referenced but not found for tile: "+R.tileIntent);}}}return e;};this.isGroupRemovable=function(e){return!this._isGroupPreset(e);};this.isGroupLocked=function(e){return this._isGroupLocked(e);};this.getGroupTiles=function(e){var T=e.payload.tiles||[];if(e.payload.links&&jQuery.isArray(e.payload.links)&&e.payload.links.length>0){T=T.concat(e.payload.links);}return T;};this.getLinkTiles=function(e){if(e.payload.links&&jQuery.isArray(e.payload.links)&&e.payload.links.length>0){return e.payload.links;}else{return[];}};this.getTileType=function(T){var R=this._mResolvedTiles[T.id];if(R&&R.isLink){return this.TileType.Link;}return this.TileType.Tile;};this.getTileId=function(T){return T.id;};this.getTileSize=function(T){var R=this._mResolvedTiles[T.id];if(R&&R.tileResolutionResult&&R.tileResolutionResult.size){return R.tileResolutionResult.size;}return"1x1";};this.getTileTarget=function(T){var R,e=this._mResolvedTiles[T.id],v;if(T.target&&T.target.url){return T.target.url;}if(e&&e.tileResolutionResult){R=e.tileResolutionResult;if(R.isCustomTile!==true){return e.tileIntent;}if(R&&typeof R.targetOutbound==="object"){v=this._toHashFromOutbound(R.targetOutbound);if(v){return v;}}}jQuery.sap.log.warning("Could not find a target for Tile with id '"+T.id+"'","sap.ushell.adapters.cdm.LaunchPageAdapter");return"";};this.isLinkPersonalizationSupported=function(T){return true;};this.isTileIntentSupported=function(T){return(this._mFailedResolvedTiles[T.id]===undefined)?true:false;};this.refreshTile=function(T){};this._notifyTileAboutVisibility=function(T,N,O){if(typeof T.tileSetVisible==="function"&&O!==N){T.tileSetVisible(N);}};this.setTileVisible=function(T,N){var R=this._mResolvedTiles[T.id];if(R){if(R.tileComponent){this._notifyTileAboutVisibility(R.tileComponent,N,R.visibility);}R.visibility=N;}};this.getTileView=function(e){var v=this;return new jQuery.Deferred(function(D){return v._getTileView(e,false).then(function(T){D.resolve(T);},function(R){var w="Tile with ID '"+e.id+"' could not be initialized"+(R?":\n"+R:".");jQuery.sap.log.error(w,null,e.tileType);D.reject(w);});}).promise();};this._getTileUiComponentContainer=function(T,R,I){var e=this,v,w,N,x,y,z,D=new jQuery.Deferred();var B=sap.ushell.Container.getService("Ui5ComponentLoader");if(I===true){w=e._createTileComponentData(T,true,R);}else{w=e._createTileComponentData(T,false,R);}v=R.tileResolutionResult;if(R.isLink){N=v.navigationMode;D.resolve(e._createLinkInstance(T,I,N,G,r));return D.promise();}var F=this._createTileComponentProperties(w,v.tileComponentLoadInfo);if(!F.name){return D.reject("Cannot find name of tile component for tile with id: '"+T.id+"'").promise();}if(F.manifest){w.properties=w.properties||{};w.properties.manifest=F.manifest;}z=this.isCustomTile(F.name);var H=function(M){var R;x=M.componentHandle.getInstance();y=new sap.ui.core.ComponentContainer({component:x,height:'100%'});if(I===true){e._mResolvedCatalogTiles[T.id].tileComponent=x;}else{R=e._mResolvedTiles[T.id];R.tileComponent=x;if(typeof R.visibility==="boolean"){e._notifyTileAboutVisibility(x,R.visibility);}}return y;};var J=function(){return B.createComponent({loadCoreExt:z,loadDefaultDependencies:false,componentData:w,url:F.url,applicationConfiguration:{},reservedParameters:{},applicationDependencies:F,ui5ComponentName:F.name},{},[]).then(H);};var K=function(){var M={componentData:w,url:F.url,name:F.name,async:false};x=sap.ui.component(M);var O={componentHandle:{getInstance:function(){return x;}}};return H(O);};if(z){E.once("CoreResourcesComplementLoaded").do(function(){J().then(function(y){D.resolve(y);}).fail(function(M){D.reject(M);});});}else{var S=K();D.resolve(S);}return D.promise();};this._createTileComponentProperties=function(T,v){var e={};if(typeof v==="string"){if(T.properties.indicatorDataSource&&T.properties.indicatorDataSource.path){e.name=d;}else{e.name=s;}return e;}if(typeof v==="object"&&v!==null){e=v.componentProperties||{};e.name=v.componentName;}return e;};this._getTileView=function(e){var R,v,D=new jQuery.Deferred();if(typeof e!=="object"||!e.id){v="Invalid input parameter passed to _getTileView: "+e;jQuery.sap.log.error(v);return D.reject(v).promise();}R=this._mResolvedTiles[e.id];if(R){return this._getTileUiComponentContainer(e,R,false);}v="No resolved tile found for tile ID: "+e.id;jQuery.sap.log.error(v);return D.reject(v).promise();};this._getCatalogTileView=function(e){if(typeof e!=="object"){return new jQuery.Deferred().reject(e);}return this._getTileUiComponentContainer(e,e,true);};this._createTileComponentData=function(T,I,R){var e=I?this.getCatalogTileTitle(T):this.getTileTitle(T),S=I?this.getCatalogTilePreviewSubtitle(T):this.getTileSubtitle(T),v=I?this.getCatalogTilePreviewIcon(T):this.getTileIcon(T),w=I?this.getCatalogTilePreviewInfo(T):this.getTileInfo(T),x=I?this.getCatalogTileTargetURL(T):this.getTileTarget(T),y=this.getTileIndicatorDataSource(T),z={properties:{},startupParameters:{}};if(R.tileResolutionResult.isCustomTile===true&&R.tileResolutionResult.startupParameters){z.startupParameters=R.tileResolutionResult.startupParameters;}if(e){z.properties.title=e;}if(w){z.properties.info=w;}if(S){z.properties.subtitle=S;}if(v){z.properties.icon=v;}if(x){z.properties.targetURL=x;}if(y.indicatorDataSource){z.properties.indicatorDataSource=y.indicatorDataSource;if(y.dataSource){z.properties.dataSource=y.dataSource;}}if(R.tileResolutionResult){z.properties.navigationMode=R.tileResolutionResult.navigationMode;}return z;};this._createLinkInstance=function(T,I,N,e,r){var v,w,x,y=this.getTileSubtitle(T);var G=e;if(I===true){v=this.getCatalogTileTitle(T);}else{v=this.getTileTitle(T);}w=new G({mode:g.LineMode,subheader:y,header:v,press:function(z){this._genericTilePressHandler(T,z);}.bind(this)});if(N){x=r.i18n.getText(N+"NavigationMode");w.setAriaLabel(x+" "+v+" "+y);}this._mResolvedTiles[T.id].linkTileControl=w;return w;};this._genericTilePressHandler=function(T,e){var v;if(e.getSource().getScope&&e.getSource().getScope()==="Display"){v=this.getTileTarget(T);if(v){if(v[0]==='#'){hasher.setHash(v);}else{window.open(v,'_blank');}}}};this._addTileToSite=function(P,e,N,v){var w=this,D=new jQuery.Deferred(),I=sap.ushell.Container.getService("URLParsing").parseShellHash(N.properties.targetURL),T={"id":w.getTileId(N),"target":{"semanticObject":I.semanticObject,"action":I.action,"parameters":q(I.params)}};P.groups[e.identification.id].payload.tiles.push(T);v.save().done(function(){D.resolve(T);}).fail(function(M){D.reject(M);});return D.promise();};this.addTile=function(e,v){var D=new jQuery.Deferred(),w,x=sap.ushell.Container.getService("CommonDataModel"),y;if(!v){v=_;}if(e.contentProviderId){if(e.externalUrl){return this.addBookmark(this._getBookmarkDataForExtensionCatalogTile(e),v);}return D.reject("Extension Tile without URL").promise();}y=f();y.appId=e.tileResolutionResult.appId;this._mResolvedTiles[y.id]={tileIntent:e.tileIntent,tileResolutionResult:e.tileResolutionResult,isLink:false};x.getSite().done(function(S){S.groups[v.identification.id].payload.tiles.push(y);x.save().done(function(){D.resolve(y);}).fail(function(R){D.reject(R);});}).fail(function(z){w="Failed to add tile with id '"+y.id+"' to group with id '"+v.identification.id+"'. ";D.reject(w+z);});return D.promise();};this._getBookmarkDataForExtensionCatalogTile=function(e){var B={title:e.tileResolutionResult.title,subtitle:e.tileResolutionResult.subTitle,icon:e.tileResolutionResult.icon,info:e.tileResolutionResult.info,url:e.externalUrl};if(e.tileResolutionResult.indicatorDataSource&&e.tileResolutionResult.indicatorDataSource.path){B.serviceUrl=e.tileResolutionResult.indicatorDataSource.path;B.serviceRefreshInterval=e.tileResolutionResult.indicatorDataSource.refresh;}return B;};this.removeTile=function(v,T,I){var w,x,D=new jQuery.Deferred(),y=this;if(!v||typeof v!=="object"||!v.identification||!v.identification.id||!T||typeof T!=="object"||!T.id){return D.reject({},"Failed to remove tile. No valid input parameters passed to removeTile method.").promise();}x="Failed to remove tile with id '"+T.id+"' from group with id '"+v.identification.id+"'. ";w=sap.ushell.Container.getService("CommonDataModel");w.getSite().done(function(S){var P,z;I=+I;try{P=S.groups[v.identification.id].payload;}catch(e){D.reject(S.groups[v.identification.id],x);}z=y.getTileType(T)===y.TileType.Link?"links":"tiles";if(y.getTileType(T)===y.TileType.Link){I-=P.tiles.length;}if(I>=0){P[z].splice(I,1);}else{P[z]=P[z].filter(function(B){return B.id!==T.id;});}w.save().done(function(){D.resolve();}).fail(function(B){jQuery.sap.log.error(B);D.reject(S.groups[v.identification.id],B);});}).fail(function(e){D.reject({},x+e);});return D.promise();};this.moveTile=function(T,S,e,v,w,x){var D=new jQuery.Deferred(),y=sap.ushell.Container.getService("CommonDataModel"),z=this,B;if(!T||jQuery.isEmptyObject(T)||S===undefined||S<0||e===undefined||e<0||!v||!v.identification||!v.identification.id||!w||!w.identification||!w.identification.id){return D.reject("Invalid input parameters").promise();}B="Failed to move tile with id '"+T.id+"'. ";y.getSite().done(function(F){var H,I,O=z.getTileType(T)===z.TileType.Link?"links":"tiles";if(!x){x=z._mResolvedTiles[T.id].isLink?"link":"tile";}H=x==="link"?"links":"tiles";if(O!=H&&z._mResolvedTiles[T.id]){z._mResolvedTiles[T.id].isLink=x==="link";}if(H==="links"){e-=F.groups[w.identification.id].payload.tiles.length;}if(O==="links"){S-=F.groups[v.identification.id].payload.tiles.length;}if(v.identification.id===w.identification.id){if(S!==e||O!=H){I=F.groups[w.identification.id].payload;I[O].splice(S,1);I[H].splice(e,0,T);}else{return D.resolve(T).promise();}}else{F.groups[v.identification.id].payload[O].splice(S,1);F.groups[w.identification.id].payload[H].splice(e,0,T);}y.save().done(function(){D.resolve(T);}).fail(function(J){jQuery.sap.log.error(B+J);D.reject(B+J);});}).fail(function(F){jQuery.sap.log.error(B+F);D.reject(B+F);});return D.promise();};this._compareCatalogs=function(e,B){if(e.identification.id>B.identification.id){return 1;}return-1;};this.getCatalogs=function(){var e=this,D=new jQuery.Deferred(),v=[],w=sap.ushell.Container.getService("CommonDataModel");function x(y,z,v,B,P,F){var H=y.catalogs[z];if(P&&F){H.contentProviderId=P;F.catalogsMap[z]=H;}v.push(H);B.notify(H);}window.setTimeout(function(){w.getSite().done(function(S){Object.keys(S.catalogs).forEach(function(y){x(S,y,v,D);});w.getExtensionSites().progress(function(y){var P=y.providerId;var z=y.site;var B=Promise.resolve(z);var F={sitePromise:B,site:z,catalogsMap:{}};Object.keys(z.catalogs).forEach(function(H){e._mContentProviders[P]=F;x(z,H,v,D,P,F);});}).done(function(y){y.filter(function(z){return!z.success;}).forEach(function(F,I){v.push({identification:{id:F.providerId},contentProviderId:F.providerId,error:"The following content providers could not provide catalogs: "+F.providerId+(F.error?" -> "+F.error:"")});});D.resolve(v.sort(e._compareCatalogs));});});},0);return D.promise();};this._isStartableInbound=function(I){var N=["Shell-plugin","Shell-bootConfig"],R;if(!I.semanticObject||!I.action){return false;}if(N.indexOf(I.semanticObject+"-"+I.action)>-1){return false;}if(!jQuery.sap.getObject("signature.parameters",undefined,I)){return true;}R=Object.keys(I.signature.parameters).every(function(p){return!I.signature.parameters[p].filter||(!!I.signature.parameters[p].launcherValue||p==="sap-external-url");});return R;};this._isHiddenInbound=function(I){return!!I.hideLauncher;};this._toHashFromInbound=function(I){var S,P,e;S={target:{semanticObject:I.semanticObject,action:I.action},params:{}};P=jQuery.sap.getObject("signature.parameters",undefined,I)||{};Object.keys(P).forEach(function(K){if(P[K].filter&&Object.prototype.hasOwnProperty.call(P[K].filter,"value")&&(P[K].filter.format===undefined||P[K].filter.format==="plain")){S.params[K]=[P[K].filter.value];}if(P[K].launcherValue&&Object.prototype.hasOwnProperty.call(P[K].launcherValue,"value")&&(P[K].launcherValue.format===undefined||P[K].launcherValue.format==="plain")){S.params[K]=[P[K].launcherValue.value];}});e=sap.ushell.Container.getService("URLParsing").constructShellHash(S);if(!e){return undefined;}return"#"+e;};this._getExternalUrlFromInbound=function(I){return jQuery.sap.getObject("signature.parameters.sap-external-url.launcherValue.value",undefined,I)||null;};this._toHashFromOutbound=function(O){var S,P,e;S={target:{semanticObject:O.semanticObject,action:O.action},params:{}};P=O.parameters||{};Object.keys(P).forEach(function(K){if(P.hasOwnProperty(K)&&typeof P[K].value==="object"){S.params[K]=[P[K].value.value];}});e=sap.ushell.Container.getService("URLParsing").constructShellHash(S);if(!e){return undefined;}return"#"+e;};this._isCustomTile=function(e){if(U.getMember(e,"sap|flp.type")==="tile"){return true;}return false;};this.getCatalogTiles=function(e){var v=this,D=new jQuery.Deferred();if(typeof e!=="object"||e===null){return D.reject("Invalid input parameter '"+e+"' passed to getCatalogTiles.").promise();}if(e.contentProviderId&&this._mContentProviders[e.contentProviderId]){this._mContentProviders[e.contentProviderId].sitePromise.then(function(S){b.call(v,e,S).done(D.resolve).fail(D.reject);},function(w){D.reject("Failed to get site: "+w);});}else{sap.ushell.Container.getService("CommonDataModel").getSite().done(function(S){b.call(v,e,S).done(D.resolve).fail(D.reject);}).fail(function(w){D.reject("Failed to get site: "+w);});}return D.promise();};this.isCustomTile=function(e){return!(e===s||e===d);};function b(e,S){var v=this,D=new jQuery.Deferred();setTimeout(function(){var w=((e.payload&&e.payload.appDescriptors)||[]).reduce(function(R,x){var y=S.applications[x.id],I,T,F,z,B,H,J,K,M,N,O,P;if(!y){return R;}I=v._getMember(y,"sap|app.crossNavigation.inbounds");if(!I||Object.keys(I).length===0){return R;}F=Object.keys(I)[0];z=I[F];if(v._isStartableInbound(z)&&!v._isHiddenInbound(z)){B=u.mapOne(F,z,y);if(!B||!B.tileResolutionResult){return R;}M=B.resolutionResult.applicationType;P=C.last("/core/navigation/enableInPlaceForClassicUIs");O=P?P[M]:false;N=B.resolutionResult.additionalInformation;B.tileResolutionResult.navigationMode=n.computeNavigationModeForHomepageTiles(M,N,O);H=B.tileResolutionResult;T=v._toHashFromInbound(z);if(e.contentProviderId){K=v._getMember(y,"sap|app.crossNavigation.inbounds.Shell-launchURL.signature.parameters.sap-external-url.launcherValue.value");}J={id:K||T,tileIntent:K||T,tileResolutionResult:H,isCatalogTile:true};if(e.contentProviderId&&K){J.contentProviderId=e.contentProviderId;J.externalUrl=K;}R.push(J);}return R;},[]);D.resolve(w);},0);return D.promise();}this.getCatalogError=function(e){if(e.error){return e.error;}};this.getCatalogId=function(e){return e.identification.id;};this.getCatalogTitle=function(e){return e.identification.title;};this._isGroupTile=function(T){return!!(T&&T.id&&T.target);};this._isCatalogTile=function(T){return!!(T&&T.isCatalogTile);};this._isFailedGroupTile=function(T){return!!(T&&this._mFailedResolvedTiles&&this._mFailedResolvedTiles[T.id]);};this._isFailedCatalogTile=function(T){return!!(T&&this._mFailedResolvedCatalogTiles&&this._mFailedResolvedCatalogTiles[T.id]);};this.getCatalogTileId=function(e){if(this._isGroupTile(e)){if(this._isFailedGroupTile(e)){return undefined;}if(e.isBookmark&&jQuery.sap.getObject("target.url",undefined,e)){return e.target.url;}return(this._mResolvedTiles[e.id]||{}).tileIntent;}if(this._isCatalogTile(e)){return e.id;}};this.getCatalogTileTitle=function(e){if(this._isGroupTile(e)){if(this._isFailedGroupTile(e)){return"";}return this._mResolvedTiles[e.id].tileResolutionResult.title;}if(this._isCatalogTile(e)){if(this._isFailedCatalogTile(e)){return undefined;}return e.tileResolutionResult.title;}};this.getCatalogTileSize=function(e){return this.getTileSize(e);};this.getCatalogTileView=function(e){return this._getCatalogTileView(e);};this.getCatalogTileTargetURL=function(e){if(!e){throw new Error("The given tile is falsy");}if(this._isCatalogTile(e)){return e.tileIntent||"";}return this.getTileTarget(e);};this.getCatalogTilePreviewTitle=function(e){if(this._isGroupTile(e)){return this.getTileTitle(e);}return(e.tileResolutionResult&&e.tileResolutionResult.title)||"";};this.getCatalogTilePreviewSubtitle=function(e){if(this._isGroupTile(e)){return this.getTileSubtitle(e);}return(e.tileResolutionResult&&e.tileResolutionResult.subTitle)||"";};this.getCatalogTilePreviewIcon=function(e){if(this._isGroupTile(e)){return this.getTileIcon(e);}return(e.tileResolutionResult&&e.tileResolutionResult.icon)||"";};this.getCatalogTilePreviewInfo=function(e){if(this._isGroupTile(e)){return this.getTileInfo(e);}return(e.tileResolutionResult&&e.tileResolutionResult.info)||"";};this.getCatalogTileKeywords=function(e){var K=[],R=e;if(!R){jQuery.sap.log.error("Could not find the Tile","sap.ushell.adapters.cdm.LaunchPageAdapter");return K;}if(this._mResolvedTiles&&this._mResolvedTiles[e.id]){R=this._mResolvedTiles[e.id];}if(R&&R.tileResolutionResult&&R.tileResolutionResult.title){K.push(R.tileResolutionResult.title);}if(R&&R.tileResolutionResult&&R.tileResolutionResult.subTitle){K.push(R.tileResolutionResult.subTitle);}return K;};this._visitBookmarks=function(e,v){var w=sap.ushell.Container;var x=w.getService("URLParsing");var y=w.getService("CommonDataModel");var R;var I=x.parseShellHash(e);if(I){R=m(I);}else{R=k(e);}return y.getSite().then(function(S){var z=S.groups;var T=Object.keys(z).filter(function(K){return!z[K].payload.locked;}).map(function(K){return z[K].payload.tiles.filter(function(B){return B.isBookmark&&i(R,B.target);});}).reduce(function(B,D){Array.prototype.push.apply(B,D);return B;},[]);if(!v){return T.length;}return jQuery.when(T.map(v)).then(function(){return T.length;});});};this.addBookmark=function(P,e){var T=this;return new jQuery.Deferred(function(D){var v=sap.ushell.Container;var w=v.getService("URLParsing");var x=v.getService("CommonDataModel");jQuery.when(e||T.getDefaultGroup(),x.getSite()).done(function(e,S){var y,z,I=w.parseShellHash(P.url),R,B=false;if(!I){z=k(P.url);B=true;}else{z=m(I);}y=c(P,z);if(B){R=new jQuery.Deferred();R.resolve(T._getTileForUrl(y));}else{R=T._getTileFromHash(P.url);}R.done(function(N){N.isLink=false;T._mResolvedTiles[y.id]=N;S.groups[e.identification.id].payload.tiles.push(y);x.save().done(function(){D.resolve(y);}).fail(function(F){D.reject(F);});}).fail(function(F){D.reject("Bookmark creation failed because: "+F);});}).fail(function(R){D.reject(R);});}).promise();};this.countBookmarks=function(e){return this._visitBookmarks(e);};this.updateBookmarks=function(e,P){var v=sap.ushell.Container;var w=v.getService("URLParsing");var x=v.getService("CommonDataModel");var R=this._mResolvedTiles;function y(T){return new jQuery.Deferred(function(D){var I,N;var z;var B=false;var F={};if(P.url||P.url===""){I=w.parseShellHash(P.url);if(!I){N=k(P.url);}else{N=m(I);}}if(T.icon!==P.icon){F.icon=P.icon;B=true;}if(T.title!==P.title){F.title=P.title;B=true;}if(T.subTitle!==P.subtitle){F.subtitle=P.subtitle;B=true;}if(P.url&&e!==P.url){F.targetURL=P.url;B=true;}if(T.info!==P.info){F.info=P.info;B=true;}h(T,P,N);if(B&&R[T.id]){z=R[T.id].tileComponent;z.tileSetVisualProperties(F);}D.resolve(T);}).promise();}return this._visitBookmarks(e,y).then(function(z){return x.save().then(function(){return z;});});};this.deleteBookmarks=function(e){var v=sap.ushell.Container;var w=v.getService("URLParsing");var x=v.getService("CommonDataModel");var I=w.parseShellHash(e);var R;if(I){R=m(I);}else{R=k(e);}return x.getSite().then(function(S){var y=S.groups;var D=Object.keys(y).map(function(K){var P=y[K].payload;var z=0;P.tiles=P.tiles.filter(function(T){if(T.isBookmark&&i(R,T.target)){++z;return false;}return true;});return z;}).reduce(function(z,B){z+=B;return z;},0);return x.save().then(function(){return D;});});};this.onCatalogTileAdded=function(T){};this._onTileSettingsSave=function(T,S){var D=new jQuery.Deferred(),e,v,N,w,x,O,y,z;if(T&&T.id&&S){N=S.oTitleInput.getValue();x=S.oSubTitleInput.getValue();w=S.oInfoInput.getValue();O=this.getTileTitle(T);y=this.getTileInfo(T);z=this.getTileSubtitle(T);if(O===N&&z===x&&y===w){return;}e=sap.ushell.Container.getService("CommonDataModel");var B=this;e.getSite().done(function(F){if(!F.modifiedTiles){F.modifiedTiles={};}if(!F.modifiedTiles[T.id]){F.modifiedTiles[T.id]={id:T.id};}v={};if(O!==N){v.title=N;F.modifiedTiles[T.id].title=N;T.title=N;}if(z!==x){v.subtitle=x;F.modifiedTiles[T.id].subTitle=x;T.subTitle=x;}if(y!==w){v.info=w;F.modifiedTiles[T.id].info=w;T.info=w;}if(B._mResolvedTiles[T.id].tileComponent){B._mResolvedTiles[T.id].tileComponent.tileSetVisualProperties(v);}else{if(B._mResolvedTiles[T.id].linkTileControl){if(v.title){B._mResolvedTiles[T.id].linkTileControl.setHeader(v.title);}if(v.subtitle){B._mResolvedTiles[T.id].linkTileControl.setSubheader(v.subtitle);}if((v.title)||(v.subtitle)){B._mResolvedTiles[T.id].linkTileControl.rerender();}}}e.save().fail(function(H){jQuery.sap.log.error(H);D.reject("Could not save personalization changes: "+H);}).done(function(){D.resolve();});}).fail(function(F){jQuery.sap.log.error(F);D.reject("Cannot get site: "+F);});}return D.promise();};this.getTileActions=function(T){var e=[],v,M;if(this._isGroupTile(T)&&!this._isFailedGroupTile(T)){M=new sap.ui.model.json.JSONModel({config:{display_title_text:this.getTileTitle(T),display_subtitle_text:this.getTileSubtitle(T),display_info_text:this.getTileInfo(T)}});v=sap.ushell.components.tiles.utilsRT.getTileSettingsAction(M,this._onTileSettingsSave.bind(this,T),this.getTileType(T));e.push(v);}return e;};function c(P,T){var e=f(P,T);e.isBookmark=true;return e;}function f(P,T){var e={id:U.generateUniqueId([])};h(e,P,T);return e;}function h(T,P,e){P=jQuery.extend(true,{},P);if(e){T.target=e;}if(P.title||P.title===""){T.title=P.title;}if(P.icon||P.icon===""){T.icon=P.icon;}if(P.subtitle||P.subtitle===""){T.subTitle=P.subtitle;}if(P.info||P.info===""){T.info=P.info;}if(P.dataSource){T.dataSource={};jQuery.extend(true,T.dataSource,P.dataSource);delete P.serviceUrl;}else if(P.dataSource===null){delete T.dataSource;delete T.indicatorDataSource;delete P.serviceUrl;}if((P.dataSource||T.dataSource)&&P.serviceUrlPath){T.indicatorDataSource={path:P.serviceUrlPath};}if(P.serviceUrl||P.serviceUrl===""){if(T.dataSource){jQuery.sap.log.warning("`serviceUrl` is marked for deprecation in the future."+"It is not the preferred means for defining a dynamic "+"tile's data source. Please use `oParameter.dataSource`");delete T.dataSource;}T.indicatorDataSource={path:P.serviceUrl};}else if(P.serviceUrl===null&&!T.dataSource){delete T.indicatorDataSource;}if(P.serviceRefreshInterval||P.serviceRefreshInterval===0){T.indicatorDataSource.refresh=P.serviceRefreshInterval;}}function i(T,O){if(T&&O){if(T.url){return T.url===O.url;}return T.semanticObject===O.semanticObject&&T.action===O.action&&j(T.parameters,O.parameters);}return T===O;}function j(P,O){var F,e;P=P||[];O=O||[];if(P.length===O.length){F=t(P);e=t(O);return F===e;}return false;}function t(e){return e.map(function(P){return P.name+P.value;}).sort().join();}function k(e){return{url:e};}function m(I){var T={semanticObject:I.semanticObject,action:I.action,parameters:q(I.params)};if(I.appSpecificRoute){T.appSpecificRoute=I.appSpecificRoute;}return T;}function q(I){return Object.keys(I).map(function(K){var v=I[K]&&I[K][0];return{name:K,value:v||""};});}}a.prototype._getMember=function(o,A){return U.getMember(o,A);};return a;},true);
