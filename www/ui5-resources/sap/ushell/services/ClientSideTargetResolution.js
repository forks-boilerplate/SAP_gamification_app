// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils","sap/ushell/services/_ClientSideTargetResolution/Utils","sap/ushell/services/AppConfiguration","sap/ushell/services/_ClientSideTargetResolution/InboundProvider","sap/ushell/services/_ClientSideTargetResolution/InboundIndex","sap/ushell/services/_ClientSideTargetResolution/VirtualInbounds","sap/ushell/services/_ClientSideTargetResolution/Search","sap/ushell/services/_ClientSideTargetResolution/StagedLogger","sap/ushell/services/_ClientSideTargetResolution/Formatter","sap/ushell/navigationMode","sap/ushell/Config","sap/ui/thirdparty/URI"],function(u,c,a,I,b,V,S,l,f,n,C,U){"use strict";function d(A,o,p,s){this._init.apply(this,arguments);}var g="";var O={apply:"apply",applied:"applied"};d.prototype._init=function(A,o,p,s){this._iLogId=0;sap.ui.lazyRequire("sap/ui/generic/app/navigation/service/SelectionVariant");if(!this._implementsServiceInterface(A)){jQuery.sap.log.error("Cannot get Inbounds","ClientSideTargetResolutionAdapter should implement getInbounds method","sap.ushell.services.ClientSideTargetResolution");return;}this._oInboundProvider=new I(A.getInbounds.bind(A));this._oHaveEasyAccessSystemsDeferreds={userMenu:null,sapMenu:null};this._oServiceConfiguration=s;this._oAdapter=A;};d.prototype._implementsServiceInterface=function(A){if(typeof A.getInbounds==="function"){return true;}return false;};d.prototype._getURLParsing=function(){if(!this._oURLParsing){this._oURLParsing=sap.ushell.Container.getService("URLParsing");}return this._oURLParsing;};d.prototype._isFullLocalWDAResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableWdaLocalResolution"]===false){return false;}return!(!o||!r||!(r["sap.wda"])||!(r.applicationType==="WDA"));};d.prototype._isLocalWDAResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableWdaLocalResolution"]===false){return false;}return!(!o||!r||!(r.applicationType==="WDA"));};d.prototype._isFullLocalWebguiResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableWebguiLocalResolution"]===false){return false;}return!(!o||!r||!(r["sap.gui"])||!(r.applicationType==="TR"));};d.prototype._isLocalWebguiNowrapResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableWebguiLocalResolution"]===false){return false;}return!((!o||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/~canvas;")>=0)||!(r.url.indexOf("app/transaction/APB_LPD_CALL_")===-1)));};d.prototype._isLocalWebguiWrapResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableWebguiLocalResolution"]===false){return false;}return!((!o||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/~canvas;")>=0)||!(r.url.indexOf("app/transaction/APB_LPD_CALL_")>=0)));};d.prototype._isLocalNativeWebguiWrapResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableNativeWebguiLocalResolution"]===false){return false;}return!((!o||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/its/webgui")>=0)||!(r.url.indexOf("APB_LPD_CALL_")!==-1)));};d.prototype._isLocalNativeWebguiNowrapResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableNativeWebguiLocalResolution"]===false){return false;}return!((!o||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/its/webgui")>=0)||!(r.url.indexOf("APB_LPD_CALL_")===-1)));};d.prototype._hasRenameTo=function(m){return m.inbound&&m.inbound.signature&&m.inbound.signature.parameters&&Object.keys(m.inbound.signature.parameters).some(function(k){return!!(m.inbound.signature.parameters[k].renameTo);});};d.prototype._removeUnusedComplexParameterValuesFromDefaultList=function(m){m.defaultedParamNames=m.defaultedParamNames.filter(function(N){if(m.intentParamsPlusAllDefaults[N]&&!jQuery.isArray(m.intentParamsPlusAllDefaults[N])){if(!(m.resolutionResult.oNewAppStateMembers&&m.resolutionResult.oNewAppStateMembers[N])){return false;}}return true;});};d.prototype._mapDefaultParameterNames=function(m){var p=jQuery.sap.getObject("inbound.signature.parameters",undefined,m)||{},M={};m.defaultedParamNames.forEach(function(N){var s=(p[N]&&p[N].renameTo)||N;if(M[s]){jQuery.sap.log.error("renaming of defaultedParamNames creates duplicates"+N+"->"+s);}else{M[s]=true;}});m.mappedDefaultedParamNames=Object.keys(M).sort();};d.prototype._mixAppStateIntoResolutionResultAndRename=function(m,A){var D=new jQuery.Deferred(),t=this,N,s,o;var r=m.resolutionResult;function e(T){var v;t._removeUnusedComplexParameterValuesFromDefaultList(T);t._mapDefaultParameterNames(T);v=n.compute(jQuery.sap.getObject("inbound.resolutionResult.applicationType",undefined,T),(T.intentParamsPlusAllDefaults["sap-ushell-next-navmode"]||[])[0],(T.intentParamsPlusAllDefaults["sap-ushell-navmode"]||[])[0],(a.getCurrentApplication()||{}).applicationType,C.last("/core/navigation/enableInPlaceForClassicUIs"));u.shallowMergeObject(T.resolutionResult,v);delete T.resolutionResult.oNewAppStateMembers;D.resolve(T);}function h(r){return(r.oNewAppStateMembers&&!jQuery.isEmptyObject(r.oNewAppStateMembers));}function j(L,P){return jQuery.isArray(L)&&L.some(function(v){return(P.indexOf(v)!==-1);});}function k(v,P){var w,x,y;if(v&&v.selectionVariant){w=new sap.ui.generic.app.navigation.service.SelectionVariant(JSON.stringify(v.selectionVariant));y=w.getSelectOptionsPropertyNames()||[];x=w.getParameterNames()||[];if(j(y,P)||j(x,P)){return true;}}return false;}function p(v,R,P,w){var x=new sap.ui.generic.app.navigation.service.SelectionVariant(),y=v.getParameterNames()||[],z=v.getSelectOptionsPropertyNames()||[],B,E;y.forEach(function(F){B=v.getParameter(F);if(w&&!P[F]){R.deleted=true;return;}if(P[F]&&P[F].renameTo){if((x.getParameter(P[F].renameTo)===undefined)&&(x.getSelectOption(P[F].renameTo)===undefined)){x.addParameter(P[F].renameTo,B);R.changed=true;}else{jQuery.sap.log.error("renaming of appstate creates duplicates "+F+"->"+P[F].renameTo);}}else{if((x.getParameter(F)===undefined)&&(x.getSelectOption(F)===undefined)){x.addParameter(F,B);}}});z.forEach(function(F){E=v.getSelectOption(F);if(w&&!P[F]){R.deleted=true;return;}if(P[F]&&P[F].renameTo){if((x.getSelectOption(P[F].renameTo)===undefined)&&(x.getParameter(P[F].renameTo)===undefined)){x.massAddSelectOption(P[F].renameTo,E);R.changed=true;}else{jQuery.sap.log.error("renaming of appstate creates duplicates "+F+"->"+P[F].renameTo);}}else{if((x.getSelectOption(F)===undefined)&&(x.getParameter(F)===undefined)){x.massAddSelectOption(F,E);}}});y.forEach(function(F){v.removeParameter(F);});z.forEach(function(F){v.removeSelectOption(F);});x.getParameterNames().forEach(function(F){v.addParameter(F,x.getParameter(F));});x.getSelectOptionsPropertyNames().forEach(function(F){v.massAddSelectOption(F,x.getSelectOption(F));});return v;}function q(v){if(v===undefined||jQuery.isPlainObject(v)){return false;}return true;}function M(v){var w=v.getData()||{},x,y={};var z=m.inbound.signature;if(w.selectionVariant){x=new sap.ui.generic.app.navigation.service.SelectionVariant(JSON.stringify(w.selectionVariant));}else{x=new sap.ui.generic.app.navigation.service.SelectionVariant();}if(h(r)){Object.keys(r.oNewAppStateMembers).forEach(function(E){x.massAddSelectOption(E,r.oNewAppStateMembers[E].Ranges);});}var B=z.additionalParameters==="ignored";x=p(x,y,z.parameters,B);if(x.getParameterNames().length!==0||x.getSelectOptionsPropertyNames().length!==0||y.deleted){w.selectionVariant=x.toJSONObject();}if(!y.changed&&!y.deleted&&!h(r)){e(m);return;}v.setData(w);v.save().done(function(){m.intentParamsPlusAllDefaults["sap-xapp-state"]=[v.getKey()];m.mappedIntentParamsPlusSimpleDefaults["sap-xapp-state"]=[v.getKey()];e(m);});}if(!h(r)&&!t._hasRenameTo(m)){e(m);}else{s=m.intentParamsPlusAllDefaults["sap-xapp-state"]&&m.intentParamsPlusAllDefaults["sap-xapp-state"][0];if(s){A.getAppState(s).done(function(v){var P=c.constructParameterDominatorMap(m.inbound.signature.parameters);o=v.getData();if(q(o)){delete r.oNewAppStateMembers;e(m);}if(r.oNewAppStateMembers){Object.keys(r.oNewAppStateMembers).forEach(function(w){var x=P[w].dominatedBy;if(k(o,x)){delete r.oNewAppStateMembers[w];}});}if(!h(r)&&!t._hasRenameTo(m)){e(m);}else{N=A.createEmptyAppState(undefined,true);if(N){N.setData(v.getData());M(N);}}});}else if(h(r)){M(A.createEmptyAppState(undefined,true));}else{e(m);}}return D.promise();};d.prototype._extractInboundFilter=function(o){if(!this._oAdapter.hasSegmentedAccess){return undefined;}if(typeof o!=="string"){return undefined;}var F=o.indexOf("#")===0?o:"#"+o;var s=this._getURLParsing().parseShellHash(F);if(!s||!s.semanticObject||!s.action){return undefined;}return[{semanticObject:s.semanticObject,action:s.action}];};d.prototype.resolveHashFragment=function(h){var t=this,D=new jQuery.Deferred(),B=this._oAdapter.resolveHashFragmentFallback&&this._oAdapter.resolveHashFragmentFallback.bind(this._oAdapter),s=this._extractInboundFilter(h);this._oInboundProvider.getInbounds(s).then(function(e){t._resolveHashFragment(h,B,e).done(function(o){return D.resolve(o);}).fail(D.reject.bind(D));},function(){D.reject.apply(D,arguments);});return D.promise();};d.prototype.resolveTileIntent=function(h){var t=this,D=new jQuery.Deferred(),s=this._extractInboundFilter(h);this._oInboundProvider.getInbounds(s).then(function(o){t._resolveTileIntent(h,undefined,o).done(D.resolve.bind(D)).fail(D.reject.bind(D));},function(){D.reject.apply(D,arguments);});return D.promise();};d.prototype.resolveTileIntentInContext=function(e,h){var o,D=new jQuery.Deferred();o=b.createIndex(e.concat(V.getInbounds()));this._resolveTileIntent(h,undefined,o).done(D.resolve.bind(D)).fail(D.reject.bind(D));return D.promise();};d.prototype._resolveHashFragment=function(h,B,e){var j=this._getURLParsing(),t=this,D=new jQuery.Deferred(),F=h.indexOf("#")===0?h:"#"+h,s=j.parseShellHash(F);if(s===undefined){jQuery.sap.log.error("Could not parse shell hash '"+h+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return D.reject().promise();}s.formFactor=u.getFormFactor();this._getMatchingInbounds(s,e,{bExcludeTileInbounds:true}).fail(function(E){jQuery.sap.log.error("Could not resolve "+h,"_getMatchingInbounds promise rejected with: "+E,"sap.ushell.services.ClientSideTargetResolution");D.reject(E);}).done(function(m){var M;if(m.length===0){jQuery.sap.log.warning("Could not resolve "+h,"rejecting promise","sap.ushell.services.ClientSideTargetResolution");D.reject("Could not resolve navigation target");return;}M=m[0];c.whenDebugEnabled(function(){function k(K,v){return this[K]===undefined?"<undefined>":v;}function r(p,v){return(p==="_original")?undefined:k.call(this,p,v);}var o=JSON.stringify(M,r,"   ");jQuery.sap.log.debug("The following target will now be resolved",o,"sap.ushell.services.ClientSideTargetResolution");});t._resolveSingleMatchingTarget(M,B,F).done(function(o){D.resolve(o);}).fail(D.reject.bind(D));});return D.promise();};d.prototype._resolveEasyAccessMenuIntent=function(o,m,B,F){var e="Intent must be either #Shell-startGUI or #Shell-startWDA";if(o.action==="startGUI"){return this._resolveEasyAccessMenuIntentWebgui(o,m,B,F,true);}if(o.action==="startWDA"){return this._resolveEasyAccessMenuIntentWDA(o,m);}return Promise.reject("The easy access menu intent "+o.semanticObject+"-"+o.action+" could not be resolved: "+e);};d.prototype._resolveEasyAccessMenuIntentWDA=function(o,m){var s,A,e,t=this;A=o.params["sap-ui2-wd-app-id"][0];s=(jQuery.sap.getObject("params.sap-ui2-wd-conf-id",undefined,o)||[])[0];e=Object.keys(o.params).reduce(function(r,p){if(p!=="sap-ui2-wd-app-id"&&p!=="sap-ui2-wd-conf-id"){r[p]=o.params[p];}return r;},{});return new Promise(function(r,R){t._buildWdaURI(A,s,e).done(function(h){var j=o.params.hasOwnProperty("sap-system-src")&&o.params["sap-system-src"][0];var k={url:h.toString(),applicationType:"NWBC",text:A,additionalInformation:"","sap-system":o.params["sap-system"][0]};if(typeof j==="string"){k["sap-system-src"]=j;}if(m&&m.inbound&&m.inbound.resolutionResult&&m.inbound.resolutionResult["sap.platform.runtime"]){k["sap.platform.runtime"]=m.inbound.resolutionResult["sap.platform.runtime"];}r(k);}).fail(function(E){R(E);});});};d.prototype._buildNativeWebGuiURI=function(t,s,e){var h,o;h="/gui/sap/its/webgui?%7etransaction="+t+"&%7enosplash=1";o=new U(h);return this._spliceSapSystemIntoURI(o,g,s,e,"NATIVEWEBGUI",O.apply);};d.prototype._buildWdaURI=function(A,s,o){var e,h,j,k,m=jQuery.extend(true,{},o);if(s){m["sap-wd-configId"]=s;}e=m["sap-system"][0];delete m["sap-system"];if(m.hasOwnProperty("sap-system-src")){h=m["sap-system-src"][0];delete m["sap-system-src"];}j="/ui2/nwbc/~canvas;window=app/wda/"+A+"/"+"?"+this._getURLParsing().paramsToString(m);k=new U(j);return this._spliceSapSystemIntoURI(k,g,e,h,"WDA",O.apply);};d.prototype._resolveEasyAccessMenuIntentWebgui=function(o,m,B,F,e){var t=this;return new Promise(function(r,R){var s;if(o.params["sap-system-src"]){s=o.params["sap-system-src"][0];}t._buildNativeWebGuiURI(o.params["sap-ui2-tcode"][0],o.params["sap-system"][0],s).done(function(h){delete m.intentParamsPlusAllDefaults["sap-ui2-tcode"];t._mapParameterNamesAndRemoveObjects(m);var j=t._blendParamsIntoNativeWebGUI(m.inbound,m.mappedIntentParamsPlusSimpleDefaults,h);if(j&&m.inbound&&m.inbound.resolutionResult&&m.inbound.resolutionResult["sap.platform.runtime"]){j["sap.platform.runtime"]=m.inbound.resolutionResult["sap.platform.runtime"];}j["sap-system"]=o.params["sap-system"][0];if(e){j.text=o.params["sap-ui2-tcode"][0];}r(j);}).fail(function(E){R(E);});});};d.prototype._resolveSingleMatchingTarget=function(m,B,F){var t=this,D=new jQuery.Deferred(),o=this._getURLParsing(),e=o.parseShellHash(F);if(e.semanticObject==="Shell"&&(e.action==="startWDA"||e.action==="startGUI")){this._resolveEasyAccessMenuIntent(e,m,B,F).then(function(r){var N=n.compute(jQuery.sap.getObject("inbound.resolutionResult.applicationType",undefined,m),(m.intentParamsPlusAllDefaults["sap-ushell-next-navmode"]||[])[0],(m.intentParamsPlusAllDefaults["sap-ushell-navmode"]||[])[0],(a.getCurrentApplication()||{}),C.last("/core/navigation/enableInPlaceForClassicUIs"));u.shallowMergeObject(r,N);D.resolve(r);},function(E){D.reject(E);});return D.promise();}this._mapParameterNamesAndRemoveObjects(m);this._mixAppStateIntoResolutionResultAndRename(m,sap.ushell.Container.getService("AppState")).done(function(m){var h=t._determineResultProcessor(m);delete m.intentParamsPlusAllDefaults["sap-tag"];delete m.mappedIntentParamsPlusSimpleDefaults["sap-tag"];m.mappedDefaultedParamNames=m.mappedDefaultedParamNames.filter(function(p){return p!=="sap-tag";});var s=jQuery.sap.getObject('inbound.resolutionResult.url',undefined,m);h(m,B,F,s).then(function(r){jQuery.sap.log.debug("Intent was resolved to the following target",JSON.stringify(m.resolutionResult,null,3),"sap.ushell.services.ClientSideTargetResolution");u.shallowMergeObject(m.resolutionResult,r);D.resolve(m.resolutionResult);},function(M){if(M.indexOf("fallback:")>=0){t._constructFallbackResolutionResult.call(this,m,B,F).then(function(r){u.shallowMergeObject(m.resolutionResult,r);D.resolve(m.resolutionResult);},D.reject.bind(D));}else{D.reject(M);}});});return D.promise();};d.prototype._resolveTileIntent=function(h,B,o){var e=this._getURLParsing(),t=this,D=new jQuery.Deferred(),F=h.indexOf("#")===0?h:"#"+h,s=e.parseShellHash(F);if(s===undefined){jQuery.sap.log.error("Could not parse shell hash '"+h+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return D.reject("Cannot parse shell hash").promise();}s.formFactor=u.getFormFactor();this._getMatchingInbounds(s,o,{bExcludeTileInbounds:false}).fail(function(E){jQuery.sap.log.error("Could not resolve "+h,"_getMatchingInbounds promise rejected with: "+E,"sap.ushell.services.ClientSideTargetResolution");D.reject(E);}).done(function(m){var M;if(m.length===0){jQuery.sap.log.warning("Could not resolve "+h,"no matching targets were found","sap.ushell.services.ClientSideTargetResolution");D.reject("No matching targets found");return;}M=m[0];t._resolveSingleMatchingTileIntent(M,B,F).done(D.resolve.bind(D)).fail(D.reject.bind(D));});return D.promise();};d.prototype._resolveSingleMatchingTileIntent=function(m,B,F){var D=new jQuery.Deferred(),t=this;this._mapParameterNamesAndRemoveObjects(m);this._mixAppStateIntoResolutionResultAndRename(m,sap.ushell.Container.getService("AppState")).done(function(m){var e=t._determineResultProcessor(m);delete m.intentParamsPlusAllDefaults["sap-tag"];delete m.mappedIntentParamsPlusSimpleDefaults["sap-tag"];m.mappedDefaultedParamNames=m.mappedDefaultedParamNames.filter(function(p){return p!=="sap-tag";});var s=jQuery.sap.getObject('inbound.resolutionResult.url',undefined,m);e(m,B,F,s).then(function(r){u.shallowMergeObject(m.resolutionResult,r);var T=jQuery.extend(true,{},m.inbound.tileResolutionResult);T.startupParameters=m.effectiveParameters;T.navigationMode=m.resolutionResult.navigationMode;if(!T.navigationMode){T.navigationMode=n.getNavigationMode(m.resolutionResult);}D.resolve(T);jQuery.sap.log.debug("Tile Intent was resolved to the following target",JSON.stringify(T,null,3),"sap.ushell.services.ClientSideTargetResolution");},function(M){D.reject(M);});});return D.promise();};d.prototype._determineResultProcessor=function(m){var o=m.inbound,r=o&&o.resolutionResult;function e(P,R){jQuery.sap.log.debug("Resolution result will be constructed via "+P+" processor",R,"sap.ushell.services.ClientSideTargetResolution");}if(!o||!r){e("FALLBACK","the inbound or the inbound resolutionResult member was not available");return this._constructFallbackResolutionResult.bind(this);}if(r.applicationType==="SAPUI5"){e("SAPUI5","inbound resolutionResult had SAPUI5 applicationType");return this._constructSAPUI5ResolutionResult.bind(this);}var h=this._isFullLocalWDAResolution(m);if(h){e("WDA full url construction");return this._constructFullWDAResolutionResult.bind(this);}var j=this._isLocalWDAResolution(m);if(j){e("WDA");return this._constructWDAResolutionResult.bind(this);}var k=this._isFullLocalWebguiResolution(m);if(k){e("NON-WRAPPED WEBGUI full url construction");return this._constructFullWebguiResolutionResult.bind(this);}var p=this._isLocalWebguiNowrapResolution(m);if(p){e("NON-WRAPPED WEBGUI");return this._constructWebguiNowrapResult.bind(this);}var q=this._isLocalWebguiWrapResolution(m);if(q){e("WRAPPED WEBGUI");return this._constructWebguiWrapResult.bind(this);}var s=this._isLocalNativeWebguiNowrapResolution(m);if(s){e("NATIVE NON-WRAPPED WEBGUI");return this._constructNativeWebguiNowrapResult.bind(this);}var t=this._isLocalNativeWebguiWrapResolution(m);if(t){e("NATIVE WRAPPED WEBGUI");return this._constructNativeWebguiWrapResult.bind(this);}if(r.applicationType==="URL"){e("URL","inbound resolutionResult had URL applicationType");return this._constructURLResolutionResult.bind(this);}if(r.applicationType==="WCF"){e("WCF","inbound resolutionResult had WCF applicationType");return this._constructWCFResolutionResult.bind(this);}e("FALLBACK","could not apply any result processor to inbound resolutionResult: "+JSON.stringify(r,null,"   "));return this._constructFallbackResolutionResult.bind(this);};d.prototype._stripURI=function(o,s,e,h){var D=new jQuery.Deferred(),t=this;if(typeof s==="undefined"){this._stripURIWithSystemAlias(o,s,h,undefined).fail(function(E){D.reject(E);}).done(function(N){D.resolve(N);});return D.promise();}this._resolveSystemAlias(s,e).fail(function(E){D.reject(E);}).done(function(r){t._stripURIWithSystemAlias(o,s,h,r).fail(function(E){D.reject(E);}).done(function(N){D.resolve(N);});});return D.promise();};d.prototype._resolveSystemAlias=function(s,e){var h=typeof e==="string";var j=[s];if(h){j.unshift(e);}var k=u.generateLocalStorageKey("sap-system-data",j);var L=u.getLocalStorage();var m=L.getItem(k);var o={};if(m){try{o=JSON.parse(m);}catch(E){return new jQuery.Deferred().reject("Cannot parse system data from local storage at key '"+k+"'. Data: "+m);}return new jQuery.Deferred().resolve(o).promise();}else if(h){return new jQuery.Deferred().reject("Cannot find data for system '"+s+"' in local storage using key '"+k+"'");}if(typeof this._oAdapter.resolveSystemAlias!=="function"){return new jQuery.Deferred().reject("fallback: the adapter does not implement resolveSystemAlias").promise();}return this._oAdapter.resolveSystemAlias(s);};d.prototype._stripURIWithSystemAlias=function(o,s,e,r){var t=this,h,j,T,k,D=new jQuery.Deferred(),p=new jQuery.Deferred();o.protocol("");o.hostname("");o.port("");t._removeParametersFromURI(o,["sap-client","sap-language"]);if(!jQuery.isPlainObject(r)||typeof s!=="string"){return D.resolve(o).promise();}j=t._selectSystemAliasDataName(r,new U(window.location.toString()).protocol());h=r[j];k=(typeof h.pathPrefix==="string")&&h.pathPrefix;if(k!==""){p.resolve(k);}else{this._resolveSystemAlias("").fail(function(E){D.reject(E);}).done(function(R){var m=R[j];p.resolve(m.pathPrefix);});}p.fail(function(E){D.reject(E);}).done(function(k){if(k&&k.length>0){T=o.path();T=T.replace(k,"");if(T.indexOf("/")!==0){T="/"+T;}o.path(T);}if(e==="NATIVEWEBGUI"&&r.hasOwnProperty("rfc")){T=o.path();T=T.split(";").filter(function(P){return P.indexOf("~sysid=")!==0&&P.indexOf("~service=")!==0&&P.indexOf("~loginGroup=")!==0&&P.indexOf("~messageServer=")!==0&&P.indexOf("~sncNameR3=")!==0&&P.indexOf("~sncQoPR3=")!==0;}).join(";");o.path(T);}D.resolve(o);});return D.promise();};d.prototype._removeParametersFromURI=function(o,p){var B={},t;p.forEach(function(P){B[P]=true;});t=o.query();t=t.split("&").filter(function(P){var s=(P.split("=")[0]||"").toLowerCase();return!B.hasOwnProperty(s);}).join("&");o.query(t);};d.prototype._spliceSapSystemIntoUrlURI=function(o,s,e,h){var t=this,D=new jQuery.Deferred();if(s===g||typeof s==="undefined"){if(this._isAbsoluteURI(o)){return D.resolve(o);}t._applyAliasToURI(e,h,o,"URL").fail(function(E){D.reject(E);}).done(function(j){D.resolve(j);});return D.promise();}this._resolveSystemAlias(s).fail(function(E){D.reject(E);}).done(function(r){var j=t._selectSystemAliasDataName(r,new U(window.location.toString()).protocol()),k=r[j],m;if((o.protocol()||"").toLowerCase()===j&&(o.hostname()||"")===k.host&&(o.path().indexOf(k.pathPrefix)===0)){o.protocol("");o.hostname("");m=o.path().replace(k.pathPrefix,"");o.path(m);t._removeParametersFromURI(o,["sap-language","sap-client"]);t._applyAliasToURI(e,h,o,"URL").fail(function(E){D.reject(E);}).done(function(p){D.resolve(p);});}else{D.resolve(o);}});return D.promise();};d.prototype._spliceSapSystemIntoURI=function(o,s,e,h,j,k){var D=new jQuery.Deferred(),t=this;if(k!==O.apply&&k!==O.applied){throw new Error("Invalid system alias semantic was provided: '"+k+"'");}if(k===O.applied&&((typeof e==="undefined"||s===e))){return D.resolve(o).promise();}if(k===O.apply&&typeof s==="undefined"&&typeof e==="undefined"){return D.resolve(o).promise();}if(j==="URL"&&k==O.applied){return this._spliceSapSystemIntoUrlURI(o,s,e,h);}(new Promise(function(r){if(k===O.apply){r({targetUri:o,alias:e?e:s,sapSystemSrc:e?h:undefined});return;}t._stripURI(o,s,undefined,j).fail(function(E){D.reject(E);}).done(function(m){r({targetUri:m,alias:e});});})).then(function(A){t._applyAliasToURI(A.alias,A.sapSystemSrc,A.targetUri,j).fail(function(E){D.reject(E);}).done(function(m){D.resolve(m);});});return D.promise();};d.prototype._applyAliasToURI=function(s,e,o,h){var t=this,N=o,D=new jQuery.Deferred();this._resolveSystemAlias(s,e).fail(function(E){D.reject(E);}).done(function(r){var v=t._validateResolvedSystemAlias(r);if(!v.isValid){t._reportResolvedSystemAliasValidationErrors(v);D.reject("Invalid system alias definition");return D;}var j=t._selectSystemAliasDataName(r,new U(window.location.toString()).protocol()),k=r[j],q,L,m;if(s===g&&k.host===""&&(k.port===0||k.port==="")){j="";}N.protocol(j);N.hostname(k.host);N.port(k.port);t._interpolatePathPrefixIntoURI(N,h,k.pathPrefix).fail(function(E){D.reject(E);}).done(function(N){q=N.query();if(typeof r.client==="string"&&r.client!==""){q=q+(q.length>0?"&":"")+"sap-client="+r.client;}if(typeof r.language==="string"&&r.language!==""){L=r.language;}else{m=sap.ushell.Container.getUser();if(!m){jQuery.sap.log.error("Cannot retieve the User object via sap.ushell.Container while determining sap-language","will default to 'en' language","sap.ushell.services.ClientSideTargetResolution");L="en";}else{L=m.getLanguage();}}q=q+(q.length>0?"&":"")+"sap-language="+L;N.query(q);if(r.hasOwnProperty("rfc")&&h==="NATIVEWEBGUI"){var w=t._constructNativeWebguiParameters(r.rfc,k.host,N);var p=N.path()+";"+w;N.path(p);o._parts.path=p;}D.resolve(N);});});return D.promise();};d.prototype._constructNativeWebguiParameters=function(s,e){var r,R,h,t,j;h=!!s.systemId;if(h){t=[s.systemId&&("~sysid="+s.systemId),s.loginGroup&&("~loginGroup="+s.loginGroup),s.sncNameR3&&("~messageServer="+encodeURIComponent(s.sncNameR3)),s.sncNameR3&&("~sncNameR3="+encodeURIComponent(s.sncNameR3)),s.sncQoPR3&&("~sncQoPR3="+s.sncQoPR3)].filter(function(o){return(typeof o==="string")&&(o!=="");});}else{j=(s.host||"");R=j.toLowerCase()===e.toLowerCase();r=/^[/][HGMR][/].*/.test(j);if(j.length>0&&!R&&!r){jQuery.sap.log.error("Invalid connect string provided in 'host' field of system alias","Data for rfc destination provided are: "+JSON.stringify(s,null,3),"sap.ushell.services.ClientSideTargetResolution");}t=[j&&!r&&!R&&("~rfcHostName="+j),r&&("~connectString="+encodeURIComponent(j)),s.service&&("~service="+s.service),s.sncNameR3&&("~sncNameR3="+encodeURIComponent(s.sncNameR3)),s.sncQoPR3&&("~sncQoPR3="+s.sncQoPR3)].filter(function(o){return(typeof o==="string")&&(o!=="");});}return t.join(";").replace(/(%[A-F0-9]{2})/g,function(E){return E.toLowerCase();});};d.prototype._interpolatePathPrefixIntoURI=function(o,s,p){var t=this,D=new jQuery.Deferred(),T;if(s==="URL"&&p.length===0){return D.resolve(o).promise();}function e(P){var r=P+o.path();o.path(r.replace(/\/+/g,"/"));D.resolve(o);}if(p.length>0){if((s==="WDA"||s==="WEBGUI")&&o.path().indexOf("~canvas")>=0){T=o.path();T="/~canvas"+T.split("~canvas")[1];o.path(T);}e(p);}else{this._resolveSystemAlias("",undefined).fail(function(E){D.reject(E);}).done(function(r){var h=t._selectSystemAliasDataName(r,new U(window.location.toString()).protocol()),P=r[h].pathPrefix;e(P);});}return D.promise();};d.prototype._selectSystemAliasDataName=function(s,B){if(s.hasOwnProperty("https")){return"https";}if(s.hasOwnProperty("http")){return"http";}jQuery.sap.log.error("Cannot select which system alias to pick between http/https","make sure they are provided in the given system alias collection","sap.ushell.services.ClientSideTargetResolution");return undefined;};d.prototype._getRenameParameterName=function(p,s,P){if(!P||!jQuery.isArray(P)){return p;}if(s&&s.parameters&&s.parameters[p]&&s.parameters[p].renameTo){return s.parameters[p].renameTo;}return p;};d.prototype._mapParameterNamesAndRemoveObjects=function(m){var t=this,N={},o=m.intentParamsPlusAllDefaults;Object.keys(o).sort().forEach(function(p){var r=t._getRenameParameterName(p,m.inbound.signature,o[p]);if(jQuery.isArray(m.intentParamsPlusAllDefaults[p])){if(N[r]){jQuery.sap.log.error("collision of values during parameter mapping : \""+p+"\" -> \""+r+"\"");}else{N[r]=m.intentParamsPlusAllDefaults[p];}}});m.mappedIntentParamsPlusSimpleDefaults=N;};d.prototype._constructFullWDAResolutionResult=function(m,B,F){var t=this,o=jQuery.sap.getObject("inbound.resolutionResult",undefined,m),M=m.mappedIntentParamsPlusSimpleDefaults||{};var s=o.systemAlias;if(M["sap-system"]){s=M["sap-system"][0];}var e;if(M["sap-system-src"]){e=M["sap-system-src"][0];}var h={"sap-system":[s]};if(typeof e==="string"){h["sap-system-src"]=[e];}return new Promise(function(r,R){t._buildWdaURI(o["sap.wda"].applicationId,o["sap.wda"].configId,h).done(function(w){var M=m.mappedIntentParamsPlusSimpleDefaults;t._constructWDAURLParameters(M,m.mappedDefaultedParamNames).then(function(j){var k=t._appendParametersToURI(w,j);var s=M["sap-system"]&&M["sap-system"][0];var e=M["sap-system-src"]&&M["sap-system-src"][0];var p=t._createWDAResolutionResult(m.inbound,k,s,e);r(p);},function(E){R(E);});}).fail(function(E){R(E);});});};d.prototype._constructFullWebguiResolutionResult=function(m,B,F){var t=this,o=m.inbound,e=o&&o.resolutionResult,M=m.mappedIntentParamsPlusSimpleDefaults||{};var s=e.systemAlias;if(M["sap-system"]){s=M["sap-system"][0];}var h;if(M["sap-system-src"]){h=M["sap-system-src"][0];}return new Promise(function(r,R){t._buildNativeWebGuiURI(o.resolutionResult["sap.gui"].transaction,s,h).done(function(j){t._mapParameterNamesAndRemoveObjects(m);var k=t._blendParamsIntoNativeWebGUI(m.inbound,m.mappedIntentParamsPlusSimpleDefaults,j);if(k&&m.inbound&&m.inbound.resolutionResult&&m.inbound.resolutionResult["sap.platform.runtime"]){k["sap.platform.runtime"]=m.inbound.resolutionResult["sap.platform.runtime"];}k["sap-system"]=s;r(k);}).fail(R);});};d.prototype._constructWDAResolutionResult=function(m,B,F,s){var t=this,o=m.inbound,e=o&&o.resolutionResult,M=m.mappedIntentParamsPlusSimpleDefaults;var w=new U(s);var h=M["sap-system"]&&M["sap-system"][0];var j=M["sap-system-src"]&&M["sap-system-src"][0];return Promise.all([(new Promise(function(D,r){t._spliceSapSystemIntoURI(w,e.systemAlias,h,j,"WDA",e.systemAliasSemantics||O.applied).fail(r).done(D);})),t._constructWDAURLParameters(M,m.mappedDefaultedParamNames)]).then(function(r){var W=r[0];var k=r[1];var p=t._appendParametersToURI(W,k);var R=t._createWDAResolutionResult(o,p,h,j);return R;},function(E){return Promise.reject(E);});};d.prototype._createWDAResolutionResult=function(o,F,s,e){var r={"sap-system":s,url:F,text:o.title,applicationType:"NWBC"};if(typeof e==="string"){r["sap-system-src"]=e;}["additionalInformation","applicationDependencies"].forEach(function(p){if(o.resolutionResult.hasOwnProperty(p)){r[p]=o.resolutionResult[p];}});return r;};d.prototype._appendParametersToURI=function(o,s){var p=o.search();if(s){p=p+((p.indexOf("?")<0)?"?":"&")+s;}return o.search(p).toString();};d.prototype._constructWDAURLParameters=function(p,m){var t=this;return new Promise(function(r,R){var e=jQuery.extend(true,{},p);if(m.length>0){e["sap-ushell-defaultedParameterNames"]=[JSON.stringify(m)];}delete e["sap-system"];sap.ushell.Container.getService("ShellNavigation").compactParams(e,["sap-xapp-state","sap-ushell-defaultedParameterNames","sap-intent-params"],undefined,true).fail(function(E){R(E);}).done(function(E){var s=t._getURLParsing().paramsToString(E);r(s);});});};d.prototype._constructWebguiNowrapResult=function(m,B,F,s){var t=this,o=m.inbound,e=o&&o.resolutionResult;var r={};var w=new U(s);var E=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var h=E["sap-system"]&&E["sap-system"][0];var j=E["sap-system-src"]&&E["sap-system-src"][0];r["sap-system"]=h;delete E["sap-system"];if(typeof j==="string"){r["sap-system-src"]=j;delete E["sap-system-src"];}var k=t._getUnnecessaryWebguiParameters(E,o||{});this._removeObjectKey(E,k);return new Promise(function(R,p){t._spliceSapSystemIntoURI(w,e.systemAlias,h,j,"WEBGUI",r.systemAliasSemantics||O.applied).fail(p).done(function(w){var q=t._getURLParsing().paramsToString(E);var P=w.search();if(q){P=P+((P.indexOf("?")<0)?"?":"&")+q;}w.search(P);["additionalInformation","applicationDependencies"].forEach(function(v){if(o.resolutionResult.hasOwnProperty(v)){r[v]=o.resolutionResult[v];}});r.url=w.toString();r.text=o.title;r.applicationType="NWBC";R(r);});});};d.prototype._constructWebguiWrapResult=function(m,B,F,s){var t=this,o=m.inbound,e=o&&o.resolutionResult;var r={};var w=new U(s);var E=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var h=E["sap-system"]&&E["sap-system"][0];var j=E["sap-system-src"]&&E["sap-system-src"][0];r["sap-system"]=h;delete E["sap-system"];if(typeof j==="string"){r["sap-system-src"]=j;delete E["sap-system-src"];}return new Promise(function(R,k){t._spliceSapSystemIntoURI(w,e.systemAlias,h,j,"WEBGUI",e.systemAliasSemantics||O.applied).fail(k).done(function(w){var p=w.search();p=t._injectEffectiveParametersIntoWebguiPobjectParam(p,E,"&","=");w.search(p);["additionalInformation","applicationDependencies"].forEach(function(P){if(o.resolutionResult.hasOwnProperty(P)){r[P]=o.resolutionResult[P];}});r.url=w.toString();r.text=o.title;r.applicationType="NWBC";R(r);});});};d.prototype._constructWCFResolutionResult=function(m,B,F,s){var t=this,o=new U(s),e=m.inbound,h=e&&e.resolutionResult,E=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults),j,k;if(E["sap-system"]){j=E["sap-system"][0];delete E["sap-system"];}if(E["sap-system-src"]){k=E["sap-system-src"][0];delete E["sap-system-src"];}return new Promise(function(r,R){t._spliceSapSystemIntoURI(o,h.systemAlias,j,k,"WCF",h.systemAliasSemantics||O.apply).done(function(p){var P=t._getURLParsing().paramsToString(E),q=t._appendParametersToUrl(P,p.toString());var v={url:q,text:"",additionalInformation:"",applicationType:"WCF",fullWidth:true};r(v);}).fail(function(p){R(p);});});};d.prototype._injectEffectiveParametersIntoWebguiPobjectParam=function(q,p,Q,s){var e,P="P_OBJECT"+s,m=132;var h=this._getURLParsing().privparamsToString(p,"%25","%21");if(!h){return q;}var j="";this._amendGuiParam("P_OBJECT",q,Q,s,function(k){var r=k.replace(P,"");j=decodeURIComponent(r);if(j.length>0){j=j+"%25";}return P;});h=j+h;var o={pObjX:"",pObject:""};h.match(new RegExp(".{1,"+m+"}","g")).map(function(k){return encodeURIComponent(k);}).forEach(function(k,G){var r="P_OBJECT";var t="pObject";if(G>0){r="P_OBJ"+G;t="pObjX";}var v=o[t].length===0?"":Q;o[t]=o[t]+v+r+s+k;});e=[o.pObjX,o.pObject].filter(function(k){return k.length>0;}).join(Q);var A=this._amendGuiParam("P_OBJECT",q,Q,s,function(F){return e;});if(A.found){return A.query;}return q+(q.length===0?"":Q)+e;};d.prototype._amendGuiParam=function(t,q,Q,s,A){var F=false,p=t+s;var e=q.split(Q).map(function(P){if(P.indexOf(p)!==0){return P;}F=true;return A(P);}).filter(function(P){return typeof P!=="undefined";}).join(Q);return{found:F,query:e};};d.prototype._parseWebguiTransactionQueryParam=function(t){var T="^(.+?)(%20|(%20)(.+))?$",r=new RegExp(T,"i"),s,p={hasParameters:null,transactionParamName:"",transactionCode:"",parameters:[]};var P=t.split("=");if(P.length>2){return{"error":"Found more than one assignment ('=') in the transaction query parameter","details":"Only one '=' sign is expected in "+t};}if(P.length<2||typeof P[1]==="undefined"||P[1].length===0){return{"error":"The transaction query parameter must specify at least the transaction name","details":"Got "+t+" instead."};}p.transactionParamName=P[0];s=P[1];var m=s.match(r);if(!m){return{"error":"Cannot parse ~transaction query parameter value.","details":s+" should match /"+T+"/"};}p.transactionCode=m[1];if(m[2]&&m[2]!=="%20"){var e=m[4]||"";e.split("%3b").forEach(function(N){var h=N.split("%3d"),j=h[0];if(j&&typeof j==="string"&&j.length>0){p.parameters.push({name:j,value:h[1]});}});}p.hasParameters=false;if(p.parameters.length>0){p.hasParameters=true;p.transactionCode=p.transactionCode.replace(/^[*]/,"");}return p;};d.prototype._injectEffectiveParametersIntoWebguiQueryParam=function(t,p){var P=this._parseWebguiTransactionQueryParam(t);if(P.error){jQuery.sap.log.error(P.error,P.details,"sap.ushell.services.ClientSideTargetResolution");return t;}var e=P.parameters.map(function(j){return j.name.toUpperCase()+"%3d"+j.value;});var o={};Object.keys(p).forEach(function(k){o[k.toUpperCase()]=p[k];});var s=this._getURLParsing().privparamsToString(o,"%3b","%3d");if(s){e.push(s);}var h=e.length>0;return P.transactionParamName+"="+(h?"*":"")+P.transactionCode+(h?"%20":"")+e.join("%3b");};d.prototype._constructNativeWebguiWrapResult=function(m,B,F,s){var t=this,o=m.inbound,e=o&&o.resolutionResult,r={};var w=new U(s);var E=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var h=E["sap-system"]&&E["sap-system"][0];var j=E["sap-system-src"]&&E["sap-system-src"][0];r["sap-system"]=h;delete E["sap-system"];if(typeof j==="string"){r["sap-system-src"]=j;delete E["sap-system-src"];}return new Promise(function(R,k){t._spliceSapSystemIntoURI(w,e.systemAlias,h,j,"NATIVEWEBGUI",e.systemAliasSemantics||O.applied).fail(k).done(function(w){var p=w.search();var P=p.split("&").map(function(q){var v;if(q.indexOf("?%7etransaction")===0||q.indexOf("%7etransaction")===0){v=t._injectEffectiveParametersIntoWebguiPobjectParam(q,E,"%3b","%3d");return v;}return q;}).join("&");w.search(P);["additionalInformation","applicationDependencies"].forEach(function(q){if(o.resolutionResult.hasOwnProperty(q)){r[q]=o.resolutionResult[q];}});r.url=w.toString();r.text=o.title;r.applicationType="TR";R(r);});});};d.prototype._isWebguiBusinessParameter=function(N,v){var e;if(arguments.length===1){e=N.split(/[=](.+)?/);if(e.length>1){return this._isWebguiBusinessParameter.apply(this,e);}}return!(N.indexOf("sap-")===0||N.charAt(0)==="~");};d.prototype._getWebguiNonBusinessParameters=function(p){var t=this,N;N=c.filterObject(p,function(k,v){return!t._isWebguiBusinessParameter(k,v);});return N;};d.prototype._getWebguiBusinessParameters=function(p){var B=c.filterObject(p,this._isWebguiBusinessParameter);return B;};function i(p,o){return o&&o.signature&&o.signature&&o.signature.parameters&&o.signature.parameters[p]&&o.signature.parameters[p].required===true;}d.prototype._getUnnecessaryWebguiParameters=function(e,o){var h=i("DYNP_OKCODE",o)||i("DYNP_NO1ST",o);var B=[];if(h){return[];}var j=this._getWebguiBusinessParameters(e);function k(s){return s.toUpperCase();}var N=Object.keys(j).map(k).sort();function m(A,p){if(A.length!==p.length){return false;}return A.every(function(v,q){return A[q]==p[q];});}if(m(["DYNP_NO1ST","DYNP_OKCODE"],N)||m(["DYNP_OKCODE"],N)||m(["DYNP_NO1ST"],N)){B=Object.keys(j);}return B;};d.prototype._constructNativeWebguiNowrapResult=function(m,B,F,s){var t=this,o=m.inbound,r=o&&o.resolutionResult,e={"sap-wd-run-sc":true,"sap-wd-auto-detect":true,"sap-ep-version":true,"sap-system":true,"sap-system-src":true};var w=new U(s);var E=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var h=E["sap-system"]&&E["sap-system"][0];var j=E["sap-system-src"]&&E["sap-system-src"][0];Object.keys(E).forEach(function(p){if(e[p.toLowerCase()]){delete E[p];}});return new Promise(function(R,k){t._spliceSapSystemIntoURI(w,r.systemAlias,h,j,"NATIVEWEBGUI",r.systemAliasSemantics||O.applied).fail(k).done(function(w){var r=t._blendParamsIntoNativeWebGUI(m.inbound,m.mappedIntentParamsPlusSimpleDefaults,w);R(r);});});};d.prototype._removeObjectKey=function(o,k){k.forEach(function(K){delete o[K];});};d.prototype._blendParamsIntoNativeWebGUI=function(o,m,w){var t=this,F={"sap-wd-run-sc":true,"sap-wd-auto-detect":true,"sap-ep-version":true,"sap-system":true};var r={};var e=jQuery.extend(true,{},m);var s=e["sap-system"]&&e["sap-system"][0];var h=e["sap-system-src"]&&e["sap-system-src"][0];r["sap-system"]=s;if(typeof h==="string"){r["sap-system-src"]=h;}Object.keys(e).forEach(function(q){if(F[q.toLowerCase()]){delete e[q];}});var j=t._getUnnecessaryWebguiParameters(e,o||{});this._removeObjectKey(e,j);var E=this._getWebguiNonBusinessParameters(e);this._removeObjectKey(e,Object.keys(E));var p=w.search();var P=p.split("&").map(function(q){var N;if(!t._isWebguiBusinessParameter(q)){if(q.indexOf("=")>=0){N=q.split("=");if(!E.hasOwnProperty(N[0])){E[N[0]]=N[1];}}else{jQuery.sap.log.error("Found no '=' separator of Webgui non-business parameter. Parameter will be skipped.","'"+q+"'","sap.ushell.services.ClientSideTargetResolution");}return undefined;}var v;if(q.indexOf("?%7etransaction")===0||q.indexOf("%7etransaction")===0){v=t._injectEffectiveParametersIntoWebguiQueryParam(q,e,"%3b","%3d");return v;}return q;}).filter(function(q){return typeof q!=="undefined";}).join("&");var k=t._getURLParsing().paramsToString(E);P=[P,k.replace("~","%7e")].join("&");w.search(P);["additionalInformation","applicationDependencies","sap.platform.runtime"].forEach(function(q){if(o.resolutionResult.hasOwnProperty(q)){r[q]=o.resolutionResult[q];}});r.url=w.toString();r.text=o.title;r.applicationType="TR";return r;};d.prototype._constructSAPUI5ResolutionResult=function(m,B,F,s){var o=m.inbound,e,h,j,E,r={};["applicationType","additionalInformation","applicationDependencies"].forEach(function(p){if(o.resolutionResult.hasOwnProperty(p)){r[p]=o.resolutionResult[p];}});r.url=s;if(r.applicationDependencies&&typeof r.url==="undefined"){r.url="";}if(typeof r.url==="undefined"){return Promise.reject("Cannot resolve intent: url was not specified in matched inbound");}E=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);r.reservedParameters={};var R={"sap-ui-fl-max-layer":true,"sap-ui-fl-control-variant-id":true};Object.keys(R).forEach(function(N){var v=E[N];if(v){delete E[N];r.reservedParameters[N]=v;}});m.mappedDefaultedParamNames=m.mappedDefaultedParamNames.filter(function(D){return!R[D];});if(m.mappedDefaultedParamNames.length>0){E["sap-ushell-defaultedParameterNames"]=[JSON.stringify(m.mappedDefaultedParamNames)];}h=E["sap-system"]&&E["sap-system"][0];j=E["sap-system-src"]&&E["sap-system-src"][0];r["sap-system"]=h;if(typeof j==="string"){r["sap-system-src"]=j;}m.effectiveParameters=E;e=this._getURLParsing().paramsToString(E);if(e){r.url=s+((s.indexOf("?")<0)?"?":"&")+e;}if(typeof o.resolutionResult.ui5ComponentName!=="undefined"){r.ui5ComponentName=o.resolutionResult.ui5ComponentName;}r.text=o.title;return Promise.resolve(r);};d.prototype._isAbsoluteURI=function(o){return(o.protocol()||"").length>0;};d.prototype._absoluteUrlDefinedByUser=function(o,s,e){if(!e||e===O.applied){return this._isAbsoluteURI(o)&&!s;}if(e===O.apply){return this._isAbsoluteURI(o);}throw new Error("Invalid system alias semantics: '"+e+"'");};d.prototype._constructURLResolutionResult=function(m,B,F,s){var t=this,o=m.inbound,e=o&&o.resolutionResult,r={};var h=new U(s);var E=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);if(m.inbound&&m.inbound.action==="launchURL"&&m.inbound.semanticObject==="Shell"){delete E["sap-external-url"];}var j=E["sap-system"]&&E["sap-system"][0];var k=E["sap-system-src"]&&E["sap-system-src"][0];r["sap-system"]=j;delete E["sap-system"];if(typeof k==="string"){r["sap-system-src"]=k;delete E["sap-system-src"];}return(new Promise(function(R,p){if(t._absoluteUrlDefinedByUser(h,e.systemAlias,e.systemAliasSemantics)){R(s);}else{t._spliceSapSystemIntoURI(h,e.systemAlias,j,k,"URL",e.systemAliasSemantics||O.applied).fail(p).done(function(q){var v=q.toString();R(v);});}})).then(function(p){var P=t._getURLParsing().paramsToString(E);return t._appendParametersToUrl(P,p);},Promise.reject.bind(Promise)).then(function(p){["additionalInformation","applicationDependencies"].forEach(function(P){if(o.resolutionResult.hasOwnProperty(P)){r[P]=o.resolutionResult[P];}});r.url=p;r.text=o.title;r.applicationType="URL";return Promise.resolve(r);},Promise.reject.bind(Promise));};d.prototype._appendParametersToUrl=function(p,s){var e,F;if(p){var h=s.match(/#.*/);if(h){F=h;e=s.replace(h,"");}else{e=s;F="";}s=e+((s.indexOf("?")<0)?"?":"&")+p+F;}return s;};d.prototype._constructFallbackResolutionResult=function(m,B,F){var e={},D;Object.keys(m.intentParamsPlusAllDefaults).forEach(function(p){if(jQuery.isArray(m.intentParamsPlusAllDefaults[p])){e[p]=m.intentParamsPlusAllDefaults[p];}});D=m.mappedDefaultedParamNames||m.defaultedParamNames;if(D.length>0){e["sap-ushell-defaultedParameterNames"]=[JSON.stringify(D)];}if(typeof B!=="function"){jQuery.sap.log.error("Cannot resolve hash fragment",F+" has matched an inbound that cannot be resolved client side"+" and no resolveHashFragmentFallback method was implemented in ClientSideTargetResolutionAdapter","sap.ushell.services.ClientSideTargetResolution");return Promise.reject("Cannot resolve hash fragment: no fallback provided.");}jQuery.sap.log.warning("Cannot resolve hash fragment client side",F+" has matched an inbound that cannot be resolved client side. Using fallback logic","sap.ushell.services.ClientSideTargetResolution");return new Promise(function(r,R){B(F,jQuery.extend(true,{},m.inbound),e).done(function(o){var h={};["applicationType","additionalInformation","url","applicationDependencies","text"].forEach(function(p){if(o.hasOwnProperty(p)){h[p]=o[p];}});r(h);}).fail(R.bind(null));});};d.prototype.getDistinctSemanticObjects=function(){var D=new jQuery.Deferred();this._oInboundProvider.getInbounds().then(function(o){var s={};o.getAllInbounds().forEach(function(e){if(typeof e.semanticObject==="string"&&e.semanticObject!=="*"&&!e.hideIntentLink&&e.semanticObject.length>0){s[e.semanticObject]=true;}});D.resolve(Object.keys(s).sort());},function(){D.reject.apply(D,arguments);});return D.promise();};d.prototype.getLinks=function(A){var N,t=this,s,p,e,D=new jQuery.Deferred(),o;if(arguments.length===1&&jQuery.isPlainObject(arguments[0])){N=arguments[0];o=jQuery.extend(true,{},N);["action","semanticObject"].forEach(function(h){if(N.hasOwnProperty(h)){o[h]=N[h];}});if(o.appStateKey){o.params=o.params||{};o.params["sap-xapp-state"]=[o.appStateKey];delete o.appStateKey;}}else if(arguments.length<=3){jQuery.sap.log.warning("Passing positional arguments to getLinks is deprecated","Please use nominal arguments instead","sap.ushell.services.ClientSideTargetResolution");s=arguments[0];p=arguments[1];e=arguments[2];o={semanticObject:s,params:p,ignoreFormFactor:e};}else{return D.reject("invalid arguments for getLinks").promise();}this._oInboundProvider.getInbounds().then(function(h){t._getLinks(o,h).done(D.resolve.bind(D)).fail(D.reject.bind(D));},function(){D.reject.apply(D,arguments);});return D.promise();};d.prototype._validateGetSemanticObjectLinksArgs=function(A){var s=A.semanticObject,e=A.action,h=!A.hasOwnProperty("action");if(typeof s!=="undefined"||h){if(typeof s!=="string"){jQuery.sap.log.error("invalid input for _getLinks","the semantic object must be a string, got "+Object.prototype.toString.call(s)+" instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}if(h&&s.match(/^\s+$/)){jQuery.sap.log.error("invalid input for _getLinks","the semantic object must be a non-empty string, got '"+s+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}if(!h&&s.length===0){jQuery.sap.log.error("invalid input for _getLinks","the semantic object must not be an empty string, got '"+s+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}}if(typeof e!=="undefined"){if(typeof e!=="string"){jQuery.sap.log.error("invalid input for _getLinks","the action must be a string, got "+Object.prototype.toString.call(e)+" instead","sap.ushell.services.ClientSideTargetResolution");return"invalid action";}if(e.length===0){jQuery.sap.log.error("invalid input for _getLinks","the action must not be an empty string, got '"+e+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid action";}}return undefined;};d.prototype._getLinks=function(A,o){var s=A.semanticObject,e=A.action,p=A.params,w=!!A.withAtLeastOneUsedParam,t=!!A.treatTechHintAsFilter,h=A.ignoreFormFactor,j=A.hasOwnProperty("sortResultsBy")?A.sortResultsBy:"intent";if(A.hasOwnProperty("sortResultOnTexts")){jQuery.sap.log.warning("the parameter 'sortResultOnTexts' was experimantal and is no longer supported","getLinks results will be sorted by '"+j+"'","sap.ushell.services.ClientsideTargetResolution");}var k={bExcludeTileInbounds:true};var E=this._validateGetSemanticObjectLinksArgs(A);if(A.tags){k.tags=A.tags;}if(E){return new jQuery.Deferred().reject(E).promise();}if(s==="*"){return jQuery.when([]);}function m(q,p){var B=q.paramsToString(p);return B?"?"+B:"";}var q=this._getURLParsing(),D=new jQuery.Deferred(),F=u.getFormFactor(),r=q.parseParameters(m(q,p)),v={semanticObject:(s===""?undefined:s),action:e,formFactor:(h?undefined:F),params:r};if(t){v.treatTechHintAsFilter=true;}this._getMatchingInbounds(v,o,k).done(function(M){var x={},R=M.map(function(z){var B=s||z.inbound.semanticObject,G="#"+B+"-"+z.inbound.action,N;if(B==="*"){return undefined;}if(z.inbound.action==="*"){return undefined;}if(z.inbound&&z.inbound.hasOwnProperty("hideIntentLink")&&z.inbound.hideIntentLink===true){return undefined;}if(!x.hasOwnProperty(G)){x[G]={matchingInbound:z.inbound,count:1};if(z.inbound.signature.additionalParameters==="ignored"){N=c.filterObjectKeys(r,function(Q){return(Q.indexOf("sap-")===0)||z.inbound.signature.parameters.hasOwnProperty(Q);},false);}else{N=r;}if(w){var J=Object.keys(N).some(function(Q){return Q.indexOf("sap-")!==0;});if(!J){x[G].hideReason="getLinks called with 'withAtLeastOneUsedParam = true', but the inbound had no business parameters defined.";return undefined;}}var K=c.inboundSignatureMeetsParameterOptions(z.inbound.signature.parameters,A.paramsOptions||[]);if(!K){x[G].hideReason="inbound signature does not meet the requested parameter filter options";return undefined;}var L={"intent":G+m(q,N),"text":z.inbound.title};if(z.inbound.icon){L.icon=z.inbound.icon;}if(z.inbound.subTitle){L.subTitle=z.inbound.subTitle;}if(z.inbound.shortTitle){L.shortTitle=z.inbound.shortTitle;}var P=jQuery.sap.getObject('inbound.signature.parameters.sap-tag.defaultValue.value',undefined,z);if(P){L.tags=[P];}return L;}else{x[G].count++;}return undefined;}).filter(function(z){return typeof z==="object";});if(j!=="priority"){R.sort(function(G,z){return G[j]<z[j]?-1:1;});}if(R.length===0){jQuery.sap.log.debug("_getLinks returned no results");}else if(jQuery.sap.log.getLevel()>=jQuery.sap.log.Level.DEBUG){if(jQuery.sap.log.getLevel()>=jQuery.sap.log.Level.TRACE){var y=[];var H=[];R.forEach(function(z){var B=z.intent.split("?")[0];if(x[B].hideReason){H.push(["-",B+"("+x[B].hideReason+")\n"," text:",z.text+"\n"," full intent:",z.intent].join(" "));}else{y.push(["-",B,x[B].count>1?"("+(x[B].count-1)+" others matched)\n":"\n","text:",z.text+"\n","full intent:",z.intent].join(" "));}});jQuery.sap.log.debug("_getLinks filtered to the following unique intents:","\n"+y.join("\n"),"sap.ushell.services.ClientSideTargetResolution");jQuery.sap.log.debug("_getLinks would have also returned the following unique intents, but something prevented this:",H.join("\n"),"sap.ushell.services.ClientSideTargetResolution");}else{jQuery.sap.log.debug("_getLinks filtered to unique intents.","Reporting histogram: \n - "+Object.keys(x).join("\n - "),"sap.ushell.services.ClientSideTargetResolution");}}D.resolve(R);}).fail(D.reject.bind(D));return D.promise();};d.prototype._getMatchingInbounds=function(s,o,e){var t=this,T,A,L,h,j,E,p,D=new jQuery.Deferred();if(e){T=e.tags;E=e.bExcludeTileInbounds;}c.whenDebugEnabled(function(){L=++t._iLogId;});l.begin(function(){function k(M){var q=M.action||(typeof M.action==="undefined"?"<any>":"<invalid-value>");var r=M.semanticObject||(typeof M.semanticObject==="undefined"?"<any>":"<invalid-value>");return t._getURLParsing().constructShellHash({semanticObject:r,action:q,params:M.params});}var m=k(s);return{logId:L,title:"Matching Intent '"+m+"' to inbounds (form factor: "+(s.formFactor||'<any>')+")",moduleName:"sap.ushell.services.ClientSideTargetResolution",stages:["STAGE1: Find matching inbounds","STAGE2: Resolve references","STAGE3: Rematch with references","STAGE4: Sort matched targets"]};});j=s.semanticObject;A=s.action;h=T?o.getSegmentByTags(T):o.getSegment(j,A);if(E){p=h.filter(function(k){return!k.tileResolutionResult||!k.tileResolutionResult.isCustomTile;});}else{p=h;}S.match(s,p,{},c.isDebugEnabled()).then(function(k){l.log(function(){return{logId:L,stage:1,prefix:"\u2718",lines:Object.keys(k.noMatchReasons||{}).map(function(q){return q+" "+k.noMatchReasons[q];})};});l.log(function(){var q=k.matchResults.map(function(M){return f.formatInbound(M.inbound);});return{logId:L,stage:1,prefix:q.length>0?"\u2705":"\u2718",lines:q.length>0?q:["No inbound was matched"]};});var m=Object.keys(k.missingReferences||[]);if(m.length===0){l.log(function(){return{logId:L,stage:2,prefix:"\u2705",line:"No need to resolve references"};});return new jQuery.Deferred().resolve({matchResults:k.matchResults,referencesToInclude:null}).promise();}l.log(function(){return{logId:L,stage:2,line:"@ Must resolve the following references:",prefix:"\u2022",lines:m};});var r=new jQuery.Deferred();sap.ushell.Container.getService("ReferenceResolver").resolveReferences(m).done(function(R){l.log(function(){return{logId:L,stage:2,line:"\u2705 resolved references with the following values:",prefix:"\u2022",lines:Object.keys(R).map(function(q){return q+": '"+R[q]+"'";})};});r.resolve({matchResults:k.matchResults,referencesToInclude:R});}).fail(function(q){l.log(function(){return{logId:L,stage:2,prefix:"\u274c",line:"Failed to resolve references: "+q};});D.resolve([]);});return r.promise();}).then(function(k){var m,M,r=k.referencesToInclude;if(!r){l.log(function(){return{logId:L,stage:3,line:"rematch was skipped (no references to resolve)",prefix:"\u2705"};});return new jQuery.Deferred().resolve(k).promise();}M=k.matchResults;m=M.map(function(q){return q.inbound;});return S.match(s,m,r,0).then(function(F){l.log(function(){var M=F.matchResults||[];if(M.length>=1){return{logId:L,stage:3,line:"The following inbounds re-matched:",lines:M.map(function(q){return f.formatInbound(q.inbound);}),prefix:"\u2705"};}return{logId:L,stage:3,line:"No inbounds re-matched",prefix:"-"};});return F;});}).then(function(F){var m=F.matchResults||[];if(m.length<=1){l.log(function(){return{logId:L,stage:4,line:"Nothing to sort"};});D.resolve(m);return;}var k=S.sortMatchingResultsDeterministic(F.matchResults||[]);l.log(function(){var q=k.map(function(M){return f.formatInbound(M.inbound||{})+(M.matchesVirtualInbound?" (virtual)":"")+"\n[ Sort Criteria ] "+"\n * 1 * sap-priority: '"+M["sap-priority"]+"'"+"\n * 2 * Sort string: '"+M.priorityString+"\n * 3 * Deterministic blob: '"+S.serializeMatchingResult(M)+"'";});return{logId:L,stage:4,line:"Sorted inbounds as follows:",lines:q,prefix:".",number:true};});D.resolve(k);});return D.promise().then(function(m){l.end(function(){return{logId:L};});return m;});};d.prototype._isIntentSupportedOne=function(s,o){var D=new jQuery.Deferred(),e=this._getURLParsing().parseShellHash(s);if(s==="#"){D.resolve(true);return D.promise();}if(e===undefined){return D.reject("Could not parse shell hash '"+s+"'").promise();}e.formFactor=u.getFormFactor();this._getMatchingInbounds(e,o,{bExcludeTileInbounds:true}).done(function(t){D.resolve(t.length>0);}).fail(function(){D.reject();});return D.promise();};d.prototype.isIntentSupported=function(e){var t=this,D=new jQuery.Deferred();this._oInboundProvider.getInbounds().then(function(o){t._isIntentSupported(e,o).done(D.resolve.bind(D)).fail(D.reject.bind(D));},function(){D.reject.apply(D,arguments);});return D.promise();};d.prototype._isIntentSupported=function(e,o){var t=this,D=new jQuery.Deferred(),s={};D.resolve();function h(j,k){s[j]={supported:k};}var r=[];e.forEach(function(j){var N=t._isIntentSupportedOne(j,o);N.fail(function(E){r.push(E);});N.done(function(k){h(j,k);});D=jQuery.when(D,N);});var R=new jQuery.Deferred();D.done(function(){R.resolve(s);}).fail(function(){R.reject("One or more input intents contain errors: "+r.join(", "));});return R.promise();};d.prototype.getUserDefaultParameterNames=function(){var t=this,D=new jQuery.Deferred();this._oInboundProvider.getInbounds().then(function(o){var r;try{r=t._getUserDefaultParameterNames(o.getAllInbounds());D.resolve(r);}catch(e){D.reject("Cannot get user default parameters from inbounds: "+e);}},function(){D.reject.apply(D,arguments);});return D.promise();};d.prototype._getUserDefaultParameterNames=function(e){var r={simple:{},extended:{}};e.forEach(function(t){var s=t.signature&&t.signature.parameters||[];Object.keys(s).forEach(function(p){var P=s[p],R,E,h,o;if(P){if(P.filter&&P.filter.format==="reference"){h=P.filter.value;}else if(P.defaultValue&&P.defaultValue.format==="reference"){h=P.defaultValue.value;}if(typeof h==="string"){o=sap.ushell.Container.getService("ReferenceResolver");R=o.extractUserDefaultReferenceName(h);if(typeof R==="string"){r.simple[R]={};}E=o.extractExtendedUserDefaultReferenceName(h);if(typeof E==="string"){r.extended[E]={};}}}});});return r;};d.prototype.getEasyAccessSystems=function(m){var r={},A,v,D;m=m||"sapMenu";if(this._oHaveEasyAccessSystemsDeferreds[m]){return this._oHaveEasyAccessSystemsDeferreds[m].promise();}this._oHaveEasyAccessSystemsDeferreds[m]=new jQuery.Deferred();D=this._oHaveEasyAccessSystemsDeferreds[m];function e(o,s,v){return o&&o.semanticObject&&o.semanticObject==="Shell"&&o.action&&v[m][o.action]&&o.deviceTypes&&s!==undefined&&o.deviceTypes[s];}A={startGUI:{priority:3,appType:"TR"},startWDA:{priority:2,appType:"WDA"},startURL:{priority:1,appType:"URL"}};v={userMenu:{startGUI:true,startWDA:true,startURL:true},sapMenu:{startGUI:true,startWDA:true,startURL:false}};this._oInboundProvider.getInbounds().then(function(o){var L={};o.getAllInbounds().filter(function(h){return e(h,u.getFormFactor(),v);}).forEach(function(E){var s;if(jQuery.isPlainObject(E.signature.parameters["sap-system"])&&E.signature.parameters["sap-system"].hasOwnProperty("filter")){s=jQuery.sap.getObject("signature.parameters.sap-system.filter.value",undefined,E);}if(typeof s==="string"){var h=A[E.action].priority;var j=A[E.action].appType;if(!r[s]){L[s]=-1;r[s]={appType:{}};}if(L[s]<h){r[s].text=E.title;L[s]=h;}r[s].appType[j]=true;}else{jQuery.sap.log.warning("Cannot extract sap-system from easy access menu inbound: "+f.formatInbound(E),"This parameter is supposed to be a string. Got '"+s+"' instead.","sap.ushell.services.ClientSideTargetResolution");}});D.resolve(r);},function(){D.reject.apply(D,arguments);});return D.promise();};d.prototype._reportResolvedSystemAliasValidationErrors=function(v){jQuery.sap.log.error("Invalid system alias definition: "+v.debug,"ERRORS:"+v.errors.map(function(e){return"\n - "+e;}).join(""),"sap.ushell.services.ClientSideTargetResolution");};d.prototype._validateResolvedSystemAlias=function(r){function v(F){var e=[];if(typeof F.host!=="string"){e.push("host field must be a string");}if(typeof F.port!=="number"&&typeof F.port!=="string"){e.push("port field must be a number or a string");}if(typeof F.pathPrefix!=="string"){e.push("pathPrefix field must be a string");}return e;}var e=[],h=r.hasOwnProperty("https"),H=r.hasOwnProperty("http");if(!H&&!h){e.push("at least one of 'http' or 'https' fields must be defined");}if(h){v(r.https).forEach(function(E){e.push("https>"+E);});}if(H){v(r.http).forEach(function(E){e.push("http>"+E);});}if(e.length>0){return{isValid:false,errors:e,debug:JSON.stringify(r,null,3)};}return{isValid:true};};d.hasNoAdapter=false;return d;},true);
