// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/Ui5ComponentHandle","sap/ushell/services/_Ui5ComponentLoader/utils","sap/ushell/EventHub"],function(U,u,e){"use strict";function a(c,p,C){this._oConfig=(C&&C.config)||{};this._defaultBundle={name:"core-ext-light",count:4,debugName:"core-ext-light-dbg",path:"sap/fiori/"};this.createComponent=function(A,P,w){var o=A||{};var l=u.shouldLoadCoreExt(o);var b=u.shouldUseAmendedLoading(this._oConfig);var L=u.shouldLoadDefaultDependencies(o,this._oConfig,b);var d=o.applicationDependencies||{};u.logAnyApplicationDependenciesMessages(d.name,d.messages);if(!o.ui5ComponentName){return new jQuery.Deferred().resolve(A).promise();}delete o.loadCoreExt;delete o.loadDefaultDependencies;var f=this._createComponentData(o.componentData||{},o.url,o.applicationConfiguration,o.reservedParameters);var s=u.constructAppComponentId(P||{});var g=l&&b;var h=this._createComponentProperties(g,L,w,o.applicationDependencies||{},o.ui5ComponentName,o.url,s);U.onBeforeApplicationInstanceCreated.call(null,h);var D=new jQuery.Deferred();u.createUi5Component(h,f).then(function(i){var j=new U(i);o.componentHandle=j;var k=l&&(l||(b===false));if(k){o.coreResourcesFullyLoaded=k;}D.resolve(o);},function(E){var i=JSON.stringify(h,null,4);u.logInstantiateComponentError(h.name,E+"",E.status,E.stack,i);D.reject(E);});return D.promise();};this._createComponentData=function(b,s,A,t){var o=jQuery.extend(true,{startupParameters:{}},b);if(A){o.config=A;}if(t){o.technicalParameters=t;}if(u.urlHasParameters(s)){var d=u.getParameterMap(s);o.startupParameters=d.startupParameters;if(d["sap-xapp-state"]){o["sap-xapp-state"]=d["sap-xapp-state"];}}return o;};this._createComponentProperties=function(A,l,w,o,s,b,d){var f=jQuery.extend(true,{},o);if(!f.asyncHints){f.asyncHints=l?{"libs":["sap.ca.scfld.md","sap.ca.ui","sap.me","sap.ui.unified"]}:{};}if(A){f.asyncHints.preloadBundles=f.asyncHints.preloadBundles||[];var g=this._prepareBundle();f.asyncHints.preloadBundles=f.asyncHints.preloadBundles.concat(g.aResources);}if(w){f.asyncHints.waitFor=w;}if(!f.name){f.name=s;}if(b){f.url=u.removeParametersFromUrl(b);}if(d){f.id=d;}return f;};this.loadCoreResourcesComplement=function(){if(this.loadCoreResourcesComplementPromise){return this.loadCoreResourcesComplementPromise.promise();}var o=this._prepareBundle(),d=new jQuery.Deferred();this._loadBundle(o).done(function(){e.emit("CoreResourcesComplementLoaded",{status:"success"});this.loadCoreResourcesComplementPromise=d;d.resolve();}.bind(this)).fail(function(){e.emit("CoreResourcesComplementLoaded",{status:"failed"});d.reject();});return d.promise();};this._prepareBundle=function(){var b,o={name:"CoreResourcesComplement"};if(this._validateConfiguredBundle()){b=this._oConfig.coreResourcesComplement;}else{b=this._defaultBundle;}if(window["sap-ui-debug"]===true){o.aResources=[b.path+b.debugName+".js"];}else{o.aResources=this._buildBundleResourcesArray(b.name,b.path,b.count);}return o;};this._validateConfiguredBundle=function(){var i=true,o=this._oConfig.coreResourcesComplement;if(!o){return false;}if(!o.name||typeof o.name!=="string"){jQuery.sap.log.error("Ui5ComponentLoader: Configured CoreResourcesComplement Bundle has incorrect 'name' property");i=false;}if(!o.count||typeof o.count!=="number"){jQuery.sap.log.error("Ui5ComponentLoader: Configured CoreResourcesComplement Bundle has incorrect 'count' property");i=false;}if(!o.debugName||typeof o.debugName!=="string"){jQuery.sap.log.error("Ui5ComponentLoader: Configured CoreResourcesComplement Bundle has incorrect 'debugName' property");i=false;}if(!o.path||typeof o.path!=="string"){jQuery.sap.log.error("Ui5ComponentLoader: Configured CoreResourcesComplement Bundle has incorrect 'path' property");i=false;}return i;};this._buildBundleResourcesArray=function(b,P,r){var R=arguments[3]||[],s=P;if(typeof b!=="string"||typeof s!=="string"||typeof r!=="number"){jQuery.sap.log.error("Ui5ComponentLoader: _buildBundleResourcesArray called with invalid arguments");return null;}if(s.substr(-1)!=="/"){s+="/";}if(r===1){R.push(s+b+".js");}if(R.length>=r){return R;}else{R.push(s+b+"-"+R.length+".js");return this._buildBundleResourcesArray(b,s,r,R);}};this._loadBundle=function(b){if(!b||!Array.isArray(b.aResources)||!b.name){jQuery.sap.log.error("Ui5ComponentLoader: _loadBundle called with invalid arguments");return null;}var P=[],d=new jQuery.Deferred();b.aResources.forEach(function(r){P.push(jQuery.sap._loadJSResourceAsync(r));});Promise.all(P).then(function(){d.resolve();}).catch(function(){jQuery.sap.log.error("Ui5ComponentLoader: failed to load bundle: "+b.name);d.reject();});return d.promise();};e.once("loadCoreResourcesComplement").do(function(){this.loadCoreResourcesComplement();}.bind(this));}a.hasNoAdapter=true;return a;},true);
