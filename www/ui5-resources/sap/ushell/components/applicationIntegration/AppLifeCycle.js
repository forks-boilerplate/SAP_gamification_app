// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ushell/components/applicationIntegration/elements/model','sap/ushell/components/container/ApplicationContainer','sap/ushell/ui5service/ShellUIService','sap/ushell/components/applicationIntegration/application/Application','sap/ushell/components/applicationIntegration/configuration/AppMeta','sap/ushell/services/AppConfiguration','sap/ushell/utils','sap/ushell/resources','sap/ui/Device'],function(e,A,S,a,b,c,u,r,D){"use strict";function d(){var v,i,f,g,R,h,s,o={},j=false,C={},k={home:{NWBC:{headerless:"headerless",default:"minimal"},TR:{headerless:"minimal",default:"minimal"},default:{default:"home"}},app:{NWBC:{headerless:"headerless",default:"minimal"},TR:{headerless:"minimal",default:"minimal"},default:{default:"app"}}},l={home:{embedded:"embedded-home",headerless:"headerless-home",merged:"blank-home",blank:"blank-home"},app:{minimal:"minimal",app:"app",standalone:"standalone",embedded:"embedded",headerless:"headerless",merged:"merged",home:"home",blank:"blank",lean:"lean"}},m;this.calculateElementsState=function(n,p,h,q){var N=!!k[n]?k[n]:k.default,t=!!N[q?undefined:p]?N[p]:N.default,w=!!t[h]?t[h]:t.default;return w;};this.isCurrentApp=function(n){return C.appId===n?true:false;};this.isAppInCache=function(n){return!!o[n];};this.normalizeAppId=function(n){var p="-component",q=n.endsWith(p);if(q){return n.substring(0,n.length-p.length);}else{return n;}};this.onComponentCreated=function(E,n,p){var q=p.component,t=this.normalizeAppId(q.getId());if(this.isAppInCache(t)){o[t].app=q;}else{C.app=q;}};this.onAfterNavigate=function(F,n,t){var p;if(F&&n&&!this.isAppOfTypeCached(F)&&!this.applicationIsStatefulType(n.getApplicationType())){this.removeControl(F,true);n.destroy();}if(t){if(o[t]){p=o[t].app;if(p&&p.setInitialConfiguration){p.setInitialConfiguration();}}else{}}};this.storeApp=function(n,p,t){if(!this.isAppInCache(n)){o[n]={appId:n,stt:'loading',container:p,meta:c.getMetadata(t),app:undefined};return true;}return false;};this.resoterApp=function(n){if(this.isAppInCache(n)){C=o[n];}};this.isAppOfTypeCached=function(n){if(!j&&n==="application-"+R){return true;}return false;};this.openApp=function(n,t){var p;var q="application"+n;if(this.isAppOfTypeCached(q)){if(!this.isAppInCache(q)){p=this.createApplicationContainer(n,t);this.storeApp(q,p,t);}this.resoterApp(q);}else if(this.applicationIsStatefulType(t.applicationType)){p=this.getStatefulContainer(t.applicationType);if(!p){p=this.createApplicationContainer(n,t);this.setStatefulContainer(t.applicationType,p);p.setIsStateful(true);}C={appId:q,stt:'loading',container:p,meta:c.getMetadata(t),app:undefined};}else{p=this.createApplicationContainer(n,t);C={appId:q,stt:'loading',container:p,meta:c.getMetadata(t),app:undefined};}};this.getAppMeta=function(){return b;};this.init=function(n,I,p,q,t){s=new S({scopeObject:t.ownerComponent,scopeType:"component"});h=n;v=I;R=p;j=q;sap.ui.getCore().getEventBus().subscribe("sap.ushell.components.container.ApplicationContainer",'componentCreated',this.onComponentCreated,this);};this.addControl=function(n){v.addCenterViewPort(n);};this.removeControl=function(I){v.removeCenterViewPort(I,true);};this.removeApplication=function(I){var n=this.getControl(I);if(n){this.removeControl(n.getId());n.destroy();}};this.getControl=function(I){return v&&(v.getViewPortControl('centerViewPort',"application"+'-'+I)||v.getViewPortControl('centerViewPort',"applicationShellPage"+'-'+I));};this.getViewPortContainer=function(){return v;};this.navTo=function(I){v.navTo('centerViewPort',I,'show');};this.createComponent=function(n,p){return a.createComponent(n,p);};this.getAppContainer=function(n,p,I){p.shellUIService=s.getInterface();p.targetNavigationMode=I?"explace":"inplace";this.openApp(n,p);return C.container;};this.getShellUIService=function(){return s;};this.initShellUIService=function(n){s._attachHierarchyChanged(this.onHierarchyChange.bind(this));s._attachTitleChanged(this.onTitleChange.bind(this));s._attachRelatedAppsChanged(this.onRelatedAppsChange.bind(this));s._attachBackNavigationChanged(n.fnOnBackNavigationChange.bind(this));};this.parseStatefulContainerConfiguration=function(n){var p={};if(n){var q={"GUI":true};Object.keys(n).filter(function(t){return true===n[t]&&q[t];}).map(function(U){var t=U;if(t==="GUI"){t="TR";}return t;}).forEach(function(t){p[t]=null;});}m=p;};this.setStatefulApplicationContainer=function(n){m=n;};this.getStatefulApplicationContainer=function(){return m;};this.applicationIsStatefulType=function(n){return m.hasOwnProperty(n);};this.getStatefulContainer=function(n){return m[n];};this.setStatefulContainer=function(n,p){return m[n]=p;};this.statefulContainerForTypeExists=function(n){return!!this.getStatefulContainer(n);};this.getAllApplicationContainers=function(){return Object.keys(m).map(function(K){return m[K];}).filter(function(n){return!!n;});};this.getElementsModel=function(){return e;};this.activeContainer=function(n){var p=this.getAllApplicationContainers();p.forEach(function(q){jQuery.sap.log.info("Deactivating container "+q.getId());q.setActive(false);});if(n){jQuery.sap.log.info("Activating container "+n.getId());n.setActive(true);}};this.reuseApplicationContainer=function(n,p,q){var t=this;return n.setNewApplicationContext(p,q).then(function(){t.navTo(n.getId());n.toggleStyleClass("hidden",false);jQuery.sap.log.info("New application context opened successfully in an existing transaction UI session.");},function(E){jQuery.sap.log.error(E&&E.message||E);});};this.createApplicationContainer=function(n,p){return a.createApplicationContainer(n,p);};this.publishNavigationStateEvents=function(n,p,O){var q,I=n.getId?n.getId():"",t=this;var w=c.getMetadata(),x=w.icon,T=w.title;n.addEventDelegate({onAfterRendering:O});q=n.exit;n.exit=function(){if(q){q.apply(this,arguments);}t.getAppMeta()._applyContentDensityByPriority();setTimeout(function(){var E=jQuery.extend(true,{},p);delete E.componentHandle;E["appId"]=I;E["usageIcon"]=x;E["usageTitle"]=T;sap.ui.getCore().getEventBus().publish("launchpad","appClosed",E);jQuery.sap.log.info('app was closed');},0);var P=t._publicEventDataFromResolutionResult(p);sap.ushell.renderers.fiori2.utils.publishExternalEvent("appClosed",P);};};this._publicEventDataFromResolutionResult=function(n){var p={};if(!n){return n;}["applicationType","ui5ComponentName","url","additionalInformation","text"].forEach(function(P){p[P]=n[P];});Object.freeze(p);return p;};this.getIsTitleChanged=function(){return g;};this.onTitleChange=function(E){g=true;var t=E.getParameters().data,n;if(!t){t=b.getTitleDefaultValue();}n=e.getModel().getProperty("/currentState");if(n&&n.stateName==="home"){e.updateStateProperty("application/title",t,false,["home"]);}e.updateStateProperty("application/title",t,true);window.document.title=t;u.setPerformanceMark("FLP -- title change");};this.getHierarchyDefaultValue=function(){var H=[],n=e.getModel().getProperty("/currentState");if(n&&((n.stateName==="app"||n.stateName==="embedded"))){H=[{icon:"sap-icon://home",title:r.i18n.getText("actionHomePage"),intent:R?"#"+R:"#"}];}return H;};this.getIsHierarchyChanged=function(){return i;};this.onHierarchyChange=function(E){i=true;var H=E.getParameters().data,n,p=[],q;if(!H){H=[];}n=this.getHierarchyDefaultValue();H.forEach(function(I,t){p[t]=jQuery.extend({},I);});p=p.concat(n);q=e.getModel().getProperty("/currentState");if(q&&q.stateName==="home"){e.updateStateProperty("application/hierarchy",p,false,["home"]);}e.updateStateProperty("application/hierarchy",p,true);};this.getIsRelatedAppsChanged=function(){return f;};this.resetShellUIServiceHandlers=function(){f=false;i=false;g=false;};this.onRelatedAppsChange=function(E){f=true;var n=E.getParameters().data,p;if(!n){n=[];}p=e.getModel().getProperty("/currentState");if(p&&p.stateName==="home"){e.updateStateProperty("application/relatedApps",n,false,["home"]);}e.updateStateProperty("application/relatedApps",n,true);};this.handleControl=function(I,n,t,w,p){var q=this.getControl(I),x=this.statefulContainerForTypeExists(t.applicationType),M=c.getMetadata(t),L=(t.applicationType==="NWBC"||t.applicationType==="TR"),y=this.isAppOfTypeCached("application-"+I);if(!x&&q&&!y){this.removeControl(q.getId());q.destroy();q=w(I,M,t,n,t.fullWidth||M.fullWidth||L);}else if(!q){q=w(I,M,t,n,t.fullWidth||M.fullWidth||L);}else if(I===R){p();}if(!x){this.navTo(q.getId());}v.switchState("Center");u.setPerformanceMark("FLP -- centerViewPort");this.activeContainer(q);if(x){this.reuseApplicationContainer(q,t.applicationType,t.url);}};this.switchViewState=function(n,p){var q=n;if(l[n]&&l[n][h]){q=l[n][h];}var t=e.switchState(q,p);if(n==="searchResults"){this.getElementsModel().setProperty("/lastSearchScreen",'');if(!window.hasher.getHash().indexOf("Action-search")===0){var w=sap.ui.getCore().getModel("searchModel");window.hasher.setHash("Action-search&/searchTerm="+w.getProperty("/uiFilter/searchTerms")+"&dataSource="+JSON.stringify(w.getProperty("/uiFilter/dataSource").getJson()));}}sap.ui.getCore().getEventBus().publish("launchpad","shellViewStateChanged",t);};}return new d();},true);
