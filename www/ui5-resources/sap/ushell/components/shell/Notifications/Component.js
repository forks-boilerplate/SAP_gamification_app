// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ushell/resources','sap/ui/core/UIComponent','sap/ushell/components/flp/ComponentKeysHandler','sap/ushell/utils','sap/ushell/ui/shell/RightFloatingContainer','sap/ushell/EventHub'],function(r,U,C,u,R,E){"use strict";return U.extend("sap.ushell.components.shell.Notifications.Component",{metadata:{version:"1.56.5",library:"sap.ushell.components.shell.Notifications",dependencies:{libs:["sap.m"]},config:{}},createContent:function(){this.oRenderer=sap.ushell.Container.getRenderer("fiori2");this.oDefConfig={};this.bIsViewCreated=false;this.isNotificationPreviewLoaded=false;this.oNotificationsPreviewModel=undefined;var t=this;var s=h.bind(this);var f=function(N){var b=this.mBindingInfos[N],a=this.getMetadata().getJSONKeys()[N],d;jQuery.each(this[a._sGetter](),jQuery.proxy(function(i,v){this[a._sRemoveMutator](v);},this));jQuery.each(b.binding.getContexts(),jQuery.proxy(function(i,v){d=b.factory(this.getId()+"-"+i,v)?b.factory(this.getId()+"-"+i,v).setBindingContext(v,b.model):"";this[a._sMutator](d);},this));};this.oPreviewNotificationsContainerPlaceholder=new R({id:'notifications-preview-container-placeholder',visible:{path:'/enableNotificationsPreview',formatter:function(v){return t._handleNotificationsPreviewVisibility.apply(t,[v]);}}}).addStyleClass('sapUshellPreviewNotificationsConainer');this.oPreviewNotificationsContainer=new R({id:'notifications-preview-container',top:4,right:'1rem',actAsPreviewContainer:true,floatingContainerItems:{path:"/previewNotificationItems",factory:function(a,b){return sap.ui.getCore().byId(b.getObject().previewItemId);}},insertItemsWithAnimation:{path:'/animationMode',formatter:function(a){return a!=='minimal';}},visible:{path:'/enableNotificationsPreview',formatter:this._handleNotificationsPreviewVisibility.bind(this)}}).addStyleClass('sapContrastPlus').addStyleClass('sapContrast');this.oPreviewNotificationsContainer.updateAggregation=f;sap.ui.getCore().getEventBus().subscribe("sap.ushell.services.Notifications","onNewNotifications",this._handleAlerts,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell.services.Notifications","enablePreviewNotificationChanged",this._updateNotificationConfiguration,this);sap.ui.getCore().getEventBus().publish("shell","notificationsPreviewContainerCreated",{previewNotificationsContainerPlaceholder:this.oPreviewNotificationsContainerPlaceholder,previewNotificationsContainer:this.oPreviewNotificationsContainer});this.oNotificationsPreviewModel=this.oPreviewNotificationsContainer.getModel();var c=(this.getComponentData()?this.getComponentData().config:{});this.oDefConfig={view:{position:"right"},enableHeaderButton:true,enablePreview:true};var n,o;this._updateNotificationConfiguration();if(sap.ushell.Container.getService("Notifications").isEnabled()===true){sap.ushell.Container.getRenderer("fiori2").shellCtrl.getModel().setProperty("/enableNotifications",true);sap.ushell.Container.getService("Notifications").init();if(this.oRenderer.getShellConfig().enableNotificationsUI===true){sap.ushell.Container.getRenderer("fiori2").shellCtrl.getModel().setProperty("/enableNotificationsUI",true);sap.ushell.Container.getService("Notifications").registerDependencyNotificationsUpdateCallback(this.notificationsCountUpdateCallback.bind(this),true);}}this.oDefConfig=jQuery.extend(this.oDefConfig,c);n=sap.ui.getCore().byId("NotificationsCountButton");n.applySettings({icon:sap.ui.core.IconPool.getIconURI("ui-notifications"),floatingNumber:{parts:["/notificationsCount"],formatter:function(a){var j=this.getDomRef(),b="";if(j){if(a>0){b=r.i18n.getText("NotificationToggleButtonCollapsed",a);}else{b=r.i18n.getText("NotificationToggleButtonCollapsedNoNotifications");}j.setAttribute("aria-label",b);}return a;}},visible:"{/enableNotifications}",enabled:"{/enableNotifications}",selected:{path:"/currentViewPortState",formatter:function(v){if(v==='RightCenter'){return true;}return false;}},press:function(){s(this,!this.getSelected());},showSeparator:false,tooltip:r.i18n.getText("NotificationToggleButtonExpanded")},true,true).removeStyleClass("sapUshellPlaceHolders");o=n.onAfterRendering;n.onAfterRendering=function(){if(o){o.apply(this,arguments);}jQuery(this.getDomRef()).attr("aria-pressed",t.oRenderer.getNotificationsSelected());if(this.getDisplayFloatingNumber()>0){jQuery(this.getDomRef()).attr("aria-label",r.i18n.getText("NotificationToggleButtonCollapsed",this.getDisplayFloatingNumber()));}else{jQuery(this.getDomRef()).attr("aria-label",r.i18n.getText("NotificationToggleButtonCollapsedNoNotifications"));}};n.addEventDelegate({onsapskipforward:function(e){t.oRenderer.AccessKeysHandler.bForwardNavigation=true;e.preventDefault();jQuery("#sapUshellHeaderAccessibilityHelper").focus();},onsaptabnext:function(e){t.oRenderer.AccessKeysHandler.bForwardNavigation=true;e.preventDefault();jQuery("#sapUshellHeaderAccessibilityHelper").focus();},onsapskipback:function(e){if(t.oRenderer.AccessKeysHandler.getAppKeysHandler()){e.preventDefault();t.oRenderer.AccessKeysHandler.bFocusOnShell=false;}}});this.oRenderer.addShellDanglingControl(n);if(sap.ushell.Container.getRenderer("fiori2").oShellModel.getModel().getProperty("/enableNotificationsUI")===true){sap.ushell.Container.getRenderer("fiori2").oShellModel.addHeaderEndItem(["NotificationsCountButton"],false,["home","app","minimal"],true);}if(sap.ui.Device.media.getCurrentRange(sap.ui.Device.media.RANGESETS.SAP_STANDARD).name==="Phone"){sap.ushell.Container.getRenderer("fiori2").getShellController().handleEndItemsOverflow({name:'Phone',showOverFlowBtn:true});}E.on('showNotifications').do(function(v){s(n,v);});sap.ui.getCore().getEventBus().publish("shell","notificationsCompLoaded",{delay:3000});},_notificationsUpdateCallback:function(){var t=this,a=5,T=0,b=this.oNotificationsPreviewModel.getProperty("/previewNotificationItems"),n=[],N=[],c,d,e,f,g,i,o,j=false,m=a-b.length-1;sap.ushell.Container.getService("Notifications").getNotifications().done(function(k){if(!k){return;}var l=sap.ui.getCore().byId("notifications-preview-container"),v;if(!this.isNotificationPreviewLoaded){l.setEnableBounceAnimations(true);}if(b&&b.length){for(g=0;g<b.length;g++){var O=b[g].originalItemId,p=false;for(i=0;i<k.length;i++){if(k[i].Id===O){p=true;break;}if(b[g].originalTimestamp>k[i].CreatedAt){break;}}if(!p){b.splice(g,1);j=true;g--;}}}if(b&&b.length>0){c=b[0].originalTimestamp;d=sap.ushell.Container.getService("Notifications")._formatAsDate(c);}for(g=0;(g<k.length)&&(T<a);g++){e=k[g].CreatedAt;f=sap.ushell.Container.getService("Notifications")._formatAsDate(e);if((d?f>d:true)){n[T]=k[g];T++;}}var q=n.length;if(b&&b.length>0&&b.length<a&&k.length>b.length){c=b[b.length-1].originalTimestamp;d=sap.ushell.Container.getService("Notifications")._formatAsDate(c);T=0;for(g=0;(g<k.length)&&(T<=m);g++){e=k[g].CreatedAt;f=sap.ushell.Container.getService("Notifications")._formatAsDate(e);if(f<d){n[q+T]=k[g];T++;}}}if(n.length===0&&!j){this._disableNotificationPreviewBouncingAnimation(l);return;}for(i=0;i<n.length;i++){o=new sap.m.NotificationListItem({hideShowMoreButton:true,title:n[i].SensitiveText?n[i].SensitiveText:n[i].Text,description:n[i].SubTitle,datetime:u.formatDate(n[i].CreatedAt),priority:sap.ui.core.Priority[n[i].Priority.charAt(0)+n[i].Priority.substr(1).toLowerCase()],press:function(s){var w=this.getBindingContext().getPath(),P=w.split("/"),x="/"+P[1]+"/"+P[2],y=this.getModel().getProperty(x),S=y.NavigationTargetObject,A=y.NavigationTargetAction,z=y.NavigationTargetParams,B=y.originalItemId,D=sap.ushell.Container.getService("Notifications");u.toExternalWithParameters(S,A,z);var F=D.markRead(B);F.fail(function(){sap.ushell.Container.getService('Message').error(r.i18n.getText('notificationsFailedMarkRead'));});},close:function(s){var w=this.getBindingContext().getPath(),P=w.split("/"),x="/"+P[1]+"/"+P[2],y=this.getModel().getProperty(x),z=y.originalItemId,b=t.oNotificationsPreviewModel.getProperty("/previewNotificationItems"),A=sap.ushell.Container.getService("Notifications"),B=A.dismissNotification(z);B.done(function(){var i;for(i=0;i<b.length;i++){if(b[i].originalItemId===z){break;}}b.splice(i,1);t.oNotificationsPreviewModel.setProperty("/previewNotificationItems",b);});B.fail(function(){sap.ushell.Container.getService('Message').error(r.i18n.getText('notificationsFailedDismiss'));t.oNotificationsPreviewModel.setProperty("/previewNotificationItems",b);});}}).addStyleClass("sapUshellNotificationsListItem");N.push({previewItemId:o.getId(),originalItemId:n[i].Id,originalTimestamp:n[i].CreatedAt,NavigationTargetObject:n[i].NavigationTargetObject,NavigationTargetAction:n[i].NavigationTargetAction,NavigationTargetParams:n[i].NavigationTargetParams});v=sap.ui.getCore().byId('viewPortContainer');if(v.getCurrentState()==="RightCenter"){o.addStyleClass("sapUshellRightFloatingContainerItemBounceOut");}}if(b.length===0){t.oNotificationsPreviewModel.setProperty("/previewNotificationItems",N);this._disableNotificationPreviewBouncingAnimation(l);return;}for(g=N.length-1;g>-1;g--){if(b.length>=a){setTimeout(function(){b.pop();t.oNotificationsPreviewModel.setProperty("/previewNotificationItems",b);},1000);}if(N[g].originalTimestamp>b[0].originalTimestamp){b.unshift(N[g]);}else{b.push(N[g]);}}t.oNotificationsPreviewModel.setProperty("/previewNotificationItems",b);this._disableNotificationPreviewBouncingAnimation(l);}.bind(this)).fail(function(){});},_disableNotificationPreviewBouncingAnimation:function(n){if(!this.isNotificationPreviewLoaded){this.isNotificationPreviewLoaded=true;n.setEnableBounceAnimations(false);}},_handleNotificationsPreviewVisibility:function(e){var c=this.oRenderer.getCurrentViewportState(),i=c==='Center',n=sap.ushell.Container.getService('Notifications');sap.ui.getCore().getEventBus().publish("shell","setPlaceForNotificationsPreview",{EnableNotificationsPreview:e});e=e&&i;if(e){if(!this.bNotificationsRegistered){n.registerNotificationsUpdateCallback(this._notificationsUpdateCallback.bind(this));this.bNotificationsRegistered=true;}if(n.isFirstDataLoaded()){setTimeout(function(){if(this.oController&&this.oController._notificationsUpdateCallback){this.oController._notificationsUpdateCallback();}}.bind(this),300);}if(!this.bSubscribedToViewportStateSwitch){this.bHeadsupNotificationsInitialyVisible=this.oRenderer.getRightFloatingContainerVisibility();sap.ui.getCore().getEventBus().subscribe("launchpad","afterSwitchState",this._handleViewportStateSwitch,this);this.bSubscribedToViewportStateSwitch=true;}this._handleHeadsupNotificationsPresentation(c);}return e;},_handleViewportStateSwitch:function(c,e,d){var s=d.getParameter('to');if(s=='Center'){var n=sap.ui.getCore().byId("notifications-preview-container");if(n&&n.setFloatingContainerItemsVisiblity){n.setFloatingContainerItemsVisiblity(true);}}},_handleHeadsupNotificationsPresentation:function(c){var i=c==='Center',p=this.oPreviewNotificationsContainer.getDomRef(),H=p&&p.getBoundingClientRect(),P=H?H.bottom<0:false,s=i?P:this.bHeadsupNotificationsInitialyVisible;this.oRenderer.showRightFloatingContainer(s);},_handleAlerts:function(c,e,n){var N;if(this.oRenderer.getViewPortContainerCurrentState()!=='RightCenter'){for(N=0;N<n.length;N++){this.handleNotification(n[N]);}}},handleNotification:function(n){var a=this.oRenderer.addRightFloatingContainerItem({press:function(e){var v=sap.ui.getCore().byId('viewPortContainer');if(window.hasher.getHash()===n.NavigationTargetObject+"-"+n.NavigationTargetAction){v.switchState("Center");}else{u.toExternalWithParameters(n.NavigationTargetObject,n.NavigationTargetAction,n.NavigationTargetParams);}sap.ushell.Container.getService("Notifications").markRead(n.Id);},datetime:r.i18n.getText("notification_arrival_time_now"),title:n.SensitiveText?n.SensitiveText:n.Text,description:n.SubTitle,unread:n.IsRead,priority:"High",hideShowMoreButton:true},true,true);setTimeout(function(){this.oRenderer.removeRightFloatingContainerItem(a.getId(),true);},3500);},notificationsCountUpdateCallback:function(d){var t=this,v=this.oRenderer.getViewPortContainerCurrentState(),i=v==="RightCenter"?true:false;if((d===undefined)||(!i)){this._updateBadge();}else{d.done(function(){t._updateBadge();});}},_updateBadge:function(){var n;sap.ushell.Container.getService("Notifications").getUnseenNotificationsCount().done(function(N){n=parseInt(N,10);sap.ushell.Container.getRenderer("fiori2").oShellModel.getModel().setProperty('/notificationsCount',n);}).fail(function(d){jQuery.sap.log.error("Shell.controller - call to notificationsService.getCount failed: ",d,"sap.ushell.renderers.lean.Shell");});},_switchToNotificationView:function(s){this.oRenderer.ViewPortContainerNavTo('rightViewPort',"notificationsView",'show');this.oRenderer.switchViewPortStateByControl(s,"RightCenter");sap.ui.getCore().getEventBus().publish("launchpad","notificationViewOpened");},_switchToNotificationViewWithPreview:function(n,a,s){if(a==='minimal'){this._switchToNotificationView(s);}else{var i=n.getFloatingContainerItems().length;setTimeout(function(){this._switchToNotificationView(s);}.bind(this),300+(i*100));}},_updateNotificationConfiguration:function(c,e,d){var o=this.oRenderer.getModelConfiguration(),D=sap.ui.Device,b=o.enableNotificationsUI,n=sap.ushell.Container.getService("Notifications").isEnabled(),N=o.appState!=="embedded"&&o.appState!=="headerless"&&o.appState!=="merged"&&o.appState!=="standalone",D=sap.ui.Device,a=true,p=true,f,g=D.system.desktop||sap.ui.Device.system.tablet||sap.ui.Device.system.combi,P={};if(n===true){f=sap.ushell.Container.getService("Notifications").getUserSettingsFlags();f.done(function(i){a=i.previewNotificationEnabled;P.bUserEnableNotificationsPreview=a;P.bConfigEnableNotificationsPreview=p;P.bMainFlagExists=false;if(p&&b&&n&&g&&N){P.bMainFlagExists=true;P.bEnableNotificationsPreview=a;}sap.ui.getCore().getEventBus().publish("shell","changeNotificationPreview",P);});}},exit:function(){sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.services.Notifications","onNewNotifications",this._handleAlerts,this);sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.services.Notifications","enablePreviewNotificationChanged",this._updateNotificationConfiguration,this);if(this.bSubscribedToViewportStateSwitch){sap.ui.getCore().getEventBus().unsubscribe("launchpad","afterSwitchState",this._handleViewportStateSwitch,this);this.bSubscribedToViewportStateSwitch=false;}if(sap.ushell.Container){if(sap.ushell.Container.getService("Notifications").isEnabled()===true){sap.ushell.Container.getService("Notifications").destroy();}}this.oPreviewNotificationsContainerPlaceholder.destroy();this.oPreviewNotificationsContainer.destroy();}});function h(s,S){S=!!S;if(s.getSelected()===S){return;}var n,N=sap.ui.getCore().byId("notifications-preview-container"),a=sap.ushell.Container.getRenderer("fiori2").oShellModel.getModel().getProperty('/animationMode')||'full';if(this.oDefConfig.view&&this.bIsViewCreated==false){n=sap.ui.view("notificationsView",{viewName:"sap.ushell.components.shell.Notifications.Notifications",type:'JS',viewData:{}});this.bIsViewCreated=true;if(this.oDefConfig.view.position==="right"){this.oRenderer.addRightViewPort(n);}else{this.oRenderer.addLeftViewPort(n);}}E.emit('showMeArea',false);this.oRenderer.setNotificationsSelected(s.getSelected());if(this.oRenderer.getNotificationsSelected()===true){this.oRenderer.switchViewPortStateByControl(s,"Center");}else{sap.ushell.Container.getRenderer("fiori2").oShellModel.getModel().setProperty("/notificationsCount",0);if(N){N.setFloatingContainerItemsVisiblity(false);this._switchToNotificationViewWithPreview(N,a,s);}else{this._switchToNotificationView(s);}}this.oRenderer.setNotificationsSelected(!this.oRenderer.getNotificationsSelected());s.setSelected(this.oRenderer.getNotificationsSelected());sap.ushell.Container.getService("Notifications").notificationsSeen();sap.ushell.Container.getRenderer("fiori2").oShellModel.getModel().setProperty("/notificationsCount",0);jQuery(s.getDomRef()).attr("aria-pressed",this.oRenderer.getNotificationsSelected());jQuery(s.getDomRef()).attr("aria-label",r.i18n.getText("NotificationToggleButtonCollapsedNoNotifications"));}});
