// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['./DashboardGroupsBox','sap/ushell/resources','sap/ushell/ui/launchpad/AnchorItem','sap/ushell/EventHub'],function(D,r,A,e){"use strict";sap.ui.jsview("sap.ushell.components.flp.launchpad.dashboard.DashboardContent",{createContent:function(c){window["alon-view"]=this;var d,v=sap.ui.getCore().byId("viewPortContainer"),C,o=sap.ushell.components.flp.launchpad.getDashboardManager?sap.ushell.components.flp.launchpad.getDashboardManager():undefined;this.isTouch=sap.ui.Device.system.combi?false:(sap.ui.Device.system.phone||sap.ui.Device.system.tablet);this.isCombi=sap.ui.Device.system.combi;this.parentComponent=sap.ui.core.Component.getOwnerComponentFor(this);this.oModel=this.parentComponent.getModel();this.addStyleClass("sapUshellDashboardView");this.ieHtml5DnD=this.oModel.getProperty("/personalization")&&o&&o.isIeHtml5DnD();this.isContentWasRendered=false;sap.ui.getCore().getEventBus().subscribe("launchpad","contentRendered",this._handleContentRendered,this);sap.ui.getCore().getEventBus().subscribe("launchpad","initialConfigurationSet",this._onAfterDashboardShow,this);sap.ui.getCore().getEventBus().subscribe("launchpad",'actionModeInactive',this._handleEditModeChange,this);sap.ui.getCore().getEventBus().subscribe("launchpad",'actionModeActive',this._handleEditModeChange,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell.services.Notifications","enablePreviewNotificationChanged",this._enablePreviewNotificationChanged,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell","coreResourcesFullyLoaded",this._enableAnchorBarOverflowAndCreateFooter,this);sap.ui.getCore().getEventBus().subscribe("shell","notificationsPreviewContainerCreated",this._notificationsPreviewContainerCreated,this);sap.ui.getCore().getEventBus().subscribe("shell","setPlaceForNotificationsPreview",this._setPlaceForNotificationsPreview,this);sap.ui.getCore().byId('navContainerFlp').attachAfterNavigate(this.onAfterNavigate,this);this.addEventDelegate({onBeforeFirstShow:function(){var o=sap.ushell.components.flp.launchpad.getDashboardManager();o.loadPersonalizedGroups();this.onAfterNavigate();}.bind(this),onAfterShow:function(){this.getController()._addBottomSpace();this.getController()._updateShellHeader();this._onAfterDashboardShow();}.bind(this),onAfterHide:function(a){}});this.oAnchorNavigationBar=this._getAnchorNavigationBar(c);d=new D();this.oDashboardGroupsBox=d.createGroupsBox(c,this.oModel);C=this._previewNotificationEnabled();if(v){v.shiftCenterTransitionEnabled(C);}this.oFilterSelectedGroup=new sap.ui.model.Filter("isGroupSelected",sap.ui.model.FilterOperator.EQ,true);this.oFooter=new sap.m.Bar('sapUshellDashboardFooter',{visible:{parts:['/tileActionModeActive','/viewPortState'],formatter:function(a,s){return a&&s==='Center';}},contentRight:[new sap.m.ToolbarSpacer()]});this.oPage=new sap.m.Page('sapUshellDashboardPage',{customHeader:this.oAnchorNavigationBar,floatingFooter:true,footer:this.oFooter,content:[this.oDashboardGroupsBox]});var O=this.oPage.onAfterRendering;this.oPage.onAfterRendering=function(){if(O){O.apply(this,arguments);}var a=this.getDomRef(),s=a.getElementsByTagName('section');jQuery(s[0]).off("scrollstop",c.handleDashboardScroll);jQuery(s[0]).on("scrollstop",c.handleDashboardScroll);};if(!!jQuery.sap.isDeclared('sap.fiori.core-ext-light',true)){this._enableAnchorBarOverflowAndCreateFooter();}this.oNotificationsContainer=new sap.m.FlexBox({displayInline:true,fitContainer:true,items:[]});this.oViewContainer=new sap.m.FlexBox({fitContainer:true,alignItems:sap.m.FlexAlignItems.Stretch,renderType:sap.m.FlexRendertype.Bare,height:'100%',items:[this.oPage,this.oNotificationsContainer]});return this.oViewContainer;},_notificationsPreviewContainerCreated:function(c,E,d){this.oNotificationsContainer.addItem(d.previewNotificationsContainerPlaceholder);this.oNotificationsContainer.addItem(d.previewNotificationsContainer);},_setPlaceForNotificationsPreview:function(c,E,d){this.oDashboardGroupsBox.toggleStyleClass('sapUshellDashboardGroupsContainerSqueezed',d.EnableNotificationsPreview);this.oAnchorNavigationBar.toggleStyleClass('sapUshellAnchorNavigationBarSqueezed',d.EnableNotificationsPreview);},_fOnAfterAnchorBarRenderingHandler:function(E){var x=this.getModel()&&this.getModel().getProperty('/enableHelp');if(this.getDefaultGroup()){if(x){this.addStyleClass("help-id-homeAnchorNavigationBarItem");}}else{if(x){this.addStyleClass("help-id-anchorNavigationBarItem");}}},_getAnchorItemTemplate:function(){var a=new A({index:"{index}",title:"{title}",groupId:"{groupId}",defaultGroup:"{isDefaultGroup}",selected:false,isGroupRendered:"{isRendered}",visible:{parts:["/tileActionModeActive","isGroupVisible","visibilityModes"],formatter:function(t,i,v){if(!v[t?1:0]){return false;}return i||t;}},locked:"{isGroupLocked}",isGroupDisabled:{parts:['isGroupLocked','/isInDrag','/homePageGroupDisplay'],formatter:function(i,I,s){return i&&I&&s==='tabs';}},afterRendering:this._fOnAfterAnchorBarRenderingHandler});return a;},_getAnchorNavigationBar:function(c){var a=this._getAnchorItemTemplate(),o=new sap.ushell.ui.launchpad.AnchorNavigationBar("anchorNavigationBar",{selectedItemIndex:"{/topGroupInViewPortIndex}",itemPress:[function(E){this._handleAnchorItemPress(E);},c],groups:{path:"/groups",template:a},overflowEnabled:false});o=this._extendAnchorNavigationBar(o);o.addStyleClass("sapContrastPlus");a.attachBrowserEvent("focus",function(){o.setNavigationBarItemsVisibility();});return o;},_extendAnchorNavigationBar:function(a){var E=jQuery.extend(a,{onsapskipforward:function(o){o.preventDefault();sap.ushell.renderers.fiori2.AccessKeysHandler.setIsFocusHandledByAnotherHandler(true);sap.ushell.components.flp.ComponentKeysHandler.goToTileContainer(o,this.bGroupWasPressed);this.bGroupWasPressed=false;},onsaptabnext:function(o){o.preventDefault();var j=jQuery(":focus");if(!j.parent().parent().siblings().hasClass("sapUshellAnchorItemOverFlow")||(j.parent().parent().siblings().hasClass("sapUshellAnchorItemOverFlow")&&j.parent().parent().siblings().hasClass("sapUshellShellHidden"))){sap.ushell.renderers.fiori2.AccessKeysHandler.setIsFocusHandledByAnotherHandler(true);sap.ushell.components.flp.ComponentKeysHandler.goToTileContainer(o);this.bGroupWasPressed=false;}else{var b=jQuery(".sapUshellAnchorItemOverFlow button");b.focus();}},onsapskipback:function(o){o.preventDefault();sap.ushell.renderers.fiori2.AccessKeysHandler.setIsFocusHandledByAnotherHandler(true);sap.ushell.renderers.fiori2.AccessKeysHandler.sendFocusBackToShell(o);},onsaptabprevious:function(o){o.preventDefault();var j=jQuery(":focus");if(!j.parent().hasClass("sapUshellAnchorItemOverFlow")){sap.ushell.renderers.fiori2.AccessKeysHandler.setIsFocusHandledByAnotherHandler(true);sap.ushell.renderers.fiori2.AccessKeysHandler.sendFocusBackToShell(o);}else{var b=jQuery(".sapUshellAnchorItem:visible:first");if(!b.length){sap.ushell.renderers.fiori2.AccessKeysHandler.sendFocusBackToShell(o);}else{sap.ushell.components.flp.ComponentKeysHandler.goToSelectedAnchorNavigationItem();}}},onsapenter:function(o){o.srcControl.getDomRef().click();},onsapspace:function(o){o.srcControl.getDomRef().click();}});return E;},_addActionModeButtonsToDashboard:function(){if(sap.ushell.components.flp.ActionMode){sap.ushell.components.flp.ActionMode.init(this.getModel());}},_createActionModeMenuButton:function(){var t=this,a={},o={id:"ActionModeBtn",text:r.i18n.getText("activateEditMode"),icon:'sap-icon://edit',press:function(){this.oDashboardGroupsBox.getBinding("groups").filter([]);var d=this.oDashboardGroupsBox.getGroups();sap.ushell.components.flp.ActionMode.toggleActionMode(this.oModel,"Menu Item",d);this.oAnchorNavigationBar.updateVisibility();var v=sap.ui.getCore().byId('viewPortContainer');if(v.getCurrentState()!="Center"){sap.ui.getCore().byId("viewPortContainer").switchState("Center");}if(this.oModel.getProperty("/homePageGroupDisplay")){if(this.oModel.getProperty("/tileActionModeActive")){if(this.oModel.getProperty("/homePageGroupDisplay")==="tabs"){this.oDashboardGroupsBox.getBinding("groups").filter([]);var g=this.oModel.getProperty("/groups"),s;for(var i=0;i<g.length;i++){if(g[i].isGroupSelected){s=i;break;}}this.getController()._scrollToGroup("launchpad","scrollToGroup",{group:{getGroupId:function(){return g[s].groupId;}},groupChanged:false,focus:true});}else{this.oDashboardGroupsBox.getBinding("groups").filter([]);}}else{this.getController()._deactivateActionModeInTabsState();}}}.bind(this)};this.oTileActionsButton=sap.ui.getCore().byId(o.id);if(this.oTileActionsButton&&this.oTileActionsButton.data("isShellHeader")){jQuery.sap.measure.start("FLP:DashboardContent,view._createActionModeMenuButton","attach press and text to edit home page button","FLP");this.oTileActionsButton.setTooltip(o.text);this.oTileActionsButton.setText(o.text);this.oTileActionsButton.attachPress(o.press);jQuery.sap.measure.end("FLP:DashboardContent,view._createActionModeMenuButton");}else{a.controlType="sap.ushell.ui.launchpad.ActionItem";a.oControlProperties=o;a.bIsVisible=true;a.bCurrentState=true;a.controlType="sap.ushell.ui.launchpad.ActionItem";a.oControlProperties=o;a.bIsVisible=true;a.bCurrentState=true;sap.ushell.Container.getRenderer("fiori2").addUserAction(a).done(function(b){t.oTileActionsButton=b;if(t.oModel.getProperty("/enableHelp")){t.oTileActionsButton.addStyleClass('help-id-ActionModeBtn');}});}},_handleEditModeChange:function(){if(this.oTileActionsButton){this.oTileActionsButton.toggleStyleClass('sapUshellAcionItemActive');}},_enablePreviewNotificationChanged:function(c,E,d){this.oModel.setProperty("/userEnableNotificationsPreview",d.bPreviewEnabled);},_enableAnchorBarOverflowAndCreateFooter:function(c,E,d){if(this.oDoneBtn){return;}this.oAnchorNavigationBar.setOverflowEnabled(true);this.oDoneBtn=new sap.m.Button('sapUshellDashboardFooterDoneBtn',{type:sap.m.ButtonType.Emphasized,text:r.i18n.getText("closeEditMode"),tooltip:r.i18n.getText("doneBtnTooltip"),press:function(){jQuery("#sapUshellDashboardPage .sapUshellAnchorNavigationBarSqueezed").toggleClass("sapUshellAnchorBarEditMode");var a=this.oDashboardGroupsBox.getGroups();sap.ushell.components.flp.ActionMode.toggleActionMode(this.oModel,"Menu Item",a);this.oAnchorNavigationBar.updateVisibility();if(this.oModel.getProperty("/homePageGroupDisplay")&&this.oModel.getProperty("/homePageGroupDisplay")==="tabs"){this.getController()._deactivateActionModeInTabsState();}}.bind(this)});this.oDoneBtn.addEventDelegate({onsapskipforward:function(o){o.preventDefault();sap.ushell.renderers.fiori2.AccessKeysHandler.setIsFocusHandledByAnotherHandler(true);sap.ushell.renderers.fiori2.AccessKeysHandler.sendFocusBackToShell(o);},onsapskipback:function(o){o.preventDefault();sap.ushell.renderers.fiori2.AccessKeysHandler.setIsFocusHandledByAnotherHandler(true);sap.ushell.components.flp.ComponentKeysHandler.goToFirstVisibleTileContainer();},onsaptabprevious:function(o){o.preventDefault();sap.ushell.renderers.fiori2.AccessKeysHandler.setIsFocusHandledByAnotherHandler(true);sap.ushell.components.flp.ComponentKeysHandler.goToFirstVisibleTileContainer();},onsaptabnext:function(o){o.preventDefault();sap.ushell.renderers.fiori2.AccessKeysHandler.setIsFocusHandledByAnotherHandler(true);sap.ushell.renderers.fiori2.AccessKeysHandler.sendFocusBackToShell(o);}});this.oFooter.addContentRight(this.oDoneBtn);},_previewNotificationEnabled:function(){var c=this.oModel.getProperty("/configEnableNotificationsPreview"),u=this.oModel.getProperty("/userEnableNotificationsPreview");return(c&&u);},_createActionButtons:function(){var E=this.oModel.getProperty("/personalization");if(E){if(this.oModel.getProperty("/actionModeMenuButtonEnabled")){this._createActionModeMenuButton();}}},onAfterNavigate:function(E){var n=sap.ui.getCore().byId('navContainerFlp'),c=n?n.getCurrentPage().getViewName():undefined,i=c=="sap.ushell.components.flp.launchpad.dashboard.DashboardContent",R=sap.ushell.Container.getRenderer("fiori2"),a=sap.ui.getCore().byId("ActionModeBtn");if(a){if(a.data){if(a.data("isShellHeader")){a.setVisible(true);}}}if(R.toggleOverFlowActions){R.toggleOverFlowActions();}if(i){R.createExtendedShellState("dashboardExtendedShellState",function(){this._createActionButtons();if(!sap.ui.Device.system.phone){R.showRightFloatingContainer(false);}}.bind(this));this.oAnchorNavigationBar.updateVisibility();this.getController()._setCenterViewPortShift();this._addActionModeButtonsToDashboard();setTimeout(function(){if(sap.ushell.Container){R.applyExtendedShellState("dashboardExtendedShellState");}},0);if(this.oAnchorNavigationBar&&this.oAnchorNavigationBar.anchorItems){this.oAnchorNavigationBar.setNavigationBarItemsVisibility();this.oAnchorNavigationBar.adjustItemSelection(this.oAnchorNavigationBar.getSelectedItemIndex());}if(document.activeElement&&document.activeElement.tagName==="BODY"){sap.ushell.renderers.fiori2.AccessKeysHandler.sendFocusBackToShell();}}},_handleContentRendered:function(E){if(!this.isContentWasRendered){this.isContentWasRendered=true;this._onAfterDashboardShow(E);e.emit("firstSegmentCompleteLoaded",true);}else{this._onAfterDashboardShow(E);}},_focusOnDomElement:function(d){if(d){setTimeout(function(){d.focus();},0);}},_onAfterDashboardShow:function(E){if(!this.isContentWasRendered){this._focusOnDomElement(jQuery("#configBtn"));return;}var j=jQuery('.sapUshellTileContainer:visible'),n=sap.ui.getCore().byId('navContainerFlp'),c=n?n.getCurrentPage().getViewName():undefined,i=c=="sap.ushell.components.flp.launchpad.dashboard.DashboardContent",t=this.oModel.getProperty('/tileActionModeActive'),v,p;if(i){if(!t){sap.ushell.utils.handleTilesVisibility();sap.ushell.utils.refreshTiles();var T=this.oModel.getProperty('/topGroupInViewPortIndex'),a=jQuery(j[T]),b=j.find("li[class*='sapUshellTile']li[tabindex=0]"),d=a.find('.sapUshellTile:first'),f;if(b.length){f=b;}else if(d.length){f=d;}else{f=jQuery("#configBtn");}p=this.oModel.getProperty('/enableNotificationsPreview');v=sap.ui.getCore().byId("viewPortContainer");if(v){v.shiftCenterTransition(p);}this._focusOnDomElement(f);}this.onAfterNavigate();}},getControllerName:function(){return"sap.ushell.components.flp.launchpad.dashboard.DashboardContent";},_isInDeashboard:function(){var n=sap.ui.getCore().byId("viewPortContainer"),c=sap.ui.getCore().byId("dashboardGroups");return((n.getCurrentCenterPage()==="application-Shell-home")&&(c.getModel().getProperty("/currentViewName")==="home"));},exit:function(){if(this.oAnchorNavigationBar){this.oAnchorNavigationBar.handleExit();}if(this.oTileActionsButton){this.oTileActionsButton.destroy();}sap.ui.core.mvc.View.prototype.exit.apply(this,arguments);sap.ui.getCore().getEventBus().unsubscribe("launchpad","contentRendered",this._handleContentRendered,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","initialConfigurationSet",this._onAfterDashboardShow,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad",'actionModeInactive',this._handleEditModeChange,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad",'actionModeActive',this._handleEditModeChange,this);sap.ui.getCore().getEventBus().unsubscribe("sap.ushell","coreResourcesFullyLoaded",this._enableAnchorBarOverflowAndCreateFooter,this);sap.ui.getCore().getEventBus().unsubscribe("shell","notificationsPreviewContainerCreated",this._notificationsPreviewContainerCreated,this);sap.ui.getCore().getEventBus().unsubscribe("shell","setPlaceForNotificationsPreview",this._setPlaceForNotificationsPreview,this);}});},false);
