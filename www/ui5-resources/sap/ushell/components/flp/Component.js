// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ushell/components/flp/launchpad/DashboardManager','sap/ushell/resources','sap/ui/core/UIComponent','sap/ushell/components/flp/ComponentKeysHandler','sap/ushell/components/flp/CustomRouter','sap/ushell/UserActivityLog','sap/ushell/Config'],function(D,r,U,C,a,b,c){"use strict";return U.extend("sap.ushell.components.flp.Component",{metadata:{routing:{config:{viewType:"JS",controlAggregation:"pages",controlId:"navContainerFlp",clearAggregation:false,routerClass:a},targets:{appFinder:{viewName:"sap.ushell.components.flp.launchpad.appfinder.AppFinder"},home:{viewName:"sap.ushell.components.flp.launchpad.dashboard.DashboardContent"}},routes:[{name:"home",target:'home',pattern:"home"}]},version:"1.56.5",library:"sap.ushell.components.flp",dependencies:{libs:["sap.m"]},config:{semanticObject:'Shell',action:'home',title:r.i18n.getText("homeBtn_tooltip"),fullWidth:true,hideLightBackground:true}},PERS_KEY:"flp.settings.FlpSettings",parseOldCatalogParams:function(u){var p=jQuery.sap.getUriParameters(u).mParams,v,k;for(k in p){if(p.hasOwnProperty(k)){v=p[k][0];p[k]=v.indexOf('/')!==-1?encodeURIComponent(v):v;}}return p;},handleNavigationFilter:function(n){var s=sap.ushell.Container.getService("URLParsing").parseShellHash(n),p;if(s&&s.semanticObject==='shell'&&s.action==='catalog'){p=this.parseOldCatalogParams(n);setTimeout(function(){this.getRouter().navTo('appFinder',{'menu':'catalog',filters:JSON.stringify(p)});}.bind(this),0);return this.oShellNavigation.NavigationFilterStatus.Abandon;}return this.oShellNavigation.NavigationFilterStatus.Continue;},createContent:function(){this.oRouter=this.getRouter();this.oModel=new sap.ui.model.json.JSONModel({animationMode:'full',groups:[],animationRendered:false,tagFiltering:true,searchFiltering:true,catalogSelection:true,tileActionModeEnabled:false,tileActionModeActive:false,isInDrag:false,rtl:sap.ui.getCore().getConfiguration().getRTL(),personalization:true,editTitle:false,tagList:[],selectedTags:[],userPreferences:{entries:[]},enableNotificationsPreview:false,previewNotificationItems:[],viewPortState:sap.ushell.Container.getRenderer('fiori2').getCurrentViewportState(),draggedTileLinkPersonalizationSupported:true});sap.ui.getCore().getEventBus().subscribe("shell","changeNotificationPreview",this._updateNotificationPreview,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell.services.UsageAnalytics","usageAnalyticsStarted",function(){sap.ui.require(["sap/ushell/components/flp/FLPAnalytics"]);});this.oModel.setSizeLimit(10000);this.setModel(this.oModel);this.oConfig=this.getComponentData().config;this.oShellConfig=sap.ushell.renderers.fiori2.RendererExtensions.getConfiguration();sap.ui.getCore().getEventBus().subscribe('launchpad','afterSwitchState',this._handleShellViewPortSateChange,this);var n,m,h,H,s,p,o,P=(this.oConfig&&(this.oConfig.enablePersonalization||this.oConfig.enablePersonalization===undefined))&&(this.oShellConfig&&this.oShellConfig.enablePersonalization||this.oShellConfig.enablePersonalization===undefined);if(P){this.oRouter.addRoute({name:"catalog",target:'appFinder',pattern:"catalog/:filters:"});this.oRouter.addRoute({name:"appFinder",target:'appFinder',pattern:"appFinder/{menu}/:filters:"});}this.oRouter.addRoute({name:"all",target:'home',pattern:":all*:"});this._setConfigurationToModel(this.oConfig);var d={model:this.oModel,config:this.oConfig,router:this.oRouter};this.oDashboardManager=new D("dashboardMgr",d);this.setModel(r.i18nModel,"i18n");m=window.matchMedia("(min-width: 800px)");h=function(e){this.oModel.setProperty("/isPhoneWidth",!e.matches);}.bind(this);if(m.addListener){m.addListener(h);h(m);}sap.ui.getCore().getEventBus().subscribe("launchpad","togglePane",this._createAndAddGroupList,this);c.on("/core/extension/SupportTicket").do(function(e){if(e){b.activate();}else{b.deactivate();}});n=this.initNavContainer();this.setInitialConfiguration();this.oShellNavigation=sap.ushell.Container.getService("ShellNavigation");this.oShellNavigation.registerNavigationFilter(this.handleNavigationFilter.bind(this));H=hasher.getHash();s=sap.ushell.Container.getService("URLParsing").parseShellHash(H);if(s&&s.semanticObject==='shell'&&s.action==='catalog'){p=this.parseOldCatalogParams(H);o=this.getMetadata().getConfig();this.oShellNavigation.toExternal({target:{semanticObject:o.semanticObject,action:o.action}});this.getRouter().navTo('appFinder',{'menu':'catalog',filters:JSON.stringify(p)});}if(this.oConfig.enableHomePageSettings!==false){sap.ui.getCore().getEventBus().subscribe("launchpad","Settings",this._addFlpSettings,this);}return n;},_createAndAddGroupList:function(s,e,d){if(d.currentContent&&(d.currentContent.indexOf('groupList')!==-1||!d.currentContent.length)){var o=this.oConfig,g=this.runAsOwner(function(){return this.oDashboardManager.getGroupListView(o);}.bind(this));if(!g.alreadyCreated){g.groupList.setModel(this.oModel);g.groupList.setModel(r.i18nModel,"i18n");sap.ushell.renderers.fiori2.RendererExtensions.setLeftPaneContent(g.groupList,"home");}}},_setConfigurationToModel:function(o){var m=this.oModel,t,R=sap.ushell.Container.getRenderer('fiori2').getModelConfiguration();if(o){if(o.enablePersonalization!==undefined&&this.oShellConfig.enablePersonalization!==undefined){m.setProperty("/personalization",o.enablePersonalization&&this.oShellConfig.enablePersonalization);}else if(o.enablePersonalization!==undefined){m.setProperty("/personalization",o.enablePersonalization);}else if(this.oShellConfig.enablePersonalization!==undefined){m.setProperty("/personalization",this.oShellConfig.enablePersonalization);}if(o.optimizeTileLoadingThreshold!==undefined){m.setProperty("/OptimizeTileLoadingThreshold",o.optimizeTileLoadingThreshold);}if(o.segments!==undefined){m.setProperty("/segments",o.segments);}if(o.initialStateNotificationsPreview!==undefined){m.setProperty("/enableNotificationsPreview",o.initialStateNotificationsPreview);}if(o.enableLockedGroupsCompactLayout!==undefined){m.setProperty("/enableLockedGroupsCompactLayout",o.enableLockedGroupsCompactLayout);}if(o.enableCatalogSelection!==undefined){m.setProperty("/catalogSelection",o.enableCatalogSelection);}if(o.enableTilesOpacity!==undefined){m.setProperty("/tilesOpacity",o.enableTilesOpacity);}if(o.enableDragIndicator!==undefined){m.setProperty("/enableDragIndicator",o.enableDragIndicator);}t=false;if(o.enableActionModeMenuButton!==undefined){m.setProperty("/actionModeMenuButtonEnabled",o.enableActionModeMenuButton);t=o.enableActionModeMenuButton;}if(o.enableRenameLockedGroup!==undefined){m.setProperty("/enableRenameLockedGroup",o.enableRenameLockedGroup);}else{m.setProperty("/enableRenameLockedGroup",false);}if(o.appFinderDisplayMode!==undefined){m.setProperty("/appFinderDisplayMode",o.appFinderDisplayMode);}if(o.enableActionModeFloatingButton!==undefined){m.setProperty("/actionModeFloatingButtonEnabled",o.enableActionModeFloatingButton);t=t||o.enableActionModeFloatingButton;}m.setProperty("/tileActionModeEnabled",t);if(o.enableTileActionsIcon!==undefined){m.setProperty("/tileActionsIconEnabled",sap.ui.Device.system.desktop?o.enableTileActionsIcon:false);}if(o.enableHideGroups!==undefined){m.setProperty("/enableHideGroups",o.enableHideGroups);}if(o.title){m.setProperty("/title",o.title);}if(o.enableEasyAccess!=undefined&&!o.enableEasyAccess){m.setProperty("/enableEasyAccessSAPMenu",o.enableEasyAccess);m.setProperty("/enableEasyAccessUserMenu",o.enableEasyAccess);m.setProperty("/enableEasyAccessUserMenuSearch",o.enableEasyAccess);m.setProperty("/enableEasyAccessSAPMenuSearch",o.enableEasyAccess);}else{if(o.enableEasyAccessSAPMenu!==undefined){m.setProperty("/enableEasyAccessSAPMenu",o.enableEasyAccessSAPMenu);if(!o.enableEasyAccessSAPMenu){m.setProperty("/enableEasyAccessSAPMenuSearch",false);}else{if(o.enableEasyAccessSAPMenuSearch!==undefined){m.setProperty("/enableEasyAccessSAPMenuSearch",o.enableEasyAccessSAPMenuSearch);}else{m.setProperty("/enableEasyAccessSAPMenuSearch",true);}}}else{m.setProperty("/enableEasyAccessSAPMenu",o.enableEasyAccess);if(o.enableEasyAccessSAPMenuSearch!==undefined){m.setProperty("/enableEasyAccessSAPMenuSearch",o.enableEasyAccessSAPMenuSearch);}else{m.setProperty("/enableEasyAccessSAPMenuSearch",o.enableEasyAccess);}}if(o.enableEasyAccessUserMenu!==undefined){m.setProperty("/enableEasyAccessUserMenu",o.enableEasyAccessUserMenu);if(!o.enableEasyAccessUserMenu){m.setProperty("/enableEasyAccessUserMenuSearch",false);}else{if(o.enableEasyAccessUserMenuSearch!==undefined){m.setProperty("/enableEasyAccessUserMenuSearch",o.enableEasyAccessUserMenuSearch);}else{m.setProperty("/enableEasyAccessUserMenuSearch",true);}}}else{m.setProperty("/enableEasyAccessUserMenu",o.enableEasyAccess);if(o.enableEasyAccessUserMenuSearch!==undefined){m.setProperty("/enableEasyAccessUserMenuSearch",o.enableEasyAccessUserMenuSearch);}else{m.setProperty("/enableEasyAccessUserMenuSearch",o.enableEasyAccess);}}}if(o.enableSearchFiltering!==undefined){m.setProperty("/searchFiltering",o.enableSearchFiltering);}else if(o.enableCatalogSearch!==undefined){m.setProperty("/searchFiltering",o.enableCatalogSearch);}else{m.setProperty("/searchFiltering",true);}if(o.enableTagFiltering!==undefined){m.setProperty("/tagFiltering",o.enableTagFiltering);}else if(o.enableCatalogTagFilter!==undefined){m.setProperty("/tagFiltering",o.enableCatalogTagFilter);}else{m.setProperty("/tagFiltering",true);}if(o.sapMenuServiceUrl!==undefined){m.setProperty("/sapMenuServiceUrl",o.sapMenuServiceUrl);}if(o.userMenuServiceUrl!==undefined){m.setProperty("/userMenuServiceUrl",o.userMenuServiceUrl);}if(o.easyAccessNumbersOfLevels!==undefined){m.setProperty("/easyAccessNumbersOfLevels",o.easyAccessNumbersOfLevels);}var d=o.enableHomePageSettings!==false?this._getCurrentHomePageGroupDisplay():jQuery.Deferred().resolve();d.done(function(s){s=s||o.homePageGroupDisplay;if(s!==undefined){m.setProperty("/homePageGroupDisplay",s);}});m.setProperty("/enableHelp",!!this.oShellConfig.enableHelp);m.setProperty("/disableSortedLockedGroups",!!o.disableSortedLockedGroups);if(R.animationMode){m.setProperty("/animationMode",R.animationMode);}}},initNavContainer:function(o){var n=new sap.m.NavContainer({id:"navContainerFlp",defaultTransitionName:'show'});return n;},setInitialConfiguration:function(){this.oRouter.initialize();if(!sap.ui.Device.system.phone){C.init(this.oModel,this.oRouter);sap.ushell.renderers.fiori2.AccessKeysHandler.registerAppKeysHandler(C.handleFocusOnMe);var t=r.i18n,s=[];s.push({text:"Alt+H",description:t.getText("hotkeyHomePage")});if(this.oModel.getProperty("/personalization")){s.push({text:"Alt+A",description:t.getText("hotkeyAppFinder")});s.push({text:"Ctrl+Enter",description:t.getText("hotkeySaveEditing")});}sap.ushell.renderers.fiori2.AccessKeysHandler.registerAppShortcuts(C.handleShortcuts,s);}sap.ui.getCore().getEventBus().publish("launchpad","initialConfigurationSet");},_handleShellViewPortSateChange:function(n,e,E){var s=E?E.getParameter('to'):'';this.oModel.setProperty('/viewPortState',s);},_updateNotificationPreview:function(s,e,d){var p=d;this.oModel.setProperty("/userEnableNotificationsPreview",p.bUserEnableNotificationsPreview);this.oModel.setProperty("/configEnableNotificationsPreview",p.bConfigEnableNotificationsPreview);if(p.bMainFlagExists===true){this.oModel.setProperty("/enableNotificationsPreview",p.bEnableNotificationsPreview);}},_addFlpSettings:function(){if(this.bFlpSettingsAdded){return;}var R=sap.ushell.Container.getRenderer("fiori2"),o=r.i18n,t=this;var f;var e={title:o.getText('FlpSettings_entry_title'),entryHelpID:"flpSettingsEntry",value:function(){return jQuery.Deferred().resolve(" ");},content:function(){f=sap.ui.xmlview({viewName:"sap.ushell.components.flp.settings.FlpSettings",viewData:{initialDisplayMode:t.oModel.getProperty("/homePageGroupDisplay")||"scroll"}});return jQuery.Deferred().resolve(f);},onSave:function(){var d=f.getController().onSave();var g=t._getPersonalizer("homePageGroupDisplay").setPersData(d);g.fail(function(h){jQuery.sap.log.error("Failed to save the anchor bar mode in personalization",h,"sap.ushell.components.flp.settings.FlpSettings");});t.oModel.setProperty("/homePageGroupDisplay",d);setTimeout(function(){t.oDashboardManager.handleDisplayModeChange(d);},0);return jQuery.Deferred().resolve();},onCancel:function(){return jQuery.Deferred().resolve();},icon:"sap-icon://home"};R.addUserPreferencesEntry(e);this.bFlpSettingsAdded=true;},_getCurrentHomePageGroupDisplay:function(){var d=this._getPersonalizer('homePageGroupDisplay').getPersData();d.fail(function(e){jQuery.sap.log.error("Failed to load anchor bar state from the personalization",e,"sap.ushell.components.flp.settings.FlpSettings");});return d;},_getPersonalizer:function(i){var p=sap.ushell.Container.getService("Personalization");var o=sap.ui.core.Component.getOwnerComponentFor(this);var s={keyCategory:p.constants.keyCategory.FIXED_KEY,writeFrequency:p.constants.writeFrequency.LOW,clientStorageAllowed:true};var P={container:this.PERS_KEY,item:i};return p.getPersonalizer(P,s,o);},exit:function(){sap.ui.getCore().getEventBus().unsubscribe("shell","changeNotificationPreview",this._updateNotificationPreview,this);sap.ui.getCore().getEventBus().unsubscribe('launchpad','shellViewStateChanged',this._handleShellViewPortSateChange,this);this.oDashboardManager.destroy();}});});
