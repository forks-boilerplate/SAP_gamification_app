/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2018 SAP SE. All rights reserved
 */
sap.ui.define(['sap/apf/utils/proxyTextHandlerForLocalTexts','sap/apf/cloudFoundry/utils'],function(P,c){'use strict';function M(s,a){var b=a.instances.messageHandler;var d=a.manifests.manifest;var e=d["sap.app"].dataSources;var f=e&&e["apf.designTime.customer.applications"]&&e["apf.designTime.customer.applications"].uri;var g=e&&e["apf.designTime.customer.analyticalConfigurations"]&&e["apf.designTime.customer.analyticalConfigurations"].uri;var h=e&&e["apf.designTime.customer.applicationAndAnalyticalConfiguration"]&&e["apf.designTime.customer.applicationAndAnalyticalConfiguration"].uri;var t=e&&e["apf.designTime.textFileAndAnalyticalConfigurations"]&&e["apf.designTime.textFileAndAnalyticalConfigurations"].uri;var j=e&&e["apf.designTime.textFiles"]&&e["apf.designTime.textFiles"].uri;var v=e&&e["apf.designTime.vendor.importToCustomerLayer"]&&e["apf.designTime.vendor.importToCustomerLayer"].uri;var k=e&&e["apf.designTime.vendor.analyticalConfigurations"]&&e["apf.designTime.vendor.analyticalConfigurations"].uri;var p=a.instances.proxyTextHandlerForLocalTexts;function l(){return{};}function n(i){var K=JSON.parse(i.SerializedAnalyticalConfiguration);delete i.SerializedAnalyticalConfiguration;K.configHeader=i;i.SerializedAnalyticalConfiguration=JSON.stringify(K);return i;}this.create=function(i,K,L){if(i==='application'){o(K,L);}else if(i==='configuration'&&K.CreationUTCDateTime&&K.LastChangeUTCDateTime){K=n(K);var N=K.AnalyticalConfiguration;J({type:"HEAD",url:g+"/"+N,success:function(){var O=b.createMessageObject({code:"5238",aParams:[N]});L(undefined,undefined,O);},error:function(O,Q,R,S){if(O.status===404){B(K,function(U,T){L(K,U,T);});}else{var T=E(O,S,b);L(undefined,undefined,T);}}});}else if(i==='configuration'){K=n(K);q(K,L);}else if(i==='texts'){r(K,L);}else{b.check(false,'The create operation on entity set '+i+' is currently not supported by the modeler proxy.');}};function o(i,K){var L={applicationName:i.ApplicationName,textFile:{inDevelopmentLanguage:""}};var N="POST";var O=f;if(i.Application){N="PUT";O=O+'/'+i.Application;}J({type:N,url:O,data:JSON.stringify(L),dataType:"json",success:function(Q,S,R){if(N==='POST'&&Q&&!jQuery.isEmptyObject(Q)){var T={ApplicationName:i.ApplicationName,Application:Q.application};K(T,l(),undefined);}else if(N==='PUT'){var T={ApplicationName:i.ApplicationName,Application:i.Application};K(T,l(),undefined);}else{var U=c.buildErrorMessage(R,"5227",[],undefined,b);K(undefined,l(),U);}},error:function(Q,S,R,T){var U=c.buildErrorMessage(Q,"5227",[],T,b);K(undefined,l(),U);},async:true});}function q(i,K){var L=i.Application;var N={analyticalConfigurationName:i.AnalyticalConfigurationName,application:L,serializedAnalyticalConfiguration:i.SerializedAnalyticalConfiguration,textFile:{inDevelopmentLanguage:p.createTextFileOfApplication(L)}};J({type:"POST",url:g,data:JSON.stringify(N),dataType:"json",success:function(O,S,Q){if(O&&!jQuery.isEmptyObject(O)){var R={AnalyticalConfiguration:O.analyticalConfiguration,AnalyticalConfigurationName:N.analyticalConfigurationName};K(R,l(),undefined);}else{var T=c.buildErrorMessage(Q,"5226",[L],undefined,b);K(undefined,l(),T);}},error:function(O,S,Q,R){var T=c.buildErrorMessage(O,"5226",[L],R,b);K(undefined,l(),T);},async:true});}function r(i,K){var L=p.addText(i);i.TextElement=L;K(i,l());}this.readCollection=function(i,K,L,N,O){if(i==='application'){u(K);}else if(i==='configuration'){w(K,O);}else if(i==='texts'){K([],undefined);}else{b.check(false,'The read collection operation on entity set '+i+' is currently not supported by the modeler proxy.');}};function u(i){var K=f+"?$select=Application,ApplicationName";J({type:"GET",url:K,success:function(L,S,N){if(L&&!jQuery.isEmptyObject(L)){var O=[];if(L.applications!==null){L.applications.forEach(function(R){O.push({Application:R.application,ApplicationName:R.applicationName,SemanticObject:""});});}i(O,l(),undefined);}else{var Q=c.buildErrorMessage(N,"5229",[],undefined,b);i(undefined,l(),Q);}},error:function(L,S,N,O){var Q=c.buildErrorMessage(L,"5229",[],O,b);i(undefined,l(),Q);},async:true});}function w(i,K){var T=K.getFilterTermsForProperty('Application');var L=T[0].getValue();var N=t+"?$select=AnalyticalConfiguration,AnalyticalConfigurationName,SerializedAnalyticalConfiguration&$filter="+K.toUrlParam();J({type:"GET",url:N,success:function(O,S,Q){if(O&&!jQuery.isEmptyObject(O)){var R=[];if(O.analyticalConfigurations!==null){O.analyticalConfigurations.forEach(function(V){R.push({AnalyticalConfiguration:V.analyticalConfiguration,Application:L,AnalyticalConfigurationName:V.analyticalConfigurationName,SerializedAnalyticalConfiguration:V.serializedAnalyticalConfiguration});});}p.initApplicationTexts(L,O.textFile.inDevelopmentLanguage);i(R,l(),undefined);}else{var U=c.buildErrorMessage(Q,"5223",[L],undefined,b);i(undefined,l(),U);}},error:function(O,S,Q,R){var U=c.buildErrorMessage(O,"5223",[L],R,b);i(undefined,l(),U);},async:true});}this.readEntity=function(i,K,L,N,O){if(i==='configuration'){var Q=L[0].value;if(N&&N.length===2&&jQuery.inArray("CreationUTCDateTime",N)>-1&&jQuery.inArray("LastChangeUTCDateTime",N)>-1){x(Q,O,K);}else{y(Q,O,K);}}else{b.check(false,'The read single entity operation on entity set '+i+' is currently not supported by the modeler proxy.');}};function x(i,K,L){var N=g+"/"+i+"?$select=Application,CreationUtcDateTime,LastChangeUtcDateTime,ServiceInstance";J({type:"GET",url:N,success:function(O,S,Q){if(O&&!jQuery.isEmptyObject(O)){var R={CreationUTCDateTime:O.analyticalConfiguration.creationUtcDateTime,LastChangeUTCDateTime:O.analyticalConfiguration.lastChangeUtcDateTime};L(R,l());}else{var T=c.buildErrorMessage(Q,"5221",[K,i],undefined,b);L(undefined,l(),T);}},error:function(O,S,Q,R){var T=c.buildErrorMessage(O,"5221",[K,i],R,b);L(undefined,l(),T);},async:true});}function y(i,K,L){var N=g+"/"+i+"?$select=AnalyticalConfigurationName,SerializedAnalyticalConfiguration";J({type:"GET",url:N,success:function(O,S,Q){if(O&&!jQuery.isEmptyObject(O)){var R={Application:K,SerializedAnalyticalConfiguration:O.analyticalConfiguration.serializedAnalyticalConfiguration,AnalyticalConfiguration:i};L(R,l(),undefined);}else{var T=c.buildErrorMessage(Q,"5221",[K,i],undefined,b);L(undefined,l(),T);}},error:function(O,S,Q,R){var T=c.buildErrorMessage(O,"5221",[K,i],R,b);L(undefined,l(),T);},async:true});}this.update=function(i,K,L,N){if(i==='application'){var O=N[0].value;z(K,O,L);}else if(i==='configuration'&&K.CreationUTCDateTime&&K.LastChangeUTCDateTime){K=n(K);B(K,L);}else if(i==='configuration'){K=n(K);A(K,L);}else{b.check(false,'The update operation on entity set '+i+' is currently not supported by the modeler proxy.');}};function z(i,K,L){var N={applicationName:i.ApplicationName};var O=f+'/'+K;J({type:"PUT",url:O,data:JSON.stringify(N),dataType:"json",success:function(Q,S,R){L(l(),undefined);},error:function(Q,S,R,T){var U=c.buildErrorMessage(Q,"5228",[K],T,b);L(l(),U);},async:true});}function A(i,K){var L=JSON.parse(i.SerializedAnalyticalConfiguration);var N=i.AnalyticalConfiguration;var O=g+'/'+N;var Q=i.Application;L.configHeader={Application:Q,AnalyticalConfiguration:N,AnalyticalConfigurationName:i.AnalyticalConfigurationName,CreationUTCDateTime:i.CreationUTCDateTime,LastChangeUTCDateTime:i.LastChangeUTCDateTime};var R={analyticalConfigurationName:i.AnalyticalConfigurationName,serializedAnalyticalConfiguration:JSON.stringify(L),textFile:{inDevelopmentLanguage:p.createTextFileOfApplication(Q)}};J({type:"PUT",url:O,data:JSON.stringify(R),dataType:"json",success:function(S,T,U){K(l(),undefined);},error:function(S,T,U,V){var W=c.buildErrorMessage(S,"5233",[Q,N],V,b);K(l(),W);},async:true});}function B(i,K){var L=JSON.parse(i.SerializedAnalyticalConfiguration);var N=L.configHeader.AnalyticalConfiguration;var O=h+'/'+N;var Q=i.Application;var R={analyticalConfigurationName:i.AnalyticalConfigurationName,application:Q,serializedAnalyticalConfiguration:i.SerializedAnalyticalConfiguration};J({type:"PUT",url:O,data:JSON.stringify(R),dataType:"json",success:function(S,T,U){K(l(),undefined);},error:function(S,T,U,V){var W=c.buildErrorMessage(S,"5233",[Q,N],V,b);K(l(),W);},async:true});}this.remove=function(i,K,L,N,O,Q){if(i==='application'){var R=K[0].value;C(R,L);}else if(i==='configuration'){var S=K[0].value;D(S,O,L);}else{b.check(false,'The delete operation on entity set '+i+' is currently not supported by the modeler proxy.');}};function C(i,K){var L=f+'/'+i;J({type:"DELETE",url:L,success:function(N,S,O){K(l(),undefined);},error:function(N,S,O,Q){var R=c.buildErrorMessage(N,"5237",[i],Q,b);K(l(),R);},async:true});}function D(i,K,L){var N=g+'/'+i;J({type:"DELETE",url:N,success:function(O,S,Q){L(l(),undefined);},error:function(O,S,Q,R){var T=c.buildErrorMessage(O,"5225",[K,i],R,b);L(l(),T);},async:true});}this.doChangeOperationsInBatch=function(i,K,L,N){i.forEach(function(O){if(O.entitySetName!=='texts'){b.check(false,'The create/update/delete operation in batch on entity set '+O.entitySetName+' is not supported by the modeler proxy.');}O.application=L;});this._readConfigurationListAndTextFile(L).then(function(O){var Q=O.textFile.inDevelopmentLanguage;this._initText(L,Q);this._applyChangesOnTextFile(i);var R=this._createTextFileOfApplication(L);this._updateRemoteTextFile(L,'DEV',R,N).then(function(){K(undefined);},function(S){K(S);});}.bind(this),function(O){K(O);});};this._readConfigurationListAndTextFile=function(i){var K="'";var L=new Promise(function(N,O){var Q=t+'?$select=AnalyticalConfiguration,AnalyticalConfigurationName,SerializedAnalyticalConfiguration'+'&$filter=(Application%20eq%20'+K+i+K+')';J({type:"GET",url:Q,success:function(R,S,T){var U=[];if(R.analyticalConfigurations!==null){R.analyticalConfigurations.forEach(function(W){U.push({analyticalConfiguration:W.analyticalConfiguration,analyticalConfigurationName:W.analyticalConfigurationName,serializedAnalyticalConfiguration:W.serializedAnalyticalConfiguration});});}var V={analyticalConfigurations:U,textFile:{inDevelopmentLanguage:R.textFile.inDevelopmentLanguage}};N(V);},error:function(R,S,T,U){var V=c.buildErrorMessage(R,"5222",[i],U,b);O(V);},async:true});});return L;};this._initText=function(i,K){p.initApplicationTexts(i,K);};this._applyChangesOnTextFile=function(i){i.forEach(function(K){if(K.entitySetName==='texts'){switch(K.method){case"POST":var L=K.data;this._createOrUpdateLocalText(L);break;case"PUT":var N=K.data;this._createOrUpdateLocalText(N);break;case"DELETE":var O=K.application;var Q=K.inputParameters[0].value;this._deleteLocalText(O,Q);break;default:b.check(false,'The method '+K.method+' is not supported during text processing in batch mode by the modeler proxy.');break;}}else{b.check(false,'The create/update/delete operation on entity set '+K.entitySetName+' is not supported by the modeler proxy.');}}.bind(this));};this._createTextFileOfApplication=function(i){return p.createTextFileOfApplication(i);};this._createOrUpdateLocalText=function(i){p.addText(i);};this._deleteLocalText=function(i,K){var L={application:i,inputParameters:[{value:K}]};p.removeText(L);};this._updateRemoteTextFile=function(i,K,L,N){var O=new Promise(function(Q,R){var S;if(N===true){S=j+'/'+i;}else{S=j+'/'+i+'/'+K;}var T={serializedTextFile:L};J({type:"PUT",data:JSON.stringify(T),url:S,success:function(U,V,W){Q();},error:function(U,V,W,X){var Y=c.buildErrorMessage(U,"5230",[i],X,b);R(Y);},async:true});});return O;};this.readCollectionsInBatch=function(i,K){var L=i[0];b.check(L.entitySetName==='configuration',"wrong usage, only 'configuration' is allowed");var T=L.filter.getFilterTermsForProperty('Application');var N=T[0].getValue();function O(){function Q(R,S,U){if(U){K(undefined,U);}else{var V=[];V.push(R);V.push(p.getTextElements(N));K(V);}}return Q;}this.readCollection(L.entitySetName,O(),L.inputParameters,L.selectList,L.filter);};function E(i,K,b){var L=b.createMessageObject({code:"5214",aParameters:[i.status,i.statusText]});if(K){L.setPrevious(K);}return L;}this.importVendorContent=function(i,K,L,N,O){this.readAllConfigurationsFromVendorLayer().done(function(Q){F(i,K,L,N,O,Q);}).fail(function(Q){N(undefined,undefined,Q);});};function F(K,L,N,O,Q,R){var i;var S,T;var U=K+"."+L;for(i=0;i<R.length;i++){if(R[i].value===U){T=R[i].configurationText;S=R[i].applicationText;break;}}J({type:"HEAD",url:g+"/"+L,success:function(){N(W,X,T);},error:function(Y,Z,$,_){if(Y.status===404){H(L,V);}else{var a1=E(Y,_,b);O(undefined,undefined,a1);}}});function V(Y,Z,$){if(!$){Q(K,S);}O(Y,Z,$);}function W(){H(L,O);}function X(Y){var Z=k+"/"+L+"?$select=SerializedAnalyticalConfiguration";J({type:"GET",url:Z,success:function($){G(K,Y,$.serializedAnalyticalConfiguration,O);},error:function($,_,a1,b1){var c1=E($,b1,b);O(undefined,undefined,c1);}});}}function G(i,K,L,N){var O="/sap/apf/design-time/customer-content/v1/AnalyticalConfigurations";var Q={analyticalConfigurationName:K,application:i,serializedAnalyticalConfiguration:L};J({type:"POST",url:O,dataType:"json",data:JSON.stringify(Q),success:function(Q){N(Q.analyticalConfiguration);},error:function(R,S,T,U){var V=E(R,U,b);N(undefined,undefined,V);}});}function H(i,K){J({type:"PUT",url:v+"/"+i,contentType:'application/x-www-form-urlencoded',success:function(){K(i);},error:function(L,N,O,Q){var R=E(L,Q,b);K(undefined,undefined,R);}});}var I;this.readAllConfigurationsFromVendorLayer=function(){var i=jQuery.Deferred();if(I){i.resolve(I);}else{J({url:k+"?$select=Application,ApplicationName,AnalyticalConfiguration,AnalyticalConfigurationName",success:function(K){var L=[];if(K!==null){K.forEach(function(N){L.push({configurationText:N.analyticalConfigurationName,applicationText:N.applicationName,value:N.application+'.'+N.analyticalConfiguration});});}I=L;i.resolve(L);},error:function(K,L,N,O){var Q=E(K,O,b);var R=b.createMessageObject({code:'5231'});R.setPrevious(Q);i.reject(R);}});}return i.promise();};function J(S){return a.instances.ajaxHandler.send(S);}}var m={ModelerProxy:M};return m;},true);
