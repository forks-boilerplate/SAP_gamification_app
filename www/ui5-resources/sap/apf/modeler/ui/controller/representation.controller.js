/*!
* SAP APF Analysis Path Framework
*
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
sap.ui.define(["sap/apf/modeler/ui/utils/representationHandler","sap/apf/ui/utils/constants","sap/apf/core/constants","sap/apf/modeler/ui/utils/nullObjectChecker","sap/apf/modeler/ui/utils/optionsValueModelBuilder","sap/apf/modeler/ui/utils/sortDataHandler","sap/apf/modeler/ui/utils/representationBasicDataHandler","sap/apf/modeler/ui/utils/stepPropertyMetadataHandler","sap/apf/ui/utils/representationTypesHandler","sap/apf/modeler/ui/utils/viewValidator"],function(R,u,c,n,o,S,a,b,d,V){'use strict';var p,C,e,r,P,f,s,g,h,j;var l=c.representationMetadata.labelDisplayOptions;function _(i){i.byId("idVisualization").setText(C.getText("visualization"));i.byId("idChartTypeLabel").setText(C.getText("chartType"));i.byId("idChartTypeLabel").setTooltip(C.getText("chartType"));i.byId("idBasicData").setText(C.getText("basicData"));i.byId("idSorting").setText(C.getText("sorting"));i.byId("idChartType").setValueStateText(C.getText("modeler.ui.representation.invalidChartTypeError"));}function k(i,M){var N;var O=f.getPictureOfRepresentationType(r.getRepresentationType());var Q=e.getCategoriesForStep(P.getId());if(Q.length===1){N={id:r.getId(),icon:O};if(M){N.name=M;}i.getView().getViewData().updateSelectedNode(N);}else{i.getView().getViewData().updateTree();}}function m(i,M){var T=C.getText("representation")+": "+M;i.getView().getViewData().updateTitleAndBreadCrumb(T);}function q(i){r.setRepresentationType(i);var M="TableRepresentation";if(i===u.representationTypes.TABLE_REPRESENTATION||i===u.representationTypes.TREE_TABLE_REPRESENTATION){M=undefined;}r.setAlternateRepresentationType(M);}function t(i){var M;var N=jQuery.Deferred();s.getEntityTypeMetadataAsPromise().done(function(O){var Q=s.getDimensionsProperties(O);var T=f.getKindsForDimensionPropertyType(i);T.forEach(function(U,W){M=false;var X;var Y;var Z=Q[W];if(r.getDimensions().length!==0){if(r.getDimensions()[W]){if(r.getDimensionKind(r.getDimensions()[W])){M=true;}}}if(!M&&Z){X=s.hasTextPropertyOfDimension(O,Z);Y=X?l.KEY_AND_TEXT:l.KEY;r.addDimension(Z);r.setLabelDisplayOption(Z,Y);r.setDimensionKind(Z,T[0]);}});N.resolve();});return N.promise();}function v(i){var M;var N=s.oStep.getService();var O=s.oStep.getEntitySet();var Q=s.oStep.getHierarchyProperty();e.getHierarchyNodeIdAsPromise(N,O,Q).done(function(T){M=s.hasTextPropertyOfDimension(i,T);});return M;}function w(i){var M,N;var O=jQuery.Deferred();s.getEntityTypeMetadataAsPromise().done(function(Q){var T=s.getHierarchicalProperty();if(T&&(r.getHierarchyPropertyLabelDisplayOption()===undefined)){M=v(Q);N=M?l.TEXT:l.KEY;r.setHierarchyPropertyLabelDisplayOption(N);}O.resolve();});return O.promise();}function x(M){var N=jQuery.Deferred(),O,Q;var T;var U=0;s.getEntityTypeMetadataAsPromise().done(function(W){T=f.getKindsForMeasurePropertyType(M);O=s.getMeasures(W);T.forEach(function(X){var Y=f.getDefaultCountForRepresentationKind(M,X);for(var i=0;i<Y;i++){Q=false;var Z=O[U];if(r.getMeasures().length!==0){if(r.getMeasures()[U]){if(r.getMeasureKind(r.getMeasures()[U])){Q=true;}}}if(!Q&&Z){r.addMeasure(Z);r.setMeasureKind(Z,X);}U++;}});N.resolve();});return N.promise();}function y(i){var M=jQuery.Deferred();var N,O;if(i==="TableRepresentation"){if(r.getProperties().length===0){O=f.getKindsForPropertyType(i);N=s.getProperties()[0];r.addProperty(N);r.setPropertyKind(N,O[0]);M.resolve();}else{M.resolve();}}else if(i==="TreeTableRepresentation"){w(i).done(function(){M.resolve();});}else{t(i).done(function(){x(i).done(function(){M.resolve();});});}return M.promise();}function z(){if(p&&p.arguments&&p.arguments.stepId){P=e.getStep(p.arguments.stepId);}}function A(){var i=C.getRepresentationTypes()[0].id;if(P.getType()==="hierarchicalStep"){i="TreeTableRepresentation";}return i;}function B(i){var M;var N=jQuery.Deferred();if(p&&p.arguments&&p.arguments.representationId){r=P.getRepresentation(p.arguments.representationId);}if(!n.checkIsNotUndefined(r)){r=P.createRepresentation();M=A();q(M);k(i,C.getText(M));e.setIsUnsaved();y(M).done(function(){return N.resolve();});}else{M=r.getRepresentationType();J().done(function(){y(M).done(function(){return N.resolve();});});}return N.promise();}function D(i){var M=new sap.m.Button({id:i.createId("idPreviewButton"),text:C.getText("preview"),press:i.handlePreviewButtonPress.bind(i)});var N=i.getView().getViewData().oFooter;N.addContentRight(M);}function E(i){var T=i.getView().getViewData().oConfigurationHandler.getTextPool();var M={oTextReader:C.getText,oConfigurationEditor:e,oTextPool:T,oParentObject:r,oParentStep:P,oRepresentationTypeHandler:f};var N=new sap.ui.controller("sap.apf.modeler.ui.controller.representationCornerTexts");var O=new sap.ui.view({viewName:"sap.apf.modeler.ui.view.cornerTexts",type:sap.ui.core.mvc.ViewType.XML,id:i.createId("representationCornerTexts"),viewData:M,controller:N});i.byId("idCornerTextsVBox").insertItem(O);i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.representation.SETCHARTICON,O.getController().setChartIcon.bind(O.getController()));}function F(){r.getDimensions().forEach(function(i){r.removeDimension(i);});r.getMeasures().forEach(function(M){r.removeMeasure(M);});}function G(){var i,M;if(r.getRepresentationType()==="TableRepresentation"){i=r.getDimensions();M=r.getMeasures();i.forEach(function(N){r.addProperty(N);r.setPropertyTextLabelKey(N,r.getDimensionTextLabelKey(N));r.setPropertyKind(N,c.representationMetadata.kind.COLUMN);e.setIsUnsaved();});M.forEach(function(N){r.addProperty(N);r.setPropertyTextLabelKey(N,r.getMeasureTextLabelKey(N));r.setPropertyKind(N,c.representationMetadata.kind.COLUMN);e.setIsUnsaved();});F();}}function H(i){var M;s.getEntityTypeMetadataAsPromise().done(function(N){M=s.hasTextPropertyOfDimension(N,i);if(M){r.setLabelDisplayOption(i,l.KEY_AND_TEXT);}else{r.setLabelDisplayOption(i,l.KEY);}e.setIsUnsaved();});}function I(){var i=jQuery.Deferred();s.getEntityTypeMetadataAsPromise().done(function(M){r.getDimensions().forEach(function(N){if(r.getLabelDisplayOption(N)===undefined){H(N);}});i.resolve();});return i.promise();}function J(){G();return I();}function K(i){j.instantiateRepresentationSortData();E(i);return h.instantiateBasicDataAsPromise();}function L(i){if(!i.getValidationState()){if(i.byId("idChartType").getValueState("None")){i.byId("idChartType").setValueState("Error");}}else{i.byId("idChartType").setValueState("None");}}sap.ui.controller("sap.apf.modeler.ui.controller.representation",{onInit:function(){var i=this;i.promiseControllerIsCreated=new Promise(function(M){var N=i.getView().getViewData();C=N.oCoreApi;p=N.oParams;e=N.oConfigurationEditor;f=new d();i.oViewValidator=new V(i.getView());_(i);z();if(P.getType()!=="hierarchicalStep"){D(i);}s=new sap.apf.modeler.ui.utils.StepPropertyMetadataHandler(C,P);B(i).then(function(){g=new R(r,f,C.getText);h=new a(i.getView(),s,g,i.oViewValidator);j=new S(i.getView(),r,s,C.getText);K(i).then(function(){i.setDetailData();M();});});});},promiseControllerIsCreated:null,setDetailData:function(){var i=this;i._setChartType();},handleChangeForChartType:function(i){var M=this;var N=i.getParameter("selectedItem").getKey();var O=C.getText(N);var Q=r.getRepresentationType();q(N);k(M,O);m(M,O);if(!f.isChartTypeSimilar(Q,N)){M.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.REMOVEALLPROPERTIESFROMPARENTOBJECT);F();y(N).done(function(){h.instantiateBasicDataAsPromise().then(function(){L(M);});M.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.representation.SETCHARTICON);e.setIsUnsaved();});}else{h.instantiateBasicDataAsPromise().then(function(){L(M);});M.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.representation.SETCHARTICON);e.setIsUnsaved();}},handlePreviewButtonPress:function(){var i=this;var M={oParentStep:P,oRepresentation:r,oConfigurationHandler:i.getView().getViewData().oConfigurationHandler,oCoreApi:C,oRepresentationHandler:g,oStepPropertyMetadataHandler:s,oRepresentationTypeHandler:f};sap.ui.view({id:i.createId("idPreviewContentView"),viewName:"sap.apf.modeler.ui.view.previewContent",type:sap.ui.core.mvc.ViewType.XML,viewData:M});},onExit:function(){var i=this;i.getView().getViewData().oFooter.removeContentRight(i.byId("idPreviewButton"));h.destroyBasicData();j.destroySortData();i.byId("idCornerTextsVBox").destroyItems();},getValidationState:function(){return this.oViewValidator.getValidationState();},_setChartType:function(){var i=this;s.getEntityTypeMetadataAsPromise().done(function(M){var N;var O=s.getDimensionsProperties(M);var Q=s.getMeasures(M);var T=i._getAnnotatedChartTypes(f.aRepresentationTypes,s.getRepresentationTypesArray(),O,Q,C);N=o.prepareModel(T);i.byId("idChartType").setModel(N);i.byId("idChartType").setSelectedKey(r.getRepresentationType());L(i);});},_getAnnotatedChartTypes:function(i,M,N,O,C){function Q(U,W){var X;U.forEach(function(Y){if(Y["id"]===W){X=Y;}});return X;}var T=jQuery.extend(true,[],M);T.forEach(function(U){var W=0,X=0;var Y=Q(i,U.key);if(Y.metadata&&Y.id!=="TableRepresentation"&&Y.id!=="TreeTableRepresentation"){Y.metadata.dimensions.supportedKinds.forEach(function(Z){W+=parseInt(Z.min,10);});Y.metadata.measures.supportedKinds.forEach(function(Z){X+=parseInt(Z.min,10);});if(N.length<W||O.length<X){U.name=C.getText("modeler.ui.representation.invalidChartTypes",[U.name]);}}});return T;}});});
