/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2018 SAP SE. All rights reserved
 */
sap.ui.define(['sap/ui/core/mvc/Controller','sap/m/Table','sap/m/Column','sap/m/ColumnListItem','sap/m/Label','sap/m/Input','sap/ui/core/Icon','sap/apf/modeler/ui/utils/helper','sap/apf/modeler/ui/utils/nullObjectChecker','sap/apf/modeler/ui/utils/optionsValueModelBuilder','sap/ui/model/Filter'],function(B,T,C,a,L,I,b,h,n,o,F){"use strict";function _(i){var j=i.coreApi.getText;i.byId("idAppPage").setTitle(j("configModelerTitle"));i.byId("idAppTitle").setText(j("applicationOverview"));i.byId("idAppNumberTitle").setText(j("applications"));i.byId("idDescriptionLabel").setText(j("description"));if(i.coreApi.showSemanticObject()){i.byId("idSemanticObjectLabel").setText(j("semanticObject"));}i.byId("idImportButton").setText(j("import"));i.byId("idImportButton").setTooltip(j("importConfig"));i.byId("idNewButton").setText(j("new"));i.byId("idNewButton").setTooltip(j("newApplication"));i.byId("idEditIcon").setTooltip(j("editApplication"));i.byId("idDeleteIcon").setTooltip(j("deleteApplication"));i.byId("idTextpoolCleanupIcon").setTooltip(j("textCleanUp"));i.byId("idAriaPropertyForDelete").setText(j("ariaTextForDeleteIcon"));i.byId("idAriaPropertyForEdit").setText(j("ariaTextForEditIcon"));i.byId("idAriaPropertyForTextpoolCleanup").setText(j("ariaTextForTextpoolCleanupIcon"));}function c(i){var j=i.coreApi.getText;sap.ui.core.Fragment.byId("idDeleteConfirmationFragment","idDeleteConfirmation").setTitle(j("confirmation"));sap.ui.core.Fragment.byId("idDeleteConfirmationFragment","idDeleteButton").setText(j("deleteButton"));sap.ui.core.Fragment.byId("idDeleteConfirmationFragment","idCancelButtonDialog").setText(j("cancel"));}function d(i){var j=i.applicationHandler.getList();i.byId("idAppCount").setText("("+j.length+")");var A=[];j.forEach(function(p){var q={};q.id=p.Application;q.description=p.ApplicationName;q.semanticObject=p.SemanticObject;A.push(q);});var M=o.prepareModel(A,A.length);i.byId("idApplicationTable").setModel(M);if(i.actualQuery!==""){i.filterValues(i.actualQuery);}}function e(i,M){var j=i.coreApi.createMessageObject({code:M});i.coreApi.putMessage(j);}function f(i){i.byId("idApplicationTable").attachEvent("addNewAppEvent",i.handleAdditionOfNewApp.bind(i));i.byId("idApplicationTable").attachEvent("updateAppListEvent",i.handleAppListUpdate.bind(i));}function g(i,v){var V,j;V={oParentControl:i.byId("idApplicationTable"),oCoreApi:i.coreApi};j=new sap.ui.view({viewName:"sap.apf.modeler.ui.view."+v,type:sap.ui.core.mvc.ViewType.XML,viewData:V});i.getView().addDependent(j);}function k(i,D,j,p){i.getView().addDependent(D);var M=new L({text:i.coreApi.getText(j)}).addStyleClass("dialogText");D.removeAllContent();D.addContent(M);if(p){D.removeAllCustomData();D.addCustomData(p);}D.open();}function l(i){var s=i.byId("idAppListScrollContainer");var A=i.byId("idApplicationTable");var v=i.getView();A.addEventDelegate({onAfterRendering:function(){var j=jQuery(window).height();var p=jQuery(v.byId("idAppTitle").getDomRef()).height();var q=jQuery(v.byId("idApplicationToolbar").getDomRef()).height();var r=jQuery(v.byId("idAppPage").getDomRef()).find("header").height();var t=jQuery(v.byId("idAppPage").getDomRef()).find("footer").height();var u;if(p>0){p=p+80;u=p+q+r+t+25;}else{u=232;}s.setHeight(j-u+"px");s.setWidth("100%");h.onResize(function(){if(jQuery(v.getDomRef()).css("display")==="block"){j=jQuery(v.byId("idAppPage").getDomRef()).height();s.setHeight(j-u+"px");s.setWidth("100%");}});sap.ui.core.UIComponent.getRouterFor(i).attachRoutePatternMatched(function(E){if(E.getParameter("name")==="applicationList"){j=jQuery(v.getDomRef()).height();s.setHeight(j-u+"px");s.setWidth("100%");}});}});}function m(i,E){var j=new sap.m.StandardListItem({title:i.coreApi.getText("importDeliveredContent"),type:sap.m.ListType.Active,press:function(){g(i,"importDeliveredContent");}});var p=new sap.m.StandardListItem({title:i.coreApi.getText("importFiles"),type:sap.m.ListType.Active,press:function(){g(i,"importFiles");}});var P=new sap.m.Popover({placement:sap.m.PlacementType.Top,showHeader:false});var A=new sap.m.List({items:[j,p]});P.addContent(A);P.openBy(E.getSource());}return B.extend("sap.apf.modeler.ui.controller.applicationList",{onInit:function(){var i=this;this.actualQuery="";var j=i.getOwnerComponent();if(n.checkIsNotUndefined(j)){i.coreApi=j.oCoreApi;if(!this.coreApi.showSemanticObject()){this.hideSemanticObjectColumn();}f(this);_(i);i.coreApi.getApplicationHandler(function(p,q){i.applicationHandler=p;if(i.applicationHandler&&!n.checkIsNotUndefined(q)){d(i);}else{i.showMessage("11508",q);}});}l(i);},showMessage:function(i,p){var M=this.coreApi.createMessageObject({code:i});if(p){M.setPrevious(p);}this.coreApi.putMessage(M);},hideSemanticObjectColumn:function(){this.byId("idSemanticObjectColumn").setVisible(false);},handleAddNewAppPress:function(){var i=this;if(n.checkIsNotNullOrUndefinedOrBlank(i.applicationHandler)){g(i,"newApplication");}else{i.showMessage("11509");}},handleListItemPress:function(i){var j=this,p;p=i.getParameter("listItem").getBindingContext().getPath().split("/")[2];sap.ui.core.UIComponent.getRouterFor(j).navTo("configurationList",{appId:j.byId("idApplicationTable").getModel().getData().Objects[p].id});},handleTextpoolCleanupPress:function(i){var t;var j=i.getSource().getBindingContext().getObject().id;var p=new sap.ui.core.CustomData({value:{applicationId:j}});var q=this.coreApi.getText;t=sap.ui.xmlfragment("idTextpoolCleanupConfirmationFragment","sap.apf.modeler.ui.fragment.textpoolCleanupConfirmationDialog",this);t.setTitle(q("confirmation"));t.getButtons()[0].setText(q("ok"));t.getButtons()[1].setText(q("cancel"));k(this,t,"textpoolCleanupConfirmation",p);},handleConfirmTextpoolCleanup:function(i){var j=this;var p=sap.ui.core.Fragment.byId("idTextpoolCleanupConfirmationFragment","idTextpoolCleanupConfirmation").getCustomData()[0].getValue().applicationId;j.coreApi.getConfigurationHandler(p,function(q){var t=q.getTextPool();j.coreApi.getUnusedTextKeys(p,function(u,r){if(!n.checkIsNotUndefined(r)){t.removeTexts(u,p,function(r){if(!n.checkIsNotUndefined(r)){j.showMessage("11511");}else{j.showMessage("11507",r);}j.closeTextpoolCleanupConfirmationDialog();});}else{j.showMessage("11506",r);j.closeTextpoolCleanupConfirmationDialog();}});});},closeTextpoolCleanupConfirmationDialog:function(){sap.ui.core.Fragment.byId("idTextpoolCleanupConfirmationFragment","idTextpoolCleanupConfirmation").destroy();},handleCancelTextpoolCleanup:function(i){this.closeTextpoolCleanupConfirmationDialog();},handleEditPress:function(i){var j,v;if(n.checkIsNotNullOrUndefinedOrBlank(this.applicationHandler)){j=i.getSource().getBindingContext().getObject();v={parentControl:this.byId("idApplicationTable"),coreApi:this.coreApi,applicationData:j};sap.ui.view({viewName:"sap.apf.modeler.ui.view.editApplication",type:sap.ui.core.mvc.ViewType.XML,viewData:v,async:true}).loaded().then(function(p){this.getView().addDependent(p);}.bind(this));}},handleDeletePress:function(i){var j=this,D;var p=i.getSource().getBindingContext().getPath().split("/")[2];var q=new sap.ui.core.CustomData({value:{removeId:this.byId("idApplicationTable").getModel().getData().Objects[p].id,sPath:p}});D=sap.ui.xmlfragment("idDeleteConfirmationFragment","sap.apf.modeler.ui.fragment.deleteConfirmationDialog",j);c(j);k(j,D,"deleteApp",q);},handleConfirmDeletion:function(){var i=this;var r=sap.ui.core.Fragment.byId("idDeleteConfirmationFragment","idDeleteConfirmation").getCustomData()[0].getValue().removeId;if(n.checkIsNotUndefined(r)){i.applicationHandler.removeApplication(r,function(R,M,j){if(!n.checkIsNotUndefined(j)&&(typeof R==="string")){d(i);e(i,"11510");}else{i.showMessage("11501",j);}i.closeDialog();});}},closeDialog:function(){sap.ui.core.Fragment.byId("idDeleteConfirmationFragment","idDeleteConfirmation").destroy();},handleNavigationWithSave:function(){var i=this;i.handleSavePress();sap.ui.core.Fragment.byId("idUnsavedDataConfirmationFragment","idMessageDialog").destroy();},handleNavigationWithoutSave:function(){sap.ui.core.Fragment.byId("idUnsavedDataConfirmationFragment","idMessageDialog").destroy();},handlePreventNavigation:function(){sap.ui.core.Fragment.byId("idUnsavedDataConfirmationFragment","idMessageDialog").destroy();},handleImportPress:function(E){if(this.coreApi.isVendorContentAvailable()){m(this,E);}else{g(this,"importFiles");}},handleSavePress:function(){var i=this,u=[],p,t,j;p=i.applicationHandler.getList();t=i.byId("idApplicationTable").getModel().getData().Objects;for(j=0;j<p.length;j++){if(t[j].description!==p[j].ApplicationName||t[j].semanticObject!==p[j].SemanticObject){u.push(t[j]);}}u.forEach(function(q){var r={ApplicationName:q.description,SemanticObject:q.semanticObject};i.applicationHandler.setAndSave(r,function(R,M,s){if(n.checkIsNotUndefined(s)){i.showMessage("11500",s);}},q.id);});},handleNavigationToConfigurationList:function(E){var i=this;var p={listItem:sap.ui.getCore().byId(E.currentTarget.id).getParent(),srcControl:i.byId("idApplicationTable")};i.byId("idApplicationTable").fireItemPress(p);},handleAdditionOfNewApp:function(E){var j=this,p,A,i,q=0,r;p=E.getParameter("appId");d(j);A=j.byId('idApplicationTable').getModel().getData().Objects;e(j,"11512");j.byId('idApplicationTable').rerender();for(i=0;i<A.length;i++){if(A[i].id===p){q=i;break;}}r=j.byId('idApplicationTable').getItems();if(r.length){var s=r[q].getDomRef();if(s){s.scrollIntoView();}}if(this.actualQuery!==""){this.filterValues(this.actualQuery);}},handleAppListUpdate:function(){var i=this;d(i);},handleNavBack:function(){window.history.go(-1);},onSearch:function(i){var q=i.getParameters().newValue;this.actualQuery=q;this.filterValues(q);},filterValues:function(q){var i=[];if(q&&q.length>0){var j=new F("description",sap.ui.model.FilterOperator.Contains,q);i.push(j);}var t=this.byId("idApplicationTable");var p=t.getBinding("items");p.filter(i,"Objects");}});});
