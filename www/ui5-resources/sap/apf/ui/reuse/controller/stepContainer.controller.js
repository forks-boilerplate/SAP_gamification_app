/*!
* SAP APF Analysis Path Framework
*
 * (c) Copyright 2012-2018 SAP SE. All rights reserved
*/
sap.ui.define(['sap/apf/ui/utils/helper','sap/apf/core/constants','sap/ui/core/mvc/Controller','sap/apf/ui/utils/constants','sap/suite/ui/commons/ChartContainerContent','sap/suite/ui/commons/ChartContainerToolbarPlaceholder','sap/ui/core/Icon','sap/ui/core/CustomData','sap/m/Link','sap/m/Label','sap/m/Button','sap/m/ToolbarSpacer','sap/m/List','sap/m/ListMode','sap/m/ListSeparators','sap/m/StandardListItem','sap/m/Popover','sap/m/PlacementType'],function(H,C,B,a,b,c,I,d,L,e,f,T,g,h,k,S,P,l){"use strict";var o,u,A,r=false;function _(){var R=A.getSelectedRepresentation();if(R.type===a.representationTypes.TABLE_REPRESENTATION){return true;}return false;}function m(){var R=A.getSelectedRepresentation();if(R.type===a.representationTypes.TREE_TABLE_REPRESENTATION){return true;}return false;}function n(){if(A.getSelectedRepresentation().bIsAlternateView===undefined||A.getSelectedRepresentation().bIsAlternateView===false){return false;}return true;}function p(i){var R=i.getCurrentRepresentation();var j=R.getParameter().requiredFilters;if(j===undefined||j.length===0){return undefined;}return j[0];}function q(i,j){var O=i.byId("idChartContainer");var Q="0";var R=jQuery(window).width();var U=O.getId();if(jQuery("#"+U).length!==0){Q=jQuery("#"+U+" > div:first-child > div:nth-child(2)").offset().top;R=jQuery("#"+U+" > div:first-child > div:nth-child(2)").width();}var V=(jQuery(window).height()-Q)-jQuery(".applicationFooter").height();var W=R;j.setHeight(V+"px");j.setWidth(W+"px");}function s(i){var j=i.byId("idChartContainer");var R=i.getCurrentRepresentation();var O=A.longTitle&&!o.isInitialTextKey(A.longTitle.key)?A.longTitle:A.title;var Q=o.getTextNotHtmlEncoded(O);var U=R.getMainContent(Q);var V={onBeforeRendering:function(){q(i,U);}};U.addEventDelegate(V);j.removeAllContent();var W=new b({content:U});j.addContent(W);}function t(i,j){var O=i.byId("idSelectedText");var Q=i.getCurrentRepresentation();var R=K(i);var U=Q.getSelectionFilterLabel();var V=U+" ("+R+") ";var W=i.byId("idSelPropertyAndCount");if(!W){W=new L({id:i.createId("idSelPropertyAndCount"),press:i.handlePressSelectedPropertyCountLink.bind(i)});W.addAriaLabelledBy(O.getId());}else{if(W&&(Q.chart!==undefined)&&(Q.chart!==null)){Q.chart.detachEvent("setFocusOnSelectedLinkEvent",Q.chart.setFocusOnSelectLink);}}if(W&&(Q.chart!==undefined)&&(Q.chart!==null)){Q.chart.setFocusOnSelectLink=function(){W.focus();};}W.setVisible(true);W.setText(V);j.addContent(W);j.onAfterRendering=function(){if(W&&(Q.chart!==undefined)&&(Q.chart!==null)){Q.chart.fireEvent("setFocusOnSelectedLinkEvent");Q.chart.detachEvent("setFocusOnSelectedLinkEvent",Q.chart.setFocusOnSelectLink);}};}function v(i){var j=i.byId("idChartContainer");j.removeAllCustomIcons();w(i);x(i);y(i);}function w(j){var O=j.byId("idChartContainer");var Q=A.getSelectedRepresentationInfo();var R;if(Q.parameter&&Q.parameter.orderby){new H(o).getRepresentationSortInfo(Q).done(function(W){var X=[];for(var i=0;i<W.length;i++){W[i].done(function(Y){X.push(Y);});}R=X.join(", ");var U=o.getTextNotHtmlEncoded(Q.label)+"\n"+((R!==undefined)?o.getTextNotHtmlEncoded("sortBy")+": "+R:"");var V=new I({src:Q.picture,tooltip:U,press:function(Y){j.handlePressChartIcon(Y);}});O.addCustomIcon(V);});}else{var U=o.getTextNotHtmlEncoded(Q.label)+"\n"+((R!==undefined)?o.getTextNotHtmlEncoded("sortBy")+": "+R:"");var V=new I({src:Q.picture,tooltip:U,press:function(i){j.handlePressChartIcon(i);}});O.addCustomIcon(V);}}function x(i){if(_()||m()){return;}var j=i.byId("idChartContainer");var O=o.getTextNotHtmlEncoded("listView");var Q=new I({src:"sap-icon://table-view",tooltip:O,press:i.handlePressAlternateRepIcon.bind(i)});j.addCustomIcon(Q);}function y(i){if((i.getCurrentRepresentation().topN!==undefined)||(!n()&&!_())||(m())){return;}var j=i.byId("idChartContainer");var O=o.getTextNotHtmlEncoded("view-Settings-Button");var Q=new I({src:"sap-icon://drop-down-list",tooltip:O,press:function(){i.getCurrentRepresentation().getViewSettingDialog().open();}});j.addCustomIcon(Q);}function z(i,j){var O=i.byId("idSelectedText");if(!O){O=new e({id:i.createId("idSelectedText"),text:o.getTextNotHtmlEncoded("selectedValue")});}O.setVisible(true);j.addContent(O);}function D(i,j){var R=i.byId("idReset");if(!R){R=new f({text:o.getTextNotHtmlEncoded("reset"),id:i.createId("idReset"),type:"Transparent",press:i.handlePressResetButton.bind(i)}).addStyleClass("chartContainerResetStyle");}R.setVisible(true);j.addContent(R);}function E(i,j){var O=K(i);if(O>0&&p(i)!==undefined){z(i,j);t(i,j);D(i,j);}}function F(i,j){var O=i.byId("idPathFilterDisplayButton");if(!O){O=new f({text:o.getTextNotHtmlEncoded("pathFilterDisplayButton"),id:i.createId("idPathFilterDisplayButton"),icon:"sap-icon://message-information",type:"Transparent",press:function(){if(i.byId("idStepLayout").getBusy()===false){o.getPathFilterInformation().then(function(Q){var R=new sap.ui.xmlview({viewName:"sap.apf.ui.reuse.view.pathFilterDisplay",viewData:{pathFilterInformation:Q,oCoreApi:o,oUiApi:u},id:i.createId("pathFilterDisplay")});R.setParent(i.getView());R.getContent()[0].open();});}}});}j.addContent(O);}function G(i){var j=i.byId("idChartContainer");var O=j.getToolbar();O.removeAllContent();var Q=new e({text:o.getTextNotHtmlEncoded("currentStep")});O.addContent(Q);var R=new T();O.addContent(R);E(i,O);F(i,O);O.addContent(new c());j.setToolbar(O);}function J(i){if(A===undefined){return;}s(i);v(i);G(i);}function K(i){var j=i.getCurrentRepresentation();var O=j.getSelections().length;return O;}function M(O,Q){var R=new g({mode:h.SingleSelectMaster,showSeparators:k.None,includeItemInSelection:true,selectionChange:O.handleSelectionChartSwitchIcon.bind(O)});var U;var V;for(var j=0;j<A.getRepresentationInfo().length;j++){V=A.getRepresentationInfo()[j];U=undefined;if(V.parameter&&V.parameter.orderby){new H(o).getRepresentationSortInfo(V).done(function(Z){var $=[];for(var i=0;i<Z.length;i++){Z[i].done(function(a1){$.push(a1);});}U=$.join(", ");var W=U!==undefined?o.getTextNotHtmlEncoded("sortBy")+": "+U:"";var X=new S({description:W,icon:V.picture,title:o.getTextNotHtmlEncoded(V.label),customData:[new d({key:'data',value:{oRepresentationType:V,icon:V.picture}})]});R.addItem(X);});}else{var W=U!==undefined?o.getTextNotHtmlEncoded("sortBy")+": "+U:"";var X=new S({description:W,icon:V.picture,title:o.getTextNotHtmlEncoded(V.label),customData:[new d({key:'data',value:{oRepresentationType:V,icon:V.picture}})]});R.addItem(X);}}if(!O.byId("idAllChartPopover")){var Y=new P({id:O.createId("idAllChartPopover"),placement:l.Bottom,showHeader:false,content:[R],afterClose:function(){Y.destroy();}});}O.byId("idAllChartPopover").openBy(Q);}function N(i,j){i.byId("idReset").setVisible(j);i.byId("idSelPropertyAndCount").setVisible(j);i.byId("idSelectedText").setVisible(j);}return B.extend("sap.apf.ui.reuse.controller.stepContainer",{onInit:function(){var i=this;o=i.getView().getViewData().oCoreApi;u=i.getView().getViewData().uiApi;A=o.getActiveStep();this.initialText=new e({id:this.createId("idInitialText")}).addStyleClass('initialText');this.initialText.setText(o.getTextNotHtmlEncoded('initialText'));},onAfterRendering:function(){var i=this;jQuery(window).resize(function(){var j=90;o.getSmartFilterBarConfigurationAsPromise().done(function(O){if(O){j=165;}var Q=jQuery(window).height()-j;jQuery('.layoutView').css({"height":Q});i.drawStepContent();});});jQuery(u.getStepContainer().getDomRef()).hide();if(jQuery("#"+this.initialText.getId()).length===0&&o.getSteps().length===0){jQuery('#'+u.getStepContainer().getId()).parent().append(sap.ui.getCore().getRenderManager().getHTML(this.initialText));}else if(o.getSteps().length>0){jQuery(u.getStepContainer().getDomRef()).show();}if(u.getAnalysisPath().getController().isOpenPath){jQuery(".initialText").remove();}},getCurrentRepresentation:function(){var i=A.getSelectedRepresentation();if(n()){i=A.getSelectedRepresentation().toggleInstance;}return i;},handlePressSelectedPropertyCountLink:function(){var i=this;i.oCoreApi=o;var j=new sap.ui.jsfragment("idSelectionDisplayFragment","sap.apf.ui.reuse.fragment.selectionDisplay",i);j.open();},handlePressResetButton:function(){var i=this;if(n()){i.getCurrentRepresentation().removeAllSelection();}i.getCurrentRepresentation().removeAllSelection();N(i,false);},createToggleRepresentationInstance:function(R,j){var O={};function Q(X){var Y=X.dimensions;var W=R.getMetaData();X.isAlternateRepresentation=true;if(W===undefined){return X;}var i,Z;for(i=0;i<Y.length;i++){var $=W.getPropertyMetadata(Y[i].fieldName).hasOwnProperty('text');if($&&Y[i].labelDisplayOption===C.representationMetadata.labelDisplayOptions.KEY_AND_TEXT){Z={};Z.fieldName=W.getPropertyMetadata(Y[i].fieldName).text;X.dimensions.splice(i+1,0,Z);}else if($&&Y[i].labelDisplayOption===C.representationMetadata.labelDisplayOptions.TEXT){Z={};Z.fieldName=W.getPropertyMetadata(Y[i].fieldName).text;X.dimensions.splice(i,1,Z);}}return X;}var U=jQuery.extend(true,{},R.getParameter());delete U.alternateRepresentationTypeId;delete U.alternateRepresentationType;U=Q(U);if(j){U.orderby=j;}O=o.createRepresentation(R.getParameter().alternateRepresentationType.constructor,U);var V=R.getData(),W=R.getMetaData();if(V!==undefined&&W!==undefined){O.setData(V,W);}return O;},handlePressAlternateRepIcon:function(){var i=this;var j=A.getSelectedRepresentation();j.bIsAlternateView=true;if(n()){j.toggleInstance=i.createToggleRepresentationInstance(j);}r=true;i.getView().getViewData().uiApi.selectionChanged(true);},handlePressChartIcon:function(i){var j=this;var O=A.getSelectedRepresentation();var Q=o.getSteps().indexOf(A);if(A.getRepresentationInfo().length>1){var R=i.getParameter("controlReference");M(j,R);}else{O.bIsAlternateView=false;r=true;u.getAnalysisPath().getCarousel().getStepView(Q).getController().drawThumbnailContent(true);j.drawStepContent();}},handleSelectionChartSwitchIcon:function(i){var j=this;j.byId("idAllChartPopover").close();var O=i.getParameter("listItem").getCustomData()[0].getValue();var Q=o.getSteps().indexOf(A);var R=A.getSelectedRepresentationInfo().representationId;var U=O.oRepresentationType.representationId;if(R===U&&A.getSelectedRepresentation().bIsAlternateView===false){return;}r=true;A.getSelectedRepresentation().bIsAlternateView=false;A.setSelectedRepresentation(O.oRepresentationType.representationId);u.getAnalysisPath().getController().refresh(O.nActiveStepIndex);o.updatePath(u.getAnalysisPath().getController().callBackForUpdatePath.bind(u.getAnalysisPath().getController()));u.getAnalysisPath().getCarousel().getStepView(Q).getController().drawThumbnailContent(true);},drawStepContent:function(i){var j=this,O=false;var Q=A;A=o.getActiveStep();if(Q!==A){O=true;}var R=o.getSteps().indexOf(A);var U=u.getAnalysisPath().getCarousel().getStepView(R);if(U===undefined){return;}var V=U.oThumbnailChartLayout.isBusy();if(V){j.byId("idStepLayout").setBusy(true);}if(i||r||O){J(j);}else{G(j);}r=false;j.byId("idStepLayout").setBusy(false);}});},true);
