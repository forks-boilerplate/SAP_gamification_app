sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","./CalculationBuilderItem","./CalculationBuilderExpression","./CalculationBuilderInput","./CalculationBuilderFunction","sap/m/OverflowToolbar","sap/m/OverflowToolbarToggleButton","sap/m/OverflowToolbarButton","sap/m/ToolbarSpacer","sap/m/Title","sap/m/ButtonType","sap/ui/core/Popup","sap/m/MessageBox"],function(q,l,C,a,b,c,d,O,e,f,T,g,B,P,M){"use strict";var I=Object.freeze({SHOW_EXPRESSION:"sap-icon://notification-2",EXPAND_VARIABLE:"sap-icon://disconnected",FULL_SCREEN:"sap-icon://full-screen",EXIT_FULL_SCREEN:"sap-icon://exit-full-screen"});var r=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var h=l.CalculationBuilderOperatorType,L=l.CalculationBuilderLogicalOperatorType,i=l.CalculationBuilderComparisonOperatorType,j=l.CalculationBuilderItemType,F=l.CalculationBuilderFunctionType,k=l.CalculationBuilderLayoutType;var m={abs:{key:"ABS",title:"ABS - Absolute Value",allowed:true},round:{key:"Round",title:"Round",template:["",",",""],allowed:true},roundup:{key:"RoundUp",title:"Round Up",template:["",",",""],allowed:true},rounddown:{key:"RoundDown",title:"Round Down",template:["",",",""],allowed:true},sqrt:{key:"SQRT",title:"SQRT",allowed:true},"case":{key:"Case",title:"Case",description:"CASE ( \"When\" Expression \"Then\" Expression \"Else\" Expression )",template:["",",","",",",""]},ndiv0:{key:"NDIV0",title:"NDIV0"},nodim:{key:"NODIM",title:"NODIM",description:"NODIM ( Variable )"},sumct:{key:"SUMCT",title:"SUMCT",description:"SUMGT ( Variable )"},sumgt:{key:"SUMGT",title:"SUMGT",description:"SUMGT ( Variable )"},sumrt:{key:"SUMRT",title:"SUMRT",description:"SUMRT ( Variable )"}};var n=C.extend("sap.suite.ui.commons.CalculationBuilder",{metadata:{library:"sap.suite.ui.commons",properties:{expression:{type:"string",group:"Misc",defaultValue:null},title:{type:"string",group:"Misc",defaultValue:null},showToolbar:{type:"boolean",group:"Misc",defaultValue:true},wrapItemsInExpression:{type:"boolean",group:"Misc",defaultValue:true},layoutType:{type:"string",group:"Misc",defaultValue:"Default"},showInputToolbar:{type:"boolean",group:"Misc",defaultValue:true},readOnly:{type:"boolean",group:"Misc",defaultValue:false},allowComparisonOperators:{type:"boolean",group:"Misc",defaultValue:true},allowLogicalOperators:{type:"boolean",group:"Misc",defaultValue:true}},defaultAggregation:"items",aggregations:{items:{type:"sap.suite.ui.commons.CalculationBuilderItem",multiple:true,singularName:"item",bindable:"bindable",forwarding:{idSuffix:"-expression",aggregation:"items"}},variables:{type:"sap.suite.ui.commons.CalculationBuilderVariable",multiple:true,singularName:"Variable",forwarding:{idSuffix:"-expression",aggregation:"variables"}},functions:{type:"sap.suite.ui.commons.CalculationBuilderFunction",multiple:true,singularName:"Function",forwarding:{idSuffix:"-expression",aggregation:"functions"}}},events:{validateFunction:{parameters:{definition:"object",customFunction:"object",result:"sap.suite.ui.commons.CalculationBuilderValidationResult"}},change:{},afterValidation:{}}},renderer:function(R,o){var w=o.getWrapItemsInExpression()?" sapCalculationBuilderWrapItems ":"",D=o._bShowInput?"":"style=\"display:none\"",p=o._isExpressionVisible(),s=o._isInputVisible(),t=o.getReadOnly();R.write("<div");R.writeControlData(o);R.addClass("sapCalculationBuilder");R.writeClasses(o);R.write(">");if(o.getShowToolbar()&&(o.getLayoutType()!==k.TextualOnly)){R.renderControl(o.getToolbar());}if(p){o._oExpressionBuilder._bReadOnly=t;R.write("<div class=\"sapCalculationBuilderInsideWrapper"+w+"\">");R.renderControl(o._oExpressionBuilder);R.write("</div>");}if(p&&s){R.write("<div class=\"sapCalculationBuilderDelimiterLine\"></div>");}if(s){o._oInput._bReadOnly=t||o.getLayoutType()===k.VisualTextualReadOnly;R.write("<div class=\"sapCalculationBuilderInputOuterWrapper\""+D+">");R.renderControl(o._oInput);R.write("</div>");}R.write("</div>");}});n.prototype.init=function(){this._bShowInput=true;this._oFullScreenContainer=null;this._bIsFullScreen=false;this._oExpressionBuilder=new b(this.getId()+"-expression",{change:function(){var p="";p=this._oInput._itemsToString({items:this._oExpressionBuilder.getItems(),errors:this._oExpressionBuilder._aErrors});this._oInput._displayError(this._oExpressionBuilder._aErrors.length!==0);this._setExpression(p);this._enableOrDisableExpandAllButton();this.fireChange();}.bind(this)});this.addDependent(this._oExpressionBuilder);this._oInput=new c(this.getId()+"-input",{change:function(E){var t=E.getParameter("value"),o=this._oInput._stringToItems(t);this._oExpressionBuilder._setItems(o);this._oExpressionBuilder._aErrors=this._oExpressionBuilder._validateSyntax();this.fireAfterValidation();this._oInput._recreateText({text:t,position:E.getParameter("position"),errors:this._oExpressionBuilder._aErrors});this._oExpressionBuilder._printErrors();this._oInput._displayError(this._oExpressionBuilder._aErrors.length>0);this._setExpression(this._oInput._getText());this._enableOrDisableExpandAllButton();this.fireChange();}.bind(this)});this.addDependent(this._oInput);};n.prototype.onBeforeRendering=function(){this._createToolbar();this._oInput._aVariables=this.getVariables();if(this._sExpressionDirectValue){this._oExpressionBuilder._setItems(this._oInput._stringToItems(this._sExpressionDirectValue));}this._sExpressionDirectValue="";};n.prototype.onAfterRendering=function(){this._oInput._itemsToString({items:this._oExpressionBuilder.getItems(),errors:this._oExpressionBuilder._aErrors});};n.prototype.getToolbar=function(){return this._oToolbar;};n.prototype.getInputToolbar=function(){return this._oInput&&this._oInput._oInputToolbar;};n.prototype.validateParts=function(p){p=p||{};return this._oExpressionBuilder._validateSyntax({items:p.items,from:p.from,to:p.to});};n.prototype.appendError=function(E){this._oExpressionBuilder._aErrors.push(E);};n.prototype.getErrors=function(){return this._oExpressionBuilder._aErrors;};n.prototype.allowFunction=function(s,A){if(!s){return;}var o=m[s.toLowerCase()];if(o){o.allowed=A;}};n.prototype._findInArray=function(K,o,p){return o.some(function(s){var v=p?s["get"+p]():s;return v.toLowerCase()===K;});};n.prototype._getFunctionMap=function(){return m;};n.prototype._getFunctionDefinition=function(K){K=(K||"").toLowerCase();return m[K]||q.grep(this.getFunctions(),function(o){return o.getKey().toLowerCase()===K;})[0];};n.prototype._getFunctionDescription=function(o){var E;if(o.description){return o.description;}E=r.getText("CALCULATION_BUILDER_EXPRESSION_TITLE");if(o.template){var D=(o.key||"")+" ( ";o.template.forEach(function(K){D+=(K?K:E)+" ";});return D+")";}return(o.key||"")+" ( "+E+" )";};n.prototype._getFunctionTemplateItems=function(o){if(!o){return[];}var t=(o instanceof d)?j.CustomFunction:j.Function;return t===j.Function?(o.template||[]):this._convertToTemplate(o.getItems());};n.prototype._getFunctionAllowParametersCount=function(K){var t=this._getFunctionTemplateItems(this._getFunctionDefinition(K)),s=t.join("");return(s.match(/,/g)||[]).length+1;};n.prototype._convertToTemplate=function(o){return o.map(function(p){return p.getKey();});};n.prototype._insertFunctionItems=function(o,p){if(o&&o.length>0){o.forEach(function(K){this.insertItem(new a({key:K}),p++);}.bind(this));}else{this.insertItem(new a({key:""}),p++);}this.insertItem(new a({key:")"}),p++);};n.prototype._isOperator=function(K,A){A=A!==false;K=(K||"").toLowerCase();return this._findInArray(K,Object.keys(h))||(A&&this.getAllowLogicalOperators()&&this._findInArray(K,Object.keys(L)))||(this.getAllowComparisonOperators()&&this._findInArray(K,Object.keys(i)));};n.prototype._getType=function(K){K=(K||"").toLowerCase();if(!K){return j.Empty;}if(this._isOperator(K)){return j.Operator;}if(this._findInArray(K,this.getVariables(),"Key")){return j.Variable;}if(this._findInArray(K,Object.keys(F))){return j.Function;}if(this._findInArray(K,this.getFunctions(),"Key")){return j.CustomFunction;}if(!isNaN(K)){return j.Constant;}return j.Error;};n.prototype._createToolbar=function(){if(this._oToolbar){this._oShowInputButton&&this._oShowInputButton.setVisible(this._isInputVisible());return;}this._oToolbarTitle=new g({text:this.getTitle(),visible:!!this.getTitle()});this._oToolbar=new O(this.getId()+"-toolbar",{content:[this._oToolbarTitle,new T()]}).addStyleClass("sapCalculationBuilderToolbar");this._oShowInputButton=new e({type:B.Transparent,icon:I.SHOW_EXPRESSION,tooltip:r.getText("CALCULATION_BUILDER_TOGGLE_EXPRESSION_BUTTON"),pressed:true,press:function(){this.$().find(".sapCalculationBuilderInputOuterWrapper").toggle();this._bShowInput=!this._bShowInput;}.bind(this)});this._oToolbar.addContent(this._oShowInputButton);this._oToolbar.addContent(this._getExpandAllVariablesButton());this._oToolbar.addContent(new e({type:B.Transparent,icon:I.FULL_SCREEN,tooltip:r.getText("CALCULATION_BUILDER_ENTER_FULL_SCREEN_BUTTON"),press:function(E){var t=E.getSource();this._toggleFullScreen();t.setTooltip(this._bIsFullScreen?r.getText("CALCULATION_BUILDER_EXIT_FULL_SCREEN_BUTTON"):r.getText("CALCULATION_BUILDER_ENTER_FULL_SCREEN_BUTTON"));t.setIcon(this._bIsFullScreen?I.EXIT_FULL_SCREEN:I.FULL_SCREEN);this.invalidate();}.bind(this)}));this._oFullScreenPopup=new P({modal:true,shadow:false,autoClose:false});this.addDependent(this._oToolbar);};n.prototype._getExpandAllVariablesButton=function(){if(!this._oExpandAllVariablesButton){this._oExpandAllVariablesButton=new f({type:B.Transparent,icon:I.EXPAND_VARIABLE,tooltip:r.getText("CALCULATION_BUILDER_EXPAND_ALL_BUTTON"),press:function(E){M.show(r.getText("CALCULATION_BUILDER_EXPAND_ALL_MESSAGE_TEXT"),{icon:M.Icon.WARNING,title:r.getText("CALCULATION_BUILDER_EXPAND_ALL_MESSAGE_TITLE"),actions:[M.Action.YES,M.Action.CANCEL],onClose:function(A){if(A===M.Action.YES){this._oExpressionBuilder._expandAllVariables();}}.bind(this)});}.bind(this)});}return this._oExpandAllVariablesButton;};n.prototype._enableOrDisableExpandAllButton=function(){var o=this.getReadOnly()||this.getLayoutType()===k.VisualTextualReadOnly;this._getExpandAllVariablesButton().setEnabled(!o&&this.getItems().some(function(p){return p._isVariable()&&p.isExpandable();}));};n.prototype.setExpression=function(v){this.setProperty("expression",v);this._sExpressionDirectValue=v;};n.prototype._setExpression=function(v){this.setProperty("expression",v,true);};n.prototype._toggleFullScreen=function(){var o=function(){this._oFullScreenContainer={};this._oFullScreenContainer.$content=this.$();if(this._oFullScreenContainer.$content){this._oFullScreenContainer.$tempNode=q("<div></div>");this._oFullScreenContainer.$content.before(this._oFullScreenContainer.$tempNode);this._oFullScreenContainer.$overlay=q("<div id='"+q.sap.uid()+"'></div>");this._oFullScreenContainer.$overlay.addClass("sapCalculationBuilderOverlay");this._oFullScreenContainer.$overlay.append(this._oFullScreenContainer.$content);this._oFullScreenPopup.setContent(this._oFullScreenContainer.$overlay);}this._oFullScreenPopup.open(0,P.Dock.BeginTop,P.Dock.BeginTop,q("body"));}.bind(this);var p=function(){this._oFullScreenContainer.$tempNode.replaceWith(this.$());this._oFullScreenPopup.close();this._oFullScreenContainer.$overlay.remove();}.bind(this);this._bIsFullScreen?p():o();this._bIsFullScreen=!this._bIsFullScreen;};n.prototype._isExpressionVisible=function(){return this.getLayoutType()!==k.TextualOnly;};n.prototype._isInputVisible=function(){return this.getLayoutType()!==k.VisualOnly;};n.prototype._createFunctionObject=function(o){if(!o){return null;}return o instanceof d?{key:o.getKey(),title:o._getLabel(),description:this._getFunctionDescription({key:o.getKey(),description:o.getDescription(),template:this._convertToTemplate(o.getItems())}),type:j.CustomFunction,functionObject:o}:{key:o.key,title:o.title,description:this._getFunctionDescription(o),type:j.Function,functionObject:o};};n.prototype._getAllFunctions=function(){var o=[];Object.keys(m).forEach(function(K){if(m[K].allowed){o.push(this._createFunctionObject(m[K]));}}.bind(this));this.getFunctions().forEach(function(p){o.push(this._createFunctionObject(p));}.bind(this));return o.sort(function(p,s){return p.title>s.title;});};return n;},true);
