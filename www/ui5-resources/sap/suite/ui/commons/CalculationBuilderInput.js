sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","./CalculationBuilderItem","sap/m/List","sap/m/ListMode","sap/m/StandardListItem","sap/m/ResponsivePopover","sap/m/PlacementType","sap/m/Button","sap/m/ButtonType","sap/m/Menu","sap/m/MenuButton","sap/m/MenuItem","sap/m/OverflowToolbar","sap/m/ToolbarSeparator","sap/m/ToolbarSpacer","sap/m/Title","sap/ui/core/CustomData","sap/ui/model/Sorter","sap/ui/model/json/JSONModel"],function(q,l,C,a,L,b,S,R,P,B,c,M,d,f,O,T,g,h,j,k,J){"use strict";var E="&nbsp;&nbsp;";var m="┘┘";var I=l.CalculationBuilderItemType;var r=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var n=function(e){if(typeof e.which==="undefined"){return true;}else if(typeof e.which==="number"&&e.which>0){return!e.ctrlKey&&!e.metaKey&&!e.altKey&&e.which!==8;}return false;};var G=function(e,p){var N,s="",i=0,t=e.nodeType;if(e instanceof q){e=e[0];}if(!t){while((N=e[i++])){s+=G(N,p);}}else if(t===1||t===9||t===11){for(e=e.firstChild;e;e=e.nextSibling){s+=G(e,p);}}else if(t===3||t===4){s+=p&&q(e).parent().hasClass("sapCalculationBuilderItemTextEmpty")&&e.nodeValue==="  "?"┘┘":e.nodeValue;}return s;};var o=C.extend("sap.suite.ui.commons.CalculationBuilderInput",{metadata:{library:"sap.suite.ui.commons",events:{change:{parameters:{value:"String",position:"integer",validate:"boolean"}}}},renderer:function(e,i){var s=i._bReadOnly?"":"contenteditable=\"true\"";if(i.getParent().getShowInputToolbar()&&!i._bReadOnly){e.write("<div class=\"sapCalculationBuilderInputToolbarWrapper\">");e.renderControl(i._oInputToolbar);e.write("</div>");}e.write("<div");e.writeControlData(i);e.addClass("sapCalculationBuilderInputWrapper");e.writeClasses(i);e.write(">");e.write("<div spellcheck=\"false\""+s+" id=\""+i.getId()+"-input\" class=\"sapCalculationBuilderInput\">");e.write("</div>");e.write("</div>");}});o.prototype.init=function(){this._setupSuggestionList();this._sSuggestionText="";this._aVariables=[];this._oInputToolbar=new O(this.getId()+"-toolbar").addStyleClass("sapCalculationBuilderInputToolbar");};o.prototype.onAfterRendering=function(){this._setupKeyPress();this._setupEvents();};o.prototype.onBeforeRendering=function(){this._aFunctions=this.getParent()._getAllFunctions();this._fillInputToolbar();};o.prototype.getFocusDomRef=function(){return this.getDomRef("input");};o.prototype._setupEvents=function(){this.$("input").blur(function(){this._lastRangeSelection=this._getSelectionRange();this._lastRangeSelection.length=0;}.bind(this));};o.prototype._setupKeyPress=function(){var t=this;this.$("input").on('focus',function(){var $=q(this);$.data('before',G($[0]));}).on('paste keyup',function(e){var $=q(this),s=$.data('before'),i=e.key,p=G($[0]);if(t._oPopup.isOpen()&&i==="Enter"){return;}if(s!==p){var u=t._getCaretPosition();t._storeCurrent();t.fireChange({position:Math.max(0,u)});t._checkSuggestions(u,p,n(e));if(t._sSuggestionText.length>0){t._filterSuggestionList(t._sSuggestionText);if(t._oSuggestionList.getItems().length===0){t._oPopup.close();}else{t._findCurrentSpan();if(!t._oPopup.isOpen()){var v=sap.ui.getCore().getConfiguration().getRTL(),w=q(t._oCurrentSpan),x=v?-($.width()-w.position().left-w.width()):w.position().left;var y=parseInt(x,10),z=t.$("input").outerHeight()-(parseInt(q(t._oCurrentSpan).position().top,10)+q(t._oCurrentSpan).height())-10;t._iSuggestionSelectedIndex=-1;t._oPopup.setOffsetX(y);t._oPopup.setOffsetY(-z);t._oPopup.openBy(t.getDomRef("input"));}}}}});};o.prototype._createItemSpan=function(K,e){var i=function(){if(!K){return"sapCalculationBuilderItemTextEmpty";}if(e){return"sapCalculationBuilderItemTextError";}if(this._isOperator(K)){return"sapCalculationBuilderItemTextOperator";}return"sapCalculationBuilderItemTextDefault";}.bind(this);var F=K?"text":"html";var N=q('<span />',{title:e?e.title:"","class":i()})[F](K||E);return N;};o.prototype._findCurrentSpan=function(){var s;if(window.getSelection&&window.getSelection().getRangeAt){s=window.getSelection();this._oCurrentSpan=s.anchorNode.parentNode;}return this._oCurrentSpan;};o.prototype._setupSuggestionList=function(){var s=new k({path:"grouptitle",descending:false,group:function(i){return i.getProperty("grouptitle");}});var A=function(K){var N=this._createItemSpan(K);q(this._oCurrentSpan).after(N);return N;}.bind(this);var e=function($){var t=$.innerText,v=this._sSuggestionText.toLowerCase(),i=v.length,p=t.toLowerCase(),N="",u=p.indexOf(v),w;if(u>-1){N+=t.substring(0,u);w=t.substring(u,u+i);N+="<span class=\"sapMInputHighlight\">"+w+"</span>";N+=t.substring(u+i);}else{N=t;}return N;}.bind(this);this._oSuggestionList=new L({mode:b.SingleSelectMaster,showNoData:false,enableBusyIndicator:false,rememberSelections:false,items:{path:"/data",factory:function(i,p){var D=p.getProperty(p.oModel.sPath),t=new S({title:D.title,customData:[new j({key:"key",value:D.key})]});t.addStyleClass("sapCalculationBuilderSuggestionItem");return t;},sorter:s},selectionChange:function(p){var t=p.getParameter("listItem"),u,v,F,K,w;if(t){K=t.getCustomData()[0].getValue();F=this._getFunction(K);q(this._oCurrentSpan).text(F?K+"(":K+"");q(this._oCurrentSpan).removeClass("sapCalculationBuilderItemTextError").addClass("sapCalculationBuilderItemTextDefault");if(F){w=this._getFunctionTemplateItems(F);u=w.length;if(u>0){w.forEach(function(K,i){this._oCurrentSpan=A(K)[0];if(!K&&!v){v=this._oCurrentSpan;}if(K&&i!==u-1){this._oCurrentSpan=A(" ");}}.bind(this));}else{v=this._oCurrentSpan=A("")[0];}var x=A(")");if(!v){this._oCurrentSpan=x[0];}}this._storeCurrent();var y=v||this._oCurrentSpan;this.fireChange({position:this._getCaretPosition(y,F?1:y.textContent.length)});}this._oPopup.close();}.bind(this)});this._oSuggestionList.addEventDelegate({onAfterRendering:function(){this._oSuggestionList.$().find(".sapMDLILabel, .sapMSLITitleOnly, .sapMDLIValue").each(function(){this.innerHTML=e(this);});}.bind(this)});this._oPopup=new R(this.getId()+"-popup",{contentWidth:"300px",showArrow:false,showHeader:false,placement:P.Vertical,horizontalScrolling:true,content:this._oSuggestionList}).attachAfterClose(function(i){this._clearSuggestion();}.bind(this));};o.prototype._checkSuggestions=function(p,t,e){var s=t[Math.max(p-1,0)];var u=function(s){return this._isOperator(s)||this._isEmptySpace(s);}.bind(this);if(!s||u(s)){this._clearSuggestion();return;}var w=e?s:"",v=e?2:1;p=Math.max(p,0);for(var i=p-v;i>=0;i--){if(u(t[i])){break;}w=t[i]+w;}for(i=p;i<t.length;i++){if(u(t[i])){break;}w=w+t[i];}if(!w){this._clearSuggestion();}this._sSuggestionText=w||"";};o.prototype._clearSuggestion=function(){this._sSuggestionText="";this._oCurrentSpan={};this._oPopup.close();};o.prototype._filterSuggestionList=function(t){var D=[];var A=function(K,s,e,i){if(K.toLowerCase().indexOf(t.toLowerCase())!==-1){D.push({title:s||K,key:K,type:e,grouptitle:i});}};this._aVariables.forEach(function(v){A(v.getKey(),v.getLabel(),I.Variable,"Variable");});this._aFunctions.forEach(function(i){A(i.key,i.title,I.Function,"Function");});D.sort(function(e,i){return e.title.toUpperCase()<i.title.toUpperCase()?-1:1;});this._oSuggestionList.setModel(new J({"data":D}));};o.prototype._getCaretPosition=function(e,s){var p,t,u,A=0;var v=function(N){return(e&&N===e)||(!e&&(N===t.anchorNode||N===t.anchorNode.parentNode));};var w=function(N){var x;if(v(N)){return false;}if(N.nodeType===3){A+=N.textContent.length;}else{for(var i=0;i<N.childNodes.length;i++){x=N.childNodes[i];if(v(x)){return false;}A+=x.textContent.length;}}return true;};if(window.getSelection&&window.getSelection().getRangeAt){p=window.getSelection().getRangeAt(0);t=window.getSelection();u=this.$("input")[0].childNodes;for(var i=0;i<u.length;i++){if(!w(u[i])){break;}}return(s||p.startOffset)+A;}return 0;};o.prototype._getSelectionRange=function(){var s,i=0,p,t=this.$("input")[0];if(typeof window.getSelection!=="undefined"){try{var u=window.getSelection().getRangeAt(0),v=u.cloneRange();if(!q.sap.containsOrEquals(t,u.startContainer)){return this._lastRangeSelection;}v.selectNodeContents(t);v.setEnd(u.startContainer,u.startOffset);s=v.toString().length;i=s+u.toString().length;p=u.startContainer;}catch(e){s=this.$("input").text().length;}}return{start:s,startElement:p||{},length:i-s};};o.prototype._setCaretPosition=function(p){var s=window.getSelection(),i=p.span,e,t,F,u;if(p){e=this.getDomRef("input");if(!i){i=e&&e.children&&e.children.length>p.spanIndex?e.childNodes[p.spanIndex]:null;}if(i){t=document.createRange();F=i.firstChild?i.firstChild:i;u=Math.min(F.length,p.position);t.setStart(F,u);t.collapse(true);s.removeAllRanges();s.addRange(t);}}};o.prototype._recreateText=function(p){var e=function(z){var A;if(z){if(!this._isEmptySpace(z)){A=q.grep(p.errors,function(D){return D.index===v;})[0];}if(z==="┘"){z="";}H+=this._createItemSpan(z,A)[0].outerHTML;if(!this._isEmptySpace(z)){v++;}w++;}}.bind(this);var s=function(){for(;i<u.length;i++){t();if(!this._isEmptySpace(u[i])&&u[i]!=="("){i--;break;}W+=u[i];if(u[i]==="("){break;}}e(W);W="";}.bind(this);var t=function(z){if(!x&&p.position===i){x={spanIndex:w-(z||0),position:z||W.length};}};var H="",u,v=0,w=0,x=null,W="",y;u=p.text||G(this.$("input")[0],true);for(var i=0;i<u.length;i++){y=u[i];t();if(y==="┘"||this._isEmptySpace(y)||this._isOperator(y)){if(this._isFunction(W)){s();}else{e(W);e(y);W="";}if(y==="┘"){i++;t(1);}}else{W+=y;}}e(W);this.$("input").html(H);if(p.position>0){this._setCaretPosition(x||{spanIndex:w-1,position:Number.MAX_SAFE_INTEGER});}};o.prototype._stringToItems=function(e){var i=[],s="",p="",t=0;var u=function(){var F,w="";if(p){F=this._getFunction(p);if(F){if(e[t]!=="("){w=I.Error;for(;t<e.length;t++){if(e[t]==="("){w="";break;}if(!this._isEmptySpace(e[t])){t--;break;}}}}var x=new a({key:p});x._sType=w;i.push(x);}p="";return!!F||!!w;}.bind(this);if(!e){e=G(this.$("input")[0],true);}for(;t<e.length;t++){s=e[t];if(s==="┘"){i.push(new a());t++;continue;}if(this._isEmptySpace(s)){if(p){u();}continue;}var N=e[t+1];if(N&&this._isOperator(s+N,false)){s+=N;t++;}var v=this._isOperator(s,false);if(v){if(u()){continue;}i.push(new a({key:s}));}else{p+=s;}}u();return i;};o.prototype._itemsToString=function(p){var e=p.items,s="",t="",u,v,V;var w=function(x){var y="";if(x){y=x.getKey();u=this._isFunction(y);if(u){y+="(";}}return y;}.bind(this);for(var i=0;i<e.length;i++){v=q.grep(p.errors,function(x){return x.index===i;})[0];V=w(e[i]);t+=this._createItemSpan(V,v)[0].outerHTML;if(!u&&V!=="("&&w(e[i+1])!==")"){t+=this._createItemSpan(" ")[0].outerHTML;}s+=V;}this.$("input").html(t);return s;};o.prototype.onsapfocusleave=function(e){if(e.relatedControlId&&q.sap.containsOrEquals(this._oPopup.getDomRef(),sap.ui.getCore().byId(e.relatedControlId).getFocusDomRef())){this.focus();}};o.prototype.onsappageup=function(e){this._suggestionListKeyHandling({event:e,add:true,toEnd:true});};o.prototype.onsappagedown=function(e){this._suggestionListKeyHandling({event:e,add:false,toEnd:true});};o.prototype.onsapdown=function(e){this._suggestionListKeyHandling({event:e,add:true});};o.prototype.onsapescape=function(e){if(this._oPopup.isOpen()){this._oPopup.close();}};o.prototype.onsapup=function(e){this._suggestionListKeyHandling({event:e,add:false});};o.prototype.onsapenter=function(e){if(this._oPopup.isOpen()){this._oSuggestionList.fireSelectionChange({listItem:this._oSuggestionList.getSelectedItem()});}e.preventDefault();e.stopPropagation();};o.prototype._suggestionListKeyHandling=function(p){var e=p.event,A=p.add,t=p.toEnd,i,s;if(!this._oPopup.isOpen()||!e){return;}A?this._iSuggestionSelectedIndex++:this._iSuggestionSelectedIndex--;i=this._oSuggestionList.$().find(".sapCalculationBuilderSuggestionItem");s=i.length;if((this._iSuggestionSelectedIndex<0)||(!A&&t)){this._iSuggestionSelectedIndex=s-1;}else if((this._iSuggestionSelectedIndex>=s)||(A&&t)){this._iSuggestionSelectedIndex=0;}this._oSuggestionList.removeSelections(true);sap.ui.getCore().byId(i[this._iSuggestionSelectedIndex].id).setSelected(true).focus();e.preventDefault();e.stopPropagation();};o.prototype._displayError=function(s){this.$("input")[s?"addClass":"removeClass"]("sapCalculationBuilderInputError");};o.prototype._insertItemFromToolbar=function(K){var $=this.$("input"),t,N,e;var s=" "+K+" ",F=this._getFunction(K),i=s.length,p;var u=function(){return{start:$.text().length,length:0};};e=this._getSelectionRange()||u();$.focus();this._lastRangeSelection={};t=G($[0],true);if(t[e.start]==="┘"&&t[e.start-1]==="┘"&&e.length===0){e.start--;e.length+=2;}if(F){s=" "+K+"(";p=this._getFunctionTemplateItems(F);if(p.length>0){p.forEach(function(K){s+=K?K:m;});}else{s+=m;}s+=") ";i=s.indexOf(m)+1;}N=[t.slice(0,e.start),s,t.slice(e.start+e.length)].join('');this.fireChange({value:N,position:e.start+i});this._storeCurrent();};o.prototype._fillInputToolbar=function(){var e=function(z,A){return new B({type:c.Transparent,text:z==="*"?"x":z,press:this._insertItemFromToolbar.bind(this,z)}).addStyleClass("sapCalculationBuilderInputToolbarButtons "+A);}.bind(this);var i=function(z){return z.map(function(A){return new f({key:A.getKey(),text:A._getLabel()});}).sort(function(A,D){return A.getText().localeCompare(D.getText());});};var p=function(K){return K.map(function(z){return new f({key:z,text:z});});};var s=function(){var z=this.getParent().getAllowComparisonOperators(),A=this.getParent().getAllowLogicalOperators();if(z&&A){return[new f({text:r.getText("CALCULATION_BUILDER_COMPARISON_TITLE"),items:p(Object.keys(u))}),new f({text:r.getText("CALCULATION_BUILDER_LOGICAL_TITLE"),items:p(Object.keys(v))})];}else if(z){return p(Object.keys(u));}else if(A){return p(Object.keys(v));}return[];}.bind(this);var t=l.CalculationBuilderOperatorType,u=l.CalculationBuilderComparisonOperatorType,v=l.CalculationBuilderLogicalOperatorType,w=s(),x=this.getParent(),y=!!x.getTitle()&&(x.getLayoutType()===l.CalculationBuilderLayoutType.TextualOnly),F;this._oInputToolbar.removeAllContent();this._oInputToolbar.addContent(new h({text:x.getTitle(),visible:y}));this._oInputToolbar.addContent(new g());Object.keys(t).forEach(function(K){this._oInputToolbar.addContent(e(t[K],""));}.bind(this));this._oInputToolbar.addContent(new T().addStyleClass("sapUiSmallMarginBeginEnd"));if(w.length>0){this._oInputToolbar.addContent(new d({text:r.getText("CALCULATION_BUILDER_OPERATORS_TITLE"),menu:new M({itemSelected:function(z){this._insertItemFromToolbar(z.getParameters().item.getKey());}.bind(this),items:w})}));}F=this._aFunctions.map(function(z){return new f({key:z.key,text:z.title});});this._oInputToolbar.addContent(new d({text:r.getText("CALCULATION_BUILDER_FUNCTIONS_AND_VARIABLES_TITLE"),menu:new M({itemSelected:function(z){this._insertItemFromToolbar(z.getParameters().item.getKey());}.bind(this),items:[new f({text:r.getText("CALCULATION_BUILDER_FUNCTIONS_TITLE"),items:[F]}),new f({text:r.getText("CALCULATION_BUILDER_VARIABLES_TITLE"),items:i(this.getParent().getVariables())})]})}).addStyleClass("sapUiSmallMarginBegin"));};o.prototype._isOperator=function(s,A){return this.getParent()&&this.getParent()._isOperator(s,A);};o.prototype._getFunctionTemplateItems=function(F){return this.getParent()._getFunctionTemplateItems(F);};o.prototype._isEmptySpace=function(s){return s===String.fromCharCode(160)||s===" ";};o.prototype._isEmptyItem=function(t){return t===E;};o.prototype._getText=function(){return this.$("input").text();};o.prototype._isFunction=function(K){return!!this._getFunction(K);};o.prototype._getFunction=function(K){return this.getParent()._getFunctionDefinition(K);};o.prototype._storeCurrent=function(v){var $=this.$("input");$.data('before',$.text());};return o;},true);
