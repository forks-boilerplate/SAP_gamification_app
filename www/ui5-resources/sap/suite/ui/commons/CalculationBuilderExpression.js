sap.ui.define(["jquery.sap.global","./library","./CalculationBuilderItem","sap/ui/core/Control","sap/ui/core/ValueState","sap/ui/core/Popup","sap/ui/core/TextAlign","sap/ui/core/delegate/ItemNavigation","sap/m/MessageBox","sap/m/OverflowToolbar","sap/m/OverflowToolbarToggleButton","sap/m/OverflowToolbarButton","sap/m/ToolbarSpacer","sap/m/Title","sap/m/ButtonType","sap/m/Button","sap/m/FlexBox","sap/m/FlexRendertype","sap/m/FlexAlignItems","sap/m/FlexDirection","sap/m/SegmentedButton","sap/m/SegmentedButtonItem","sap/m/StepInput","sap/m/Input","sap/m/InputType","sap/m/Page","sap/m/List","sap/m/ListMode","sap/m/ListType","sap/m/StandardListItem","sap/m/NavContainer","sap/m/SearchField","sap/m/Label","sap/m/Panel","sap/m/ResponsivePopover","sap/m/PlacementType","sap/m/Toolbar","./CalculationBuilderValidationResult","sap/ui/thirdparty/jqueryui/jquery-ui-core","sap/ui/thirdparty/jqueryui/jquery-ui-widget","sap/ui/thirdparty/jqueryui/jquery-ui-mouse","sap/ui/thirdparty/jqueryui/jquery-ui-draggable","sap/ui/thirdparty/jqueryui/jquery-ui-droppable","sap/ui/thirdparty/jqueryui/jquery-ui-selectable"],function(q,l,C,a,V,P,T,I,M,O,b,c,d,e,B,f,F,g,h,j,S,k,m,n,o,p,L,r,s,t,N,u,v,w,R,x,y,z){"use strict";var A=l.CalculationBuilderItemType,D=l.CalculationBuilderOperatorType,E=l.CalculationBuilderComparisonOperatorType,G=l.CalculationBuilderLogicalOperatorType;var H=Object.freeze({PAGE_MAIN:"-pagemain",PAGE_OPERATORS:"-pageoperators",PAGE_CONSTANT:"-pageconstant",PAGE_VARIABLE:"-pagevariable",PAGE_FUNCTIONS:"-pagefunctions"});var J=Object.freeze({OPERATORS_CATEGORY:"sap-icon://attachment-html",CONSTANTS_CATEGORY:"sap-icon://grid",VARIABLES_CATEGORY:"sap-icon://notes",FUNCTIONS_CATEGORY:"sap-icon://chalkboard",DELETE:"sap-icon://delete"});var K=Object.freeze({KEY_PREVIOUS:"previous",KEY_NEXT:"next",MOUSE:"mouse"});var Q=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var U=a.extend("sap.suite.ui.commons.CalculationBuilderExpression",{metadata:{library:"sap.suite.ui.commons",defaultAggregation:"items",aggregations:{items:{type:"sap.suite.ui.commons.CalculationBuilderItem",multiple:true,singularName:"item",bindable:"bindable"},variables:{type:"sap.suite.ui.commons.CalculationBuilderVariable",multiple:true,singularName:"Variable"},functions:{type:"sap.suite.ui.commons.CalculationBuilderFunction",multiple:true,singularName:"Function"}},events:{change:{}}},renderer:function(W,X){W.write("<div");W.writeControlData(X);W.addClass("sapCalculationBuilderInner");W.writeClasses(X);W.write(">");W.write(X._renderDelimiter(0));X.getItems().forEach(function(Y,i){Y._iIndex=i;Y._bReadOnly=X._bReadOnly;W.renderControl(Y);W.write(X._renderDelimiter(i+1));},this);if(!X._bReadOnly){W.renderControl(X._getNewItem());}W.write("<div class=\"sapCalculationBuilderSelected\"></div>");W.write("</div>");}});U.prototype.init=function(){this._bIsCalculationBuilderRendering=false;this._aErrors=[];this._bAreSelectedItemsDeleting=false;this._bDragging=false;this._bSkipValidation=false;this._bIsCalculationBuilderRendering=false;};U.prototype._renderDelimiter=function(i){var W="";W+="<div class=\"sapCalculationBuilderDelimiter sapCalculationBuilderDroppable\" index=\""+i+"\">";W+="<div class=\"sapCalculationBuilderDelimiterNewButton\" index=\""+i+"\">";W+="<span role=\"presentation\" aria-hidden=\"true\" data-sap-ui-icon-content=\"îˆ½\""+"class=\"sapUiIcon sapUiIconMirrorInRTL sapCalculationBuilderDelimiterNewButtonIcon\" style=\"font-family:'SAP-icons'\"></span>";W+="</div>";W+="</div>";return W;};U.prototype.onBeforeRendering=function(){this._createPopup();this.getParent()._enableOrDisableExpandAllButton();if(!this._bSkipValidation){this._aErrors=this._validateSyntax();this._fireAfterValidation();}this._bSkipValidation=false;this._bIsCalculationBuilderRendering=true;};U.prototype.onAfterRendering=function(){this._bIsCalculationBuilderRendering=false;if(!this._bReadOnly){this._setupDroppable();this._setupSelectable();this._setupNewButtonEvents();}this._setupKeyboard();};U.prototype.onsapfocusleave=function(){if(!this._bAreSelectedItemsDeleting){this._deselect();}};U.prototype.onsapenter=function(i){this._handleEnter(i);};U.prototype.onsapspace=function(i){if(q(i.target).hasClass("sapCalculationBuilderItem")){this._handleSpace(i);}};U.prototype.onsappreviousmodifiers=function(i){if(i.ctrlKey){this._handleCtrlPrevious(i);}};U.prototype.onsapnextmodifiers=function(i){if(i.ctrlKey){this._handleCtrlNext(i);}};U.prototype.onsapdelete=function(i){this._handleDelete(i);};U.prototype.exit=function(){if(this._oPopover){this._oPopover.destroy();}if(this._oItemNavigation){this.removeDelegate(this._oItemNavigation);this._oItemNavigation.destroy();}};U.prototype._createPopup=function(){var i={};if(this._oPopover){return;}this._createPopoverLayout(i);this._createPopoverConstantsItems(i);this._createPopoverVariablesItems(i);this._createPopoverFunctionsItems(i);this._createPopoverOperatorsItems(i);this._createPopoverNavContainer(i);this._createPopover(i);};U.prototype._createPopoverLayout=function(i){var W=function(Y){return new f({text:Y==="*"?"x":Y,press:this._updateOrCreateItem.bind(this,{type:A.Operator,key:Y})}).addStyleClass("sapUiTinyMarginEnd");}.bind(this);var X=new F({renderType:g.Div});X.addStyleClass("sapCalculationBuilderItemPopupOperators");Object.keys(D).forEach(function(Y){X.addItem(W(D[Y]));});i.layout=X;};U.prototype._createPopoverConstantsItems=function(i){i.constantInput=new n({type:o.Number,width:"100%",placeholder:Q.getText("CALCULATION_BUILDER_ADD_CONSTANT_FIELD_PLACEHOLDER"),textAlign:T.Right,valueStateText:Q.getText("CALCULATION_BUILDER_ADD_CONSTANT_FIELD_ERROR_TEXT"),submit:function(W){if(i.constantInput.getValue()!==""){this._updateOrCreateItem({type:A.Constant,key:i.constantInput.getValue()});}}.bind(this)});};U.prototype._createPopoverVariablesItems=function(i){var W=[];this.getVariables().forEach(function(X){var Y=new t({title:X._getLabel()});Y._calculationBuilderKey=X.getKey();W.push(Y);},this);W=W.sort(function(X,Y){return X.getTitle().localeCompare(Y.getTitle());});i.variablesList=new L({mode:r.SingleSelectMaster,selectionChange:function(X){this._updateOrCreateItem({type:A.Variable,key:X.getParameter("listItem")._calculationBuilderKey});}.bind(this),items:W});i.searchField=new u({placeholder:Q.getText("CALCULATION_BUILDER_SEARCH_VARIABLE"),liveChange:function(X){var Y=X.getSource().getValue();if(Y||Y===""){i.variablesList.removeAllItems();W.forEach(function(Z){if(Z.getTitle().toLowerCase().indexOf(Y.toLowerCase())!==-1){i.variablesList.addItem(Z);}});}}});};U.prototype._createPopoverFunctionsItems=function(i){var W=this,X=this.getParent();var Y=function(Z){return new t({title:Z.title,description:Z.description,type:s.Active,customData:[{key:"functionKey",value:Z.key}],press:Z.press});};i.functionList=new L({mode:r.SingleSelectMaster,itemPress:function(){this.getSelectedItem().firePress();}});X._getAllFunctions().forEach(function(Z){i.functionList.addItem(Y({key:Z.key,title:Z.title,description:Z.description,press:W._updateOrCreateItem.bind(W,{key:Z.key,type:Z.type,functionObject:Z.functionObject})}));});};U.prototype._createPopoverOperatorsItems=function(i){var W=function(Y){var Z=[];Object.keys(Y).forEach(function($){Z.push(new f({text:Y[$],press:this._updateOrCreateItem.bind(this,{type:A.Operator,key:Y[$]})}).addStyleClass("sapCalculationBuilderPopoverOperatorsButton").addStyleClass("sapUiTinyMarginEnd"));}.bind(this));return Z;}.bind(this);var X=function(Y,Z){return new w({content:[new e({width:"100%",text:Y}),W(Z)]});};i.operatorsItems=[];if(this.getParent().getAllowComparisonOperators()){i.operatorsItems.push(X("Comparison operators:",E));}if(this.getParent().getAllowLogicalOperators()){i.operatorsItems.push(X("Logical operators:",G));}};U.prototype._createPopoverNavContainer=function(i){var W=function($){var _=Z.getPage($);Z.to(_);};var X=function(){Z.back();};var Y=[new t({title:Q.getText("CALCULATION_BUILDER_CONSTANTS_TITLE"),type:s.Active,description:Q.getText("CALCULATION_BUILDER_CONSTANTS_CATEGORY_DESCRIPTION"),icon:J.CONSTANTS_CATEGORY,press:W.bind(this,this.getId()+H.PAGE_CONSTANT)}),new t({title:Q.getText("CALCULATION_BUILDER_VARIABLES_TITLE"),description:Q.getText("CALCULATION_BUILDER_VARIABLES_CATEGORY_DESCRIPTION"),icon:J.VARIABLES_CATEGORY,press:W.bind(this,this.getId()+H.PAGE_VARIABLE),type:s.Active}),new t({title:Q.getText("CALCULATION_BUILDER_FUNCTIONS_TITLE"),type:s.Active,description:Q.getText("CALCULATION_BUILDER_FUNCTIONS_CATEGORY_DESCRIPTION"),icon:J.FUNCTIONS_CATEGORY,press:W.bind(this,this.getId()+H.PAGE_FUNCTIONS)})];if(i.operatorsItems.length>0){Y.unshift(new t({title:Q.getText("CALCULATION_BUILDER_OPERATORS_TITLE"),type:s.Active,description:Q.getText("CALCULATION_BUILDER_OPERATORS_CATEGORY_DESCRIPTION"),icon:J.OPERATORS_CATEGORY,press:W.bind(this,this.getId()+H.PAGE_OPERATORS)}));}var Z=new N({defaultTransitionName:"show",navigate:function($){var _=$.getParameters().to;_.setFooter(this._getPageFooter(_.getId(),i));}.bind(this),pages:[new p({id:this.getId()+H.PAGE_MAIN,showHeader:false,content:[i.layout,new F({direction:j.Column,items:[new L({items:Y})]}).addStyleClass("sapUiTinyMargin").addStyleClass("sapCalculationBuilderNavMainPage")]}),new p({id:this.getId()+H.PAGE_OPERATORS,content:[new F({direction:j.Column,items:[i.operatorsItems]}).addStyleClass("sapUiSmallMargin")],showNavButton:true,title:Q.getText("CALCULATION_BUILDER_OPERATORS_PAGE_TITLE"),navButtonPress:X}),new p({id:this.getId()+H.PAGE_CONSTANT,content:[new F({direction:j.Column,items:[i.constantInput]}).addStyleClass("sapUiSmallMargin")],showNavButton:true,title:Q.getText("CALCULATION_BUILDER_CONSTANTS_PAGE_TITLE"),navButtonPress:X}),new p({id:this.getId()+H.PAGE_VARIABLE,content:[new F({direction:j.Column,items:[i.searchField,i.variablesList]}).addStyleClass("sapUiTinyMargin")],showNavButton:true,title:Q.getText("CALCULATION_BUILDER_VARIABLES_PAGE_TITLE"),navButtonPress:X}),new p({id:this.getId()+H.PAGE_FUNCTIONS,content:[new F({direction:j.Column,items:[i.functionList]}).addStyleClass("sapUiTinyMargin")],showNavButton:true,title:Q.getText("CALCULATION_BUILDER_FUNCTIONS_PAGE_TITLE"),navButtonPress:W.bind(this,this.getId()+H.PAGE_MAIN)})]});i.navContainer=Z;};U.prototype._createPopover=function(W){var X=function(){var Y=this._oCurrentItem,Z=W.navContainer.getCurrentPage().getId(),$=W.variablesList.getSelectedItem(),_=W.functionList.getSelectedItem(),a1,b1,c1,d1;W.constantInput.setValue("");if($){W.variablesList.setSelectedItem($,false);}if(_){W.functionList.setSelectedItem(_,false);}if(!Y){a1=this.getId()+H.PAGE_MAIN;}else{if(Y._isFunction()){d1=Y.getKey();a1=this.getId()+H.PAGE_FUNCTIONS;c1=W.functionList.getItems();for(var i=0;i<c1.length;i++){var e1=c1[i].data("functionKey");if((e1&&e1.toLowerCase())===d1.toLowerCase()){W.functionList.setSelectedItem(c1[i],true);break;}}}else if(Y._isConstant()){W.constantInput.setValue(Y.getKey());a1=this.getId()+H.PAGE_CONSTANT;}else if(Y._isVariable()){b1=W.variablesList.getItems();for(var i=0;i<b1.length;i++){if(b1[i].getTitle()===Y.getKey()){W.variablesList.setSelectedItem(b1[i],true);break;}}a1=this.getId()+H.PAGE_VARIABLE;}else{a1=this.getId()+H.PAGE_MAIN;}}if(a1!==Z){if(a1!==this.getId()+H.PAGE_MAIN){W.navContainer.backToPage(this.getId()+H.PAGE_MAIN);}W.navContainer.to(W.navContainer.getPage(a1),"show");}else{W.navContainer.getCurrentPage().setFooter(this._getPageFooter(Z,W));}}.bind(this);this._oPopover=new R({showHeader:false,contentWidth:"370px",contentHeight:"400px",placement:x.Bottom,content:[W.navContainer],beforeOpen:X,afterClose:function(){this._bDragging=false;this._clearNewButtonPositions();}.bind(this)});};U.prototype._getPageFooter=function(i,W){var X=false,Y=false,Z=function(){};if(this._oCurrentItem&&!this._oCurrentItem._bIsNew){Y=true;}if(i===(this.getId()+H.PAGE_CONSTANT)){X=true;Z=function(){if(W.constantInput.getValue()!==""){this._updateOrCreateItem({type:A.Constant,key:W.constantInput.getValue()});W.constantInput.setValueState(V.None);}else{W.constantInput.setValueState(V.Error);}}.bind(this);}return new y({content:[new f({enabled:Y,text:Q.getText("CALCULATION_BUILDER_DELETE_BUTTON"),press:this._deleteItem.bind(this)}),new d(),new f({enabled:X,text:Q.getText("CALCULATION_BUILDER_CONFIRM_BUTTON"),press:Z}),new f({text:Q.getText("CALCULATION_BUILDER_CLOSE_BUTTON"),press:this._instantClose.bind(this)})]});};U.prototype._updateOrCreateItem=function(i){var W=!this._oCurrentItem||this._oCurrentItem._bIsNew,X=this.getParent(),Y=i.functionObject,Z;if(W){this._oCurrentItem=new C({key:i.key});Z=isNaN(this._iCurrentIndex)?this.getItems().length:this._iCurrentIndex;this.insertItem(this._oCurrentItem,Z);if(Y){var $=i.type===A.Function?Y.template:X._convertToTemplate(Y.getItems());X._insertFunctionItems($,Z+1);}}else{this._oCurrentItem.setKey(i.key);Z=this.getItems().indexOf(this._oCurrentItem);}if(i.type){this._oCurrentItem._sType=i.type;}this._instantClose();this._aErrors=this._validateSyntax();this._fireAfterValidation();if(W){this._bSkipValidation=true;}this._fireChange();};U.prototype._expandAllVariables=function(){this.getItems().forEach(function(i){if(i.isExpandable()){i._expandVariable(false);}});this._aErrors=this._validateSyntax();this._fireAfterValidation();this._fireChange();};U.prototype._handleDelete=function(i){if(this._isEmptySelected()){return;}this._bAreSelectedItemsDeleting=true;M.show(Q.getText("CALCULATION_BUILDER_DELETE_MESSAGE_TEXT"),{icon:M.Icon.WARNING,title:Q.getText("CALCULATION_BUILDER_DELETE_MESSAGE_TITLE"),actions:[M.Action.YES,M.Action.CANCEL],onClose:function(W){var X=this;if(W===M.Action.YES){this.$().find(".sapCalculationBuilderSelected .sapCalculationBuilderItem").each(function(){X.removeItem(sap.ui.getCore().byId(q(this)[0].id));});this._fireChange();}this._bAreSelectedItemsDeleting=false;}.bind(this)});};U.prototype._handleEnter=function(i){var $=q(i.target),W;if(this._oItemNavigation&&!this._bReadOnly){if($.hasClass("sapCalculationBuilderNewItem")){W=this._getNewItem();if(W){W._buttonPress(i);}}else if($.hasClass("sapCalculationBuilderItem")){W=this._getItemById($[0].id);if(W){W._buttonPress(i);}}else if($.hasClass("sapCalculationBuilderItemExpandButton")){W=this._getItemById($.closest(".sapCalculationBuilderItem")[0].id);if(W){W._expandButtonPress(i);}}}};U.prototype._handleSpace=function(i){this._selectItem(i.target);};U.prototype._handleCtrlNext=function(i){this._moveItems(K.KEY_NEXT);};U.prototype._handleCtrlPrevious=function(i){this._moveItems(K.KEY_PREVIOUS);};U.prototype._getVariableByKey=function(W){var X=this.getVariables();if(!W){return null;}W=W.toLowerCase();for(var i=0;i<X.length;i++){if(X[i].getKey().toLowerCase()===W){return X[i];}}return null;};U.prototype.setTitle=function(i){var W=this._oToolbarTitle;if(W){W.setText(i);W.setVisible(!!i);}this.setProperty("title",i);};U.prototype._deleteItem=function(){this.removeItem(this._oCurrentItem);this._aErrors=this._validateSyntax();this._fireAfterValidation();this._instantClose();this._fireChange();};U.prototype._openDialog=function(i){this._oCurrentItem=i.currentItem;this._iCurrentIndex=i.index;this._oPopover.openBy(i.opener);};U.prototype._setupDroppable=function(i){var W=this;i=i||this.$().find(".sapCalculationBuilderDroppable");i.droppable({scope:W.getId()+"-scope",tolerance:"pointer",activeClass:"sapCalculationBuilderDroppableActive",hoverClass:"sapCalculationBuilderDroppableActive",drop:function(X,Y){if(!Y.draggable.hasClass("sapCalculationBuilderSelected")){W._selectItem(Y.draggable[0]);}W._moveItems(K.MOUSE,parseInt(q(this).attr("index"),10));W._bDragging=false;},over:function(X,Y){W._bDragging=true;}});};U.prototype._clearNewButtonPositions=function(){var $=this.$();$.find(".sapCalculationBuilderDelimiterNewButton").hide(200).css("opacity",0.5);$.find(".sapCalculationBuilderItem").animate({"left":0},300);};U.prototype._setupNewButtonEvents=function(){var i=13,W=300;var X=this.$().find(".sapCalculationBuilderDelimiter[data-events!='bound']"),Y=this.$().find(".sapCalculationBuilderDelimiterNewButton[data-events!='bound']"),Z=this,$,_;var a1=function(b1,c1){b1.prev().animate({"left":-c1},W);b1.next().animate({"left":c1},W);};Y.click(function(ev){var b1=q(this),c1=parseInt(b1.attr("index"),10);b1.css("opacity",1);Z._oCurrentItem=null;Z._iCurrentIndex=c1;Z._openDialog({opener:this,index:c1});});Y.attr("data-events","bound");X.mouseover(function(ev){var b1=q(this);if(!Z._bDragging&&!Z._oPopover.isOpen()){$=true;_=setTimeout(function(){if($){$=false;a1(b1,i);b1.find(".sapCalculationBuilderDelimiterNewButton").show(200);}},700);}});X.mouseout(function(ev){var b1=q(this).find(".sapCalculationBuilderDelimiterNewButton"),c1=q(this);$=false;clearTimeout(_);if(Z._bDragging||Z._oPopover.isOpen()){return;}if(!b1.is(':hover')){a1(c1,0);b1.hide(200).css("opacity",0.5);}});X.attr("data-events","bound");};U.prototype._setupSelectable=function(){this.$().selectable({cancel:".sapCalculationBuilderCancelSelectable",distance:5,start:function(){this._deselect();this._instantClose();}.bind(this),stop:function(){this._selectItems(this.$().find(".sapCalculationBuilderItem.ui-selected"));}.bind(this)});};U.prototype._selectItemsTo=function($){var i=q($.next(".sapCalculationBuilderDelimiter")[0]),W=i.attr("index")-1,X=this.$(),Y,Z,_,a1,b1;if($.parent().hasClass("sapCalculationBuilderSelected")||this._isEmptySelected()){this._selectItem($);return;}if(W>this._iLastSelectedIndex){Y=this._iFirstSelectedIndex;Z=W+1;}else{Y=W;Z=this._iLastSelectedIndex+1;}this._deselect();a1=X.find(".sapCalculationBuilderDelimiter[index=\""+Y+"\"]");b1=X.find(".sapCalculationBuilderDelimiter[index=\""+Z+"\"]");_=a1.nextUntil(b1,".sapCalculationBuilderItem");this._selectItems(_);};U.prototype._selectItems=function(W){for(var i=0;i<W.length;i++){this._selectItem(W[i]);}};U.prototype._selectItem=function(i){var $=this.$().find(".sapCalculationBuilderSelected"),W=q(i),X=q(W.next(".sapCalculationBuilderDelimiter")[0]),Y=$[0].children.length,Z=X.attr("index")-1,_=true;if(!this._oItemNavigation||!this._getItemById(W[0].id)||this._bReadOnly){return;}if(Y===0){this._iFirstSelectedIndex=Z;this._iLastSelectedIndex=Z;}else{if(W.parent().hasClass("sapCalculationBuilderSelected")){if(this._iFirstSelectedIndex===Z){this._iFirstSelectedIndex++;this._deselectItem(W,false);}else if(this._iLastSelectedIndex===Z){this._iLastSelectedIndex--;this._deselectItem(W,true);}else{this._deselect();}this._setCorrectFocus();return;}if((this._iFirstSelectedIndex-Z)===1){this._iFirstSelectedIndex=Z;_=false;}else if((Z-this._iLastSelectedIndex)===1){this._iLastSelectedIndex=Z;_=true;}else{this._iFirstSelectedIndex=Z;this._iLastSelectedIndex=Z;this._deselect();}}if(this._isEmptySelected()){$.detach().insertBefore(W);$.draggable({revert:"invalid",axis:"x",scope:this.getId()+"-scope"});}if(_){W.detach().appendTo($);X.detach().appendTo($);}else{X.detach().prependTo($);W.detach().prependTo($);}if(W.hasClass("sapCalculationBuilderItem")){W.draggable("disable");W.addClass("ui-selected");}this._setCorrectFocus();};U.prototype._isEmptySelected=function(){var $=this.$().find(".sapCalculationBuilderSelected");if($){return $.is(":empty");}return true;};U.prototype._deselectItem=function($,i){var W=this.$().find(".sapCalculationBuilderSelected"),X=q($.next(".sapCalculationBuilderDelimiter")[0]);if(!$.hasClass("ui-selected")){return;}if(i){X.detach().insertAfter(W);$.detach().insertAfter(W);}else{$.detach().insertBefore(W);X.detach().insertBefore(W);}$.draggable("enable");$.removeClass("ui-selected");};U.prototype._deselect=function(){var $=this.$().find(".sapCalculationBuilderSelected");if(this._isEmptySelected()){return;}this.$().find(".sapCalculationBuilderSelected .ui-selected").removeClass("ui-selected");$.children().each(function(){var i=q(this);if(i.hasClass("sapCalculationBuilderItem")){i.draggable("enable");}i.detach().insertBefore($);});};U.prototype._setupKeyboard=function(){var i=this.getDomRef(),W=[];this.getItems().forEach(function(X){W.push(X.getFocusDomRef());if(X.isExpandable()){W.push(X.$("expandbutton"));}});W.push(this._getNewItem().getFocusDomRef());if(!this._oItemNavigation){this._oItemNavigation=new I();this.addDelegate(this._oItemNavigation);}this._oItemNavigation.setRootDomRef(i);this._oItemNavigation.setItemDomRefs(W);this._oItemNavigation.setCycling(true);this._oItemNavigation.setPageSize(250);};U.prototype._setCorrectFocus=function(){q(this._oItemNavigation.getFocusedDomRef()).focus();};U.prototype._getItemById=function(i){return this.getItems().filter(function(W){return W.getId()===i;})[0];};U.prototype._getNewItem=function(){if(!this._oNewItem){this._oNewItem=new C();this._oNewItem._bIsNew=true;this._oNewItem.setParent(this,null,true);}return this._oNewItem;};U.prototype._instantClose=function(){var i=this._oPopover.getAggregation("_popup");if(i&&i.oPopup&&i.oPopup.close){i.oPopup.close(0);this._setCorrectFocus();}};U.prototype._printErrors=function(){this.getItems().forEach(function(i){var W=i._getItemError(),$=i.$(),X=!!W?"addClass":"removeClass";$[X]("sapCalculationBuilderItemErrorSyntax");$.attr("title",W?W.title:"");});};U.prototype._validateSyntax=function(W){var X=function(){var r1=this.getItems()[i1],s1=r1.getKey();return!r1._isOperator()||s1==="("||s1==="+"||s1==="-"||s1.toLowerCase()==="not";}.bind(this);var Y=function(){var c1=this.getItems(),r1=c1[j1-1];return!r1._isOperator()||r1.getKey()===")";}.bind(this);var Z=function(f1){var r1=f1.getKey().toLowerCase();if(f1._isOperator()){return r1==="not"||r1==="("||r1===")"?r1:"#op#";}return f1._isFunction()?"#fun#":"#col#";};var $=function(f1){return{index:i,item:f1,items:[],text:f1.getKey()+(f1._isFunction()?"(":"")};};var _=function(o1){var r1=1,s1=i;i++;for(;i<c1.length;i++){var f1=c1[i],t1=f1.getKey(),u1=$(f1);o1.items.push(u1);switch(t1){case")":r1--;break;case"(":r1++;break;case",":r1=1;break;}if(f1._isFunction()){_(u1);o1.text+=u1.text;}else{o1.text+=t1;}if(r1===0){return o1;}}m1.push({index:s1,title:Q.getText("CALCULATION_BUILDER_CLOSING_BRACKET_ERROR_TEXT")});return o1;};var a1=function(o1){var r1=this.getParent()._getFunctionAllowParametersCount(o1.item.getKey()),s1=[],t1=[];o1.items.forEach(function(f1){if(f1.item._isComma()){s1.push(t1);t1=[];}else{t1.push(f1);}});if(t1.length>0&&t1[t1.length-1].text===")"){t1.pop();}s1.push(t1);if(s1.length!==r1){m1.push({index:o1.index,title:Q.getText(s1.length<r1?"CALCULATION_BUILDER_TOO_LITTLE_PARAMETERS":"CALCULATION_BUILDER_TOO_MANY_PARAMETERS")});}if(s1.length>0){s1.forEach(function(u1){if(u1.length>0){q.merge(m1,this._validateSyntax({from:u1[0].index,to:u1[u1.length-1].index+1}));}else{m1.push({index:o1.index,title:Q.getText("CALCULATION_BUILDER_EMPTY_PARAMETER")});}}.bind(this));}}.bind(this);var b1={"#op#":["(","#col#","#fun#","not"],"(":["(","+","-","#col#","#fun#","not"],")":["#op#",")"],"#col#":["#op#",")"],"#fun#":["(","+","-","#col#","#fun#"],"not":["#col#","#fun#","not","("]};W=W||{};var c1=W.items||this.getItems(),d1,e1,f1,g1,h1,i1=W.from||0,j1=W.to||c1.length,k1=(i1===0&&j1===c1.length),l1=[],m1=[];if(c1.length>0){if(!X()){m1.push({index:i1,title:Q.getText("CALCULATION_BUILDER_FIRST_CHAR_ERROR_TEXT")});}if(!Y()){m1.push({index:j1-1,title:Q.getText("CALCULATION_BUILDER_LAST_CHAR_ERROR_TEXT")});}}for(var i=i1;i<j1;i++){f1=c1[i];if(f1._getType()===A.Error){m1.push({index:i,title:Q.getText("CALCULATION_BUILDER_SYNTAX_ERROR_TEXT")});continue;}if(!W.skipCustomValidation&&f1._isFunction()){var n1=f1._getCustomFunction(),o1=_($(f1));if(n1&&!n1.getUseDefaultValidation()){var p1=new z();this.getParent().fireValidateFunction({definition:o1,customFunction:n1,result:p1});q.merge(m1,p1.getErrors());}else{a1(o1);}}if(i<j1-1){g1=c1[i+1];d1=Z(c1[i]);e1=Z(g1);h1=g1?g1.getKey().toLowerCase():"";if(b1[d1].indexOf(e1)===-1&&b1[d1].indexOf(h1)===-1){var q1={index:i+1};if(f1._isOperator()&&g1._isOperator()){q1.title=Q.getText("CALCULATION_BUILDER_BEFORE_OPERATOR_ERROR_TEXT",g1.getKey());}else if(!f1._isOperator()&&!g1._isOperator()){q1.title=Q.getText("CALCULATION_BUILDER_BETWEEN_NOT_OPERATORS_ERROR_TEXT",[f1.getKey(),g1.getKey()]);}else if(f1.getKey()===")"&&!g1._isOperator()){q1.title=Q.getText("CALCULATION_BUILDER_AFTER_CLOSING_BRACKET_ERROR_TEXT");}else if(!f1._isOperator()&&(g1.getKey()==="(")){q1.title=Q.getText("CALCULATION_BUILDER_BEFORE_OPENING_BRACKET_ERROR_TEXT");}else{q1.title=Q.getText("CALCULATION_BUILDER_CHAR_ERROR_TEXT");}m1.push(q1);}}if(f1._isFunction()){continue;}if(k1&&f1.getKey()===","){m1.push({index:i,title:Q.getText("CALCULATION_BUILDER_WRONG_PARAMETER_MARK")});}if((f1._isOperator()&&f1.getKey()==="(")||f1._isFunction()){l1.push(i);}if(f1._isOperator()&&f1.getKey()===")"){if(l1.length===0){m1.push({index:i,title:Q.getText("CALCULATION_BUILDER_OPENING_BRACKET_ERROR_TEXT")});}else{l1.pop();}}}for(i=0;i<l1.length;i++){m1.push({index:l1[i],title:Q.getText("CALCULATION_BUILDER_CLOSING_BRACKET_ERROR_TEXT")});}return m1;};U.prototype._getType=function(i){return this.getParent()&&this.getParent()._getType(i);};U.prototype._setItems=function(i){this._smartRender(i);};U.prototype._moveItems=function(W,X){var Y=[],Z=this.getItems(),$=this.$().find(".sapCalculationBuilderSelected"),_,a1,b1,c1;if(this._isEmptySelected()){return;}c1=$.children();if(W===K.KEY_PREVIOUS){a1=this._iFirstSelectedIndex-1;}else if(W===K.KEY_NEXT){a1=this._iLastSelectedIndex+2;}else if(W===K.MOUSE){a1=X;}if(a1<0||a1===(Z.length+1)){return;}_=this.$().find(".sapCalculationBuilderDelimiter[index=\""+a1+"\"]");for(var i=0;i<Z.length+1;i++){b1=Z[i];if(a1===i){c1.each(function(){var d1=q(this),b1;if(d1.hasClass("sapCalculationBuilderItem")){b1=sap.ui.getCore().byId(q(this)[0].id);Y.push(b1);b1._bMovingItem=true;d1.draggable("enable");}d1.css("left",0);d1.detach().insertAfter(_).removeClass("");_=d1;});}if(b1&&!b1.$().parent().hasClass("sapCalculationBuilderSelected")&&!b1._bMovingItem){Y.push(b1);}}$.css("left","");q(".sapCalculationBuilderDelimiter").each(function(i){q(this).attr("index",i);});this.removeAllAggregation("items",true);Y.forEach(function(b1,i){b1._bMovingItem=false;b1._iIndex=i;this.addAggregation("items",b1,true);}.bind(this));this._setupKeyboard();this._selectItems(c1.filter(function(i,el){return q(el).hasClass("sapCalculationBuilderItem");}));this._aErrors=this._validateSyntax();this._fireAfterValidation();this._printErrors();this._fireChange();};U.prototype._fireAfterValidation=function(){this.getParent().fireAfterValidation();};U.prototype._smartRender=function(W){var X="",$=this.$(),Y=[],Z=this.getItems(),_=Z.length;if(!this.getParent()._isExpressionVisible()){this.removeAllAggregation("items",true);(W||[]).forEach(function(b1){this.addAggregation("items",b1,true);}.bind(this));return;}this._bIsCalculationBuilderRendering=true;this._deselect();var a1=function(d1){this.addAggregation("items",d1,true);d1._iIndex=i;if($[0]){X+=d1._render();X+=this._renderDelimiter(i+1);}Y.push(d1);}.bind(this);for(var i=0;i<W.length;i++){var b1=Z[i];if(!b1){a1(W[i]);}else if(b1.getKey()!==W[i].getKey()||b1._getType()!==W[i]._getType()){b1.setKey(W[i].getKey(),true);b1._sType=W[i]._getType();b1.$()[0].innerHTML=b1._innerRender();b1.$().attr("class",b1._getClass());b1._setEvents();}}if(W.length<_){for(var i=W.length;i<Z.length;i++){var c1=Z[i].$();c1.next().remove();c1.remove();this.removeAggregation("items",Z[i],true);}}if($[0]&&Y.length>0){$.find(".sapCalculationBuilderDelimiter").last().after(X);Y.forEach(function(b1){b1._afterRendering();});this._setupDroppable($.find(".sapCalculationBuilderDroppable").filter(function(){return parseInt(q(this).attr("index"),10)>_;}));}this._setupKeyboard();this._setupNewButtonEvents();this._bIsCalculationBuilderRendering=false;};U.prototype._fireChange=function(){this.fireEvent("change");};return U;},true);
