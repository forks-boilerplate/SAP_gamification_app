sap.ui.define(["sap/m/Button","sap/m/ButtonType","sap/m/Label","sap/m/Dialog","sap/m/Bar","sap/m/SearchField","sap/m/Toolbar","sap/m/ToolbarSpacer","sap/m/Title","sap/m/VBox","sap/m/HBox","sap/m/CheckBox","sap/m/Link","sap/m/List","sap/m/TextArea","sap/m/Text","sap/m/StandardListItem","sap/m/ListSeparators","sap/m/Popover","sap/ui/layout/form/SimpleForm","sap/ui/layout/GridData","sap/ui/core/mvc/Controller","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/m/SegmentedButton","sap/m/SegmentedButtonItem","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms",'sap/ui/model/Filter',"sap/suite/ui/generic/template/AnalyticalListPage/controller/DropDownController","sap/m/OverflowToolbarButton","sap/ui/model/json/JSONModel","sap/m/OverflowToolbar","sap/m/OverflowToolbarLayoutData","sap/ui/core/CustomData","sap/ui/Device","sap/m/library","sap/ui/core/library","sap/ui/model/FilterOperator"],function(B,a,L,D,b,S,T,c,d,V,H,C,e,f,g,h,j,k,P,l,G,m,F,n,o,p,q,r,O,J,s,t,u,v,w,x,y){"use strict";var z="_BASIC";var A="100%";var E=0.33;var I=0.5;var K=m.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController",{init:function(i){this.oState=i;this.oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");this.bIsTimeBasedLine;this.bSortOrder;},_createForm:function(){this._searchTriggered=false;this._restoreTriggered=false;var i=new J();var M=this.oState.alr_visualFilterBar.getModel('_visualFilterConfigModel');this._initialFilters=this.oState.alr_visualFilterBar.getModel("_filter").getJSON();this.oConfig=JSON.parse(M.getJSON());i.setData(this.oConfig);this.filterCompList=[];this.filterChartList=[];this._buildFiltersFromConfig(true);var _=new J();_.setData(JSON.parse(this._initialFilters));this.oVerticalBox=new V();this.oVerticalBox.setModel(this.oState.oController.getView().getModel("_templPriv"),"_templPriv");this.oVerticalBox.setModel(this.oState.oController.getView().getModel());this.oVerticalBox.setModel(this.oState.oController.getView().getModel("i18n"),"i18n");this.oVerticalBox.setModel(_,"_dialogFilter");this.oVerticalBox.setModel(i,'_visualFilterDialogModel');this._addFilterSwitch();this._addGroupsAndFilters();return this.oVerticalBox;},_toggle:function(){var i=this.oState.oSmartFilterbar.getFilterDialogContent();if(i&&(i.length===2)){if(i[0].getVisible()){i[0].setVisible(false);i[1].setVisible(true);i[1].getItems()[0].getContent()[1].addCustomData(new u({key:'isToggle',value:true}));}else{i[0].setVisible(true);i[1].setVisible(false);i[0].getToolbar().getContent()[1].addCustomData(new u({key:'isToggle',value:true}));}}},_addFilterSwitch:function(){var i=[new o({icon:"sap-icon://filter-fields",width:"inherit",key:"compact",tooltip:"{i18n>FILTER_COMPACT}"}),new o({icon:"sap-icon://filter-analytics",width:"inherit",key:"visual",tooltip:"{i18n>FILTER_VISUAL}"})];var M=new n({width:"inherit",selectedKey:"visual",items:i}).addEventDelegate({onAfterRendering:function(Q){if(Q.srcControl.getCustomData()[0]&&Q.srcControl.getCustomData()[0].getValue()){Q.srcControl.focus();Q.srcControl.removeAllCustomData();}}});M.attachSelect(function(Q){var R=Q.getSource();R.setSelectedKey("visual");this._toggle();}.bind(this));var N=new s({design:w.ToolbarDesign.Transparent,content:[new c(),M]}).addStyleClass("sapSmartTemplatesAnalyticalListPageFilterDialogToolbar");this.oVerticalBox.addItem(N);},_searchDialog:function(){this._searchTriggered=true;},_updateFilterBarFromDialog:function(){var i=this.oState.alr_visualFilterBar.getModel('_filter'),M=this.oVerticalBox.getModel('_dialogFilter'),N=jQuery.sap.equal(i.getJSON(),M.getJSON());if(!N){i.setData(JSON.parse(M.getJSON()));}var Q=this.oState.alr_visualFilterBar.getModel('_visualFilterConfigModel'),R=this._getDialogConfigModel(),U=jQuery.sap.equal(Q.getJSON(),R.getJSON());if(!U){Q.setData(JSON.parse(R.getJSON()));this.oState.alr_visualFilterBar.updateVisualFilterBindings(true);}},_closeDialog:function(){if(this._searchTriggered){this._updateFilterBarFromDialog();if(this._restoreTriggered){this._restoreTriggered=false;this.oState.filterBarController._afterSFBVariantLoad();}}this.oVerticalBox.destroyItems();},_restoreDialog:function(){var i=this.oState.alr_visualFilterBar._oCurrentVariant.config;if(i){this.oConfig.filterCompList.forEach(function(M){if(i[M.component.properties.parentProperty]){jQuery.extend(true,M,i[M.component.properties.parentProperty]);}});}else{this.oConfig=this.oState.alr_visualFilterBar._getStandardVariantConfig();}this._getDialogConfigModel().setData(this.oConfig);this._reloadForm();this._restoreTriggered=true;},_buildFiltersFromConfig:function(M){var i;this.filterCompList=[];this.filterChartList=[];for(i=0;i<this.oConfig.filterCompList.length;i++){var N=this.oConfig.filterCompList[i].component.properties.sortOrder;if(N.constructor===Object&&N.value){this.oConfig.filterCompList[i].component.properties.sortOrder=N.value;}this.filterCompList.push({obj:{shownInFilterBar:this.oConfig.filterCompList[i].shownInFilterBar,shownInFilterDialog:this.oConfig.filterCompList[i].shownInFilterDialog,cellHeight:this.oConfig.filterCompList[i].cellHeight,component:{type:this.oConfig.filterCompList[i].component.type,cellHeight:this.oConfig.filterCompList[i].component.cellHeight},group:{label:this.oConfig.filterCompList[i].group.label,name:this.oConfig.filterCompList[i].group.name}},searchVisible:M===true||this.oConfig.filterCompList[i].searchVisible===undefined||this.oConfig.filterCompList[i].searchVisible});}},_rebuildConfig:function(){var i;var M={filterCompList:[]};for(i=0;i<this.filterCompList.length;i++){M.filterCompList.push({shownInFilterBar:this.filterCompList[i].obj.shownInFilterBar&&this.filterCompList[i].obj.shownInFilterDialog,shownInFilterDialog:this.filterCompList[i].obj.shownInFilterDialog,cellHeight:this.filterCompList[i].obj.cellHeight,group:{label:this.filterCompList[i].obj.group.label,name:this.filterCompList[i].obj.group.name},component:{type:this.filterCompList[i].obj.component.type,cellHeight:this.filterCompList[i].obj.component.cellHeight,properties:{scaleFactor:this.filterChartList[i].getScaleFactor(),numberOfFractionalDigits:this.filterChartList[i].getNumberOfFractionalDigits(),sortOrder:this.filterChartList[i].getSortOrder(),filterRestriction:this.oConfig.filterCompList[i].component.properties.filterRestriction,entitySet:this.filterChartList[i].getEntitySet(),isDropDown:this.oConfig.filterCompList[i].component.properties.isDropDown,width:this.oConfig.filterCompList[i].component.properties.width,height:this.oConfig.filterCompList[i].component.properties.height,dimensionField:this.filterChartList[i].getDimensionField(),dimensionFieldDisplay:this.filterChartList[i].getDimensionFieldDisplay(),dimensionFieldIsDateTime:this.filterChartList[i].getDimensionFieldIsDateTime(),dimensionFilter:this.filterChartList[i].getDimensionFilter(),unitField:this.filterChartList[i].getUnitField(),isCurrency:this.filterChartList[i].getIsCurrency(),isMandatory:this.oConfig.filterCompList[i].component.properties.isMandatory,measureField:this.filterChartList[i].getMeasureField(),outParameter:this.oConfig.filterCompList[i].component.properties.outParameter,inParameters:this.oConfig.filterCompList[i].component.properties.inParameters,parentProperty:this.oConfig.filterCompList[i].component.properties.parentProperty,chartQualifier:this.oConfig.filterCompList[i].component.properties.chartQualifier}}});}return M;},_reloadForm:function(){this.oVerticalBox.destroyItems();this._buildFiltersFromConfig();this._addFilterSwitch();this._addGroupsAndFilters();},_addGroupsAndFilters:function(){var i;var M;var N;var Q=[];var R=0;for(i=0;i<this.filterCompList.length;i++){if(!Array.isArray(this.filterCompList[i])){if(this.filterCompList[i].searchVisible===false){continue;}if(!(Q.indexOf(this.filterCompList[i].obj.group.name)>-1)){if(N){this.oVerticalBox.addItem(N);}M=this.filterCompList[i].obj.group.name;Q.push(M);N=new V();N.setWidth("100%");N.setLayoutData(new G({span:"L12 M12 S12"}));N.addStyleClass("sapUiSmallMarginTop");R++;this._addGroupToolbar(N,this.filterCompList[i].obj.group.label,this.filterCompList[i].obj.group.name);}if(this.filterCompList[i].obj.shownInFilterDialog){this.filterCompList[i].toolbar=this._addChartCustomToolbar(this.oConfig.filterCompList[i],i);this.filterCompList[i].overlay=this._addChartOverlay(this.oConfig.filterCompList[i],i);var U=this,W=new V(),X=this.oConfig.filterCompList[i].component.properties.parentProperty;W.setModel(this._getDialogConfigModel(),'_visualFilterDialogModel');W.bindAggregation('items',{path:"_visualFilterDialogModel>/filterCompList",factory:function(_,a1){var b1=a1.getProperty('component/type'),c1=a1.getProperty('component/properties'),d1=a1.getPath().split("/")[2];this.filterChartList[d1]=this._addChart(b1,c1,d1);return this.filterChartList[d1];}.bind(this),filters:new q("component/properties/parentProperty",y.EQ,X)});var Y=this.filterChartList[i].getParentProperty().replace(/[^\w]/gi,'')+"checkBox";var Z=[new V({items:[U.filterCompList[i].toolbar,U.filterCompList[i].overlay,W]}).setWidth("100%").addStyleClass("sapUiSmallMarginEnd")];if(v.system.desktop){Z[0].setWidth("80%");Z.splice(1,0,new V({items:[new L({text:"{i18n>SHOW_ON_FILTER_BAR}",labelFor:Y}).addStyleClass("sapUiTinyMarginTop"),new C({id:Y,text:"",selected:U.oConfig.filterCompList[i].shownInFilterBar}).data("idx",i).attachSelect(null,U._onCheckBoxSelect,U)]}).setAlignItems("Center"));Z[1].setWidth("20%");}var $=new H({items:Z}).addStyleClass("sapUiSmallMarginTop").setWidth("100%");N.addItem($);}}if(N){this.oVerticalBox.addItem(N);}}if(R==1&&M===z){F.executeFunction(N,"mAggregations.items.0.setVisible",[false]);}},_onCheckBoxSelect:function(i){var M=i.getSource().data("idx");this.selectCheckBox(M,i.getSource().getSelected());},_addGroupToolbar:function(i,M,N){var Q=new d({text:M});var R=new T({content:[Q,new c()]});if(N!=z){R.addContent(this._createMoreFiltersLink(N,Q));}i.addItem(R);},selectCheckBox:function(i,M){var N=this._getDialogConfigModel();var Q=jQuery.extend(true,{},N);Q.setProperty('/filterCompList/'+i+'/shownInFilterBar',M);N.setData(Q.getData());this.oConfig=N.getData();this.oState.oSmartFilterbar._oVariantManagement.currentVariantSetModified(true);},_addChartOverlay:function(i,M){var N=new V({width:"100%",height:i.component.properties.height,items:[new L({text:{path:'_visualFilterDialogModel>/filterCompList/'+M+'/overlayMessage',formatter:function(Q){return this.getModel("i18n").getResourceBundle().getText(Q);}}})],visible:{path:'_visualFilterDialogModel>/filterCompList/'+M+'/showChartOverlay',formatter:function(Q){return Q;}}});N.addStyleClass("sapUiOverlay");N.addStyleClass("sapSmartTemplatesAnalyticalListPageVFOverflow");return N;},_formatTitle:function(i,M){var N=this.oVerticalBox.getModel("i18n").getResourceBundle();var Q=i.titleMD;var R=i.titleUnitCurr;if(M==="tooltipMD"){return R==""?Q:N.getText("VIS_FILTER_TITLE_MD_WITH_UNIT_CURR",[Q,R]);}else if(M==="titleUnitCurr"){return R.length>0?"| "+R:"";}},_addChartCustomToolbar:function(i,M){var N=this;var Q=i.component.properties.parentProperty,R=i.component.properties,U=F.getPropertyNameDisplay(this.oState.alr_visualFilterBar.getModel(),i.component.properties.entitySet,i.component.properties.dimensionField),W=Q.replace(/[^\w]/gi,''),X=this.oState.alr_visualFilterBar._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(i.component.properties.entitySet),Y=i.component.properties.sortOrder[0].Descending.Boolean,Z=F.readProperty(i,"component.type")==="Line"&&F.readProperty(i,"component.properties.dimensionFieldIsDateTime"),$=this.oState.alr_visualFilterBar._resolveChartType(i.component.type),_=this._getChartTypeIconLink($),rb=this.oVerticalBox.getModel("i18n").getResourceBundle(),b1=N._getChartTitle(i,M),c1=new d({text:b1.titleMD,tooltip:this._formatTitle(b1,"tooltipMD"),titleStyle:x.TitleLevel.H6}),d1=new d({text:this._formatTitle(b1,"titleUnitCurr"),tooltip:"",titleStyle:x.TitleLevel.H6});if(this.oConfig.filterCompList[M].component.properties.isMandatory){c1.addStyleClass("sapMLabelRequired");}var e1=this.oState.oSmartFilterbar.getControlByKey(i.component.properties.parentProperty);this.oState.oSmartFilterbar.ensureLoadedValueHelp(i.component.properties.parentProperty);var f1=e1.getShowValueHelp&&e1.getShowValueHelp(),g1=(R.isDropDown)?"sap-icon://slim-arrow-down":"",h1=f1?"sap-icon://value-help":g1,i1,j1=[new B({type:"Transparent",icon:"sap-icon://line-chart-time-axis",visible:false,press:function(a1){N._showLineChartTimeAxisPopup(a1);}}).data("idx",M),new B({type:"Transparent",icon:(f1||R.isDropDown)?h1:"",visible:{path:"_dialogFilter>/"+Q,formatter:function(a1){if(f1||R.isDropDown){return true;}else{if(!a1){return false;}if(typeof a1==="object"){return(a1.value||(a1.items&&a1.items.length)||(a1.ranges&&a1.ranges.length))?true:false;}return true;}}},text:{path:"_dialogFilter>/"+Q,formatter:function(a1){i1=0;if(a1){if(typeof a1==="object"){if(a1.value){i1++;}if(a1.items){i1+=a1.items.length;}if(a1.ranges){i1+=a1.ranges.length;}}else{i1++;}}return i1?"("+i1+")":"";}},press:function(a1){if(f1){e1.fireValueHelpRequest.call(e1);}else if(R.isDropDown){var l1=N.oState.alr_visualFilterBar._isEntitytypeSearchable(this.getModel(),R.entitySet),m1=this.getModel("visualFilter")||this.getModel();r.createDropdown(a1.getSource(),N.filterChartList[a1.getSource().data("idx")],m1,U,R,l1);}else{sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController.launchAllFiltersPopup(a1.getSource(),N.filterChartList[a1.getSource().data("idx")],a1.getSource().getModel('i18n'));}},tooltip:{path:"_dialogFilter>/"+Q,formatter:function(){return F.getTooltipForValueHelp(f1,U,rb,i1);}},layoutData:new t({priority:w.OverflowToolbarPriority.NeverOverflow})}).data("idx",M),new O({type:"Transparent",icon:(Y?"sap-icon://sort-descending":"sap-icon://sort-ascending"),visible:!Z,tooltip:"{i18n>VISUAL_FILTER_SORT_ORDER}",text:"{i18n>VISUAL_FILTER_SORT_ORDER}",press:function(a1){N._showChartSortPopup(a1);},layoutData:new t({closeOverflowOnInteraction:false,priority:(!v.system.desktop)?w.OverflowToolbarPriority.AlwaysOverflow:w.OverflowToolbarPriority.High})}).data("idx",M),new O({type:"Transparent",icon:_,tooltip:"{i18n>VISUAL_FILTER_CHART_TYPE}",text:"{i18n>VISUAL_FILTER_CHART_TYPE}",press:function(a1){N._showChartTypesPopup(a1);},layoutData:new t({closeOverflowOnInteraction:false,priority:(!v.system.desktop)?w.OverflowToolbarPriority.AlwaysOverflow:w.OverflowToolbarPriority.High})}).data("idx",M),new O({id:"template::VisualFilterDialog::MeasureChangeButton::"+X+"::"+W,type:"Transparent",icon:"sap-icon://measure",tooltip:"{i18n>VISUAL_FILTER_MEASURE}",text:"{i18n>VISUAL_FILTER_MEASURE}",press:function(a1){N._showChartMeasuresPopup(a1);},layoutData:new t({closeOverflowOnInteraction:false,priority:(!v.system.desktop)?w.OverflowToolbarPriority.AlwaysOverflow:w.OverflowToolbarPriority.High})}).data("idx",M)];if((v.system.tablet||v.system.phone)&&!v.system.desktop){j1.splice(2,0,new C({tooltip:"{i18n>SHOW_ON_FILTER_BAR}",text:"{i18n>SHOW_ON_FILTER_BAR}",selected:N.oConfig.filterCompList[M].shownInFilterBar,layoutData:new t({closeOverflowOnInteraction:false,priority:w.OverflowToolbarPriority.AlwaysOverflow})}).data("idx",M).attachSelect(null,N._onCheckBoxSelect,N));j1[2].addStyleClass("sapSmartTemplatesAnalyticalListPageVFDShowInFilterBarCozy");}var k1=new s({design:w.ToolbarDesign.Transparent,content:[c1,d1,new c(),j1]}).addStyleClass("sapSmartTemplatesAnalyticalListPageFilterDialogTitleToolbar");k1.getContent()[0].addStyleClass("sapUiTinyMarginTop");k1.getContent()[0].addStyleClass("sapSmartTemplatesAnalyticalListPageVFDialogChartTitle");k1.getContent()[1].addStyleClass("sapUiTinyMarginTop");k1.setWidth("100%");return k1;},_addChart:function(i,M,N){var Q;var R=this;var U=M.selectFilters&&M.selectFilters.SelectOptions;var W={selectFilters:M.selectFilters,scaleFactor:M.scaleFactor,numberOfFractionalDigits:M.numberOfFractionalDigits,sortOrder:M.sortOrder,filterRestriction:M.filterRestriction,isDropDown:M.isDropDown,width:A,height:M.height,labelWidthPercent:E,entitySet:M.entitySet,dimensionField:M.dimensionField,dimensionFieldDisplay:M.dimensionFieldDisplay,dimensionFieldIsDateTime:M.dimensionFieldIsDateTime,unitField:M.unitField,isCurrency:M.isCurrency,isMandatory:M.isMandatory,measureField:M.measureField,dimensionFilter:M.dimensionFilter,outParameter:M.outParameter,inParameters:M.inParameters,parentProperty:M.parentProperty,textArrangement:M.textArrangement,chartQualifier:M.chartQualifier,lazyLoadVisualFilter:this.oState.alr_visualFilterBar.getLazyLoadVisualFilter()};var X="/filterCompList/"+N;if(i==="Donut"){W.labelWidthPercent=I;}i=this.oState.alr_visualFilterBar._resolveChartType(i);var Q=this.oState.alr_visualFilterBar._createFilterItemOfType(i,W);Q.setModel(this.oVerticalBox.getModel('_dialogFilter'),'_dialogFilter');Q.setModel(this._getDialogConfigModel(),'_visualFilterDialogModel');Q.data("idx",N);Q.addCustomData(new u({key:'sPath',value:X}));Q.bindProperty('visible',{path:'_visualFilterDialogModel>/filterCompList/'+N+'/showChartOverlay',formatter:function(_){return!_;}});Q.bindProperty('dimensionFilter',{path:'_dialogFilter>/'+Q.getParentProperty()});var Y=Q.getInParameters(),Z=[];if(Y&&Y.length>0){Y.forEach(function(_){Z.push({path:"_dialogFilter>/"+_.localDataProperty});});}if(R.oState.alr_visualFilterBar.getEntitySet()===Q.getEntitySet()){var $=R.oState.alr_visualFilterBar._smartFilterContext.determineMandatoryFilterItems();if($&&$.length>0){$.forEach(function(_){if(!_.data("isCustomField")){Z.push({path:'_dialogFilter>/'+_.getName()});}});}}if(Z&&Z.length>0){Q.bindProperty('dimensionFilterExternal',{parts:Z,formatter:function(){var Y=this.getInParameters(),_=this.getParentProperty(),a1,b1;if(!(R.oState.alr_visualFilterBar.getEntitySet()===this.getEntitySet()&&R.oState.oSmartFilterbar.getAnalyticBindingPath()!=="")&&(R.oState.oSmartFilterbar.getAnalyticBindingPath()===""||((R.oState.oSmartFilterbar.getAnalyticBindingPath().indexOf("P_DisplayCurrency"))!=-1))){var c1=R.oState.alr_visualFilterBar.getProperty("displayCurrency");if(c1){var d1=this.getMeasureField();var e1=R.oState.alr_visualFilterBar.getModel();var f1=e1.getMetaModel();var g1=f1.getODataEntityType(R.oState.alr_visualFilterBar._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(this.getEntitySet()));var h1=f1.getODataEntitySet(this.getEntitySet());var i1=f1.getODataProperty(g1,d1);if(i1){var j1=i1[p.ISOCurrency];if(j1){var k1=j1.Path;for(var l1=(Y.length-1);l1>-1;l1--){var m1=Y[l1].valueListProperty;var n1=Y[l1].localDataProperty;if(m1===k1){var o1=R.oState.oSmartFilterbar.getFilterData();if(!o1[n1]){b1=f1.getODataProperty(g1,k1);var p1=b1&&F.isPropertyNonFilterable(h1,b1.name);if(!p1){a1=new q({aFilters:[new q({path:k1,operator:"EQ",value1:c1,value2:undefined})],and:false});}}break;}}}}}}return R.oState.alr_visualFilterBar._getFiltersForFilterItem(Y,_,a1,k1,U);}});}Q._updateBinding();Q._bAllowBindingUpdateOnPropertyChange=true;Q.attachFilterChange(function(_){R.oState.alr_visualFilterBar.fireFilterChange();});Q.attachTitleChange(function(_){var N=_.getSource().data("idx");if(R.filterCompList[N].toolbar.getContent().length>0){if(W.isMandatory){R.filterCompList[N].toolbar.getContent()[0].addStyleClass("sapMLabelRequired");}var a1=R.filterCompList[N].toolbar.getContent()[0];var b1=R.filterCompList[N].toolbar.getContent()[1];var c1=R._getChartTitle(R.filterCompList[N].obj,N);a1.setText(c1.titleMD);var d1=R._formatTitle(c1,"tooltipMD");a1.setTooltip(d1);b1.setText(R._formatTitle(c1,"titleUnitCurr"));var e1=c1.titleUnitCurr.split(" ");if(c1.titleUnitCurr==""){b1.setVisible(false);}else{b1.setVisible(true);var f1=e1.length>1?"4.15rem":"2.4rem";b1.setWidth(f1);}}});return Q;},_createMoreFiltersLink:function(M,N){var Q=this;var R=0;var i;var U=new e();for(i=0;i<this.filterCompList.length;i++){if(this.filterCompList[i].searchVisible&&this.filterCompList[i].obj.group.name===M&&!this.filterCompList[i].obj.shownInFilterDialog){R++;}}if(R>0){U.setText(this.oRb.getText("FILTER_BAR_SHOW_MORE_FILTERS",[R]));}else{U.setText(this.oRb.getText("FILTER_BAR_SHOW_CHANGE_FILTERS"));}U.attachPress(function(W){Q._createAddRemoveFiltersDialog(M,U);});if(N){U.addAriaLabelledBy(N);}return U;},_showChartMeasuresPopup:function(i){var M=this;var N=i.getSource().data("idx");var Q=this.filterChartList[N].getProperty("entitySet");var R=sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createPopoverDialog(i.getSource().getModel('i18n'),"VISUAL_FILTER_MEASURES");var U=new f({mode:w.ListMode.SingleSelectLeft,includeItemInSelection:true});U.data("idx",N);R.addContent(U);var W=this.oState.alr_visualFilterBar._getMeasureMap()[Q];U.addStyleClass("sapUiSizeCompact");if(W){for(var X in W){var Y=new j({title:W[X].label?W[X].label:W[X].name,tooltip:(W[X].fieldInfo&&W[X].fieldInfo.quickInfo)||W[X].label||W[X].name}).data("measureName",W[X].name);U.addItem(Y);if(this.filterChartList[N].getMeasureField()===W[X].name){U.setSelectedItem(Y);}}}U.attachSelectionChange(function(i){var N=i.getSource().data("idx"),Z=i.getSource().getSelectedItem().data("measureName");M.filterChartList[N].setProperty("unitField",W[Z].fieldInfo.unit);var $=M.filterCompList[N].toolbar.getContent()[0];var _=M.filterCompList[N].toolbar.getContent()[1];var a1=M._getChartTitle(M.filterCompList[N].obj,N);$.setText(a1.titleMD);_.setText(M._formatTitle(a1,"titleUnitCurr"));M.oConfig.filterCompList[N].component.properties.measureField=Z;if(!M.filterChartList[N]._chart.getPoints){var b1=jQuery.extend(true,[],M.filterChartList[N].getSortOrder());b1[0].Field.String=Z;M.filterChartList[N].setSortOrder(b1);M._updateVisualFilterConfigModel(N,'/component/properties/sortOrder',b1);}var c1={bUpdateBinding:true,value:Z};M.filterChartList[N].setMeasureField(c1);M._updateVisualFilterConfigModel(N,'/component/properties/measureField',c1);M._updateVisualFilterConfigModel(N,'/component/properties/measureField',Z);M._updateVisualFilterConfigModel(N,'/component/properties/unitField',W[Z].fieldInfo.unit);if(R){R.close();}});R.attachAfterClose(function(){R.destroy();R=null;});R.openBy(i.getSource());},_showChartTypesPopup:function(M){var N=this,Q=M.getSource(),R=Q.getModel('i18n'),U=sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createPopoverDialog(R,"VISUAL_FILTER_CHART_TYPES"),W=this.oState.alr_visualFilterBar._getSupportedFilterItemList(),X=[];for(var i=0;i<W.length;i++){var Y=W[i];var Z=new j({title:"{i18n>"+Y.textKey+"}",icon:Y.iconLink,selected:Q.getIcon()===Y.iconLink}).data("type",Y.type);X.push(Z);}var $=new f({mode:w.ListMode.SingleSelectMaster,items:X});$.data("button",Q);$.addStyleClass("sapUiSizeCompact");$.setModel(R,"i18n");U.addContent($);$.attachSelectionChange(function(M){var _=M.getSource().data("button").data("idx"),a1=M.getSource().getSelectedItem().data("type"),b1=N.filterChartList[_],c1=b1.getDimensionField(),d1=b1.getMeasureField(),e1=b1.getDimensionFieldIsDateTime(),f1=F.readProperty(N.oConfig,"filterCompList."+_+".component.properties.sortOrder.0.Field.String"),g1=N._getDialogConfigModel(),h1=g1.getProperty('/filterCompList/'),i1=jQuery.extend(true,{},h1[_]),j1=F.readProperty(i1,"component.properties.sortOrder.0.Field.String");M.getSource().data("button").setIcon(N._getChartTypeIconLink(a1));if(f1&&j1){if(a1==="Line"){N.oConfig.filterCompList[_].component.properties.sortOrder[0].Field.String=c1;i1.component.properties.sortOrder[0].Field.String=c1;if(e1){N.bSortOrder=N.oConfig.filterCompList[_].component.properties.sortOrder[0].Descending.Boolean;N.oConfig.filterCompList[_].component.properties.sortOrder[0].Descending.Boolean=true;i1.component.properties.sortOrder[0].Descending.Boolean=true;N.bIsTimeBasedLine=true;}}else{N.oConfig.filterCompList[_].component.properties.sortOrder[0].Field.String=d1;i1.component.properties.sortOrder[0].Field.String=d1;if(N.bIsTimeBasedLine){N.oConfig.filterCompList[_].component.properties.sortOrder[0].Descending.Boolean=N.bSortOrder;i1.component.properties.sortOrder[0].Descending.Boolean=N.bSortOrder;N.bIsTimeBasedLine=false;}}}i1.component.type=a1;g1.setProperty('/filterCompList/'+_,i1);N.oState.oSmartFilterbar._oVariantManagement.currentVariantSetModified(true);N.oState.alr_visualFilterBar.updateVisualFilterBindings.apply(N,[true,true]);if(U){U.close();}});U.attachAfterClose(function(){U.destroy();U=null;});U.openBy(M.getSource());},_showLineChartTimeAxisPopup:function(i){var M=i.getSource().data("idx");var N=i.getSource();var Q=sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createPopoverDialog(i.getSource().getModel('i18n'),"VISUAL_FILTER_LINE_CHART_TIME_LINE");var R=new f({mode:w.ListMode.SingleSelectLeft,items:[new j({title:"{i18n>VISUAL_FILTER_LINE_CHART_TIME_LINE_DAYS}"}).data("idx",M),new j({title:"{i18n>VISUAL_FILTER_LINE_CHART_TIME_LINE_MONTH}"}).data("idx",M),new j({title:"{i18n>VISUAL_FILTER_LINE_CHART_TIME_LINE_QUARTERS}"}).data("idx",M),new j({title:"{i18n>VISUAL_FILTER_LINE_CHART_TIME_LINE_YEARS}"}).data("idx",M)]});R.data("button",N);R.addStyleClass("sapUiSizeCompact");Q.addContent(R);R.attachSelectionChange(function(i){Q.close();});Q.attachAfterClose(function(){Q.destroy();Q=null;});Q.openBy(i.getSource());},_showChartSortPopup:function(i){var M=this;var N=i.getSource().data("idx");var Q=i.getSource();var R=i.getSource().getModel('i18n');var U=sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createPopoverDialog(R,"VISUAL_FILTER_SORTING");var W=new f({mode:w.ListMode.SingleSelectLeft,includeItemInSelection:true,items:[new j({title:R.getResourceBundle().getText("VISUAL_FILTER_SORTING_ASCENDING")}).data("idx",N),new j({title:R.getResourceBundle().getText("VISUAL_FILTER_SORTING_DESCENDING")}).data("idx",N)]});W.data("button",Q);W.addStyleClass("sapUiSizeCompact");if(this.filterChartList[N].getSortOrder()[0].Descending.Boolean){W.setSelectedItem(W.getItems()[1],true);}else{W.setSelectedItem(W.getItems()[0],true);}U.addContent(W);W.attachSelectionChange(function(i){var Q=i.getSource().data("button");var N=Q.data("idx");var X=jQuery.extend(true,[],M.filterChartList[N].getSortOrder());X[0].Descending.Boolean=i.getSource().getItems()[1].isSelected();if(X[0].Descending.Boolean){Q.setIcon("sap-icon://sort-descending");}else{Q.setIcon("sap-icon://sort-ascending");}var Y={bUpdateBinding:true,value:X};M.filterChartList[N].setSortOrder(Y);M._updateVisualFilterConfigModel(N,'/component/properties/sortOrder',Y);M._updateVisualFilterConfigModel(N,'/component/properties/sortOrder',X);if(U){U.close();}});U.attachAfterClose(function(){U.destroy();U=null;});U.openBy(i.getSource());},_createAddRemoveFiltersDialog:function(M,N){var i;var Q=this;var R=new D();R.setTitle(this.oRb.getText("SELECT_FILTER_FIELDS"));R.addStyleClass("sapUiPopupWithPadding");R.addStyleClass("sapUiCompAddRemoveFilterDialog");R.addStyleClass("sapUiSizeCompact");R.setVerticalScrolling(true);var U=new b();var W=new S({placeholder:this.oRb.getText("FILTER_BAR_SEARCH")});this._oSearchField=W;W.attachLiveChange(function(_){Q._onAddRemoveFiltersSearch(_);});U.addContentRight(W);R.setSubHeader(U);this.addRemoveList=new f({mode:w.ListMode.MultiSelect});this.addRemoveList.setShowSeparators(k.None);R.addContent(this.addRemoveList);for(i=0;i<this.filterCompList.length;i++){if(this.filterCompList[i].obj.group.name===M&&this.filterCompList[i].searchVisible){var X=this._getChartTitle(this.filterCompList[i].obj,i,true);var Y=new j({title:X.titleMD}).data("idx",i);this.addRemoveList.addItem(Y);if(this.filterCompList[i].obj.shownInFilterDialog){this.addRemoveList.setSelectedItem(Y,true);}}}this.addRemoveList.attachSelectionChange(function(_){if(_){var a1=_.getParameters();if(a1){var Y=a1.listItem;var b1=Y.data("idx");if(Y){var c1={bVisible:a1.selected,propertyName:Q.oConfig.filterCompList[b1].component.properties.parentProperty};Q.oState.alr_visualFilterBar.fireFilterChange(c1);}}}});var Z=new B({text:this.oRb.getText("FORM_PERS_DIALOG_OK")});Z.attachPress(function(){var i;var _=Q.addRemoveList.getItems();var a1=Q._getDialogConfigModel(),b1=jQuery.extend(true,{},a1);for(i=0;i<_.length;i++){var c1=_[i].data("idx");var d1=_[i].isSelected();b1.setProperty('/filterCompList/'+c1+'/shownInFilterBar',d1);b1.setProperty('/filterCompList/'+c1+'/shownInFilterDialog',d1);}a1.setData(b1.getData());Q.oConfig=JSON.parse(a1.getJSON());Q.oState.alr_visualFilterBar.updateVisualFilterBindings.apply(this,[true,true]);Q.oState.oSmartFilterbar._oVariantManagement.currentVariantSetModified(true);Q._reloadForm();R.close();});R.addAggregation("buttons",Z);R.setInitialFocus(this._oSearchField);R.setContentHeight("23.25rem");var $=new B({text:this.oRb.getText("FORM_PERS_DIALOG_CANCEL"),press:function(){R.close();}});R.addAggregation("buttons",$);R.attachAfterClose(function(){R.destroy();R=null;});R.open();},_onAddRemoveFiltersSearch:function(M){var i;if(!M){return;}var N=M.getParameters();if(!N){return;}var Q=(N.newValue?N.newValue:"").toLowerCase();var R=this.addRemoveList.getItems();for(i=0;i<R.length;i++){var U=(R[i].getTitle()).toLowerCase();R[i].setVisible(U.indexOf(Q)>=0);}},_getChartTypeIconLink:function(i){var M=this.oState.alr_visualFilterBar._getSupportedFilterItemMap();var N=M[i];return!N?"":N.iconLink;},_getChartTitle:function(i,M,N){var Q="";if(this.filterChartList[M]){if(N){i.component.properties=this.filterChartList[M].getP13NConfig();Q=this.oState.alr_visualFilterBar.getTitleByFilterItemConfig(i);}else{Q=this.filterChartList[M].getTitle();}}else{i.component.properties=this.oConfig.filterCompList[M].component.properties;Q=this.oState.alr_visualFilterBar.getTitleByFilterItemConfig(i);}return Q;},_adjustToolbarIcons:function(i){if(this.filterCompList[i].obj.component.type==="Line"){this.filterCompList[i].toolbar.getContent()[1].getItems()[1].setVisible(true);this.filterCompList[i].toolbar.getContent()[1].getItems()[2].setVisible(false);}else{this.filterCompList[i].toolbar.getContent()[1].getItems()[1].setVisible(false);this.filterCompList[i].toolbar.getContent()[1].getItems()[2].setVisible(true);}},_updateVisualFilterConfigModel:function(i,M,N,Q){var R=this._getDialogConfigModel();R.setProperty('/filterCompList/'+i+M,N);if(Q){var U=jQuery.extend(true,{},R.getProperty('/filterCompList/'+i));R.setProperty('/filterCompList/'+i,U);this.oState.alr_visualFilterBar.updateVisualFilterBindings.apply(this,[true,true]);}this.oConfig=R.getData();this.oState.oSmartFilterbar._oVariantManagement.currentVariantSetModified(true);},_triggerSearchInFilterDialog:function(M){var i;if(!M){return;}var N=M.getParameters();if(!N){return;}var Q=(N.newValue?N.newValue:"").toLowerCase();for(i=0;i<this.oConfig.filterCompList.length;i++){var R=this.oConfig.filterCompList[i].component.properties;var U=this._getChartTitle(this.oConfig.filterCompList[i],i).titleMD.toLowerCase();var W=this._getLabelForDimensionsAndMeasures(R,R.parentProperty),X=this._getLabelForDimensionsAndMeasures(R,R.measureField),Y=(W.indexOf(Q)>=0)||(X.indexOf(Q)>=0)||(U.indexOf(Q)>=0);this.oConfig.filterCompList[i].searchVisible=Y;}this._reloadForm();},_getDialogConfigModel:function(){return this.oVerticalBox.getModel('_visualFilterDialogModel');},_getLabelForDimensionsAndMeasures:function(i,M){var N=this.oState.alr_visualFilterBar._oMetadataAnalyser,Q=this.oVerticalBox.getModel().getMetaModel(),R=N.getEntityTypeNameFromEntitySetName(i.entitySet),U=Q.getODataEntityType(R),W=Q.getODataProperty(U,M)[p.Label];W=W&&W.String?W.String:"";return W;}});sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createPopoverDialog=function(i,M){if(this._oPopoverDialog){this._oPopoverDialog.destroy();}this._oPopoverDialog=new P();this._oPopoverDialog.setTitle(i.getResourceBundle().getText(M));this._oPopoverDialog.setPlacement(sap.m.PlacementType.PreferredBottomOrFlip);this._oPopoverDialog.addStyleClass("sapUiPopupWithPadding");return this._oPopoverDialog;};sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createFilterItemSelectedList=function(M,N){var Q=new f({mode:w.ListMode.Delete}),R,U=M.getFilterRestriction();Q.data("chart",M);if(U==='multiple'){R=jQuery.extend(true,{},M.getDimensionFilter());var W=(R&&R.items)?R.items:undefined,X=(R&&R.ranges)?R.ranges:undefined,Y=(R&&R.value)?R.value:null;R=jQuery.extend(true,{},M.getDimensionFilter());if(W){for(var i=0;i<W.length;i++){var Z=new j({title:W[i].text?W[i].text:W[i].key});if(Z){Z.addCustomData(new u({key:'items',value:i}));}Q.addItem(Z);}}if(X){for(var i=0;i<X.length;i++){var Z=new j({title:X[i].tokenText?X[i].tokenText:F.createTitleFromCode(X[i])});Z.addCustomData(new u({key:'ranges',value:i}));Q.addItem(Z);}}if(Y){var Z=new j({title:Y});Z.addCustomData(new u({key:'value'}));Q.addItem(Z);}}else{Q.addItem(new j({title:M.getDimensionFilter()}));}Q.attachDelete(function($){var _=$.getParameter("listItem"),a1=Q.data('chart'),b1;if(U==='single'){b1=null;}else{b1=jQuery.extend(true,{},a1.getDimensionFilter());var c1=_.getCustomData()[0],d1=c1.getKey(),e1=b1[d1];if(d1!=='value'){var f1=c1.getValue();e1.splice(f1,1);}else{b1.value=null;}}Q.removeItem(_);a1.setDimensionFilter(b1);a1.fireFilterChange();N.removeContent(Q);var g1=sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createFilterItemSelectedList(a1,N);if(g1.getItems().length>0){N.addContent(g1);N.focus();}else{N.close();}});return Q;};sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController.launchAllFiltersPopup=function(i,M,N){var Q=sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createPopoverDialog(N,"VISUAL_FILTER_ALL_SELECTED_FILTERS"),R=sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createFilterItemSelectedList(M,Q);Q.addContent(R);Q.addStyleClass("sapUiSizeCompact");Q.addStyleClass("sapSmartTemplatesAnalyticalListPageSelectedLinkDialog");var U=new b();var W=new B({text:N.getResourceBundle().getText("CLEAR_FILTERS_ALL"),press:function(X){var Y=R.data('chart'),Z=Y.getFilterRestriction(),$;if(Z==='multiple'){$=jQuery.extend(true,{},Y.getDimensionFilter());$.items=[];$.ranges=[];$.value=null;}else{$=null;}Q.removeContent(R);Y.setDimensionFilter($);Y.fireFilterChange();Q.close();}});U.addContentRight(W);Q.setFooter(U);Q.attachAfterClose(function(){Q.destroy();Q=null;});Q.openBy(i);};return K;});
