sap.ui.define(["sap/ui/base/EventProvider","sap/ui/comp/personalization/Util","sap/ui/table/AnalyticalTable","sap/ui/core/mvc/Controller","sap/ui/model/FilterType","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/m/Table","sap/ui/model/Sorter","sap/ui/core/format/DateFormat","sap/ui/model/odata/type/Time","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/table/RowSettings","sap/ui/model/FilterOperator","sap/ui/table/library","sap/suite/ui/generic/template/listTemplates/listUtils"],function(E,P,A,C,F,a,R,S,D,T,J,b,c,d,f,l){"use strict";var g=new E();var t=C.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.DetailController",{setState:function(s){this.oState=s;this._enableExpandByFilter=true;this._enableUpdateExpandLevelInfo=false;var e=this.oState.oSmartTable;var o=this.oState.oController.getOwnerComponent();var h=this.oState.oController.getOwnerComponent().getModel("_templPriv");h.setProperty('/alp/autoHide',o.getAutoHide()?"filter":"highlight");e.attachInitialise(this._onSmartTableInit,this);e.attachBeforeRebindTable(this._onBeforeRebindTable,this);},_onSmartTableInit:function(){var s=this.oState.oSmartTable,e=s.getCustomToolbar(),o=e.getContent(),n;this.oState.oTemplateUtils.oCommonUtils.checkToolbarIntentsSupported(s);if(this.oState._pendingTableToolbarInit){if(!this.oState.oSmartFilterableKPI){e.insertContent(this.oState.alr_viewSwitchButtonOnTable,o.length);}}if(this.oState._pendingTableToolbarInit){for(var i=0;i<o.length;i++){if(o[i].mProperties.text==="Settings"){n=i;}}e.insertContent(this.oState._autoHideToggleBtn,n);}delete this.oState._pendingTableToolbarInit;this.oState.oSmartTable.attachShowOverlay(function(j){this.oState.oSmartTable.getCustomToolbar().setEnabled(!j.getParameter("overlay").show);},this);var h=new J({"highlightMode":"rebindTable"});this.oState.oSmartTable.setModel(h,"_tableHighlight");},_onBindingDataReceived:function(){var e=this.oState.oSmartTable.getTable();if(e instanceof A){this._expandByFilter("bindingDataReceived");}if(!this.isFilter()&&this.oState.oSmartChart){}},_onBeforeRebindTable:function(o){var v=this.oState.oSmartTable.fetchVariant(),h=v,k=this.oState.oSmartTable.getTable(),m={},B=o.getParameter("bindingParams");B.parameters=B.parameters||{};if(!v){return;}var n=this.oState.oController.getOwnerComponent().getModel("_templPriv");var _=n.getProperty('/alp/_ignoreChartSelections');if(this.isFilter()&&this.oState.oSmartChart&&!_){this._applyChartSelectionOnTableAsFilter(o);}var p=this.oState.oSmartChart?this.oState.oSmartChart.getChart().getDrillStack().pop():undefined;if(this.isFilter()&&p&&p.filter){o.getParameter("bindingParams").filters.push(p.filter);}var q=[];var r=this.oState.oSmartTable.getTable().getColumns();for(var i=0;i<r.length;i++){var s=r[i];if(s.getGrouped&&s.getGrouped()){q.push(s.getLeadingProperty?s.getLeadingProperty():P.getColumnKey(s));}}this._updateExpandLevelInfo(q);var u=[];if(v.sort&&v.sort.sortItems){for(var i=0;i<v.sort.sortItems.length;i++){var w=v.sort.sortItems[i].operation==="Descending"?true:false;u.push(new S(v.sort.sortItems[i].columnKey,w));}}else if(!h.sort){m.allTableSortRemoved=true;}if(this.oState.oSmartFilterbar&&this.oState.oSmartFilterbar.getAnalyticBindingPath&&this.oState.oSmartFilterbar.getConsiderAnalyticalParameters()){try{var x=this.oState.oSmartFilterbar.getAnalyticBindingPath();if(x){this.oState.oSmartTable.setTableBindingPath(x);}}catch(e){jQuery.sap.log.warning("Mandatory parameters have no values","","AnalyticalListPage");}}if(this.oState.oController.getOwnerComponent().getModel().getDefaultCountMode()==="None"&&this.oState.oSmartTable._isAnalyticalTable){o.mParameters.bindingParams.parameters.provideTotalResultSize=false;this.oState.oSmartTable.setShowRowCount(false);}var y=this._getValueFromCustomData(this.oState.oSmartTable,"InitialExpansionLevel");if(y){o.mParameters.bindingParams.parameters.numberOfExpandedLevels=parseInt(y,10);}this.oState.oController.onBeforeRebindTableExtension(o);this.oState.oSmartTable.getModel("_tableHighlight").setProperty("/highlightMode","rebindTable");this._applyCriticalityInfo(o,this.oState.oSmartTable);if((!v||!v.sort)&&k instanceof R&&this.oState.oSmartTable.data("TemplateSortOrder")){var z=this.oState.oSmartTable.data("TemplateSortOrder").split(", ");for(var j=0;j<z.length;j++){var G=z[j].split(" ");if(G.length>1){B.sorter.push(new S(G[0],G[1]==="true"));}else{B.sorter.push(new S(G[0]));}}}if(k instanceof R){var H=k.getColumns(),I=B.sorter[0];if(I&&I.vGroup){var K;for(var L=0;L<H.length;L++){for(var M=0;M<H[L].getCustomData().length;M++){var N=H[L].getCustomData()[M];if(N.getProperty("key")==="p13nData"&&N.getValue("p13nData").leadingProperty&&N.getValue("p13nData").leadingProperty===I.sPath){K=H[L].getHeader().getProperty("text");I.fnGroup=this.fnGroupFunction(I.sPath,K);return;}}}}}l.handleErrorsOnTableOrChart(this.oState.oTemplateUtils,o);},attachTableChange:function(o,e,L){return g.attachEvent("TableChange",o,e,L);},detachTableChange:function(e,L){return g.detachEvent("TableChange",e,L);},isFilter:function(){var o=this.oState.oController.getOwnerComponent().getModel("_templPriv");return o.getProperty("/alp/autoHide")==="filter";},applyParamsToTable:function(){var e=this.oState.oSmartChart&&this.oState.oSmartChart.getChart()&&this.oState.oSmartChart.getDrillStackFilters(),i=e&&e.length,o=this.oState.oSmartChart.getChart(),h;if(o&&o._getVizFrame().vizSelection()){var j=this.oState.oSmartTable.getModel("_tableHighlight");h=this.oState.oTemplateUtils.oCommonUtils.getSelectionPoints(o);if(this.isFilter()||(h&&h.count)||j.getProperty("/highlightMode")==="eyeModeSwitch"||i){this.oState.oSmartTable.rebindTable(true);}else{this._applyCriticalityInfo(undefined,this.oState.oSmartTable);j.refresh(true);}}},_getValueFromCustomData:function(s,p){var _=s.getCustomData();for(var i=0;i<_.length;i++){if(_[i].mProperties.key===p){if(p==="lineItemCriticality"){return _[i].mProperties.value&&JSON.parse(_[i].mProperties.value);}else{return _[i].mProperties.value;}}}return"";},_applyCriticalityInfo:function(e,s){var o=s.getTable(),B=[],r=[],m=this,h=this._getValueFromCustomData(s,"lineItemCriticality");var j=this.oState.oSmartChart&&this.oState.oSmartChart.getChart();if(j){var p=this._getSelParamsFromChart(j);if(p&&p.length>0){p.forEach(function(i){if(i){var K=Object.keys(i);if(K){K.forEach(function(u){if(u!=="__metadata"&&r.indexOf(u)<0){B.push({path:u});r.push(u);}});}}});}this._setParamMap(j);}var k=h&&h.Path;if(k){B.push({path:k});if(e&&e.mParameters){e.mParameters.bindingParams.parameters.select.indexOf(k)===-1?e.mParameters.bindingParams.parameters.select+=","+k:"";}}else if(h&&h.EnumMember){B.push({path:"EnumMember"});}m.isFilterMode=this.isFilter();m.isResponsive=o instanceof R;if(!m.isFilterMode&&s.getModel("_tableHighlight").getProperty("/highlightMode")!=="eyeModeSwitch"){B.push({path:"_tableHighlight>/highlightMode"});}if(B&&B.length>0){var n=function(){var u=m._paramMap,_=m.isFilterMode;var v=m.isResponsive?this:this._getRow();if(!v){return;}if(v.getBindingContext()){var w;var x=this.getBindingContext();if(u&&!jQuery.isEmptyObject(u)){for(var y in u){if(!x.getObject(y)){continue;}for(var i=0;i<u[y].length;i++){if(u[y][i]===x.getObject(y)){w=true;break;}else{w=false;}}}}else{w=false;}m._applyCSSHighlight(v,_,w);if(k){var z=x.getObject(k);switch(z&&z.toString()){case"0":return"None";case"1":return"Error";case"2":return"Warning";case"3":return"Success";default:return"None";}}else if(h&&h.EnumMember){switch(h.EnumMember){case"com.sap.vocabularies.UI.v1.CriticalityType/Neutral":return"None";case"com.sap.vocabularies.UI.v1.CriticalityType/Negative":return"Error";case"com.sap.vocabularies.UI.v1.CriticalityType/Critical":return"Warning";case"com.sap.vocabularies.UI.v1.CriticalityType/Positive":return"Success";default:return"None";}}else{return"None";}}else{m._applyCSSHighlight(v,_,false);return"None";}};if(m.isResponsive){this.oState.alp_ColumnListItem.bindProperty("highlight",{parts:B,formatter:n});}else{var q=new c({highlight:{parts:B,formatter:n}});o.setRowSettingsTemplate(q);}}else{if(m.isResponsive){this.oState.alp_ColumnListItem.bindProperty("highlight",{path:"{_tableHighlight>/highlightMode}",formatter:function(){var _=m.isResponsive?this:this._getRow();if(!_){return;}m._applyCSSHighlight(_,false,false);return"None";}});}else{var q=new c({highlight:{path:"{_tableHighlight>/highlightMode}",formatter:function(){return"None";}}});o.setRowSettingsTemplate(q);}}},_applyCSSHighlight:function(r,i,e){if(e===undefined){return;}var h=r.getDomRefs?r.getDomRefs(true):r.getDomRef();if(h&&h.row){h.row.toggleClass("sapSmartTemplatesAnalyticalListPageRowHighlighted",(i&&e)?i:e);}else{r.toggleStyleClass("sapSmartTemplatesAnalyticalListPageRowHighlighted",(i&&e)?i:e);}},_getBindingProperty:function(e,n){if(e.getProperty){return e.getProperty(n);}else{var p=e.oEntityType.property;for(var i=0;i<p.length;i++){if(p[i].name==n){return p[i];}}return null;}},_getPageFilters:function(B){var p=this.oState.oSmartFilterbar.getFilters();for(var i=0;i<p.length;i++){if(p[i].aFilters!==undefined){var e=p[i].aFilters;for(var j=0;j<e.length;j++){var h=e[j];var n=h.sPath;if(!B.getProperty(n)){jQuery.sap.log.warning("Could not apply filter with name \""+n+"\" as that field does not exist in the entity type");continue;}h.sPath=n;}}else{var h=p[i];var n=h.sPath;if(!B.getProperty(n)){jQuery.sap.log.warning("Could not apply filter with name \""+n+"\" as that field does not exist in the entity type");continue;}h.sPath=n;}}return p;},_applyParamsToTableAsHighlight:function(u){if(!this.oState){return;}var e=this.oState.oSmartChart.getChart();if(!e){return;}var p=this._getSelParamsFromChart(e);var h=e.getVisibleDimensions();var j=this.oState.oSmartChart._lastSelected;var k=this.oState.oSmartTable.getTable();var m=this._getTableBinding(k);if(!m){jQuery.sap.log.error("No table binding to apply the selection(s) to");return;}var n=[];for(var i=0;i<p.length;i++){var o=p[i];var q={};for(var r in o){if(h.indexOf(r)==-1||!this._getBindingProperty(m,r)){continue;}q[r]=o[r];}n.push(q);}var s=this.oState.oSmartChart.getDrillStackFilters();s.forEach(function(v){var r=v.sPath,w={};w[r]=v.oValue1;n.push(w);});var q={};n.forEach(function(v){for(var w in v){if(!q.hasOwnProperty(w)){q[w]=[v[w]];}else{q[w].push(v[w]);}}});this._paramListFiltered=n;this._lastSelected=j;this._paramMap=q;this._updateRows(u);},_setParamMap:function(e){var p=this._getSelParamsFromChart(e);var h=e.getVisibleDimensions();var i=this.oState.oSmartChart.getDrillStackFilters();var j={};if(!this.oState.oController.getOwnerComponent().getModel("_templPriv").getProperty('/alp/_ignoreChartSelections')){p.forEach(function(o){for(var k in o){if(h.indexOf(k)==-1){continue;}if(!j.hasOwnProperty(k)){j[k]=[o[k]];}else{j[k].push(o[k]);}}});}i.forEach(function(o){if(!j.hasOwnProperty(o.sPath)){j[o.sPath]=[o.oValue1];}else{j[o.sPath].indexOf(o.oValue1)===-1?j[o.sPath].push(o.oValue1):"";}});this._paramMap=j;},_expandByFilter:function(u){if(!this._enableExpandByFilter){return;}var e=this.oState.oSmartTable.getTable();var h=this._getTableBinding(e);if(h&&this._lastBinding!=h){var m=this;h.attachDataReceived(this._onBindingDataReceived,this);h.attachEvent("change",function(o){if(m._expandingProgrammatically){return;}var p=o.getParameter("reason");if(p=="expand"||p=="collapse"){m._inUserChartSelectMode=false;}});this._lastBinding=h;}if(u=="selection"||u=="bindingDataReceived"){this._firstVisibleRelevantEventTS=new Date().getTime();}if(u=="selection"){this._inUserChartSelectMode=true;}if(!this._inUserChartSelectMode){return;}var r=this._getTableRows();for(var i=0;i<r.length;i++){var j=r[i];var k=j.getBindingContext();if(!k){continue;}var n=e.getFirstVisibleRow()+i;if(this._isRowHighlighted(k.getObject())){if(e.isExpanded(n)){continue;}if(!j._bHasChildren){continue;}if(!h.findNode(n)){continue;}this._expandingProgrammatically=true;e.expand(n);this._expandingProgrammatically=false;}else{if(!e.isExpanded(n)){continue;}if(!j._bHasChildren){continue;}if(!h.findNode(n)){continue;}this._expandingProgrammatically=true;e.collapse(n);this._expandingProgrammatically=false;}}this._updateFirstVisibleRow(u);},_updateFirstVisibleRow:function(u){var e=this.oState.oSmartTable.getTable();var h=this._getTableBinding(e);var j=h.getTotalSize();if(j==0||(new Date().getTime()-this._firstVisibleRelevantEventTS)>250){return;}var e=this.oState.oSmartTable.getTable();if(u=="selection"&&(!this._paramListFiltered||this._paramListFiltered.length==0)){e.setFirstVisibleRow(0);return;}var k=h.getContexts(0,j);for(var i=0;i<k.length;i++){var r=k[i].getObject();if(!this._isRowHighlighted(r)){continue;}if(this._lastSelected&&!this._rowMatch(this._lastSelected,r)){continue;}var m=e.getFirstVisibleRow();if(u=="selection"||this.isFilter()){e.setFirstVisibleRow(i);}else{if(i>m){e.setFirstVisibleRow(i);}}break;}},_rowMatch:function(s,r){for(var n in s){if(n.indexOf("__")!=-1){continue;}if(!r.hasOwnProperty(n)){continue;}if(s[n]!=r[n]){return false;}}return true;},_updateExpandLevelInfo:function(e){if(!this._enableUpdateExpandLevelInfo){return false;}var o=this.oState.oSmartTable.getTable();if(!o.getNumberOfExpandedLevels){return false;}var B=o.getBinding();if(!B){return false;}var h=e.length;var L=false;if(h>=B.aMaxAggregationLevel.length){L=true;h=B.aMaxAggregationLevel.length-1;this.wasAtMaxLevel=true;}else{L=o.getNumberOfExpandedLevels()!=h||this.wasAtMaxLevel;this.wasAtMaxLevel=false;}if(L){if(h>=0){o.setNumberOfExpandedLevels(h);o.bindRows(o.getBindingInfo("rows"));}var i=o.getGroupedColumns();o.fireGroup({column:i[0],groupedColumns:i,type:f.GroupEventType.group});}return L;},_updateRows:function(u){var e=this.oState.oSmartTable.getTable();if(e instanceof A){this._expandByFilter(u);}},_getTableRows:function(){var e=this.oState.oSmartTable.getTable();if(e.getRows){return e.getRows();}else{return e.getItems();}},_isRowHighlighted:function(r){var p=this._paramMap;if(!p||jQuery.isEmptyObject(p)){return false;}var m=true;for(var n in p){if(!r.hasOwnProperty(n)){continue;}if(p[n].indexOf(r[n])==-1){m=false;}}return m;},_getTableBinding:function(e){return e.getBinding()?e.getBinding():e.getBinding("items");},_applyChartSelectionOnTableAsFilter:function(e){var h=[],k=this.oState.oSmartChart.getChart();if(!k){return;}var p=this._getSelParamsFromChart(k);if(p.length>0){var m=k.getVisibleDimensions();for(var i=0;i<p.length;i++){var n=p[i],o=[];for(var q in n){if(m.indexOf(q)==-1){jQuery.sap.log.warning("Could not apply filter with name \""+q+"\" as that field does not exist in the entity type");continue;}var r=false;var s=e.mParameters.bindingParams.filters;if(s.length>0){var s=s[0].aFilters?s[0].aFilters:s;for(var j=0;j<s.length;j++){var u=s[j].aFilters?s[j].aFilters:s;if(u.length==1){if(u[0].sPath===q&&u[0].oValue1===n[q]){r=true;}}}}if(!r){o.push(new b({path:q,operator:d.EQ,value1:n[q]}));}}if(o.length>0){h.push(new b(o,true));}}if(h.length>0){e.mParameters.bindingParams.filters.push(new b(h,false));}}},_latestUpdateRow:function(p){var e=this.isFilter();var r=this._getTableRows();var h=false;for(var i=0;i<r.length;i++){var j=r[i];if(!e){if(j.getBindingContext()){var k=j.getBindingContext().getObject();h=this._isRowHighlighted(k);}}var m=j.getDomRefs?j.getDomRefs(true):j.getDomRef();if(!m){continue;}if(m.row){m.row.toggleClass("sapSmartTemplatesAnalyticalListPageRowHighlighted",(e&&p)?e:h);}else{$(m).toggleClass("sapSmartTemplatesAnalyticalListPageRowHighlighted",(e&&p)?e:h);}}},_getSelParamsFromChart:function(e){var h=[];if(e._getVizFrame().vizSelection()){h=this.oState.oTemplateUtils.oCommonUtils.getSelectionPoints(e).dataPoints;}return this._getSelParamsFromDPList(h);},_getSelParamsFromDPList:function(e){if(!e){return[];}var p=[];for(var i=0;i<e.length;i++){var h=e[i];var k=h.context;if(!k){if(h.dimensions){p.push(h.dimensions);}continue;}var m=k.getProperty(k.sPath);var n={};if(this._selectFilterByMeasure){for(var j=0;j<h.measures.length;j++){var o=h.measures[j];var v=m[o];n[o]=v;}}else{for(var o in m){n[o]=m[o];}}p.push(n);}return p;},fnGroupFunction:function(p,s){var e="";var m=[];var i;return function(o){var L=s;var j=p;var n;for(var h in m){if(m[h].path===p){n=m[h];break;}}if(!n){var M=o.getModel("entitySet").getMetaModel();var q=M.getObject(M.getMetaContext(o.sPath).sPath);var r=M.getObject(M.getMetaContext(o.sPath+"/"+p).sPath);if(r){var u=" ";for(var k=0;r.extensions&&k<r.extensions.length;k++){if(r.extensions[k].namespace==="http://www.sap.com/Protocols/SAPData"){switch(r.extensions[k].name){case"display-format":u=r.extensions[k].value;break;case"label":if(!L){L=r.extensions[k].value;}break;case"text":var v=r.extensions[k].value;var w=p.split("/");w[w.length-1]=v;j=w.join("/");break;default:break;}}}if(L===""||L===undefined){L=p;}i=sap.suite.ui.generic.template.js.AnnotationHelper.getTextArrangement(q,r);n={path:p,data:{type:r.type,displayFormat:u,label:L,textPath:j,textArrangement:i}};m.push(n);}}L=n.data.label;var x=o.getProperty(p);var y;if(n.data.textPath&&n.data.textPath!==""){y=o.getProperty(n.data.textPath);}switch(n.data.type){case"Edm.DateTime":if(n.data.displayFormat==="Date"){var z=D.getDateInstance({style:"medium"});var B=new Date(0).getTimezoneOffset()*60*1000;if(x&&x!==""&&x.getTime){x=z.format(new Date(x.getTime()+B));}}break;case"Edm.Time":if(x&&x!==""){var G=new T();x=G.formatValue(x,"string");}break;case"Edm.Boolean":if(x===true){x="{i18n>YES}";}else if(x===false){x="{i18n>NO}";}break;default:break;}if(!y||n.data.textPath===p){e=x?x:"";}else{switch(n.data.textArrangement){case"idAndDescription":e=x+" ("+y+")";break;case"idOnly":e=x;break;case"descriptionOnly":e=y;break;default:e=y+(x?" ("+x+")":"");break;}}return{key:e?e:p,text:L?L+": "+e:e};};}});return t;});
