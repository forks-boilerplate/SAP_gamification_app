sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/suite/ui/generic/template/ListReport/controller/MultipleViewsSingleTableModeHelper","sap/suite/ui/generic/template/ListReport/controller/MultipleViewsMultipleTablesModeHelper","sap/suite/ui/generic/template/lib/BusyHelper","sap/ui/model/Filter","sap/suite/ui/generic/template/lib/testableHelper"],function(q,B,M,a,b,F,t){"use strict";var P="/listReport/multipleViews";var c=P+"/selectedKey";var d=P+"/mode";var e=P+"/items";function g(s,C,T){var I;var Q;var m;var S;var o=T.oComponentUtils.getTemplatePrivateModel();var f;var D=T.oServices.oApplication.getBusyHelper().getBusyDelay();function h(){return Q&&Q.enableAutoBinding;}function r(){if(I&&I.fnRegisterToChartEvents){return I.fnRegisterToChartEvents.apply(null,arguments);}}function k(){if(I&&I.onDetailsActionPress){return I.onDetailsActionPress.apply(null,arguments);}}function l(){if(!I){return;}var i=x();return i.templateSortOrder;}function n(i){var j;if(!i){return"";}if(i.state==="error"){return T.oCommonUtils.getText("SEG_BUTTON_ERROR",i.text);}if(i.state===""||i.state==="busy"){var _=sap.ui.core.format.NumberFormat.getIntegerInstance({groupingEnabled:true});j=_.format(i.count);}return T.oCommonUtils.getText("SEG_BUTTON_TEXT",[i.text,i.state==="busyLong"?"...":j]);}function p(){if(I){var i=o.getProperty(c);var j=I.getContentForIappState(i);return{mode:m,state:j};}}function R(i){if(I){var j=I.getSelectedKeyAndRestoreFromIappState(i);o.setProperty(c,j);}}function u(){return o.getProperty(c);}function v(i){if(!I){return;}var j=function(_,a1,b1){var c1=T.oCommonUtils.getElementCustomData(a1);var d1=f[_]||Object.create(null);d1.selectionVariantFilters=b1;d1.templateSortOrder=c1.TemplateSortOrder;d1.implementingControl=a1;if(I.getIsDifferentEntitySets&&I.getIsDifferentEntitySets()){d1.entitySet=a1.getEntitySet&&a1.getEntitySet();d1.properties=O(a1);}f[_]=d1;if(S){var e1=e+"/"+_;var f1=function(h1,i1,j1){if(d1.numberOfUpdates!==i1){return;}var g1=q.extend({},o.getProperty(e1));if(!g1.state&&h1=="busy"){setTimeout(function(){if(o.getProperty(e1).state==="busy"){g1=q.extend({},o.getProperty(e1));g1.state="busyLong";o.setProperty(e1,g1);}},D);}g1.state=h1;if(!h1){g1.count=j1;}o.setProperty(e1,g1);};d1.numberOfUpdates=0;d1.updateStartFunction=f1.bind(null,"busy");d1.updateSuccessFunction=f1.bind(null,"");d1.errorFunction=f1.bind(null,"error");var g1={text:c1.text,count:0,state:""};o.setProperty(e1,g1);}};I.init(i,j);}function w(){return m;}function x(){return f[o.getProperty(c)];}function y(i){if(!I){return;}var j=i.getParameter("bindingParams");s.oFiltersWithoutSmartFilterBar=q.extend(true,{},j);if(w()==="multi"){var _=s.oSmartFilterbar.getFilters();s.oFiltersForCounts=z(j);H(s.oSmartTable,j,_);}else if(w()==="single"){s.oFiltersForCounts=q.extend(true,{},j);}A(j);}function A(j){var _=x();if(_){var a1=_.selectionVariantFilters;for(var i in a1){j.filters.push(a1[i]);}}}function z(i){var j=q.extend(true,{},i);G(j.filters,s.oMultipleViewsHandler.aTableFilters);return j;}function E(i,j){if(I.getIsDifferentEntitySets&&I.getIsDifferentEntitySets()){$(i,j.filters);}}function G(_,a1){for(var i in a1){var b1=a1[i];for(var j=_.length;j--;j>=0){if(JSON.stringify(_[j])===JSON.stringify(b1)){_.splice(j,1);break;}}}}function U(){var i=s.oSmartTable.getModel();var j=[],_;var a1=s.oSmartFilterbar.getBasicSearchValue();var b1={};var c1;if(a1){b1={search:a1};}var d1;for(var e1 in f){d1=q.extend(true,{},s.oFiltersForCounts);c1=s.oSmartFilterbar.getFilters();var f1=f[e1];_=f1.entitySet;if(!_){_=s.oSmartTable.getEntitySet();}f1.numberOfUpdates++;f1.updateStartFunction(f1.numberOfUpdates);if(w()==="multi"){H(f1.implementingControl,d1,c1);}if(f1.selectionVariantFilters&&f1.selectionVariantFilters.length>0){j=d1.filters.concat(f1.selectionVariantFilters);}else{j=d1.filters;}i.read("/"+_+"/$count",{urlParameters:b1,filters:j,groupId:"updateMultipleViewsItemsCounts",success:f1.updateSuccessFunction.bind(null,f1.numberOfUpdates),error:f1.errorFunction.bind(null,f1.numberOfUpdates)});}}function H(i,j,_){E(i,j);W(i,_,j);}function J(){if(S){U();}if(w()==="multi"){I.setTablesToDirtyExcept(s.oSmartTable);}}function K(){return S;}function L(){return I;}function N(i){var j,_,a1,b1;j=i.getEntitySet();_=i.getModel().getMetaModel();a1=_.getODataEntitySet(j);b1=_.getODataEntityType(a1.entityType);return b1;}function O(i){var j=N(i);return j.property;}function V(i){var j=N(i);return j.navigationProperty;}function W(i,j,_){var a1=[],b1=[],c1;if(j.length<1){return;}if(I.getIsDifferentEntitySets&&I.getIsDifferentEntitySets()){a1=$(i,j);}else{a1=j;}b1=_.filters&&_.filters.slice();b1=b1.concat(a1);c1=new F(b1,true);_.filters=[c1];}function X(i){var j;for(j in f){if(f[j].implementingControl===i){return f[j].properties;}}}function Y(j,_,a1,b1,c1){var d1,e1,f1,g1,h1;if(j.indexOf("/")!==-1){d1=j.split("/");for(var i=0;i<d1.length-1;i++){e1=d1[i];for(var i in c1){if(c1[i].name===e1){f1=true;break;}}if(!f1){return false;}g1=a1.getODataAssociationEnd(b1,e1);b1=g1&&a1.getODataEntityType(g1.type);c1=b1&&b1.navigationProperty;}h1=b1&&b1.property;}else{h1=X(_);}return h1;}function Z(i){var j,_;if(i.indexOf("/")!==-1){j=i.split("/");_=j.pop();}else{_=i;}return _;}function $(i,_){var a1,b1,c1,j,d1,e1,f1,g1,h1,i1,h1;if(!_||_.length<1){return;}f1=i.getModel().getMetaModel();g1=N(i);e1=V(i);h1=q.extend(true,[],_);if(h1[0]&&h1[0].aFilters instanceof Array){d1=h1[0].aFilters;}else{d1=h1;}if(!d1){return;}for(j=d1.length-1;j>=0;j--){b1=false;if(d1[j].aFilters instanceof Array){c1=d1[j].aFilters[0].sPath;}else{c1=d1[j].sPath;}a1=Y(c1,i,f1,g1,e1);if(!a1){d1.splice(j,1);continue;}i1=Z(c1);a1.some(function(j1){if(j1.name===i1){b1=true;return b1;}});if(!b1){d1.splice(j,1);}}if(h1&&h1[0]&&h1[0].aFilters&&h1[0].aFilters.length<1){h1=[];}return h1;}(function(){var i,j,_,a1;i=C.getOwnerComponent().getAppComponent().getConfig();j=i&&i.pages[0]&&i.pages[0].component&&i.pages[0].component.settings;if(!j){return;}_=j.quickVariantSelectionX;a1=j.quickVariantSelection;if(_&&a1){throw new Error("Defining both QuickVariantSelection and QuickVariantSelectionX in the manifest is not allowed.");}Q=_||a1;if(!Q){return;}S=Q.showCounts;f=Object.create(null);o.setProperty(P,Object.create(null));o.setProperty(e,Object.create(null));var b1=C.byId("page");var c1=function(d1){o.setProperty(c,d1);var e1=o.bindProperty(c);e1.attachChange(function(f1){if(b1){b1.setPreserveHeaderStateOnScroll(true);}if(I.onSelectedKeyChanged){var g1=f1.getSource().getValue();I.onSelectedKeyChanged(g1);}var h1=s.oIappStateHandler.areDataShownInTable();var i1=true;if(typeof I.isTableDirty==='function'){i1=I.isTableDirty(s.oSmartTable);}if(s.oWorklistData.bWorkListEnabled){h1=true;i1=true;}if(h1&&i1){if(T.oCommonUtils.isSmartChart(s.oSmartTable)){s.oSmartTable.rebindChart();if(typeof I.setTableDirty==='function'){I.setTableDirty(s.oSmartTable,false);}}else if(T.oCommonUtils.isSmartTable(s.oSmartTable)){s.oSmartTable.rebindTable();T.oCommonUtils.refreshSmartTable(s.oSmartTable);}}else{T.oCommonUtils.setEnabledToolbarButtons(s.oSmartTable);}s.oIappStateHandler.changeIappState(true,h1);if(T.oCommonUtils.isSmartTable(s.oSmartTable)){if(b1&&b1.getPreserveHeaderStateOnScroll()){b1.setPreserveHeaderStateOnScroll(false);}}});};if(a1){I=new M(a1,s,C,T,c1,f);m="single";q.sap.log.info("This list supports multiple views with single table");}else{I=new a(_,s,C,T,c1,f);m="multi";q.sap.log.info("This list supports multiple views with multiple tables/charts");}o.setProperty(d,m);})();var G=t.testable(G,"fnRemoveTableSettingsFromFilters");var $=t.testable($,"fnCheckIfFiltersSupported");var X=t.testable(X,"findEntityProperties");var W=t.testable(W,"fnAddFiltersFromSmartFilterbar");return{getEnableAutoBinding:h,fnRegisterToChartEvents:r,onDetailsActionPress:k,determineSortOrder:l,onDataRequested:J,formatItemTextForMultipleView:n,getContentForIappState:p,restoreFromIappState:R,getVariantSelectionKey:u,init:v,getMode:w,onRebindContentControl:y,getShowCounts:K,getImplementingHelper:L};}return B.extend("sap.suite.ui.generic.template.ListReport.controller.MultipleViewsHandler",{constructor:function(s,C,T){q.extend(this,g(s,C,T));}});});
