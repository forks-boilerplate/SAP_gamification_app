sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/core/mvc/ControllerExtension","sap/ui/generic/app/navigation/service/NavError","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/comp/state/UIState"],function(q,B,C,N,S,U){"use strict";var d="sap.suite.ui.generic.template.customData",a="sap.suite.ui.generic.template.extensionData",b="sap.suite.ui.generic.template.genericData";var I=["INIT","DATA_SUITE","CANCEL","RESET","SET_VM_ID"];function n(o){if(o){for(var p in o){o[p]=null;}}}function f(o,O){var k=Object.keys(o);if(k.length!==Object.keys(O).length){return true;}for(var i=0;i<k.length;i++){var K=k[i];var p=o[K];var P=O[K];if(p.length!==P.length){return true;}for(var j=0;j<p.length;j++){if(p[j]!==P[j]){return true;}}}return false;}function l(m,D){if(sap.ui.support){var L=q.sap.log.getLevel();if(L<q.sap.log.Level.INFO){q.sap.log.setLevel(q.sap.log.Level.INFO);}}var s;if(typeof D==="string"){s=D;}else{s="";var c="";for(var k in D){s=s+c+k+": "+D[k];c="; ";}}q.sap.log.info(m,s,"sap.suite.ui.generic.template.ListReport.controller.IappStateHandler");}function g(s,c,t){var o=t.oCommonUtils.getNavigationHandler();var e=c.getOwnerComponent().getSmartVariantManagement();var r={appStateKey:"",urlParams:{},selectionVariant:"",tableVariantId:""};var h=false;var j=null;var A=Promise.resolve();var D=false;var k=false;var E=c.byId("editStateFilter");var m;var p=null;var u=null;s.oSmartFilterbar.setSuppressSelection(true);var v=(function(){var i;return function(){i=i||s.oSmartFilterbar.getNonVisibleCustomFilterNames();return i;};})();function w(){return D;}function x(){var _={};var a1=[];var b1=v();for(var i=0;i<b1.length;i++){var c1=b1[i];if(s.oSmartFilterbar.isVisibleInFilterBarByName(c1)){a1.push(c1);}}var d1={suppressDataSelection:!D,visibleCustomFields:a1};_[b]=d1;if(E){d1.editStateFilter=E.getSelectedKey();}var e1=s.oMultipleViewsHandler.getContentForIappState();if(e1){var f1=e1.mode==="single"?"tableViewData":"tableTabData";d1[f1]=e1.state;}if(s.oWorklistData.bWorkListEnabled){var g1=s.oWorklistData.oSearchField?s.oWorklistData.oSearchField.getValue():"";var h1={"searchString":g1};d1.Worklist=h1;}var i1={};_[d]=i1;c.getCustomAppStateDataExtension(i1);var j1;var k1=true;var l1=function(m1,n1){if(!(m1 instanceof C)){throw new Error("State must always be set with respect to a ControllerExtension");}if(!k1){throw new Error("State must always be provided synchronously");}if(n1){j1=j1||Object.create(null);var o1=m1.getMetadata().getNamespace();j1[o1]=n1;}};c.templateBaseExtension.provideExtensionAppStateData(l1);k1=false;if(j1){_[a]=j1;}return _;}function y(){var _=JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant());var a1=new S(_);var b1=c.getVisibleSelectionsWithDefaults();for(var i=0;i<b1.length;i++){if(!a1.getValue(b1[i])){a1.addSelectOption(b1[i],"I","EQ","");}}if(c.byId('template::PageVariant')&&c.byId('template::PageVariant').currentVariantGetModified()&&a1.getID()){a1.setID("");}if(s.oWorklistData.bWorkListEnabled){var c1=s.oWorklistData.oSearchField?s.oWorklistData.oSearchField.getValue():"";a1.addSelectOption("Worklist.SearchField","I","EQ",c1);}var d1={selectionVariant:a1.toJSONString(),tableVariantId:(!e&&s.oSmartTable.getCurrentVariantId())||"",customData:x()};return d1;}function z(){l("fnStoreCurrentAppStateAndAdjustURL called",{bAppStateDirty:k,bDataAreShownInTable:D});if(!k){return;}k=false;try{p=o.storeInnerAppStateWithImmediateReturn(y(),true);}catch(i){q.sap.log.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: "+i);return;}if(p instanceof N){k=true;p=null;return;}p.promise.fail(function(_){q.sap.log.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Error when persisting appState"+_);});l("Result received from storeInnerAppStateWithImmediateReturn",{appStateKey:p.appStateKey,sAppStateKeyInUrl:u});if(u===p.appStateKey){p=null;}else{l("Call NavigationHandler.replaceHash",{appStateKey:p.appStateKey});o.replaceHash(p.appStateKey);}}function R(_,a1){if(_&&_.editStateFilter!==undefined){if(E){E.setSelectedKey((_.editStateFilter===null)?0:_.editStateFilter);}}var b1=_&&_.visibleCustomFields;if(b1&&b1.length>0){var c1=s.oSmartFilterbar.getAllFilterItems();for(var i=0;i<c1.length;i++){var d1=c1[i];var e1=d1.getName();if(b1.indexOf(e1)!==-1){d1.setVisibleInFilterBar(true);}}}D=a1&&!(_&&_.suppressDataSelection);if(D&&!s.oWorklistData.bWorkListEnabled){s.oSmartFilterbar.search();$(D);}}function F(i){c.restoreCustomAppStateDataExtension(i||{});}function G(i){if(!i){return;}var _=true;var a1=function(b1){if(!(b1 instanceof C)){throw new Error("State must always be retrieved with respect to a ControllerExtension");}var c1=b1.getMetadata().getNamespace();if(!_){throw new Error("State must always be restored synchronously");}return i[c1];};c.templateBaseExtension.restoreExtensionAppStateData(a1);_=false;}function H(i,_){i=i||{};if(i.hasOwnProperty(d)&&i.hasOwnProperty(b)){G(i[a]);F(i[d]);R(i[b],_);}else{if(i._editStateFilter!==undefined){R({editStateFilter:i._editStateFilter});delete i._editStateFilter;}F(i);}}function J(){return A.then(function(){if(r.appStateKey){return{"sap-iapp-state":[r.appStateKey]};}return r.urlParams;});}function K(i){var _=t.oComponentUtils.getTemplatePrivateModel();_.setProperty("/generic/bDataAreShownInTable",i);}function L(i,_){l("changeIappState called",{bFilterOrSettingsChange:i,bDataAreShown:_,bDataAreShownInTable:D,bIsTransferringUrlStateToPageState:h,bAppStateDirty:k});K(_);if(h){return;}if(i||_!==D){D=_;if(!k){k=true;if(!s.oSmartFilterbar.isDialogOpen()){if(j){z();}else{setTimeout(z,0);}}}}}function M(i){var _=s.oSmartFilterbar.determineMandatoryFilterItems(),a1;for(var b1=0;b1<_.length;b1++){if(_[b1].getName().indexOf("P_DisplayCurrency")!==-1){if(i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")&&i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0]&&i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low){a1=i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low;if(a1){i.oSelectionVariant.addParameter("P_DisplayCurrency",a1);}}break;}}}function O(_,a1,b1){l("fnAdaptToAppState called",{sNavType:b1,sAppStateKeyInUrl:u,sAppStateKey:_.appStateKey,storingInformationAppStateKey:p&&p.appStateKey});s.oSmartFilterbar.setSuppressSelection(false);s.sNavType=b1;var c1=_.appStateKey||"";if(h){return;}if(u===null){u=c1;}else if(c1!==u){return;}h=true;var d1=_.selectionVariant||"";var e1=(!e&&_.tableVariantId)||"";var f1=(!c1&&a1)||{};if((r.appStateKey!==c1||r.selectionVariant!==d1||r.tableVariantId!==e1||f(r.urlParams,f1))&&b1!==sap.ui.generic.app.navigation.service.NavType.initial){if(!p||p.appStateKey!==c1){var g1=_&&_.bNavSelVarHasDefaultsOnly;if((_.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1)&&(_.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1)&&(_.oSelectionVariant.getParameterNames().indexOf("P_DisplayCurrency")===-1)){M(_);}if(!s.oWorklistData.bWorkListEnabled){if(_.oSelectionVariant&&r.selectionVariant!==d1){var h1=_.oSelectionVariant.getParameterNames().concat(_.oSelectionVariant.getSelectOptionsPropertyNames());for(var i=0;i<h1.length;i++){s.oSmartFilterbar.addFieldToAdvancedArea(h1[i]);}}var i1=new U({selectionVariant:_.oSelectionVariant.toJSONObject()});_.oUiState=i1;if(g1&&s.oSmartFilterbar.isCurrentVariantStandard()){s.oSmartFilterbar.setUiState(i1,{replace:false,strictMode:false});}else if(!g1||s.oSmartFilterbar.isCurrentVariantStandard()){l("Clear filter bar");s.oSmartFilterbar.clearVariantSelection();s.oSmartFilterbar.clear();s.oSmartFilterbar.setUiState(i1,{replace:true,strictMode:false});}}if(e1!==r.tableVariantId){s.oSmartTable.setCurrentVariantId(e1);}_.customData=_.customData||{};var j1=s.oMultipleViewsHandler.getMode();if(j1){var k1=j1==="single"?"tableViewData":"tableTabData";if(_.customData[b]&&_.customData[b][k1]){s.oMultipleViewsHandler.restoreFromIappState(_.customData[b][k1]);}}if(s.oWorklistData.bWorkListEnabled){s.oWorklistData.oWorklistSavedData=_.customData[b]&&_.customData[b]["Worklist"]?_.customData[b]["Worklist"]:{};s.oWorklistHandler.restoreWorklistStateFromIappState();}H(_.customData,true);}r={appStateKey:c1,urlParams:f1,selectionVariant:d1,tableVariantId:e1};}if(j){j();j=null;}if(b1!==sap.ui.generic.app.navigation.service.NavType.iAppState&&!D){var l1=(b1===sap.ui.generic.app.navigation.service.NavType.xAppState||b1===sap.ui.generic.app.navigation.service.NavType.URLParams)&&!_.bNavSelVarHasDefaultsOnly;D=l1||s.bLoadListAndFirstEntryOnStartup||m||s.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled()||s.oMultipleViewsHandler.getEnableAutoBinding();K(D);if(D){s.oSmartFilterbar.search();$(D);}}if(b1==="initial"&&s.oWorklistData.bWorkListEnabled){if(s.oSmartFilterbar.isCurrentVariantStandard()){s.oWorklistHandler.restoreWorklistStateFromIappState();}}p=null;h=false;}function P(){if(!j){A=new Promise(function(_){j=_;});}var i=new Promise(function(_,a1){var b1=o.parseNavigation();b1.done(function(c1,d1,e1){O(c1,d1,e1);_();});b1.fail(function(c1,d1,e1){q.sap.log.warning(c1.getErrorCode(),"app state could not be parsed - continuing with empty state","sap.suite.ui.generic.template.ListReport.controller.IappStateHandler");O({},d1,sap.ui.generic.app.navigation.service.NavType.initial);_();});});return i;}function Q(){var i=y();s.oSmartFilterbar.setFilterData({_CUSTOM:i.customData});}function T(){L(true,D);}function V(i){var _=i.getParameter("context");var a1=s.oSmartFilterbar.getFilterData();if(a1._CUSTOM!==undefined){if(s.oWorklistData.bWorkListEnabled){var b1=a1._CUSTOM[b]["Worklist"];s.oSmartFilterbar.setSuppressSelection(false);s.oWorklistData.oSearchField.setValue(b1.searchString);s.oWorklistData.oSearchField.fireSearch();}else{H(a1._CUSTOM);}}else{var c1=x();n(c1[d]);n(c1[b]);H(c1);}if(I.indexOf(_)<0){D=i.getParameter("executeOnSelect");L(true,D);}}function W(){if(!e){L(true,D);}}function X(){if(!e){L(true,D);}}function Y(i){var _=i.getParameter("arguments");var a1=_&&_["?query"];u=(a1&&a1["sap-iapp-state"])||"";if(p){if(p.appStateKey!==u){q.sap.log.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Got AppstateKey "+u+" expected "+p.appStateKey);return false;}P();return true;}return false;}function Z(){m=s.oSmartTable.getEnableAutoBinding();s.oSmartFilterbar.attachFiltersDialogClosed(z);}function $(D){if(c&&c.getOwnerComponent&&c.getOwnerComponent().getModel){var i=c.getOwnerComponent().getModel("_templPriv");if(D){i.setProperty("/listReport/isHeaderExpanded",false);}else{i.setProperty("/listReport/isHeaderExpanded",true);}}}s.getCurrentAppState=y;return{areDataShownInTable:w,parseUrlAndApplyAppState:P,getUrlParameterInfo:J,changeIappState:L,onSmartFilterBarInitialise:Z,onBeforeSFBVariantFetch:Q,onAfterSFBVariantSave:T,onAfterSFBVariantLoad:V,onAfterTableVariantSave:W,onAfterApplyTableVariant:X,isStateChange:Y};}return B.extend("sap.suite.ui.generic.template.ListReport.controller.IappStateHandler",{constructor:function(s,c,t){q.extend(this,g(s,c,t));}});});
