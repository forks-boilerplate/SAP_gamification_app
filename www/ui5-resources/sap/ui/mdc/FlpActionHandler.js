/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2018 SAP SE. All rights reserved
 */
sap.ui.define(['sap/ui/mdc/base/FieldInfoBase','sap/ui/mdc/base/linkinfo/Panel','sap/ui/mdc/base/linkinfo/PanelItem','sap/ui/mdc/base/linkinfo/ContactDetails','sap/m/Link','sap/ui/mdc/base/linkinfo/Util','sap/ui/model/json/JSONModel','sap/ui/core/InvisibleText','sap/m/ResponsivePopover','sap/ui/mdc/base/linkinfo/Factory'],function(F,P,a,C,L,U,J,I,R,b){"use strict";var c=F.extend("sap.ui.mdc.FlpActionHandler",{metadata:{library:"sap.ui.mdc",specialSettings:{metadataContexts:{provider:"sap/ui/mdc/experimental/provider/control/FlpActionHandler"}},properties:{semanticObject:{type:"string"},additionalSemanticObjects:{type:"string[]",defaultValue:[]},semanticObjectMapping:{type:"object"},enablePersonalization:{type:"boolean",defaultValue:true},title:{type:"string"},subTitle:{type:"string"}},aggregations:{contactDetailsItem:{type:"sap.ui.mdc.base.linkinfo.ContactDetailsItem",multiple:false}}}});c.prototype.init=function(){var m=new J({popoverTitle:"",availableActions:[]});m.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);m.setSizeLimit(1000);this.setModel(m,"$sapuimdcFlpActionHandler");this._proxyOnModelContextChange=jQuery.proxy(this._onModelContextChange,this);this.attachModelContextChange(this._proxyOnModelContextChange);};c.prototype.exit=function(){this.detachModelContextChange(this._proxyOnModelContextChange);};c.prototype.setSemanticObject=function(s){this.setProperty("semanticObject",s);this._retrieveNavigationTargets();return this;};c.prototype.setContactDetailsItem=function(i){this.setAggregation("contactDetailsItem",i);this.fireDataUpdate();return this;};c.prototype.isTriggerable=function(){if(this._hasExtraContent()){return true;}return this._getTriggerableActions().length>0;};c.prototype.getDirectLink=function(){if(this._hasExtraContent()){return null;}var A=this._getTriggerableActions();if(A.length!==1){return null;}return new L({text:A[0].text,target:A[0].target,href:A[0].href});};c.prototype.createPopover=function(){var m=this._getInternalModel();var i=new I({text:m.getProperty("/popoverTitle")});var t=this;return this.getPopoverContent().then(function(p){return new R({contentWidth:"380px",horizontalScrolling:false,showHeader:sap.ui.Device.system.phone,placement:sap.m.PlacementType.Auto,ariaLabelledBy:i,content:[p,i],beforeClose:function(){this.destroyContent();},afterClose:function(){var o=t.getPopover();if(o){o.destroy();}}});});};c.prototype.getPopoverContent=function(){var s=this._getNavigationContainerStableId();if(!s){jQuery.sap.log.error("FlpActionHandler: Due to undefined stable ID the button of action personalization is set to disabled");}var o;if(this.getContactDetailsItem()){var d=this.getContactDetailsItem();o=new C({items:d.clone()});o.setModel(this.getModel());o.bindElement({path:this.getBindingContext().getPath(),parameters:d.getParameters()});}this._updateMainItemInformation();var p=new P({items:{path:'$sapuimdcFlpActionHandler>/availableActions',templateShareable:false,template:new a({href:"{$sapuimdcFlpActionHandler>href}",text:"{$sapuimdcFlpActionHandler>text}",description:"{$sapuimdcFlpActionHandler>description}",target:"{$sapuimdcFlpActionHandler>target}",visible:"{$sapuimdcFlpActionHandler>visible}",icon:"{$sapuimdcFlpActionHandler>icon}",isMain:"{$sapuimdcFlpActionHandler>isMain}"})},extraContent:o,enablePersonalization:this.getEnablePersonalization()&&!!s});p.setModel(this._getInternalModel(),"$sapuimdcFlpActionHandler");return Promise.resolve(p);};c.prototype._onModelContextChange=function(){if(!this.getBindingContext()){return;}this._retrieveNavigationTargets();};c.prototype._retrieveNavigationTargets=function(){var s=this.getSemanticObject();var A=this.getAdditionalSemanticObjects()||[];var d="";var o=this.getControl();var e=this._getAppComponentForControl(o);var S=this._calculateSemanticAttributes(s,A,this.getSemanticObjectMapping(),o&&o.getBindingContext()||undefined);U.retrieveNavigationTargets(s,A,d,e,S).then(function(n){var m=this._getInternalModel();var f=n.availableActions;if(n.mainNavigation){f.push(n.mainNavigation);}m.setProperty("/availableActions",this._updateVisibilityOfAvailableActions(f));this.fireDataUpdate();}.bind(this));};c.prototype._calculateSemanticAttributes=function(s,A,S,B){if(!B||(!s&&!(A&&A.length))){return{};}var r={};var o=B.getObject(B.getPath());var d=[s].concat(A);d.forEach(function(e){r[e]={};for(var f in o){if(f==="__metadata"){continue;}if(o[f]===undefined||o[f]===null){continue;}if(jQuery.isPlainObject(o[f])){continue;}if(S&&(!S[e]||!S[e][f])){continue;}var g=S?S[e][f]:f;if(r[e][g]){jQuery.sap.log.error("During the mapping of the attribute "+f+" a clash situation is occurred. This can lead to wrong navigation later on.");}r[e][g]=o[f];}});return r;};c.prototype._onAvailableActionsPersonalizationPress=function(e){var t=this;var p=e.getSource();this.getPopover().setModal(true);p.openSelectionDialog(false,true,undefined,true,undefined).then(function(){if(t.getPopover()){t.getPopover().setModal(false);}});};c.prototype._updateVisibilityOfAvailableActions=function(m){var M=U.getStorableAvailableActions(m);var h=M.some(function(o){return!!o.isSuperiorAction;});M.forEach(function(o,i){if(m.length>10){o.visible=false;}if(h){o.visible=false;}if(o.isSuperiorAction){o.visible=true;}});return m;};c.prototype._getExtraContent=function(){var o=this.getContactDetailsItem();if(!o){return null;}var d=new C({items:o.clone()});d.setModel(this.getModel());d.bindElement({path:this.getBindingContext().getPath(),parameters:o.getParameters()});};c.prototype._updateMainItemInformation=function(){var m=this._getInternalModel();var A=m.getProperty("/availableActions");var i=U.getIndexByKey("isMain",true,A);if(i<0){i=A.length;m.setProperty("/availableActions/"+i+"/",{isMain:true});}m.setProperty("/availableActions/"+i+"/text",this.getTitle());if(this.getSubTitle()){m.setProperty("/availableActions/"+i+"/description",this.getSubTitle());}};c.prototype._getNavigationContainerStableId=function(){var o=this.getControl();if(!o){jQuery.sap.log.error("FlpActionHandler: Stable ID could not be determined because the control is undefined");return undefined;}var A=this._getAppComponentForControl(o);if(!A){jQuery.sap.log.error("FlpActionHandler: Stable ID could not be determined because the app component is not defined for control '"+o.getId()+"'");return undefined;}var s=[this.getSemanticObject()].concat(this.getAdditionalSemanticObjects());U.sortArrayAlphabetical(s);if(!s.length){jQuery.sap.log.error("FlpActionHandler: Stable ID could not be determined because the property 'persistencyKey' is not defined");return undefined;}return A.createId("sapuimdcbaseactionActionHandler---"+s.join("--"));};c.prototype._getTriggerableActions=function(){var m=this._getInternalModel();return m.getProperty('/availableActions').filter(function(A){return!!A.href;});};c.prototype._hasExtraContent=function(){return!!this.getContactDetailsItem();};c.prototype._getInternalModel=function(){return this.getModel("$sapuimdcFlpActionHandler");};c.prototype._getAppComponentForControl=function(o){return b.getService("FlUtils").getAppComponentForControl(o);};return c;},true);
