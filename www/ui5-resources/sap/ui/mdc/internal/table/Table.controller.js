/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2018 SAP SE. All rights reserved
 */
sap.ui.define(["../../ResourceModel","sap/ui/base/Object","sap/ui/mdc/experimental/Action","sap/ui/model/json/JSONModel","sap/m/Bar","sap/m/Label","sap/m/Button"],function(R,B,A,J,a,L,b){"use strict";var T=B.extend("sap.ui.mdc.internal.table.Table.controller",{constructor:function(t){B.apply(this,arguments);this.oTable=t;this.oInnerTable=t.getInnerTable();}});var p,c=false;T.prototype.handleDataRequested=function(e){this.oInnerTable.setBusy(true);};T.prototype.handleCallAction=function(e){var m=e.getParameters();var o=e.getSource();m.mode=o.getMode();if(m.mode==='Inline'){m.contexts=[o.getBindingContext()];}else{m.contexts=this.oTable.getSelectedContexts();}m.setBusy=true;m.checkBusy=true;this.oTable.fireCallAction(m);};T.prototype.getToolbarActions=function(t){var d=[];for(var i=0;i<t.length;i++){if(t[i]instanceof A){d.push(t[i]);}}return d;};T.prototype.enableDisableActionsUtil=function(s,t){var f,d,o;if(s!=null){for(var i=0;i<t.length;i++){o=t[i];f=o.getMultiplicityFrom();d=o.getMultiplicityTo();if((!f||(s>=f)&&(!d||s<=d))){o.setEnabled(true);}else{o.setEnabled(false);}}}};T.prototype.bindTableCountUtil=function(t){if(t!=null){t.setModel(this.oInnerTable.getModel(),"headerContext");}var o=this.oTable.getListBinding();if(o){t.setBindingContext(o.getHeaderContext(),"headerContext");}};T.prototype.createAndOpenP13nSettingsDialog=function(P,d){if(this.oP13nSettingsPropertyModel==null&&this.oP13nSettingsPropertyModel==undefined){P["p13nSortItems"]=[];P["p13nGroupItems"]=[];this.oP13nSettingsPropertyModel=new J(P);}var o=new sap.ui.view("p13nSettingsXMLView",{viewName:"sap.ui.mdc.internal.table.p13nsettings.P13nSettings",type:"XML",async:true,preprocessors:{xml:{bindingContexts:{propertiesModel:this.oP13nSettingsPropertyModel.createBindingContext("/"),dialogProperties:d.createBindingContext("/")},models:{propertiesModel:this.oP13nSettingsPropertyModel,dialogProperties:d}}}});o.setModel(this.oP13nSettingsPropertyModel);this.oTable.addDependent(o);o.loaded().then(function(){var C=o.getController();p=o.byId("p13nDialog");C.oTableController=this;var t=new L({text:this._p13nTitle()}),e=new b({text:'{$i18n>p13nDialog.RESET}',press:this._p13nReset});var f=new a({contentMiddle:t,contentRight:e});p.setCustomHeader(f);p.open();}.bind(this));};T.prototype._p13nTitle=function(){if(c){return R.getText("p13nDialog.TITLE");}if(p.getPanels()[0]._oSortPanel){return R.getText("p13nDialog.SORT_PANEL_TITLE");}if(p.getPanels()[0]._oGroupPanel){return R.getText("p13nDialog.GROUP_PANEL_TITLE");}};T.prototype._p13nReset=function(){var s,g;if(c){p.getPanels().forEach(function(P){if(P._oSortPanel){s=P._oSortPanel;}if(P._oGroupPanel){g=P._oGroupPanel;}});}else{s=p.getPanels()[0]._oSortPanel;g=p.getPanels()[0]._oGroupPanel;}s&&s.setConditions({});g&&g.setConditions({});};T.prototype.getEntityTypePath=function(){var l=this.oTable.getListBinding().getPath();if(l.indexOf("/")===0){return l+"/";}else{return this.oTable.getModel().getMetaModel().getMetaContext(this.oTable.getBindingContext().getPath()).getPath()+'/'+l+'/';}};T.prototype.onStandardActionClick=function(e){var s=e.getSource().getText(),i=this.oInnerTable.getModel().getMetaModel(),E=i.getObject(this.getEntityTypePath()),t=this.oInnerTable.getColumns(),C=t.length,d=[],S=0,f=[],g=[],h=[],k=[],n=[];var l=this.oTable.getListBinding().getPath();if(l.charAt(0)!=='/'){var j=this.getEntityTypePath().split('/');l="/"+j[1]+"/$NavigationPropertyBinding/"+j[2];}var o=i.getObject(l+"@Org.OData.Capabilities.V1.SortRestrictions");if(o){o.NonSortableProperties.forEach(function(N){n.push(N.$PropertyPath);});}for(var m=0;m<C;m++){var q=t[m];var r=q.getId().split("::");d.push(r[r.length-1]);}E["$Key"].forEach(function(w){k.push(w);});for(var u in E){if(n.indexOf(u)===-1&&typeof(E[u])=="object"&&E[u].$kind&&E[u].$kind==="Property"){var _=i.getObject(this.getEntityTypePath()+u+"@com.sap.vocabularies.Common.v1.Label");S=(d.indexOf(u)>-1)?S+1:S;var I={"name":(_!=null&&_!=undefined)?_:u,"columnKey":u,"selected":false};f.push(JSON.parse(JSON.stringify(I)));g.push(JSON.parse(JSON.stringify(I)));var v=JSON.parse(JSON.stringify(I));v.selected=!!(d.indexOf(u)>-1);h.push(v);}}var P={"isMultiTab":c,"keyAttributes":k,"sortPanelItems":f.sort(function(x,y){if(x.name>=y.name){return 1;}else{return-1;}}),"groupPanelItems":g.sort(function(x,y){if(x.name>=y.name){return 1;}else{return-1;}}),"columnPanelItems":h.sort(function(x,y){if(x.selected===y.selected){return 0;}else if(x.selected){return-1;}else{return 1;}})};var D=new J({"InitialVisiblePanel":s,"showSortPanel":!!(c||s==="sort"),"showGroupPanel":!!((c||s==="group")&&(this.oInnerTable.getMetadata().getName()==="sap.m.Table")),"showColumnPanel":!!(c||s==="column")});this.createAndOpenP13nSettingsDialog(P,D);};T.prototype.applyGroupAndSort=function(s){if(s.length>0){var o=this.getListBinding();o.sort(s);}};return T;});
