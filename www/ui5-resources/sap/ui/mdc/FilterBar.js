/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2018 SAP SE. All rights reserved
 */
sap.ui.define(["./ResourceModel",'sap/ui/mdc/XMLComposite','sap/ui/base/ManagedObject','sap/ui/Device',"sap/ui/mdc/internal/common/Helper","sap/ui/mdc/FilterField","sap/m/SearchField","sap/m/Dialog","sap/m/Button","sap/m/MessageToast","sap/ui/model/json/JSONModel",'sap/ui/mdc/base/ConditionModel','sap/ui/mdc/experimental/P13nFilterPanel','sap/ui/mdc/experimental/P13nFilterItem',"sap/ui/fl/ControlPersonalizationAPI"],function(R,X,M,D,C,F,S,a,B,b,J,c,P,d,e){"use strict";var f=X.extend("sap.ui.mdc.FilterBar",{metadata:{designtime:"sap/ui/mdc/designtime/FilterBar.designtime",specialSettings:{metadataContexts:{defaultValue:"{ model: 'entitySet', path:'',  name: 'entitySet'},{model: 'sap.fe.deviceModel', path: '/', name: 'sap.fe.deviceModel'},{model:'entitySet', path:'./@com.sap.vocabularies.UI.v1.SelectionFields', name:'selectionFields'}"}},properties:{liveUpdate:{type:"boolean",defaultValue:!D.system.phone,invalidate:"template"},searchOnStart:{type:"boolean",defaultValue:true,invalidate:"template"},filterSummary:{type:"string",defaultValue:"",invalidate:false},enabled:{type:"boolean",defaultValue:true,invalidate:false},conditionModelName:{type:"string",defaultValue:"sap.fe.cm",invalidate:false},listBindingNames:{type:"string[]",invalidate:false},hideBasicSearch:{type:"boolean",defaultValue:false,invalidate:"template"},enablePersonalization:{type:"boolean",defaultValue:true,invalidate:false}},events:{search:{},change:{}},aggregations:{},publicMethods:[]},fragment:"sap.ui.mdc.internal.filterbar.FilterBar"});var s=function(E){var o=this._getConditionModel(),m=this.getModel(),l,g,h;h=o.applyFilters();if(h&&m.getBindingForReference){var i=this._getSearchControl();if(i){g=i.getValue()||undefined;l=this.getListBindingNames();l.forEach(function(L){m.getBindingForReference(L).then(function(j){j.changeParameters({$search:g});});});}}};f.prototype.init=function(){X.prototype.init.call(this);var t=this;this._bIsReady=false;this.attachSearch(s);this._requestConditionModel().then(function(o){if(!t.bInitialized){t.bInitialized=true;var g=o.bindProperty("/",o.getContext("/"));g.attachChange(t.handleChange.bind(t));if(t.getSearchOnStart()&&t.getEnabled()){t._bIsReady=true;t.fireSearch();}if(!t.getEnabled()){t._getInnerFilterBar().setBusy(true);}}});};f.prototype.onBeforeRendering=function(){this._setFilterSummary();};f.prototype.setEnabled=function(E){this._getInnerFilterBar().setBusy(!E);this.setProperty("enabled",E);if(E){if(this.bInitialized&&this.getSearchOnStart()){this._bIsReady=true;this.fireSearch();}}};f.prototype.isReady=function(){return this._bIsReady;};f.prototype.getAppState=function(){var o=this._getConditionModel(),g=this._getDraftEditStateControl(),h=this._getSearchControl(),A={};if(o){A.conditionModel=o.serialize();}if(g){A.draftEditState=g.getSelectedKey();}if(h){A.search=h.getValue();}return A;};f.prototype.setAppState=function(A){var t=this;return this._requestConditionModel().then(function(o){var g=t._getDraftEditStateControl(),h=t._getSearchControl();if(A.conditionModel){if(o){o.parse(A.conditionModel);}else{throw("app state contains condition model state but condition model not yet set");}}if(A.draftEditState&&g){g.setSelectedKey(A.draftEditState);}if(A.search&&h){h.setValue(A.search);}if(!t.getLiveUpdate()){t.handleGo();}});};f.prototype.handleChange=function(){if(this.getLiveUpdate()&&this.getEnabled()){this.fireSearch();this._setFilterSummary();this.fireChange();}else{this._bIsReady=false;this.fireChange();}};f.prototype.handleSearch=function(E){this.fireSearch();this._setFilterSummary();this.fireChange();};f.prototype.handleSearchChange=function(E){var t=this,i;if(t._iSearchCounter){t._iSearchCounter++;}else{t._iSearchCounter=1;}i=t._iSearchCounter;if(this.getLiveUpdate()){setTimeout(function(){if(i===t._iSearchCounter){t.fireSearch();t._setFilterSummary();t.fireChange();delete t._iSearchCounter;}},400);}else{this._bIsReady=false;this.fireChange();}};f.prototype.handleGo=function(){this._bIsReady=true;this.fireSearch();this._setFilterSummary();this.fireChange();};f.prototype.handleAdapt=function(E){var t=this;var o=this.getModel(this.getConditionModelName());var g=o.clone();var h,A,j;this.aSelectedFilter=[];if(this.oAdaptDialog){j=this.oAdaptDialog.getModel("p13n");this._updateAdaptFilterModel(j);}else{var p=new P();this.oAdaptDialog=A=new a({title:"Adapt Filters",contentWidth:"75%",contentHeight:"75%",content:p,verticalScrolling:true,resizable:true,draggable:true,endButton:new B({text:'{$i18n>filterbar.ADAPT_CANCEL}',press:function(){A.close();}}),beginButton:new B({text:'{$i18n>filterbar.ADAPT_OK}',type:'Emphasized',press:function(){var n=j.getObject("/filters");var k=[],r=[];for(var i=0;i<n.length;i++){if(n[i].selected&&t.aSelectedFilter.indexOf(n[i])===-1){k.push(n[i]);}else if(!n[i].selected&&t.aSelectedFilter.indexOf(n[i])>-1){r.push(n[i]);}}if(k.length>0||r.length>0){t._adaptFilterBar(k,r);}o.merge(undefined,this.getModel("sap.fe.cm"));o.applyFilters();A.close();}})});j=this._getAdaptFilterModel(A);A.setModel(j,"p13n");p.bindAggregation("items",{path:"/filters",model:"p13n",factory:function(I,k){var m=k.getObject(k.getPath());return new d({columnKey:{path:"p13n>"+k.getPath()+"/columnKey"},text:{path:"p13n>"+k.getPath()+"/text"},tooltip:{path:"p13n>"+k.getPath()+"/tooltip"},position:{path:"p13n>"+k.getPath()+"/position"},selected:{path:"p13n>"+k.getPath()+"/selected"},required:{path:"p13n>"+k.getPath()+"/required"},controls:[m.control]});}});this.addDependent(A);}h=j.getObject("/filters");for(var i=0;i<h.length;i++){if(h[i].selected){this.aSelectedFilter.push(h[i]);}}this.oAdaptDialog.setModel(g,"sap.fe.cm");this.oAdaptDialog.open();};f.prototype._getEntitySet=function(){return this.byId("template::Filterbar::Adapt").getCustomData()[0].getValue();};f.prototype._getInnerFilterBar=function(){return this.get_content();};f.prototype._setFilterSummary=function(){var o=this._getSearchControl(),g=this._getDraftEditStateControl(),h,j="",k=[],i;if(o){h=o.getValue();}if(h){j=R.getText("filterbar.SEARCHBY")+": "+h+((k.length>0)?" | ":"");}if(g&&g.getSelectedKey()!=='0'){k.push(R.getText("filterbar.EDITING_STATUS"));}var l=this._getFilterFieldControls();for(i=0;i<l.length;i++){if(l[i].getConditions().length>0){k.push(l[i].getCustomData()[0].getValue());}}if(k.length>0){j+=R.getText("filterbar.FILTERBY")+" ("+k.length+"): ";for(i=0;i<k.length;i++){j+=((i>0)?', ':'')+k[i];}}if(!j){j=R.getText("filterbar.FILTERBYNONE");}this.setFilterSummary(j);};f.prototype._requestConditionModel=function(){var o=this._getConditionModel(),t=this;if(o){return Promise.resolve(o);}else{return new Promise(function(r){var m=t.getModel();var g=function(){var m=t.getModel(),o,n;if(!m){return;}t.detachModelContextChange(g);o=t.getModel(t.getConditionModelName());if(o){return Promise.resolve(o);}else{n=t.getListBindingNames();if(n&&m.getBindingForReference){n.forEach(function(N){m.getBindingForReference(N).then(function(l){o=t.getModel(t.getConditionModelName());if(!o){o=c.getFor(l);this.setModel(o,this.getConditionModelName());}r(o);}.bind(this));}.bind(t));}}};if(m){g();}else{t.attachModelContextChange(g);}});}};f.prototype._getConditionModel=function(){return this.getModel(this.getConditionModelName());};f.prototype._getDraftEditStateControl=function(){var g=this._getInnerFilterBar().getContent();var o;for(var i=0;i<g.length;i++){if(!(g[i]instanceof F)&&g[i].getItems){o=g[i].getItems()[1];if(o.getBinding("items")&&o.getBinding("items").getPath()==="/editStates"&&o.getBinding("items").getModel()===o.getModel("$draft")){return o;}}}};f.prototype._getSearchControl=function(){if(!this.getHideBasicSearch()){var g=this._getInnerFilterBar().getContent();var o;for(var i=0;i<g.length;i++){o=g[i].getItems()[1];if(o instanceof S){return o;}}}};f.prototype._getFilterFieldControls=function(){var g=this._getInnerFilterBar().getContent();var o,h=[];for(var i=0;i<g.length;i++){o=g[i];if(o instanceof F){h.push(o.get_content().getItems()[1]);}}return h;};f.prototype._getAdaptFilterModel=function(o){var t=this;var g=this._getFilterFieldControls();var E=this._getEntitySet();var h=[];var m=this.getModel().getMetaModel();var j=m.getObject("/"+E+"/");var A,k;function l(i){return F.createInstance({entitySet:E,propertyPath:i,metaModel:m,parent:o});}function n(i){return t._getFilterFieldControl(g,i)!==undefined;}function q(u){for(var i=0;i<g.length;i++){if(g[i].getFieldPath()===u){return i;}}}for(var p in j){if(j[p].$kind&&j[p].$kind==="Property"){A=m.getObject("/"+E+"/"+p+"@");k=m.getContext("/"+E+"/"+p);if(C.isPropertyFilterable(p,{context:k})){h.push({columnKey:p,text:A['@com.sap.vocabularies.Common.v1.Label']||p,position:q(p),tooltip:A['@com.sap.vocabularies.Common.v1.Label']||p,selected:n(p),control:l(p),required:F._helper.isRequiredInFilter(p,{context:k})});}}}var r=new J({"filters":h});return r;};f.prototype._updateAdaptFilterModel=function(A){var g=this._getFilterFieldControls();var h=A.getObject("/filters");for(var i=0;i<h.length;i++){h[i].selected=this._getFilterFieldControl(g,h[i].columnKey)!==undefined;}A.setProperty("/filters",h);};f.prototype._getFilterFieldControl=function(g,p){for(var i=0;i<g.length;i++){if(g[i].getFieldPath()===p){return g[i];}}};f.prototype._adaptFilterBar=function(A,r){var g="",h="",i=[];A.forEach(function(o){g+=o.text+", ";i.push({selectorControl:this,changeSpecificData:{changeType:"addFilter",content:{columnKey:o.columnKey,text:o.text+':'}}});}.bind(this));r.forEach(function(o){h+=o.text+", ";i.push({selectorControl:this,changeSpecificData:{changeType:"removeFilter",content:{removedElement:this._getFilterFieldControl(this._getFilterFieldControls(),o.columnKey).getParent().getParent().getId()}}});}.bind(this));if(e.hasVariantManagement(this)){e.addPersonalizationChanges(i);}else{b.show("Adapting the Filter Bar is not yet implemented. \n The following filters shall be added:"+g+"The following filters shall be removed: "+h);}};f._helper={resolveSelectionField:function(o){var p=o.getObject();if(p.$PropertyPath){return o.getModel().createBindingContext(o.getPath()+"/$PropertyPath");}else{return o;}},isNavPropertyFilterable:function(o,n){var E,g,i=false,p=o.getPath(),m=o.getModel();E=C._getEntitySetPath(m,p);g=p.slice(E.length+1);if(g.indexOf("/")<0){i=C._isInNonFilterableProperties(m,E,g);}else{i=C._isContextPathFilterable(m,E,g);}return!i;},replaceSpecialCharsInId:function(p,i){var g;if(typeof(p)==="string"){g=p;}else{g=i.context.getModel().getObject(i.context.getPath()+"@sapui.name");}return C.replaceSpecialCharsInId(g);}};f._helper.isNavPropertyFilterable.requiresIContext=true;return f;},true);
