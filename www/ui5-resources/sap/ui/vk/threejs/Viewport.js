/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../library","../ViewportBase","sap/ui/core/ResizeHandler","../Loco","./thirdparty/three","../ContentConnector","../ViewStateManager","./ViewportGestureHandler","./OrthographicCamera","./PerspectiveCamera","./NodesTransitionHelper","../Messages"],function(q,l,V,R,L,a,C,b,c,O,P,N,M){"use strict";var d=V.extend("sap.ui.vk.threejs.Viewport",{metadata:{library:"sap.ui.vk",properties:{renderMode:{type:"sap.ui.vk.RenderMode",defaultValue:"default"}},events:{cameraChanged:{parameters:{position:"float[]",quaternion:"float[]",zoom:"float"},enableEventBubbling:true}}}});var e=d.getMetadata().getParent().getClass().prototype;d.prototype.init=function(){if(e.init){e.init.call(this);}this._resizeListenerId=null;this._renderLoopRequestId=0;this._renderLoopFunction=this._renderLoop.bind(this);this._shouldRenderFrame=true;this._clippingPlanes=[];this._renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});this._renderer.setPixelRatio(window.devicePixelRatio);this._renderer.setSize(1,1);this._renderer.shadowMap.enabled=true;this._camera=new sap.ui.vk.threejs.PerspectiveCamera();var f=["varying float vPos;","void main() {","	gl_Position = vec4(position, 1.0);","	vPos = position.y * -0.5 + 0.5;","}"].join("\n");var g=["uniform vec4 topColor;","uniform vec4 bottomColor;","varying float vPos;","void main() {","	gl_FragColor = mix(topColor, bottomColor, vPos);","}"].join("\n");var h=new THREE.Vector4();var i=new THREE.Vector4();this._updateColor(h,this.getBackgroundColorTop());this._updateColor(i,this.getBackgroundColorBottom());this._checkBackgroundColor();this._backgroundMaterial=new THREE.ShaderMaterial({uniforms:{topColor:{value:h},bottomColor:{value:i}},vertexShader:f,fragmentShader:g,side:THREE.DoubleSide,depthTest:false,depthWrite:false,blending:THREE.NoBlending});var j=new THREE.Geometry();j.vertices.push(new THREE.Vector3(-1,1,0),new THREE.Vector3(1,1,0),new THREE.Vector3(-1,-1,0),new THREE.Vector3(1,-1,0));j.faces.push(new THREE.Face3(0,2,1),new THREE.Face3(1,2,3));this._backgroundCamera=new THREE.Camera();this._backgroundScene=new THREE.Scene();this._backgroundScene.add(new THREE.Mesh(j,this._backgroundMaterial));var x=["#include <clipping_planes_pars_vertex>","varying vec3 vNormal;","void main() {","#include <begin_vertex>","#include <project_vertex>","#include <clipping_planes_vertex>","#include <beginnormal_vertex>","#include <defaultnormal_vertex>","	vNormal = normalize( transformedNormal );","}"].join("\n");var k=["#include <clipping_planes_pars_fragment>","uniform vec4 color1;","uniform vec4 color2;","varying vec3 vNormal;","void main() {","#include <clipping_planes_fragment>","	gl_FragColor = mix(color1, color2, abs(normalize(vNormal).z));","}"].join("\n");this._xrayColor1=new THREE.Vector4(0,0.75,1,0.45);this._xrayColor2=new THREE.Vector4(0,0,1,0);this._xrayMaterial=new THREE.ShaderMaterial({uniforms:{color1:{value:this._xrayColor1},color2:{value:this._xrayColor2}},vertexShader:x,fragmentShader:k,side:THREE.DoubleSide,depthWrite:false,depthFunc:THREE.LessDepth,blending:THREE.NormalBlending,clipping:true,transparent:true});this._viewportGestureHandler=new c(this);this._loco=new L();this._loco.addHandler(this._viewportGestureHandler);this._zoomedObject=null;this._nodesTransitionHelper=new N();this._nodesTransitionHelper.setViewport(this);this._cdsLoader=null;this.attachCameraChanged(function(m){this.setShouldRenderFrame();});};d.prototype.exit=function(){this._loco.removeHandler(this._viewportGestureHandler);this._viewportGestureHandler.destroy();if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this._stopRenderLoop();this.setScene(null);this.setCamera(null);this._renderer=null;this._backgroundCamera=null;this._backgroundMaterial=null;this._backgroundScene=null;this._loco=null;this._viewportGestureHandler=null;if(this._cdsLoader){this._cdsLoader.detachSceneUpdated(this._handleCdsSceneUpdate,this);}if(e.exit){e.exit.call(this);}};d.prototype._startRenderLoop=function(){if(!this._renderLoopRequestId){this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction);}return this;};d.prototype._stopRenderLoop=function(){if(this._renderLoopRequestId){window.cancelAnimationFrame(this._renderLoopRequestId);this._renderLoopRequestId=0;}return this;};d.prototype.setBackgroundColorTop=function(v){e.setBackgroundColorTop.call(this,v);if(this._backgroundMaterial!==null){this._updateColor(this._backgroundMaterial.uniforms.topColor.value,v);this._checkBackgroundColor();}return this;};d.prototype.setBackgroundColorBottom=function(v){e.setBackgroundColorBottom.call(this,v);if(this._backgroundMaterial!==null){this._updateColor(this._backgroundMaterial.uniforms.bottomColor.value,v);this._checkBackgroundColor();}return this;};d.prototype.setClippingPlanes=function(f){this._clippingPlanes=f;return this;};d.prototype.onBeforeRendering=function(){if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this._stopRenderLoop();};d.prototype.onAfterRendering=function(){var f=this.getDomRef();f.appendChild(this._renderer.domElement);this._resizeListenerId=R.register(this,this._handleResize.bind(this));this._handleResize({size:{width:f.clientWidth,height:f.clientHeight}});this._startRenderLoop();};d.prototype._handleResize=function(f){if(!this._camera||!this._renderer){return false;}var w=f.size.width;var h=f.size.height;if(this._camera){this._camera.update(w,h);}this._renderer.setSize(w,h);this.fireResize({size:{width:w,height:h}});this.setShouldRenderFrame();return true;};d.prototype.setScene=function(s){this._scene=s;this._homeCamera=null;var n=this._scene?this._scene.getSceneRef():undefined;if(n){var g;for(var i=0;i<n.children.length;i++){g=n.children[i];if(g.private&&g.name==="DefaultLights"&&g.children.length){if(g.children[0]instanceof THREE.PointLight){this._eyePointLight=g.children[0];}}}}this.setShouldRenderFrame();return this;};d.prototype.getScene=function(){return this._scene;};d.prototype.setCamera=function(f){if(e.setCamera){e.setCamera.call(this,f);}var g=this.getCamera();if(g&&this._renderer){var s=this._renderer.getSize();g.update(s.width,s.height);if(!this._homeCamera&&g.getCameraRef()){this._homeCamera=g.getCameraRef().clone();}}this.setShouldRenderFrame();return this;};d.prototype.getRenderer=function(){return this._renderer;};d.prototype._getViewStateManagerThreeJS=function(){if(this._viewStateManager){if(this._viewStateManager.constructor===sap.ui.vk.threejs.ViewStateManager){return this._viewStateManager;}if(this._viewStateManager.constructor===sap.ui.vk.ViewStateManager&&this._viewStateManager._implementation.constructor===sap.ui.vk.threejs.ViewStateManager){return this._viewStateManager._implementation;}}return null;};d.prototype._updateBoundingBoxesIfNeeded=function(){var v=this._getViewStateManagerThreeJS();if(v){v._updateBoundingBoxesIfNeeded();}};d.prototype._updateColor=function(f,g){var h=sap.ui.vk.cssColorToColor(g);f.color=new THREE.Color(h.red/255,h.green/255,h.blue/255);f.alpha=h.alpha;f.x=f.color.r*f.alpha;f.y=f.color.g*f.alpha;f.z=f.color.b*f.alpha;f.w=f.alpha;};d.prototype._checkBackgroundColor=function(){var f=this.getBackgroundColorTop();if(f===this.getBackgroundColorBottom()){if(this._backgroundColor===null){this._backgroundColor=new THREE.Vector4();}this._updateColor(this._backgroundColor,f);}else{this._backgroundColor=null;}this.setShouldRenderFrame();};d.prototype._handleCdsSceneUpdate=function(){this.setShouldRenderFrame();};d.prototype.setShouldRenderFrame=function(){this._shouldRenderFrame=true;return this;};d.prototype.shouldRenderFrame=function(){return this._shouldRenderFrame;};d.prototype.hitTest=function(x,y){var n=this._scene?this._scene.getSceneRef():undefined;var f=this._camera?this._camera.getCameraRef():undefined;if(!f||!n){return null;}var g=this._renderer.domElement;var m=new THREE.Vector2((x-g.clientLeft)/g.clientWidth*2-1,(g.clientTop-y)/g.clientHeight*2+1);var h=new THREE.Raycaster();h.setFromCamera(m,f);if(this._clippingPlanes){for(var i in this._clippingPlanes){var j=this._clippingPlanes[i];var k=j.distanceToPoint(h.ray.origin),t=-k/j.normal.dot(h.ray.direction);if(t>0){if(k<0){h.near=Math.max(h.near,t);}else{h.far=Math.min(h.far,t);}}else if(k<0){return null;}}}var s=h.intersectObjects(n.children,true);if(s&&s.length){var u=s[0];if(!u.object.name&&u.object.children.length===0){u.object=u.object.parent;}return u;}return null;};d.prototype.tap=function(x,y,i){if(!i){if(this._viewStateManager){var h=this.hitTest(x,y);var n=h&&h.object;var f={picked:n?[n]:[]};this.fireNodesPicked(f);if(this.getSelectionMode()===sap.ui.vk.SelectionMode.Exclusive){this.exclusiveSelectionHandler(f.picked);}else if(this.getSelectionMode()===sap.ui.vk.SelectionMode.Sticky){this.stickySelectionHandler(f.picked);}if(n!==null){this.fireNodeClicked({nodeRef:n,x:x,y:y},true,true);}}}else{var g=this.hitTest(x,y);if(g&&(this._zoomedObject===null||this._zoomedObject!==g.object)){this._zoomedObject=g.object;this._viewportGestureHandler.zoomObject(this._zoomedObject,true);}else{this._viewportGestureHandler.zoomObject(this._zoomedObject,false);this._zoomedObject=null;}}return this;};var o={x:-2,y:-2};var r=2;var p=5;[{key:"left",dx:-r,dy:0},{key:"right",dx:+r,dy:0},{key:"up",dx:0,dy:-r},{key:"down",dx:0,dy:+r}].forEach(function(i){d.prototype["onsap"+i.key]=function(f){var g=this._viewportGestureHandler._cameraController;g.beginGesture(o.x,o.y);g.rotate(i.dx,i.dy,true);g.endGesture();this.setShouldRenderFrame();f.preventDefault();f.stopPropagation();};});[{key:"left",dx:-p,dy:0},{key:"right",dx:+p,dy:0},{key:"up",dx:0,dy:-p},{key:"down",dx:0,dy:+p}].forEach(function(i){d.prototype["onsap"+i.key+"modifiers"]=function(f){if(f.shiftKey&&!(f.ctrlKey||f.altKey||f.metaKey)){var g=this._viewportGestureHandler._cameraController;g.beginGesture(o.x,o.y);g.pan(i.dx,i.dy);g.endGesture();this.setShouldRenderFrame();f.preventDefault();f.stopPropagation();}};});[{key:"minus",d:0.98},{key:"plus",d:1.02}].forEach(function(i){d.prototype["onsap"+i.key]=function(f){var g=this._viewportGestureHandler._cameraController;g.beginGesture(this.$().width()/2,this.$().height()/2);g.zoom(i.d);g.endGesture();this.setShouldRenderFrame();f.preventDefault();f.stopPropagation();};});d.prototype._handleVisibilityChanged=d.prototype._handleOpacityChanged=d.prototype._handleTintColorChanged=d.prototype._handleHighlightColorChanged=function(f){this.setShouldRenderFrame();};d.prototype._handleSelectionChanged=function(f){var t=this.getTools();for(var i=0;i<t.length;i++){var g=sap.ui.getCore().byId(t[i]);var h=g.getGizmoForContainer(this);if(h&&h.handleSelectionChanged){h.handleSelectionChanged(f);}}this.setShouldRenderFrame();};d.prototype.setSelectionRect=function(f){this.setShouldRenderFrame();if(!f){this._selectionRect=null;return;}var s=this._renderer.getSize();var x=(f.x1/s.width)*2-1,y=(f.y1/s.height)*-2+1,g=(f.x2/s.width)*2-1,h=(f.y2/s.height)*-2+1;if(!this._selectionRect){var i=new THREE.Geometry();i.vertices.push(new THREE.Vector3(x,h,-1),new THREE.Vector3(g,h,-1),new THREE.Vector3(g,y,-1),new THREE.Vector3(x,y,-1));this._selectionRect=new THREE.LineLoop(i,new THREE.LineBasicMaterial({color:0xFFFF00,lineWidth:window.devicePixelRatio}));}else{var v=this._selectionRect.geometry.vertices;v[0].set(x,h,-1);v[1].set(g,h,-1);v[2].set(g,y,-1);v[3].set(x,y,-1);this._selectionRect.geometry.verticesNeedUpdate=true;}};d.prototype._renderLoop=function(){if(!this._renderer||!this.getDomRef()){this._renderLoopRequestId=0;return;}if(this._viewportGestureHandler){this._viewportGestureHandler.animateCameraUpdate();}if(this._nodesTransitionHelper){this._nodesTransitionHelper.displayNodesMoving();}var n=this.getCamera()?this.getCamera().getCameraRef():undefined;if(this._eyePointLight&&n){this._eyePointLight.position.copy(n.position);}if(this._shouldRenderFrame){this._shouldRenderFrame=false;this.render();}this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction);};d.prototype.render=function(){var f=this._renderer;if(!f){return;}f.autoClear=this._backgroundColor!=null;if(f.autoClear){f.setClearColor(this._backgroundColor.color,this._backgroundColor.alpha);}else{f.render(this._backgroundScene,this._backgroundCamera);}var n=this._scene?this._scene.getSceneRef():null;var g=this._camera?this._camera.getCameraRef():null;if(!n||!g){return;}var t=this.getTools();var i,h,j;if(this._camera.getUsingDefaultClipPlanes()||(g.isOrthographicCamera&&this._camera.getZoomNeedRecalculate())){var k=this._scene._computeBoundingBox();if(!k.isEmpty()){if(g.isOrthographicCamera&&this._camera.getZoomNeedRecalculate()){this._camera.adjustZoom(k);}if(this._camera.getUsingDefaultClipPlanes()){for(i=0;i<t.length;i++){h=sap.ui.getCore().byId(t[i]);j=h.getGizmoForContainer(this);if(j&&j.expandBoundingBox){j.expandBoundingBox(k);}}this._camera.adjustClipPlanes(k);}}}var v=this._getViewStateManagerThreeJS();f.clippingPlanes=this._clippingPlanes;if(this.getRenderMode()===sap.ui.vk.RenderMode.XRay){if(v){var m=n.children[n.children.length-1].clone();v._selectedNodes.forEach(function(u){if(u.visible){u.add(m);f.render(u,g);f.autoClear=false;u.remove(m);}});}this._xrayColor1.w=0.45;n.overrideMaterial=this._xrayMaterial;}f.render(n,g);f.autoClear=false;f.clippingPlanes=[];n.overrideMaterial=null;if(v){var s=v._boundingBoxesScene;if(s){f.render(s,g);}}for(i=0;i<t.length;i++){h=sap.ui.getCore().byId(t[i]);j=h.getGizmoForContainer(this);if(j&&j.render){j.render(this);}}if(this._selectionRect){f.render(this._selectionRect,this._backgroundCamera);}};d.prototype.getImage=function(f,g,t,i){if(this._scene===null){return null;}f=f||16;g=g||16;if(f>2048){f=2048;}if(g>2048){g=2048;}var j=new THREE.WebGLRenderer({preserveDrawingBuffer:true});j.setSize(f,g);var k=this.getBackgroundColorTop();var m=this.getBackgroundColorBottom();if(t&&!i){j.setClearColor(t,1);}else if(!t&&i){j.setClearColor(i,1);}else{if(t&&i){this.setBackgroundColorTop(t);this.setBackgroundColorBottom(i);}j.render(this._backgroundScene,this._backgroundCamera);j.autoClear=false;}document.body.appendChild(j.domElement);var n=this.getCamera().getCameraRef().clone();var s=f/g;if(n.isOrthographicCamera){var w=n.right-n.left;var h=n.top-n.bottom;if(w>h){n.top=w/s/2;n.bottom=-w/s/2;}else{n.left=-h*s/2;n.right=h*s/2;}}else{var u=2*Math.atan(n.aspect*Math.tan(n.fov*Math.PI/360));if(n.fov<u*180/Math.PI){n.fov=360*Math.atan(Math.tan(u*0.5)/s)/Math.PI;}n.aspect=s;}n.updateProjectionMatrix();var v=[];var x=this._getViewStateManagerThreeJS();if(x!==null){x.enumerateSelection(function(z){v.push(z);});x.setSelectionState(v,false,false);}j.render(this._scene.getSceneRef(),n);var y=j.getContext().canvas.toDataURL();if(x!==null&&v.length>0){x.setSelectionState(v,true,false);}j.forceContextLoss();document.body.removeChild(j.domElement);if(m&&t){this.setBackgroundColorBottom(m);}if(k&&i){this.setBackgroundColorTop(k);}return y;};d.prototype._setContent=function(f){var s;var g;if(f){s=f;if(!(s instanceof sap.ui.vk.threejs.Scene)){s=null;}g=f.camera;if(!(g instanceof sap.ui.vk.threejs.OrthographicCamera||g instanceof sap.ui.vk.threejs.PerspectiveCamera)){g=null;}if(f.loaders){for(var i=0;i<f.loaders.length;i++){if(f.loaders[i]instanceof sap.ui.vk.threejs.ContentDeliveryService){this._cdsLoader=f.loaders[i];this._cdsLoader.attachSceneUpdated(this._handleCdsSceneUpdate,this);break;}}}}this.setScene(s);if(g){this.setCamera(g);}};d.prototype._onAfterUpdateContentConnector=function(){this._setContent(this._contentConnector.getContent());};d.prototype._onBeforeClearContentConnector=function(){if(e._onBeforeClearContentConnector){e._onBeforeClearContentConnector.call(this);}this.setScene(null);};d.prototype._handleContentReplaced=function(f){var g=f.getParameter("newContent");this._setContent(g);};d.prototype._onAfterUpdateViewStateManager=function(){};d.prototype._onBeforeClearViewStateManager=function(){};C.injectMethodsIntoClass(d);b.injectMethodsIntoClass(d);d.prototype.activateView=function(v){var f=v.getCameraInfo();var n;if(f){if(f.type==="PerspectiveCamera"){n=new sap.ui.vk.threejs.PerspectiveCamera();n.setFov(f.fov);}if(f.type==="OrthographicCamera"){n=new sap.ui.vk.threejs.OrthographicCamera();n.setZoomFactor(f.zoomFactor);if(f.zoomNeedRecalculate){n.setZoomNeedRecalculate(true);}}n.setNearClipPlane(f.nearClipPlane);n.setFarClipPlane(f.farClipPlane);n.setUpDirection(f.upDirection);n.setPosition(f.position);n.setTargetDirection(f.targetDirection);n.setUsingDefaultClipPlanes(f.usingDefaultClipPlanes);this._viewportGestureHandler.prepareForCameraUpdateAnimation(f.type);this.setCamera(n);this._viewportGestureHandler.startAnimatingCameraUpdate(500);}function g(D){return new THREE.Matrix4().set(D[0],D[1],D[2],D[3],D[4],D[5],D[6],D[7],D[8],D[9],D[10],D[11],0,0,0,1);}var h=this._viewStateManager.getNodeHierarchy();var i=v.getNodeInfos();if(i){this._nodesTransitionHelper.clear();i.forEach(function(B){if(B.target===null){return;}function D(G,H,I){for(var J=0;J<G.elements.length;J++){if(Math.abs(G.elements[J]-H.elements[J])>I){return false;}}return true;}if(B.transform){var E=g(B.transform);if(!D(E,B.target.matrix,1e-6)){var F=h.createNodeProxy(B.target);this._nodesTransitionHelper.setNodeForDisplay(F);E.decompose(B.target.position,B.target.quaternion,B.target.scale);B.target.updateMatrix();}}}.bind(this));var j=[];var k=[];for(var m=0;m<i.length;m++){if(i[m].visible){j.push(i[m].target);}else{k.push(i[m].target);}}this._viewStateManager.setVisibilityState(j,true,false);this._viewStateManager.setVisibilityState(k,false,false);var s=new Set(j);var t=[];var u=h.getSceneRef();var w=this;u.traverse(function collectChildNodes(B){if(B.parent&&w._viewStateManager.getVisibilityState(B.parent)===false){return;}if(w._viewStateManager.getVisibilityState(B)){if(B.userData&&B.userData.treeNode){t.push(B);}}});var x=[];for(var y=0;y<t.length;y++){if(!s.has(t[y])){var z=true;var A=0;var B=t[y];while(B&&A<4){if(B.parent&&B.parent.userData&&B.parent.userData.treeNode){z=false;break;}else{B=B.parent;A++;}}if(!z){x.push(t[y]);}}}this._viewStateManager.setVisibilityState(x,false,false);this._nodesTransitionHelper.startDisplay(500);}return this;};d.prototype.zoomTo=function(w,n,f,m){var g=this._scene?this._scene.getSceneRef():null;var h=this._camera?this._camera.getCameraRef():null;if(!h||!g){return this;}m=m||0;var i=new THREE.Box3();var j=null;var k=null;(Array.isArray(w)?w:[w]).forEach(function(w){switch(w){case sap.ui.vk.ZoomTo.All:i.expandByObject(g);break;case sap.ui.vk.ZoomTo.Visible:i=this._scene._computeBoundingBox(true);break;case sap.ui.vk.ZoomTo.Selected:var v=this._getViewStateManagerThreeJS();if(v){v.enumerateSelection(function(n){i.expandByObject(n);});}break;case sap.ui.vk.ZoomTo.Node:if(!n){return this;}k=n;if(Array.isArray(n)){n.forEach(function(n){i.expandByObject(n);});}else{i.expandByObject(n);}break;case sap.ui.vk.ZoomTo.Restore:q.sap.log.error("sap.ui.vk.ZoomTo.Restore is not implemented");return this;case sap.ui.vk.ZoomTo.NodeSetIsolation:q.sap.log.error("sap.ui.vk.ZoomTo.NodeSetIsolation is not implemented");return this;case sap.ui.vk.ZoomTo.RestoreRemoveIsolation:q.sap.log.error("sap.ui.vk.ZoomTo.RestoreRemoveIsolation is not implemented");return this;case sap.ui.vk.ZoomTo.ViewLeft:j=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),-Math.PI/2);break;case sap.ui.vk.ZoomTo.ViewRight:j=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI/2);break;case sap.ui.vk.ZoomTo.ViewTop:j=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0),-Math.PI/2);break;case sap.ui.vk.ZoomTo.ViewBottom:j=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0),Math.PI/2);break;case sap.ui.vk.ZoomTo.ViewBack:j=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI);break;case sap.ui.vk.ZoomTo.ViewFront:j=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),0);break;default:break;}}.bind(this));if(!i.isEmpty()){this._viewportGestureHandler.zoomTo(i,j,m,f*1000,k,k!==null);}return this;};d.prototype.getViewInfo=function(f){var v={};var n=this._camera?this._camera.getCameraRef():null;if(f.camera&&n){var g=n.rotation.clone();g.reorder("YXZ");v.camera={rotation:{yaw:THREE.Math.radToDeg(g.y),pitch:THREE.Math.radToDeg(g.x),roll:THREE.Math.radToDeg(g.z)},position:{x:n.position.x,y:n.position.y,z:n.position.z},projectionType:n.isOrthographicCamera?sap.ui.vk.CameraProjectionType.Orthographic:sap.ui.vk.CameraProjectionType.Perspective,bindingType:sap.ui.vk.CameraFOVBindingType.Vertical};if(v.camera.projectionType===sap.ui.vk.CameraProjectionType.Perspective){v.camera.fieldOfView=n.fov;}else if(v.camera.projectionType===sap.ui.vk.CameraProjectionType.Orthographic){v.camera.zoomFactor=n.zoom;}if(f.camera.matrices){v.camera.matrices={view:n.matrixWorldInverse.elements.slice(),projection:n.projectionMatrix.elements.slice()};}}if(f.visibility&&this._viewStateManager){v.visibility={mode:f.visibility.mode};if(f.visibility.mode===sap.ui.vk.VisibilityMode.Complete){var h=this._viewStateManager.getVisibilityComplete();v.visibility.visible=h.visible;v.visibility.hidden=h.hidden;}else if(this._viewStateManager.getShouldTrackVisibilityChanges()){v.visibility.changes=this._viewStateManager.getVisibilityChanges();}else{q.sap.log.warning(sap.ui.vk.getResourceBundle().getText(M.VIT32.summary),M.VIT32.code,"sap.ui.vk.dvl.Viewport");}}return v;};d.prototype.setViewInfo=function(v,f){var n=this._camera?this._camera.getCameraRef():null;if(v.camera&&n){var g=v.camera;var h=g.projectionType===sap.ui.vk.CameraProjectionType.Orthographic?new THREE.OrthographicCamera():new THREE.PerspectiveCamera();h.userData=n.userData;h.aspect=n.aspect;h.position.copy(g.position);var i=g.rotation;h.quaternion.setFromEuler(new THREE.Euler(THREE.Math.degToRad(i.pitch),THREE.Math.degToRad(i.yaw),THREE.Math.degToRad(i.roll),"YXZ"));h.fov=g.fieldOfView||h.fov;h.zoom=g.zoomFactor||h.zoom;this._viewportGestureHandler._activateCamera(h,(f||0)*1000);}if(v.visibility){var j=this._viewStateManager.getNodeHierarchy(),k=new Map(),m=j.findNodesByName();m.forEach(function(u){var w=j.createNodeProxy(u);var x=w.getVeId();j.destroyNodeProxy(w);if(x){k.set(x,u);}});switch(v.visibility.mode){case sap.ui.vk.VisibilityMode.Complete:var s=v.visibility.visible,t=v.visibility.hidden;s.forEach(function(u){this._viewStateManager.setVisibilityState(k.get(u),true,false);},this);t.forEach(function(u){this._viewStateManager.setVisibilityState(k.get(u),false,false);},this);break;case sap.ui.vk.VisibilityMode.Differences:v.visibility.changes.forEach(function(u){var w=k.get(u);if(w){this._viewStateManager.setVisibilityState(w,!this._viewStateManager.getVisibilityState(w),false);}},this);break;default:q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT28.summary),M.VIT28.code,"sap.ui.vk.dvl.Viewport");break;}}return this;};d.prototype.queueCommand=function(f){if(this instanceof sap.ui.vk.threejs.Viewport){f();}return this;};d.prototype.getOutputSize=function(){var f=this.getDomRef().getBoundingClientRect();var v=f.width;var g=f.height;var h;h=Math.min(v,g);return{left:(v-h)/2,top:(g-h)/2,sideLength:h};};return d;});
