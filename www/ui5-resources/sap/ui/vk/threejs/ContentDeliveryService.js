/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["jquery.sap.global","sap/ui/base/ManagedObject","./thirdparty/three","sap/ui/vk/threejs/thirdparty/totara","./PerspectiveCamera","./OrthographicCamera","sap/ui/vk/View"],function(q,M,t,a,P,O,V){"use strict";var C=M.extend("sap.ui.vk.threejs.ContentDeliveryService",{metadata:{events:{cameraChanged:{parameters:{sceneId:{type:"string"},camera:{type:"any"}},enableEventBubbling:true},sceneUpdated:{parameters:{},enableEventBubbling:true},errorReported:{paramters:{error:{type:"any"}}}}}});var b=C.getMetadata().getParent().getClass().prototype;C.prototype.init=function(){if(b.init){b.init.call(this);}this._loader=null;this._transientSceneMap=new Map();};C.prototype.initUrl=function(u,h){var d=this;var e;var f;function n(){d.fireSceneUpdated({});}if(!d._loader){this._loader=new Totara.Loader();var s=this._loader.getState();s.onErrorCallbacks.attach(this._reportError.bind(d));s.onMaterialFinishedCallbacks.attach(n);s.onImageFinishedCallbacks.attach(n);s.onSetGeometryCallbacks.attach(n);}var p=[];if(q.sap.startsWith(u,"ws")){e=new Totara.Loader.WebSocketConnection();f=e.init(u).then(function(){d._loader.init(e);}).catch(function(g){d._loader=null;throw g;});p.push(f);}else if(q.sap.startsWith(u,"http")){e=new Totara.Loader.HttpConnection();f=e.init(u,h).then(function(){d._loader.init(e);});p.push(f);}else{d._loader=null;p.push(Promise.reject("Content Delivery Service only allows http and websocket connection"));}return Promise.all(p);};function c(d){if(!d){return null;}var e;if(d.isOrthographicCamera){e=new sap.ui.vk.threejs.OrthographicCamera();}else if(d.isPerspectiveCamera){e=new sap.ui.vk.threejs.PerspectiveCamera();}e.setCameraRef(d);e.setUsingDefaultClipPlanes(true);if(d.cameraInfo&&d.cameraInfo.zoom===-1){e.setZoomNeedRecalculate(true);}return e;}C.prototype._reportError=function(e){this.fireErrorReported(e);};C.prototype._createLoadParam=function(r,d,p,e){var f=this;var i;var s=false;var g={root:p,includeHidden:e.getIncludeHidden(),pushPMI:e.getPushPMI(),metadataFilter:e.getMetadataFilter(),activateView:e.getActivateView(),enableLogger:e.getEnableLogger()===true,onActiveCamera:function(n){var j=false;var k=f._loader.getState();if(k){var l=k.contextMap.get(e.getVeid());if(l&&l.phase<2){i=c(n);j=true;}}if(!j){f.fireCameraChanged({sceneId:e.getVeid(),camera:c(n)});}},onInitialSceneFinished:function(){s=true;r({node:p,camera:i,contentResource:e,loader:f});}};var h=function(j){if(!s){var k=j.getParameter("context");if(k&&k.sceneId===e.getVeid()){f.detachErrorReported(h);var l;if(j.getParameter("error")){l=j.getParameter("error");}else if(j.getParameter("errorText")){l=j.getParameter("errorText");}else if(j.getParameter("reason")){l=j.getParameter("reason");}else{l="failed to load: unknown reason";}if(j.getParameter("events")){l=l+"\n"+JSON.stringify(j.getParameter("events"));}d(l);}}};f.attachErrorReported(h);return g;};C.prototype.load=function(p,d){var e=this;return new Promise(function(r,f){if(!d.getSource()||!d.getVeid()){f("url or veid not specified");return;}var g=true;if(e._loader){var h=e._loader.getConnection();if(h){if(h.getUrl()===d.getSource()){g=false;}else{h.close();}}}var i=e._createLoadParam(r,f,p,d);if(g){e.initUrl(d.getSource(),d.getHttpHeaders()).then(function(){e._loader.request(d.getVeid(),i);}).catch(function(j){f(j);});}else{e._loader.request(d.getVeid(),i);}});};C.prototype.getState=function(){if(this._loader){return this._loader.getState();}return null;};C.prototype.decrementResouceCountersForDeletedTreeNode=function(s){var d=this.getState();if(d){d.contextMap.forEach(function(v,k){if(v.treeNodeMap.has(s)){Totara.decrementResouceCountersForDeletedTreeNode(d,v,s);}});}};C.prototype.loadTransientScene=function(s,p){var d=this;return new Promise(function(r,e){if(!s||!p){e("invalid arguments");return;}if(d._transientSceneMap.has(s)){var f=d._transientSceneMap.get(s).clone();p.add(f);r({nodeRef:f});return;}if(!d._loader){e("ContentDeliveryService is not initialised");return;}var g=new THREE.Object3D();g.name="transient";var o=function(){var i=d._loader.getState().getContext(s);i.onSceneCompletedCallbacks.detach(o);d._transientSceneMap.set(s,g);var f=g.clone();p.add(f);r({nodeRef:f});};var h={root:g,onSceneCompleted:o};d._loader.request(s,h);});};C.prototype.update=function(s,d,v){if(!this._loader){return Promise.reject("ContentDeliveryService is not initialised");}else{return Promise.resolve(this._loader.update(s,d,v));}};C.prototype.exit=function(){if(b.exit){b.exit.call(this);}if(this._loader){this._loader.dispose();this._loader=null;}this._transientSceneMap=null;};C.prototype.loadView=function(s,v,d){if(typeof d==="undefined"){d="static";}return this._loader.requestView(s,d,v).then(function(e){var m=new sap.ui.vk.View({name:e.name,nodeInfos:e.viewNodes});if(e.camera){var f=true;var r=false;if(e.camera.cameraInfo&&e.camera.cameraInfo.zoom===-1){r=true;}if(e.camera.type==="PerspectiveCamera"){m.setCameraInfo({type:e.camera.type,fov:e.camera.cameraInfo.fov*180/Math.PI,position:e.camera.position.toArray(),nearClipPlane:e.camera.near,farClipPlane:e.camera.far,upDirection:e.camera.up.toArray(),targetDirection:e.camera.getWorldDirection().toArray(),usingDefaultClipPlanes:f});}if(e.camera.type==="OrthographicCamera"){m.setCameraInfo({type:e.camera.type,zoomFactor:e.camera.zoom,position:e.camera.position.toArray(),nearClipPlane:e.camera.near,farClipPlane:e.camera.far,upDirection:e.camera.up.toArray(),targetDirection:e.camera.getWorldDirection().toArray(),usingDefaultClipPlanes:f,zoomNeedRecalculate:r});}}return m;}).catch(function(e){q.sap.log.error(e);return null;});};C.prototype.assignMaterialToNodes=function(s,m,n,d){var e=this;return this._loader.requestMaterial(m).then(function(f){function g(f,o){if(o===null||o===undefined){return;}o.userData.materialId=m;if(o.userData.originalMaterial!==undefined&&o.userData.originalMaterial!==f){o.userData.originalMaterial=f;f.userData.materialUsed++;}if(o.material!==undefined&&o.material!==f){o.material=f;if(o.userData.originalMaterial!==undefined){f.userData.materialUsed++;}}if(o.children===undefined||o.children===null){return;}o.children.forEach(function(p){g(f,p);});}function h(f,o){if(o.userData.markedForNotAssigningMaterial){delete o.userData.markedForNotAssigningMaterial;return;}o.userData.materialId=m;if(o.userData.originalMaterial!==undefined&&o.userData.originalMaterial!==f){o.userData.originalMaterial=f;f.userData.materialUsed++;}if(o.material!==undefined&&o.material!==f){o.material=f;if(o.userData.originalMaterial!==undefined){f.userData.materialUsed++;}}o.userData.materialId=m;if(o.userData.originalMaterial!==undefined&&o.userData.originalMaterial!==f){o.userData.originalMaterial=f;f.userData.materialUsed++;}if(o.children===undefined||o.children===null){return;}o.children.forEach(function(p){h(f,p);});}if(d===undefined||!d){for(var i=0;i<n.length;i++){g(f,n[i]);}}else{for(var j=0;j<n.length;j++){n[j].userData.markedForNotAssigningMaterial=true;}var k=e._loader.getState().contextMap.get(s);var l=k.root;h(f,l);}e.fireSceneUpdated({});return true;}).catch(function(f){q.sap.log.error(f);return false;});};C.prototype.printLogTokens=function(){if(this._loader){this._loader.printLogTokens();return true;}else{return false;}};return C;});
