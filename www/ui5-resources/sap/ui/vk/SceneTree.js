/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","sap/ui/table/TreeTable","sap/ui/table/Column","sap/ui/model/json/JSONModel","sap/ui/core/ResizeHandler","sap/m/Title","sap/m/SearchField","sap/m/Toolbar","sap/m/ToolbarLayoutData","sap/m/ToolbarSpacer","./CheckEye","./ContentConnector","./ViewStateManager"],function(q,a,C,T,b,J,R,c,S,d,e,f,g,h,V){"use strict";var j=C.extend("sap.ui.vk.SceneTree",{metadata:{library:"sap.ui.vk",aggregations:{_tree:{type:"sap.ui.table.TreeTable",multiple:false,visibility:"hidden"}},associations:{contentConnector:{type:"sap.ui.vk.ContentConnector",multiple:false},viewStateManager:{type:"sap.ui.vk.ViewStateManager",multiple:false}}}});var k=function(i,s){return sap.ui.vk.getResourceBundle().getText(i?"SCENETREE_VISIBILITYSTATEVISIBLE":"SCENETREE_VISIBILITYSTATEHIDDEN");};j.prototype._createNodeForSceneTree=function(n,i,v){var l=v.getVisibilityState(i);return{name:n,id:i,visible:l,checkEyeTooltip:k(l,this)};};j.prototype.setScene=function(s,v){this.setViewStateManager(v);this._setScene(s);};j.prototype._setScene=function(s){this._scene=s;this.refresh();};j.prototype.init=function(){if(C.prototype.init){C.prototype.init.apply(this);}var _=new c({text:sap.ui.vk.getResourceBundle().getText("SCENETREE_TITLE"),tooltip:sap.ui.vk.getResourceBundle().getText("SCENETREE_TITLE")});_.onAfterRendering=function(){var $=this.$();$.addClass("sapUiVkTitle");};var t=this;var s=new S({layoutData:new e({shrinkable:true,maxWidth:"400px"}),search:function(l){var m=l.getParameter("query"),n=t._scene.getDefaultNodeHierarchy(),v=t._viewStateManager;if(n&&v){var o=!m?[]:n.findNodesByName({value:m,predicate:"contains"});var p=new Set(o);var u=[];v.enumerateSelection(function(r){if(!p.has(r)){u.push(r);}});v.setSelectionState(u,false,false);v.setSelectionState(o,true,false);}}});var i=new d({content:[_,new f(),s]});this._visibilityColumnHeader=new g({checked:true,tooltip:k(true,this),change:function(l){var m=this.getChecked();this.setTooltip(k(m,t));t._toggleVisibilityForAllChildren(t._model.getData(),m);}});this._tree=new T({title:i,columnHeaderHeight:32,columns:[new b({label:sap.ui.vk.getResourceBundle().getText("SCENETREE_NAME"),tooltip:sap.ui.vk.getResourceBundle().getText("SCENETREE_NAME"),template:new sap.m.Text({text:"{name}",maxLines:1,tooltip:"{name}"}),resizable:false}),new b({label:this._visibilityColumnHeader,template:new g({checked:"{visible}",tooltip:"{checkEyeTooltip}",change:function(l){var n=t._indexToNodeRef(this.getParent().getIndex());t._viewStateManager.setVisibilityState(n,this.getChecked(),true);}}),width:"2.7em",resizable:false,hAlign:"Center"})],enableSelectAll:false,selectionMode:"MultiToggle",selectionBehavior:"RowSelector",visibleRowCountMode:"Fixed",expandFirstLevel:false,collapseRecursive:true,rowHeight:32});this.setAggregation("_tree",this._tree,true);this._scene=null;this._syncing=false;this._updateSelectionTimer=0;this._updateVisibilityTimer=0;this._model=new J();this._tree.setModel(this._model);this._tree.bindRows({path:"/"});this._tree.attachRowSelectionChange(this._handleRowSelectionChange.bind(this));this._tree.attachFirstVisibleRowChanged(this._updateSelection.bind(this));this._tree.getBinding("rows").attachChange(this._dataChange.bind(this));};j.prototype.onBeforeRendering=function(){this._tree.setVisible(true);if(!this._resizeListenerId){this._resizeListenerId=R.register(this,this._handleResize.bind(this));}};j.prototype._indexToNodeRef=function(i){var l=this._tree.getContextByIndex(i);return l?l.getObject().id:null;};j.prototype._handleRowSelectionChange=function(l){if(this._syncing||this._tree.getBinding("rows")._aSelectedContexts!=undefined){return;}var s=[];var m=[];var r=l.getParameter("rowIndices");for(var i in r){var n=r[i];var o=this._indexToNodeRef(n);if(o){(this._tree.isIndexSelected(n)?s:m).push(o);}}if(m.length>0){this._viewStateManager.setSelectionState(m,false);}if(s.length>0){this._viewStateManager.setSelectionState(s,true);}};j.prototype._handleSelectionChanged=function(m){if(this._syncing){return;}function n(t,o){var r=t.getBinding("rows");if(r){for(var i=t.getFirstVisibleRow(),l=Math.min(i+t.getVisibleRowCount(),r.getLength());i<l;i++){var p=r.getContextByIndex(i);if(p&&p.getObject().id===o){return true;}}}return false;}var s=m.getParameter("selected");if(s.length===1&&!n(this._tree,s[0])){if(this._updateSelectionTimer>0){clearTimeout(this._updateSelectionTimer);this._updateSelectionTimer=0;}this._expandToNode(s[0],this._updateSelection.bind(this));}else if(this._updateSelectionTimer===0){this._updateSelectionTimer=setTimeout(this._updateSelection.bind(this),0);}};j.prototype._updateSelection=function(){this._updateSelectionTimer=0;if(this._syncing){return;}this._syncing=true;var v=this._viewStateManager,t=this._tree,r=t.getBinding("rows");if(v&&r){for(var i=t.getFirstVisibleRow(),l=Math.min(i+t.getVisibleRowCount(),r.getLength());i<l;i++){var m=r.getContextByIndex(i);if(m){var n=m.getObject().id;if(n){var s=v.getSelectionState(n);if(s!=t.isIndexSelected(i)){t[s?"addSelectionInterval":"removeSelectionInterval"](i,i);}}}}}this._syncing=false;};j.prototype._expandToNode=function(n,i){var l={tree:this._tree,rows:this._tree.getBinding("rows"),index:0,nodeRef:n,ancestors:new Set(this._scene.getDefaultNodeHierarchy().getAncestors(n)),callback:i};function s(t,o,p){var r=t.getFirstVisibleRow(),u=t.getVisibleRowCount();if((o<r)||(o>=(r+u))){r=Math.min(Math.max(o-(u>>1),0),p-u);setTimeout(function(){t.setFirstVisibleRow(r);},0);}}function m(l,o){if(o&&o.getParameter("reason")!=="expand"){return;}var t=l.rows.getLength();while(l.index<t){var r=l.rows.getContextByIndex(l.index);if(!r){break;}var n=r.getObject().id;if(n===l.nodeRef){s(l.tree,l.index,t);break;}if(l.ancestors.has(n)&&!l.tree.isExpanded(l.index)){l.tree.expand(l.index++);return;}l.index++;}l.rows.detachChange(l.expandHandlerProxy);l.callback();}l.expandHandlerProxy=m.bind(this,l);l.rows.attachChange(l.expandHandlerProxy);m(l);};j.prototype._dataChange=function(i){var r=i.getParameter("reason");if((r==="expand"||r==="collapse")&&this._updateSelectionTimer===0){this._updateSelectionTimer=setTimeout(this._updateSelection.bind(this),0);}};j.prototype._toggleVisibilityForAllChildren=function(n,l){var m=n.hasOwnProperty("children")?n.children:n;for(var i=0;m[i]!=null;i++){this._viewStateManager.setVisibilityState(m[i].id,l,true);}};j.prototype._handleVisibilityChanged=function(i){if(this._updateVisibilityTimer===0){this._updateVisibilityTimer=setTimeout(this._updateVisibility.bind(this),0);}};j.prototype._updateVisibility=function(){this._updateVisibilityTimer=0;this._getNodeVisibilityRecursive(this._model.getData());this._tree.getModel().refresh(true);};j.prototype._getNodeVisibilityRecursive=function(n){if(n.id!=null){n.visible=this._viewStateManager.getVisibilityState(n.id);n.checkEyeTooltip=k(n.visible,this);}var l=n.hasOwnProperty("children")?n.children:n;for(var i=0;l[i]!=null;i++){this._getNodeVisibilityRecursive(l[i]);}};j.prototype._handleResize=function(i){this._tree.setVisibleRowCount(Math.max(Math.floor(i.size.height/this._tree.getRowHeight()-2.2),0));this._updateSelection();};j.prototype.refresh=function(){if(!this._scene||!this._viewStateManager||!this._viewStateManager.getNodeHierarchy()){this._model.setData([]);return;}var n=this._scene.getDefaultNodeHierarchy();var t=[];var i=function(t,l){l.forEach(function(m,o){var p=n.createNodeProxy(m);var r=this._createNodeForSceneTree(p.getName(),p.getNodeRef(),this._viewStateManager);t[o]=r;n.destroyNodeProxy(p);r.children=[];i.bind(this)(r.children,n.getChildren(m));}.bind(this));};i.bind(this)(t,n.getChildren());this._model.setData(t);this._tree.setModel(this._model);this._tree.bindRows({path:"/",parameters:{arrayNames:["children"]}});this._tree.getBinding("rows").attachChange(this._dataChange.bind(this));this._visibilityColumnHeader.setChecked(true);this._visibilityColumnHeader.setTooltip(k(true,this));};j.prototype._onBeforeClearContentConnector=j.prototype._onBeforeClearViewStateManager=function(){this._setScene(null);};j.prototype._onAfterUpdateContentConnector=j.prototype._onAfterUpdateViewStateManager=function(){if(this._contentConnector){this._setContent(this._contentConnector.getContent());}};j.prototype._setContent=function(i){this._setScene(i);};j.prototype._handleContentReplaced=function(i){this._setContent(i.getParameter("newContent"));};j.prototype._handleNodeHierarchyReplaced=function(i){this._setScene(this._scene);};j.prototype._handleContentChangesFinished=function(i){this.refresh();};h.injectMethodsIntoClass(j);V.injectMethodsIntoClass(j);return j;},true);
