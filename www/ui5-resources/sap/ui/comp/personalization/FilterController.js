/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','./BaseController','sap/m/library','sap/ui/comp/library','./Util','./ChartWrapper','sap/ui/comp/filterbar/VariantConverterTo','sap/ui/comp/filterbar/VariantConverterFrom','sap/ui/model/odata/type/Boolean','sap/ui/model/type/Boolean','sap/ui/model/odata/ODataModel','sap/ui/model/odata/v2/ODataModel','sap/ui/model/Model'],function(q,B,M,C,U,a,V,b,c,d,O,e,f){"use strict";var F=B.extend("sap.ui.comp.personalization.FilterController",{constructor:function(i,s){B.apply(this,arguments);this.setType(M.P13nPanelType.filter);this.setItemType(M.P13nPanelType.filter+"Items");},metadata:{events:{afterFilterModelDataChange:{}}}});F.prototype.setTable=function(t){B.prototype.setTable.apply(this,arguments);};F.prototype.getColumn2Json=function(o,s,i){if(this.getTableType()!==C.personalization.TableType.AnalyticalTable&&this.getTableType()!==C.personalization.TableType.Table&&this.getTableType()!==C.personalization.TableType.TreeTable){return null;}if(!U.isFilterable(o)){return null;}if(!o.getFiltered||(o.getFiltered&&!o.getFiltered())){return null;}return{columnKey:s,exclude:false,operation:o.getFilterOperator(),value1:o.getFilterValue(),value2:""};};F.prototype.getColumn2JsonTransient=function(o,s,t,T){if(!U.isFilterable(o)){return null;}var g=this.getTable();var h;if(g.getModel()instanceof O||g.getModel()instanceof e){h=new c();}else if(g.getModel()instanceof f){h=new d();}var i;if(h){i=["",h.formatValue(false,"string"),h.formatValue(true,"string")];}var v;if(this.getTableType()===C.personalization.TableType.AnalyticalTable||this.getTableType()===C.personalization.TableType.Table||this.getTableType()===C.personalization.TableType.TreeTable){if(U.getColumnType(o)==="boolean"){v=U._getCustomProperty(o,"values")||i;}return{columnKey:s,text:t,tooltip:T,maxLength:U._getCustomProperty(o,"maxLength"),precision:U._getCustomProperty(o,"precision"),scale:U._getCustomProperty(o,"scale"),type:U.getColumnType(o),values:v};}if(this.getTableType()===C.personalization.TableType.ResponsiveTable){if(U.getColumnType(o)==="boolean"){v=U._getCustomProperty(o,"values")||i;}return{columnKey:s,text:t,tooltip:T,maxLength:U._getCustomProperty(o,"maxLength"),precision:U._getCustomProperty(o,"precision"),scale:U._getCustomProperty(o,"scale"),type:U.getColumnType(o),values:v};}if(this.getTableType()===C.personalization.TableType.ChartWrapper){return{columnKey:s,text:t,tooltip:T,maxLength:U._getCustomProperty(o,"maxLength"),precision:U._getCustomProperty(o,"precision"),scale:U._getCustomProperty(o,"scale"),type:U.getColumnType(o),values:v};}};F.prototype.handleIgnore=function(j,i){j.sort.sortItems.splice(i,1);};F.prototype.syncJson2Table=function(j){var o=this.getColumnMap();var g=q.extend(true,{},o);this.fireBeforePotentialTableChange();if(this.getTableType()===C.personalization.TableType.AnalyticalTable||this.getTableType()===C.personalization.TableType.Table||this.getTableType()===C.personalization.TableType.TreeTable){j.filter.filterItems.forEach(function(i){var h=o[i.columnKey];if(h){if(!h.getFiltered()){h.setFiltered(true);}delete g[i.columnKey];}});for(var s in g){var h=g[s];if(h&&h.getFiltered()){h.setFiltered(false);}}}this.fireAfterPotentialTableChange();};F.prototype.getDataSuiteFormat2Json=function(D){var j=this.createControlDataStructure();if(!D.SelectOptions||!D.SelectOptions.length){return j;}j.filter.filterItems=D.SelectOptions.map(function(s){var o=b.convertOption(s.Ranges[0].Option,s.Ranges[0].Low);return{columnKey:s.PropertyName,exclude:(s.Ranges[0].Sign==="E"),operation:o.op,value1:o.v,value2:s.Ranges[0].High};});return j;};F.prototype.getDataSuiteFormatSnapshot=function(D){var o=this.getUnionData(this.getControlDataInitial(),this.getControlData());if(!o.filter||!o.filter.filterItems||!o.filter.filterItems.length){return;}o.filter.filterItems.forEach(function(g){var r=V.addRangeEntry(D,g.columnKey);V.addRanges(r,[g]);});};F.prototype.getPanel=function(p){if(!U.hasFilterableColumns(this.getColumnMap())){return null;}if(p&&p.column){var s=U.getColumnKey(p.column);if(s){var j=this.getTransientData();j.filter.filterItems.forEach(function(i){i["isDefault"]=i.columnKey===s;});}}var t=this;return new Promise(function(r){sap.ui.require(['sap/m/P13nFilterPanel','sap/m/P13nItem','sap/m/P13nFilterItem','sap/ui/comp/providers/ValueListProvider'],function(P,g,h,i){var o=new P({containerQuery:true,items:{path:"$sapmP13nPanel>/transientData/filter/filterItems",template:new g({columnKey:'{$sapmP13nPanel>columnKey}',text:"{$sapmP13nPanel>text}",tooltip:"{$sapmP13nPanel>tooltip}",maxLength:"{$sapmP13nPanel>maxLength}",precision:"{$sapmP13nPanel>precision}",scale:"{$sapmP13nPanel>scale}",type:"{$sapmP13nPanel>type}",isDefault:"{$sapmP13nPanel>isDefault}",values:"{$sapmP13nPanel>values}"})},filterItems:{path:"$sapmP13nPanel>/controlDataReduce/filter/filterItems",template:new h({key:"{$sapmP13nPanel>key}",columnKey:"{$sapmP13nPanel>columnKey}",exclude:"{$sapmP13nPanel>exclude}",operation:"{$sapmP13nPanel>operation}",value1:"{$sapmP13nPanel>value1}",value2:"{$sapmP13nPanel>value2}"})},beforeNavigationTo:t.setModelFunction(),addFilterItem:function(E){if(!E.getParameter("filterItemData")){return;}var I=E.getParameter("index");var k=E.getParameter("filterItemData");var l={columnKey:k.getColumnKey(),operation:k.getOperation(),exclude:k.getExclude(),value1:k.getValue1(),value2:k.getValue2()};var m=t.getControlDataReduce();if(I>-1){m.filter.filterItems.splice(I,0,l);}else{m.filter.filterItems.push(l);}t.setControlDataReduce2Model(m);},removeFilterItem:function(E){var I=E.getParameter("index");if(I<0){return;}var k=t.getControlDataReduce();k[t.getType()][t.getItemType()].splice(I,1);t.setControlDataReduce2Model(k);}});var S=function(k,l){var m=t.getColumnMap(true);var n=m[l];var u=U._getCustomProperty(n,"fullName");if(u){k.setShowSuggestion(true);k.setFilterSuggests(false);k.setModel(t.getTable().getModel());return new i({control:k,fieldName:l,typeAheadEnabled:true,aggregation:"suggestionRows",resolveInOutParams:false,loadAnnotation:true,fullyQualifiedFieldName:u,model:t.getTable().getModel(),enableShowTableSuggestionValueHelp:false});}};o._oIncludeFilterPanel._fSuggestCallback=S;o._oExcludeFilterPanel._fSuggestCallback=S;return r(o);});});};F.prototype.getChangeType=function(p,P){if(!P||!P.filter||!P.filter.filterItems){return C.personalization.ChangeType.Unchanged;}if(P&&P.filter&&P.filter.filterItems){P.filter.filterItems.forEach(function(o){delete o.key;delete o.source;});}if(p&&p.filter&&p.filter.filterItems){p.filter.filterItems.forEach(function(o){delete o.key;delete o.source;});}var i=JSON.stringify(p.filter.filterItems)!==JSON.stringify(P.filter.filterItems);return i?C.personalization.ChangeType.ModelChanged:C.personalization.ChangeType.Unchanged;};F.prototype.getChangeData=function(p,P){if(!p||!p.filter||!p.filter.filterItems){return this.createControlDataStructure();}if(P&&P.filter&&P.filter.filterItems){P.filter.filterItems.forEach(function(o){delete o.key;delete o.source;});}if(p&&p.filter&&p.filter.filterItems){p.filter.filterItems.forEach(function(o){delete o.key;delete o.source;});}if(!P||!P.filter||!P.filter.filterItems){return{filter:U.copy(p.filter)};}if(JSON.stringify(p.filter.filterItems)!==JSON.stringify(P.filter.filterItems)){return{filter:U.copy(p.filter)};}return null;};F.prototype.getUnionData=function(j,J){if(!J||!J.filter||!J.filter.filterItems){return{filter:U.copy(j.filter)};}return{filter:U.copy(J.filter)};};F.prototype.exit=function(){B.prototype.exit.apply(this,arguments);};return F;},true);
