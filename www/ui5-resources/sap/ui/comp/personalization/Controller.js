/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','sap/ui/base/ManagedObject','sap/m/library','sap/ui/comp/library','./ColumnsController','./FilterController','./GroupController','./SortController','./DimeasureController','./SelectionController','./Util','./ChartWrapper','./SelectionWrapper','./ColumnHelper','sap/ui/core/MessageType','sap/m/P13nDialog','./Validator','sap/ui/model/json/JSONModel','sap/ui/Device','sap/ui/model/BindingMode'],function(q,M,a,C,b,F,G,S,D,c,U,d,e,f,g,P,V,J,h,B){"use strict";var i=M.extend("sap.ui.comp.personalization.Controller",{constructor:function(I,s){M.apply(this,arguments);},metadata:{library:"sap.ui.comp",properties:{setting:{type:"object",defaultValue:{}},resetToInitialTableState:{type:"boolean",defaultValue:true},columnKeys:{type:"string[]",defaultValue:[]}},associations:{table:{type:"object",multiple:false}},events:{beforePotentialTableChange:{},afterPotentialTableChange:{},afterP13nModelDataChange:{parameters:{persistentData:{type:"object"},persistentDataChangeType:{type:"sap.ui.comp.personalization.ChangeType"},runtimeDeltaData:{type:"object"},runtimeDeltaDataChangeType:{type:"sap.ui.comp.personalization.ChangeType"}}},requestColumns:{parameters:{columnKeys:{type:"string"}}},dialogAfterClose:{},dialogAfterOpen:{},dialogConfirmedReset:{}}}});i.prototype.applySettings=function(s){M.prototype.applySettings.apply(this,arguments);this._initialize();};i.prototype._initialize=function(){this._bInitCalled=true;var t=this.getTable();if(!t){throw"The table instance should be passed into constructor.";}this._createSettingCurrent(this.getSetting());var j=t.getColumns();if(!this.getColumnKeys().length){this.setProperty("columnKeys",U.getColumnKeys(j),true);}var m=this._createInternalModel(this.getColumnKeys());this._callControllers(this._oSettingCurrent,"initializeInternalModel",m);this._oColumnHelper=new f({callbackOnSetVisible:this._onSetVisible.bind(this),callbackOnSetSummed:this._onSetSummed.bind(this)});this._oColumnHelper.addColumns(j);this._callControllers(this._oSettingCurrent,"setColumnHelper",this._oColumnHelper);this._callControllers(this._oSettingCurrent,"setTriggerModelChangeOnColumnInvisible");this._callControllers(this._oSettingCurrent,"setTable",t);this._callControllers(this._oSettingCurrent,"setColumnKeys",this.getColumnKeys());this._callControllers(this._oSettingCurrent,"setIgnoreColumnKeys");this._callControllers(this._oSettingCurrent,"checkConsistency");this._callControllers(this._oSettingCurrent,"calculateIgnoreData");var k=i._getOrderedColumnKeys(this._oColumnHelper.getColumnMap(),this.getColumnKeys());this._extendModelStructure(k);this._callControllers(this._oSettingCurrent,"calculateControlData");this._suspendTable();this._syncTableUi();this._resumeTable(true);this._fireChangeEvent();};i.prototype.init=function(){this._oDialog=null;this._aColumnKeysOfDateType=[];this._aColumnKeysOfBooleanType=[];this._aColumnKeysOfTimeType=[];this._bIsDirty=false;this._bInitCalled=false;this._bSuspend=false;this._bUnconfirmedResetPressed=false;this._oColumnHelper=null;this._oSettingCurrent={};};i.prototype.setSetting=function(s){if(this._bInitCalled){throw"The setting instance should be passed only into constructor.";}s=this.validateProperty("setting",s);this.setProperty("setting",s,true);return this;};i.prototype.setResetToInitialTableState=function(r){if(this._bInitCalled){throw"The resetToInitialTableState property should be passed only into constructor.";}r=this.validateProperty("resetToInitialTableState",r);this.setProperty("resetToInitialTableState",r,true);return this;};i.prototype.setColumnKeys=function(j){if(this._bInitCalled){throw"The columnKeys array should be passed only into constructor.";}j=this.validateProperty("columnKeys",j);this.setProperty("columnKeys",j,true);return this;};i.prototype.setTable=function(t){if(this._bInitCalled){throw"The table instance should be passed only into constructor.";}this.setAssociation("table",t);return this;};i.prototype._createSettingCurrent=function(s){var t=U.getTableType(this.getTable());var j,T;switch(t){case C.personalization.TableType.ChartWrapper:j=[a.P13nPanelType.dimeasure,a.P13nPanelType.sort,a.P13nPanelType.filter];break;case C.personalization.TableType.SelectionWrapper:j=[a.P13nPanelType.selection];break;default:j=[a.P13nPanelType.columns,a.P13nPanelType.sort,a.P13nPanelType.filter,a.P13nPanelType.group];}for(T in s){if(s[T].visible===false&&j.indexOf(T)>-1){j.splice(j.indexOf(T),1);}if(s[T].visible===true){j.push(T);}}j.forEach(function(T){this._oSettingCurrent[T]={visible:true,controller:(s[T]&&s[T].controller)?s[T].controller:this._controllerFactory(T),payload:(s[T]&&s[T].payload)?s[T].payload:undefined,ignoreColumnKeys:(s[T]&&s[T].ignoreColumnKeys)?s[T].ignoreColumnKeys:[],triggerModelChangeOnColumnInvisible:(s[T]&&s[T].triggerModelChangeOnColumnInvisible)?s[T].triggerModelChangeOnColumnInvisible:undefined};},this);};i.prototype._mixSetting=function(s,o){if(!o){return s;}for(var t in o){if(o[t].visible===true&&s[t]&&s[t].visible===true){o[t].controller=s[t].controller;o[t].payload=o[t].payload||s[t].payload;}}return o;};i.prototype.openDialog=function(s){this._suspendTable();this._prepareDialogUi();var o=this._mixSetting(this._oSettingCurrent,s);this._oDialog=new P(this.getId()+"-P13nDialog",{stretch:h.system.phone,showReset:(s&&s.showReset!==undefined)?s.showReset:true,showResetEnabled:this._bIsDirty,initialVisiblePanelType:this._oInitialVisiblePanelType,validationExecutor:function(){var T=U.getTableType(this.getTable());var k=this._oColumnHelper.getColumnMap();var l=this._callControllers(o,"getUnionData",this._getControlDataInitial(),this._getControlDataReduce());return V.checkGroupAndColumns(T,o,k,l,[]).then(function(r){return V.checkSaveChanges(T,o,l,r);}).then(function(r){return V.checkChartConsistency(T,o,l,r);}).then(function(r){return r;});}.bind(this)});this._oDialog.toggleStyleClass("sapUiSizeCompact",!!q(this.getTable().getDomRef()).closest(".sapUiSizeCompact").length);if(s&&s.contentWidth){this._oDialog.setContentWidth(s.contentWidth);}if(s&&s.contentHeight){this._oDialog.setContentHeight(s.contentHeight);}if(s&&s.styleClass){this._oDialog.addStyleClass(s.styleClass);}var p=this._callControllers(o,"getPanel");var j=[];for(var t in p){if(p[t]){j.push(p[t]);}}Promise.all(j).then(function(k){k.forEach(function(l){this._oDialog.addPanel(l);},this);this._oDialog.attachOk(this._handleDialogOk,this);this._oDialog.attachCancel(this._handleDialogCancel,this);this._oDialog.attachReset(this._handleDialogReset,this);this._oDialog.attachAfterClose(this._handleDialogAfterClose,this);this._oDialog.open();this.fireDialogAfterOpen();}.bind(this));};i.prototype.addColumns=function(o){var t=this.getTable();Object.keys(o).forEach(function(s){if(!o[s].getParent()){t.addDependent(o[s]);}});this._oColumnHelper.addColumnMap(o);};i.prototype.getDataSuiteFormatSnapshot=function(){this._callControllers(this._oSettingCurrent,"calculateControlData");var r={};this._callControllers(this._oSettingCurrent,"getDataSuiteFormatSnapshot",r);return r;};i.prototype.setDataSuiteFormatSnapshot=function(r,p){var R=this._callControllers(this._oSettingCurrent,"getDataSuiteFormat2Json",r);this._setRuntimeAndPersonalizationData(R,p);};i.prototype.setPersonalizationDataAsDataSuiteFormat=function(r){var R=this._callControllers(this._oSettingCurrent,"getDataSuiteFormat2Json",r);this._setRuntimeAndPersonalizationData(R,R);};i.prototype.setPersonalizationData=function(p){this._setRuntimeAndPersonalizationData(p,p);};i.prototype.resetPersonalization=function(r){r=this._determineResetType(r);if(r===C.personalization.ResetType.ResetFull){this._resetFull();}else{this._resetPartial();}this._suspendTable();this._syncTableUi();this._resumeTable(true);this._fireChangeEvent(r);};i.prototype.addToSettingIgnoreColumnKeys=function(j){if(this._isEqualAdditionalIgnoreColumnKeys(j)){return this;}this._callControllers(this._oSettingCurrent,"setAdditionalIgnoreColumnKeys",j);this._callControllers(this._oSettingCurrent,"calculateIgnoreData");this._requestMissingColumnsWithoutIgnore(this._getControlDataBase());this._suspendTable();this._syncTableUi();this._resumeTable(true);this._fireChangeEvent();return this;};i.prototype._handleDialogReset=function(){this._bUnconfirmedResetPressed=true;var r=this._determineResetType();if(r===C.personalization.ResetType.ResetFull){this._resetFull();}else{this._resetPartial();}this._syncDialogUi();};i.prototype._handleDialogOk=function(){this._oDialog.detachOk(this._handleDialogOk,this);if(this._bUnconfirmedResetPressed){this.fireDialogConfirmedReset();}setTimeout(function(){this._postDialogUi(this._getControlDataReduce());this._syncTableUi();this._resumeTable(true);this._fireChangeEvent();}.bind(this),0);this._oDialog.close();};i.prototype._handleDialogCancel=function(){this._oDialog.detachCancel(this._handleDialogCancel,this);setTimeout(function(){this._postDialogUi(this._getBeforeOpenData());this._resumeTable(false);}.bind(this),0);this._oDialog.close();};i.prototype._handleDialogAfterClose=function(){this._oInitialVisiblePanelType=this._oDialog.getVisiblePanel()?this._oDialog.getVisiblePanel().getType():this._getInitialVisiblePanelType();this._bUnconfirmedResetPressed=false;if(this._oDialog){this._oDialog.destroy();this._oDialog=null;}this.fireDialogAfterClose();};i.prototype._getInitialVisiblePanelType=function(){for(var t in this._oSettingCurrent){return t;}};i.prototype._suspendTable=function(){if(U.getTableBaseType(this.getTable())===C.personalization.TableType.Table){this._bSuspend=true;}};i.prototype._resumeTable=function(I){I=(I===undefined)?true:I;var t=this.getTable();if(this._bSuspend){if(t){if(I){t.invalidate();}}this._bSuspend=false;}};i.prototype._requestMissingColumnsWithoutIgnore=function(j){var o=this._callControllers(this._oSettingCurrent,"determineMissingColumnKeys",j);var m=U.getUnionOfColumnKeys(o);if(!m.length){return[];}this.fireRequestColumns({columnKeys:m});return m;};i.prototype._extendModelStructure=function(j){if(!j.length){return;}var o=this._callControllers(this._oSettingCurrent,"createColumnKeysStructure",j);var k=this._callControllers(this._oSettingCurrent,"getTable2Json",o);this._callControllers(this._oSettingCurrent,"extendControlDataInitial",k);this._callControllers(this._oSettingCurrent,"extendVariantDataInitial",k);this._callControllers(this._oSettingCurrent,"extendControlDataBase",k);this._callControllers(this._oSettingCurrent,"extendAlreadyKnownRuntimeData",k);this._callControllers(this._oSettingCurrent,"extendAlreadyKnownPersistentData",k);};i.prototype._setRuntimeAndPersonalizationData=function(r,p){r=(r===null?{}:r);if(!this._sanityCheck(r)){return;}p=(p===null?{}:p);if(!this._sanityCheck(p)){return;}this._setVariantData(p);this._extendModelStructure(this._requestMissingColumnsWithoutIgnore(r));var j=this._callControllers(this._oSettingCurrent,"getUnionData",this._getControlDataInitial(),p);this._callControllers(this._oSettingCurrent,"setVariantDataInitial2Model",j);var R=this._callControllers(this._oSettingCurrent,"getUnionData",this._getControlDataInitial(),r);this._callControllers(this._oSettingCurrent,"fixConflictWithIgnore",R,this._getIgnoreData());this._callControllers(this._oSettingCurrent,"setControlDataBase2Model",R);this._suspendTable();this._syncTableUi();this._resumeTable(true);this._fireChangeEvent();};i.prototype._prepareDialogUi=function(){var j=this._callControllers(this._oSettingCurrent,"createColumnKeysStructure",this.getColumnKeys());this._extendModelStructure(this._requestMissingColumnsWithoutIgnore(j));this._callControllers(this._oSettingCurrent,"setBeforeOpenData2Model",this._getControlDataBase());this._callControllers(this._oSettingCurrent,"calculateControlDataReduce");var o=this._callControllers(this._oSettingCurrent,"getTable2JsonTransient",j);this._callControllers(this._oSettingCurrent,"calculateTransientData",o);};i.prototype._postDialogUi=function(j){this._callControllers(this._oSettingCurrent,"updateControlDataBaseFromJson",j);this._callControllers(this._oSettingCurrent,"setBeforeOpenData2Model",undefined);this._callControllers(this._oSettingCurrent,"setControlDataReduce2Model",undefined);this._callControllers(this._oSettingCurrent,"setTransientData2Model",undefined);};i.prototype._syncDialogUi=function(){this._callControllers(this._oSettingCurrent,"calculateControlDataReduce");};i.prototype._syncTableUi=function(){this._callControllers(this._oSettingCurrent,"calculateControlData");this._callControllers(this._oSettingCurrent,"syncJson2Table",this._getControlData());};i.prototype._resetFull=function(){this._setVariantData(undefined);this._callControllers(this._oSettingCurrent,"setControlDataBase2Model",this._getControlDataInitial());};i.prototype._resetPartial=function(){this._callControllers(this._oSettingCurrent,"setControlDataBase2Model",this._getVariantDataInitial());};i.prototype._fireChangeEvent=function(r){r=this._determineResetType(r);var o={};var j=this._callControllers(this._oSettingCurrent,"getUnionData",this._getControlDataInitial(),this._getControlData());o.runtimeDeltaDataChangeType=this._callControllers(this._oSettingCurrent,"getChangeType",j,this._getAlreadyKnownRuntimeData());var k=this._callControllers(this._oSettingCurrent,"getUnionData",this._getControlDataInitial(),this._getControlDataBase());o.persistentDeltaDataChangeType=this._callControllers(this._oSettingCurrent,"getChangeType",k,this._getAlreadyKnownPersistentData());if(r===C.personalization.ResetType.ResetFull){o.persistentDataChangeType=this._callControllers(this._oSettingCurrent,"getChangeType",this._getControlDataBase(),this._getControlDataInitial());}else if(r===C.personalization.ResetType.ResetPartial){o.persistentDataChangeType=this._callControllers(this._oSettingCurrent,"getChangeType",this._getControlDataBase(),this._getVariantDataInitial());}this._bIsDirty=U.hasChangedType(o.persistentDataChangeType);if(!U.hasChangedType(o.runtimeDeltaDataChangeType)&&!U.hasChangedType(o.persistentDeltaDataChangeType)){return;}this._aColumnKeysOfDateType=U.getColumnKeysOfType("date",this._oColumnHelper.getColumnMap());this._aColumnKeysOfTimeType=U.getColumnKeysOfType("time",this._oColumnHelper.getColumnMap());this._aColumnKeysOfBooleanType=U.getColumnKeysOfType("boolean",this._oColumnHelper.getColumnMap());var l=this._callControllers(this._oSettingCurrent,"getChangeData",j,this._getAlreadyKnownRuntimeData());o.runtimeDeltaData=U.removeEmptyProperty(U.copy(l));U.recoverPersonalisationDateData(o.runtimeDeltaData,this._aColumnKeysOfDateType);U.recoverPersonalisationTimeData(o.runtimeDeltaData,this._aColumnKeysOfTimeType);U.recoverPersonalisationBooleanData(o.runtimeDeltaData,this._aColumnKeysOfBooleanType);var p=this._callControllers(this._oSettingCurrent,"getChangeData",this._getControlDataBase(),this._getControlDataInitial());o.persistentData=U.removeEmptyProperty(p);U.recoverPersonalisationDateData(o.persistentData,this._aColumnKeysOfDateType);U.recoverPersonalisationTimeData(o.persistentData,this._aColumnKeysOfTimeType);U.recoverPersonalisationBooleanData(o.persistentData,this._aColumnKeysOfBooleanType);this._callControllers(this._oSettingCurrent,"setAlreadyKnownRuntimeData2Model",this._getControlData());this._callControllers(this._oSettingCurrent,"setAlreadyKnownPersistentData2Model",this._getControlDataBase());delete o.persistentDeltaDataChangeType;this.fireAfterP13nModelDataChange(o);};i.prototype._onSetVisible=function(v,s){if(v){var I=U.getUnionOfAttribute(this._oSettingCurrent,"ignoreColumnKeys");if(I.indexOf(s)>-1){throw"The provided 'ignoreColumnKeys' are inconsistent. No column specified as ignored is allowed to be visible. "+this;}}};i.prototype._onSetSummed=function(I,o){this._oSettingCurrent.columns.controller._onColumnTotal({column:o,isSummed:I});};i.prototype._getArgumentsByType=function(A,t){var r=[],o=null;if(A&&A.length&&t){A.forEach(function(j){if(j&&j[t]&&typeof j[t]!=="function"){o={};o[t]=j[t];r.push(o);}else{r.push(j);}});}return r;};i.prototype._callControllers=function(s,m){var o,j,A;var r={},k=Array.prototype.slice.call(arguments,2);for(var t in s){o=j=A=null;o=s[t];j=o.controller;if(!j||!o.visible||!j[m]){continue;}A=this._getArgumentsByType(k,t);if(m==="getPanel"){A.push(o.payload);}else if(m==="setIgnoreColumnKeys"){A.push(o.ignoreColumnKeys);}else if(m==="setTriggerModelChangeOnColumnInvisible"){A.push(o.triggerModelChangeOnColumnInvisible);}var R=j[m].apply(j,A);if(R!==null&&R!==undefined&&R[t]!==undefined){r[t]=R[t];}else{r[t]=R;}}return r;};i.prototype._sanityCheck=function(j){return true;};i.prototype._createInternalModel=function(j){var m=new J();m.setDefaultBindingMode(B.TwoWay);if(j.length){m.setSizeLimit(j.length);}this.setModel(m,"$sapuicomppersonalizationBaseController");return m;};i.prototype._getInternalModel=function(){return this.getModel("$sapuicomppersonalizationBaseController");};i.prototype._getInternalModelData=function(s){return this._getInternalModel().getProperty("/"+s);};i.prototype._getControlDataInitial=function(){return this._getInternalModelData("controlDataInitial");};i.prototype._getControlDataBase=function(){return this._getInternalModelData("controlDataBase");};i.prototype._getIgnoreData=function(){return this._getInternalModelData("ignoreData");};i.prototype._getControlData=function(){return this._getInternalModelData("controlData");};i.prototype._getControlDataReduce=function(){return this._getInternalModelData("controlDataReduce");};i.prototype._getTransientData=function(){return this._getInternalModelData("transientData");};i.prototype._getAlreadyKnownRuntimeData=function(){return this._getInternalModelData("alreadyKnownRuntimeData");};i.prototype._getAlreadyKnownPersistentData=function(){return this._getInternalModelData("alreadyKnownPersistentData");};i.prototype._getVariantDataInitial=function(){return this._getInternalModelData("variantDataInitial");};i.prototype._getBeforeOpenData=function(){return this._getInternalModelData("beforeOpenData");};i.prototype._setVariantData=function(j){this._getInternalModel().setProperty("/variantData",j?U.copy(j):undefined);};i.prototype._getVariantData=function(){return this._getInternalModel().getProperty("/variantData");};i.prototype._getControllers=function(){return this._oSettingCurrent;};i.prototype._controllerFactory=function(t){var j=this;switch(t){case a.P13nPanelType.columns:return new b({afterColumnsModelDataChange:function(){j._fireChangeEvent();},beforePotentialTableChange:function(){j.fireBeforePotentialTableChange();},afterPotentialTableChange:function(){j.fireAfterPotentialTableChange();}});case a.P13nPanelType.sort:return new S({afterSortModelDataChange:function(){j._fireChangeEvent();},beforePotentialTableChange:function(){j.fireBeforePotentialTableChange();},afterPotentialTableChange:function(){j.fireAfterPotentialTableChange();}});case a.P13nPanelType.filter:return new F({afterFilterModelDataChange:function(){j._fireChangeEvent();},beforePotentialTableChange:function(){j.fireBeforePotentialTableChange();},afterPotentialTableChange:function(){j.fireAfterPotentialTableChange();}});case a.P13nPanelType.group:return new G({afterGroupModelDataChange:function(){j._fireChangeEvent();},beforePotentialTableChange:function(){j.fireBeforePotentialTableChange();},afterPotentialTableChange:function(){j.fireAfterPotentialTableChange();}});case a.P13nPanelType.dimeasure:return new D({afterDimeasureModelDataChange:function(){j._fireChangeEvent();},beforePotentialTableChange:function(){j.fireBeforePotentialTableChange();},afterPotentialTableChange:function(){j.fireAfterPotentialTableChange();}});case a.P13nPanelType.selection:return new c({afterSelectionModelDataChange:function(){j._fireChangeEvent();},beforePotentialTableChange:function(){j.fireBeforePotentialTableChange();},afterPotentialTableChange:function(){j.fireAfterPotentialTableChange();}});default:throw"Panel type '"+t+"' is not valid";}};i.prototype.getTable=function(){var t=this.getAssociation("table");if(typeof t==="string"){t=sap.ui.getCore().byId(t);}return t;};i._getOrderedColumnKeys=function(o,j){var m=Object.keys(o);return j.reduce(function(r,s){if(m.indexOf(s)>-1){r.push(s);}return r;},[]);};i.prototype.exit=function(){var t;this._resumeTable(false);if(this._oDialog){this._oDialog.destroy();this._oDialog=null;}this._callControllers(this._oSettingCurrent,"destroy");for(t in this._oSettingCurrent){this._oSettingCurrent[t]=null;}this._oSettingCurrent=null;this._oColumnHelper=null;};i.prototype._determineResetType=function(r){r=r||this.getResetToInitialTableState()?C.personalization.ResetType.ResetFull:C.personalization.ResetType.ResetPartial;if(r===C.personalization.ResetType.ResetFull||this._getVariantData()===undefined){return C.personalization.ResetType.ResetFull;}return C.personalization.ResetType.ResetPartial;};i.prototype._isEqualAdditionalIgnoreColumnKeys=function(j){var o=this._callControllers(this._oSettingCurrent,"isEqualAdditionalIgnoreColumnKeys",j);var I=true;for(var t in o){I=I&&o[t];}return I;};i.SyncReason={ResetFull:14,ResetPartial:15,NewModelDataMixedWithVariant:7};return i;},true);
