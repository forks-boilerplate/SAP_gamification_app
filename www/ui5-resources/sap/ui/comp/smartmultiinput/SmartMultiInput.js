/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','sap/m/MultiInput','sap/m/MultiComboBox','sap/m/Token','sap/m/Tokenizer','sap/ui/comp/smartfield/SmartField','sap/ui/comp/odata/MetadataAnalyser',"sap/ui/core/ValueState","sap/ui/model/ParseException","sap/ui/model/ValidateException",'sap/ui/model/BindingMode','sap/ui/comp/odata/ODataType','sap/ui/comp/providers/ValueHelpProvider',"sap/ui/comp/smartfilterbar/DisplayBehaviour","sap/ui/comp/util/FormatUtil","sap/ui/core/format/DateFormat","sap/ui/comp/valuehelpdialog/ValueHelpRangeOperation","sap/ui/comp/smartfilterbar/FilterProvider"],function(q,M,a,T,b,S,c,V,P,d,B,O,e,D,F,f,g,h){"use strict";var I="-mInput";var s="-mInputTokenizer";var j=S.extend("sap.ui.comp.smartmultiinput.SmartMultiInput",{metadata:{library:"sap.ui.comp",properties:{supportRanges:{type:"boolean",defaultValue:false}},events:{beforeCreate:{allowPreventDefault:true,parameters:{oData:{type:"object"},mParameters:{type:"object"}}},beforeRemove:{allowPreventDefault:true,parameters:{mParameters:{type:"object"}}},tokenUpdate:{parameters:{type:{type:"string"},addedTokens:{type:"sap.m.Token[]"},removedTokens:{type:"sap.m.Token[]"}}},selectionChange:{parameters:{changedItem:{type:"sap.ui.core.Item"},selected:{type:"boolean"}}}}},renderer:function(r,C){S.getMetadata().getRenderer().render(r,C);}});j.prototype.getTokens=function(){if(this._oMultiComboBox){return this._oMultiComboBox._oTokenizer.getTokens();}else{return this._oMultiInput.getTokens();}};j.prototype.getValue=function(){return this.getTokens();};j.prototype._createMultiInput=function(){var A=this._createAttributes();this._oMultiInput=new M(this.getId()+I,A);this._sInternalType=this._oMultiInput.getMetadata().getPropertyLikeSetting("value").type;this._oMultiInput.attachChange(function(E){this._validateValueOnChange(E.getParameter("value"));},this);this._oMultiInput.attachSuggestionItemSelected(function(E){this._validateValueOnChange(E.getSource().getValue());},this);if(this.getBindingContext()){this._bindMultiInput();}else{this._oMultiInput.attachTokenUpdate(function(E){var m=E.getParameters();delete m.id;this.fireTokenUpdate(m);},this);}var p={control:this._oMultiInput,onCreate:"_onMultiInputCreate",params:{type:{type:this._getType(),property:this._oFactory._oMetaData.property}}};this._initMultiInputValueHelp(p);return p;};j.prototype._createMultiComboBox=function(){var A=this._createAttributes();this._oMultiComboBox=new a(this.getId()+"mComboBox",A);this._sInternalType=this._oMultiComboBox.getMetadata().getPropertyLikeSetting("value").type;if(this.getBindingContext()){this._bindMultiComboBox();}else{this._oMultiInput=this._oMultiComboBox._oTokenizer;this._oMultiComboBox.attachSelectionChange(function(E){var m=E.getParameters();delete m.id;this.fireSelectionChange(m);},this);}var p={control:this._oMultiComboBox,onCreate:"_onCreate",params:{type:{type:this._getType(),property:this._oFactory._oMetaData.property},valuehelp:{annotation:this._getValueListAnnotation(),aggregation:"items",noDialog:true,noTypeAhead:true}}};return p;};j.prototype._createAttributes=function(){var n={width:true,textAlign:true,placeholder:true,tooltip:true,name:true,valueState:true,valueStateText:true};var A=this._oFactory.createAttributes(null,this._oFactory._oMetaData.property,n,{event:"change",parameter:"value"});return A;};function o(C){var t=C.getParameter("tokens"),r,k,i=0,R=[],l=null,m;this._onCancel();if(this.oControl instanceof sap.m.MultiInput){this.oControl.setValue("");var n=this.oControl.getTokens();var A=[];var p=[];n.forEach(function(u){var v=t.some(function(w){return u.getKey()===w.getKey();});if(!v){p.push(u);}});t.forEach(function(u){var v=n.some(function(w){return w.getKey()===u.getKey();});if(!v){A.push(u);}});this.oControl.setTokens(t);this.oControl.fireTokenUpdate({type:"tokensChanged",removedTokens:p,addedTokens:A});i=t.length;while(i--){l=t[i].data("row");if(l){R.push(l);}}}else{if(t[0]){if(this.bIsSingleIntervalRange){r=t[0].data("range");if(r){if(this._sType==="datetime"){m=f.getDateTimeInstance(q.extend({},this._oDateFormatSettings,{UTC:false}));if(typeof r.value1==="string"){r.value1=new Date(r.value1);}if(r.operation==="BT"){if(typeof r.value2==="string"){r.value2=new Date(r.value2);}k=m.format(r.value1)+"-"+m.format(r.value2);}else{k=m.format(r.value1);}}else{if(r.operation==="BT"){k=r.value1+"-"+r.value2;}else{k=r.value1;}}}}else{k=t[0].getKey();}l=t[0].data("row");if(l){R.push(l);}}this.oControl.setValue(k);this.oControl.fireChange({value:k,validated:true});}this._calculateAndSetFilterOutputData(R);}j.prototype._initMultiInputValueHelp=function(p){var i=this._getFilterType(this._oFactory._oMetaData.property.property),k={},l=this._getDateFormatSettings(),v;this._oFactory._getValueHelpDialogTitle(k);if(this._getValueListAnnotation()){p.params.valuehelp={annotation:this._getValueListAnnotation(),aggregation:"suggestionRows",noDialog:false,noTypeAhead:false,supportMultiSelect:true,supportRanges:this.getBindingContext()?false:this.getSupportRanges(),type:i};}else if(this.getSupportRanges()&&!this.getBindingContext()){v=new e({fieldName:this._getPropertyName(),preventInitialDataFetchInValueHelpDialog:true,model:this.getModel(),control:this._oMultiInput,title:k.dialogtitle,supportMultiSelect:true,supportRanges:true,type:i,dateFormatSettings:l,isUnrestrictedFilter:this._isTimeType(i),displayBehaviour:this._getDisplayBehaviour()});v._onOK=o;this._oMultiInput.addValidator(this._validateToken.bind(this));}else{this._oMultiInput.setShowValueHelp(false);this._oMultiInput.addValidator(this._validateToken.bind(this));}};j.prototype._bindMultiInput=function(){var i=this.getBinding("value").getBindingMode();switch(i){case B.OneTime:this._bindMultiInputOneTime();break;case B.OneWay:this._bindMultiInputOneWay();break;case B.TwoWay:default:this._bindMultiInputTwoWay();}};j.prototype._bindMultiInputOneTime=function(){var t=this;this._readNavigationPropertySet().then(function(r){r.results.forEach(function(R){var k=R[t._getPropertyName()];var i=t._getDescriptionFieldName();var l=i?R[i]:"";t._oMultiInput.addToken(t._createToken(k,l));});});};j.prototype._bindMultiInputOneWay=function(){this._bindMultiInputTokens();};j.prototype._bindMultiInputTwoWay=function(){this._bindMultiInputTokens();this._oMultiInput.attachTokenUpdate(function(E){E.getParameter("addedTokens").forEach(this._addToken.bind(this));E.getParameter("removedTokens").forEach(this._removeToken.bind(this));},this);};j.prototype._bindMultiInputTokens=function(){var n=this._getNavigationPath();this._oMultiInput.bindAggregation("tokens",{path:n,factory:this._tokensFactory.bind(this)});};j.prototype._bindMultiComboBox=function(){var i=this.getBinding("value").getBindingMode();switch(i){case B.OneTime:this._bindMultiComboBoxOneTime();break;case B.OneWay:this._bindMultiComboBoxOneWay();break;case B.TwoWay:default:this._bindMultiComboBoxTwoWay();}};j.prototype._bindMultiComboBoxOneTime=function(){var t=this;this._readNavigationPropertySet().then(function(r){var k=r.results.map(function(R){return R[t._getPropertyName()];});t._oMultiComboBox.setSelectedKeys(k);});};j.prototype._bindMultiComboBoxOneWay=function(){this._createAndAttachHelperMultiInput();};j.prototype._bindMultiComboBoxTwoWay=function(){this._createAndAttachHelperMultiInput();this._oMultiComboBox.attachSelectionChange(function(E){var i=E.getParameter("selected"),k=E.getParameter("changedItem"),l=k.getBindingContext().getProperty(),C=this.getBindingContext(),K=this._getEntityKeyProperties(C);Object.keys(K).forEach(function(p){l[p]=K[p];});if(i){this._createEntity(l);}else{this._removeEntity(l);}},this);};j.prototype._readNavigationPropertySet=function(){var t=this;return new Promise(function(r,i){var C=t.getBindingContext(),m=t._getModel(),n=t._getNavigationPath();m.read(n,{context:C,success:function(R){r(R);},error:function(E){t.setValueState(V.Error);t.setValueStateText(E.responseText);i(E);}});});};j.prototype._createAndAttachHelperMultiInput=function(){var n=this._getNavigationPath();this._oMultiInput=new M();this._oMultiInput.setBindingContext(this.getBindingContext());this._oMultiInput.setModel(this._getModel());this._oMultiInput.bindAggregation("tokens",{path:n,factory:this._tokensFactory.bind(this)});var i=this._oMultiInput.getBinding("tokens");i.attachChange(function(){var k=this._oMultiInput.getTokens().map(function(t){return t.getKey();});this._oMultiComboBox.setSelectedKeys(k);},this);};j.prototype._createTokenizer=function(){var n=this._getNavigationPath();this._oTokenizer=new b(this.getId()+s,{editable:false,width:"100%"});if(this.getBindingContext()){this._oTokenizer.bindAggregation("tokens",{path:n,factory:this._tokensFactory.bind(this)});}else{this.attachInnerControlsCreated(function(){if(this.getMode()==="display"&&typeof this._oMultiInput!=="undefined"){this._oTokenizer.removeAllTokens();this._oMultiInput.getTokens().forEach(function(t){var N=new T({text:t.getText(),key:t.getKey()});this._oTokenizer.addToken(N);},this);}},this);}return{control:this._oTokenizer,onCreate:"_onCreate"};};j.prototype._tokensFactory=function(C,i){var v=i.getProperty(this._getPropertyName());var k=this._getType().formatValue(v,this._sInternalType);var l=this._getDescriptionFieldName();var m=l?i.getProperty(l):"";var t=this._createToken(k,m);return t;};j.prototype._createToken=function(k,i){var l=this._getFormattedText(k,i);var t=new T();t.setKey(k);t.setText(l);return t;};j.prototype._addToken=function(t){var i={},r=t.data("row"),R=t.data("range"),C=this.getBindingContext(),k=this._getEntityKeyProperties(C);Object.keys(k).forEach(function(p){i[p]=k[p];});if(r){Object.keys(r).forEach(function(p){if(p!=="__metadata"){i[p]=r[p];}});}if(R){i["range"]=R;}this.setValueState(V.None);C=this._createEntity(i);t.setBindingContext(C);};j.prototype._createEntity=function(i){var m=this._getModel(),A=this._getEntitySetName(),p=m._resolveGroup(A),k=this.getBindingContext().getPath()+"/"+this._getNavigationPath(),l=this.fireBeforeCreate({oData:i,mParameters:p});if(l){p.properties=i;var C=m.createEntry(k,p);return C;}};j.prototype._removeToken=function(t){var k=this._getEntityKeyProperties(t.getBindingContext());this._removeEntity(k);};j.prototype._removeEntity=function(k){var m=this._getModel(),A=this._getEntitySetName(),p=m._resolveGroup(A),i=this.fireBeforeRemove({mParameters:p});if(i){var l="/"+m.createKey(A,k);m.remove(l,p);}};j.prototype._getEntityKeyProperties=function(C){var m=this._getModel(),E=m.oMetadata._getEntityTypeByPath(C.getPath()),k={};E.key.propertyRef.forEach(function(K){var p=K.name;k[p]=C.getProperty(p);});return k;};j.prototype.checkClientError=function(){if(this.getMode()==="display"){return false;}return!this._validateMultiInput();};j.prototype.getRangeData=function(){var t=this.getTokens(),r=[];t.forEach(function(i){var R;if(i.data("range")){R=i.data("range");}else{R=this._getDefaultTokenRangeData(i);}r.push(R);},this);return r;};j.prototype.getFilter=function(){var i=[this._getPropertyName()],k={},r=this.getRangeData(),l;k[this._getPropertyName()]={ranges:r,items:[]};l=h.generateFilters(i,k);return l&&l.length===1&&l[0];};j.prototype._getDefaultTokenRangeData=function(t){var r={exclude:false,operation:g.EQ,value1:this._parseValue(t.getKey()),value2:"",keyField:this._getPropertyName()};return r;};j.prototype._validateToken=function(A){var t=A.text;var v=this._validateValue(t);if(v){var i=new T({key:t,text:t});if(this.getBindingContext()){var r={};r[this._getPropertyName()]=this._getType().parseValue(t,this._sInternalType);i.data("row",r);}else if(this.getSupportRanges()){var R=this._getDefaultTokenRangeData(i);i.data("range",R);i.setText("="+t);}return i;}};j.prototype._validateMultiInput=function(){if(this._oMultiInput.getValueState()!==V.None){return false;}if(this.getRequired()&&this.getTokens().length===0){this.setValueStateText(sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("VALUEHELPVALDLG_FIELDMESSAGE"));this.setValueState(V.Error);return false;}else{this.setValueState(V.None);return true;}};j.prototype._validateValueOnChange=function(v){if(v===""){this.setValueState(V.None);this._validateMultiInput();}else{this._validateValue(v);}};j.prototype._parseValue=function(v){return this._getType().parseValue(v,this._sInternalType);};j.prototype._validateValue=function(v){try{var p=this._parseValue(v);this._getType().validateValue(p);this.setValueState(V.None);return true;}catch(E){this.setValueState(V.Error);this.setValueStateText(E.message);var m={element:this._oMultiInput,property:"value",type:this._getType(),newValue:v,oldValue:null,exception:E,message:E.message};if(E instanceof P){this.fireParseError(m);}else if(E instanceof d){this.fireValidationError(m);}return false;}};j.prototype._getModel=function(){if(this._oFactory){return this._oFactory._oModel;}};j.prototype._getDateFormatSettings=function(){var i=this.data("dateFormatSettings");if(typeof i==="string"){try{i=JSON.parse(i);}catch(k){}}return i;};j.prototype._getNavigationPath=function(){return this._oFactory._oMetaData.navigationPath;};j.prototype._getDescriptionFieldName=function(){var i=this._oFactory._oMetaData.annotations.text;if(i){return i.property.property.name;}};j.prototype._getType=function(){if(!this._oType){var i;if(this._isEdmTimeType()){i=this._getDateFormatSettings();}this._oType=this._oFactory._oTypes.getType(this._oFactory._oMetaData.property,i);}return this._oType;};j.prototype._isEdmTimeType=function(){var t=["Edm.DateTime","Edm.DateTimeOffset","Edm.Time"];return t.indexOf(this._oFactory._oMetaData.property.property.type)>-1;};j.prototype._isTimeType=function(t){var i=["date","datetime","time"];return i.indexOf(t)>-1;};j.prototype._getPropertyName=function(){return this._oFactory._oMetaData.property.property.name;};j.prototype._getEntitySetName=function(){return this._oFactory._oMetaData.entitySet.name;};j.prototype._getValueListAnnotation=function(){return this._oFactory._oMetaData.annotations.valuelist;};j.prototype._getDisplayBehaviour=function(){var i=this._oFactory._getDisplayBehaviourConfiguration("defaultDropDownDisplayBehaviour");if(!i||i===D.auto){i=D.descriptionAndId;}return i;};j.prototype._getFormattedText=function(k,i){var l=this._getDisplayBehaviour();return F.getFormattedExpressionFromDisplayBehaviour(l,k,i);};j.prototype._getFilterType=function(p){if(O.isNumeric(p.type)){return"numeric";}else if(p.type==="Edm.DateTime"&&p["sap:display-format"]==="Date"){return"date";}else if(p.type==="Edm.String"){return"string";}else if(p.type==="Edm.Boolean"){return"boolean";}else if(p.type==="Edm.Time"){return"time";}else if(p.type==="Edm.DateTimeOffset"){return"datetime";}return undefined;};j.prototype.setEntitySet=function(){S.prototype.setEntitySet.apply(this,arguments);this.updateBindingContext(false,this._getModel());return this;};j.prototype.bindProperty=function(p,A){S.prototype.bindProperty.apply(this,arguments);if(p==="value"){this.updateBindingContext(false,this._getModel());}return this;};j.prototype._checkComboBox=function(){var C=this._oFactory._oSelector.checkComboBox();return C&&C.combobox;};function _(){this._onCreate.apply(this,arguments);if(this._aProviders.length>0){this._aProviders[0]._onOK=o;}}j.prototype._init=function(){var t=this;S.prototype._init.apply(this,arguments);if(this._oFactory){this._oFactory._createMultiInput=this._createMultiInput.bind(this);this._oFactory._createMultiComboBox=this._createMultiComboBox.bind(this);this._oFactory._createTokenizer=this._createTokenizer.bind(this);this._oFactory._onMultiInputCreate=_;this._oFactory._oSelector.getCreator=function(){if(!t.getEditable()||!t.getEnabled()||!t.getContextEditable()){return"_createTokenizer";}else if(t._checkComboBox()){return"_createMultiComboBox";}else{return"_createMultiInput";}};}};return j;},true);
