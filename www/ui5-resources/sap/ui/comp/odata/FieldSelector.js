/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.getCore().loadLibrary('sap.ui.fl');sap.ui.define(['jquery.sap.global','sap/ui/comp/library','sap/ui/core/Control','./FieldSelectorController','sap/m/library','sap/m/HBox','sap/m/VBox','sap/m/FlexItemData','sap/m/Label','sap/ui/core/ResizeHandler','sap/ui/comp/odata/FieldSelectorModelConverter','sap/ui/fl/fieldExt/Access','./FieldSelectorRenderer'],function(q,l,C,F,L,H,V,a,b,R,c,A,d){"use strict";var f=L.FlexDirection;var g=L.FlexAlignItems;var h=C.extend("sap.ui.comp.odata.FieldSelector",{metadata:{library:"sap.ui.comp",properties:{showSearchBar:{type:"boolean",group:"Misc",defaultValue:true}},aggregations:{content:{type:"sap.ui.core.Control",multiple:false}},events:{fieldSelectionChanged:{}}}});h._tooltipBinding={parts:[{path:"com.sap.vocabularies.Common.v1.QuickInfo"},{path:"com.sap.vocabularies.Common.v1.Label"}],formatter:function tooltipFormatter(Q,o){if(Q&&Q.String){return Q.String;}if(o&&o.String){return o.String;}return'';}};h.prototype.init=function(){this._fieldNameText=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("ODATA_FIELD_SEL_NAME");this._fieldTypeText=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("ODATA_FIELD_SEL_TYPE");this._fieldLabelText=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("ODATA_FIELD_SEL_LABEL");this._entityTypeText=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("ODATA_FIELD_SEL_HEADER");this._createNewFieldText=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("ODATA_CREATE_NEW_FIELD");this._oFieldController=new F();this._sSelectedKey=undefined;this._oTable=undefined;this._oSearchField=undefined;this._oConverter=undefined;this._oCreateButton=undefined;this._bDisplayFieldExtButton=undefined;this._oCurrentFieldExtInfo=undefined;this._oScrollView=new sap.m.ScrollContainer();this._oTable=new sap.m.Table();this._oHeaderLayout=undefined;var s=sap.ui.getCore().byId("smartFormPersDialog");if(s){this._oResizeDialogHandlerId=R.register(s,this._handleResizeDialog.bind(this));}if(this._oScrollView){this._oResizeScrollViewHandlerId=R.register(this._oScrollView,this._handleResizeTable.bind(this));}};h.prototype._handleResizeDialog=function(){if(this._oScrollView){var e=q("#smartFormPersDialog-cont").height();var i=q("#smartFormPersDialogFieldSelectorHeader").height();var j=q("#sapUiCompFieldSelectorHeaderSearch").height();var t=q("#sapUiCompFieldSelectorTable-tblHeader").height();this._oScrollView.setHeight(e-i-j-t+"px");}};h.prototype._handleResizeTable=function(){if(this._oScrollView){var w=this._oScrollView.$("scroll").innerWidth();this._oTable.setWidth(w+"px");}};h.prototype.setModel=function(m,e,s,i,B,I){this._bDisplayFieldExtButton=s;if(!m){q.sap.log.error("oModel has to be set otherwise nothing will be displayed");}if(!e){q.sap.log.error("sEntityTypes has to be set otherwise nothing will be displayed");}this._oFieldController.init(m,e,i,B,I);this._constructLayout();this._updateCreateButtonState();};h.prototype.getSelectedField=function(){var r={entityType:this._sSelectedKey};var s=this._oTable.getSelectedItem();if(s){var S=s.getBindingContext();if(S){var o=S.getProperty();if(o){r.field=o.fieldLabel;r.name=o.name;r.entityName=o.entityName;r.entitySet=this._oFieldController.getMetaDataAnalyzer().getEntitySetNameFromEntityTypeName(r.entityType);r.path=o.name;r.isBoundToODataService=o.id===undefined;if(!r.isBoundToODataService){r.id=o.id;}else{if(r.entityType!==o.entityName){var p=this._oFieldController.getMetaDataAnalyzer()._getNameOfPropertyUsingComplexType(r.entityType,o.entityName);if(p){r.path=p+"/"+o.name;}else{q.sap.log.error("FieldSelector: Property of complex type "+o.name+" not found on entityType "+r.entityType);}}}}}}return r;};h.prototype.updateFieldLabel=function(o){var t=this;var e=this._oFieldController.getFields();var i=o.isBoundToODataService;var n=o.label;if(i===true){var B=o.bindingPaths;q.each(B,function(j,k){var s=k.path;var m=s.indexOf('/');var r=s.slice(0,m);var p=s.slice(m+1);var E=e[r];q.each(E,function(u,v){if(v.name&&v.name===p){v.fieldLabel=n;t._oFieldController.sortFieldsForEntity(r);t._updateTableData();return;}});});}else if(i===false){q.each(e,function(s,E){q.each(E,function(j,k){if(k.id&&k.id===o.id){k.fieldLabel=n;t._oFieldController.sortFieldsForEntity(s);}});});this._updateTableData();}};h.prototype._constructLayout=function(){var t=this;var o=new V({direction:f.Column});this._oHeaderLayout=new H("smartFormPersDialogFieldSelectorHeader",{direction:f.Row});this._oHeaderLayout.addStyleClass("sapUiCompFieldSelectorHeader");this._oHeaderLayoutSearch=new H({direction:f.Row});this._oHeaderLayoutSearch.addStyleClass("sapUiCompFieldSelectorHeaderSearch");this._oResizeHeaderHandlerId=R.register(this._oHeaderLayout,this._handleResizeDialog.bind(this));var e=new H({direction:f.Row,alignItems:g.Start,layoutData:new a({growFactor:2})});e.addStyleClass("sapUiCompFieldSelectorHeaderEntitySelection");var i=new b({text:this._entityTypeText,layoutData:new a({order:1,growFactor:1})});var D=this._getEntityTypesRow();D.setLayoutData(new a({order:2,growFactor:1}));D.addStyleClass("sapUiCompFieldSelectorComboBox");i.setLabelFor(D);i.setVisible(D.getVisible());e.addItem(i);e.addItem(D);this._oHeaderLayout.addItem(e);var s=this._getSearchRow();s.setLayoutData(new a({growFactor:1}));s.addStyleClass("sapUiCompFieldSelectorHeader");this._oHeaderLayoutSearch.addItem(s);this._oCreateButton=new sap.m.Button({text:this._createNewFieldText,press:function(E){if(t._oCurrentFieldExtInfo){var j=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");var k=(j&&j.hrefForExternal({target:{semanticObject:"CustomField",action:"develop"},params:{businessContexts:t._oCurrentFieldExtInfo.BusinessContexts,serviceName:t._oCurrentFieldExtInfo.ServiceName,serviceVersion:t._oCurrentFieldExtInfo.ServiceVersion}}));window.open(k,"_blank");}}});this._oCreateButton.addStyleClass("sapUiCompFieldSelectorCreateButton");this._oHeaderLayout.addItem(this._oCreateButton);o.addItem(this._oHeaderLayout);o.addItem(this._oHeaderLayoutSearch);o.addItem(this._getFieldsRow());this.setContent(o);};h.prototype._getEntityTypesRow=function(){var t=this;var D=new sap.m.ComboBox({selectionChange:function(E){t._oSearchField.setValue("");t._sSelectedKey=E.mParameters.selectedItem.getKey();t._updateTableData();t._updateCreateButtonState();},layoutData:new a({growFactor:1})});var e=this._oFieldController.getEntityTypes();for(var i=0;i<e.length;i++){D.addItem(new sap.ui.core.Item({text:e[i].label,key:e[i].key}));}if(e.length>0){this._sSelectedKey=e[0].key;D.setSelectedKey(this._sSelectedKey);}if(e.length===1){D.setVisible(false);}return D;};h.prototype._getSearchRow=function(){var i=0;var t=this;var v;this._oSearchField=new sap.m.SearchField({visible:this.getShowSearchBar(),liveChange:function(e){v=e.getSource().getValue();var D=(v?300:0);clearTimeout(i);if(D){i=setTimeout(function(){t._executeSearch(v);},D);}else{t._executeSearch(v);}},search:function(e){v=e.getSource().getValue();t._executeSearch(v);},layoutData:new a({growFactor:2})});return this._oSearchField;};h.prototype._executeSearch=function(v){var e=[];var o=new sap.ui.model.Filter("fieldLabel",sap.ui.model.FilterOperator.Contains,v);var Q=new sap.ui.model.Filter("quickInfo",sap.ui.model.FilterOperator.Contains,v);var i=new sap.ui.model.Filter([o,Q],false);e.push(i);var j=this._oTable.getBinding("items");j.filter(e,"Application");};h.prototype._getFieldsRow=function(){this._oScrollView.setVertical(true);this._oScrollView.addStyleClass("sapUiCompFieldSelectorScrollContainer");var i=[new sap.m.Column({header:new b({text:this._fieldLabelText})})];this._oTable=new sap.m.Table("sapUiCompFieldSelectorTable",{mode:"SingleSelectMaster",columns:i,selectionChange:function(e){var s=this.getSelectedField();this.fireFieldSelectionChanged(s);}.bind(this)});this._oTable.setFixedLayout(false);this._updateTableData();this._oScrollView.addContent(this._oTable);this._handleResizeDialog();return this._oScrollView;};h.prototype._updateTableData=function(){var m=new sap.ui.model.json.JSONModel();m.setData({modelData:this._oFieldController.getFields()});var t=new sap.m.ColumnListItem({cells:[new sap.m.Text({text:"{fieldLabel}",tooltip:h._tooltipBinding,wrapping:false})],visible:{path:"fieldLabel",formatter:function(s){return!!s;}}});this._oTable.setModel(m);this._oTable.getModel().setSizeLimit(this._oFieldController.getMaxEntitySetSize()+5);this._oTable.bindItems("/modelData/"+this._sSelectedKey,t);};h.prototype._updateCreateButtonState=function(){if(!this._bDisplayFieldExtButton){this._oCreateButton.setVisible(false);}else{var t=this;var m=this._oFieldController.getMetaDataAnalyzer();t._oCreateButton.setEnabled(false);try{var p=A.getBusinessContexts(m.oModel.sServiceUrl,this._sSelectedKey);p.done(function(r){if(r){if(r.BusinessContexts){if(r.BusinessContexts.length>0){t._oCurrentFieldExtInfo=r;t._oCreateButton.setEnabled(true);}}}});p.fail(function(e){t._oCreateButton.setEnabled(false);if(e){if(q.isArray(e.errorMessages)){for(var i=0;i<e.errorMessages.length;i++){q.sap.log.error(e.errorMessages[i].text);}}}});}catch(e){t._oCreateButton.setEnabled(false);q.sap.log.error("exception occured in sap.ui.fl.fieldExt.Access.getBusinessContexts");}}};h.prototype.exit=function(){if(this._oResizeDialogHandlerId){R.deregister(this._oResizeDialogHandlerId);}if(this._oResizeHeaderHandlerId){R.deregister(this._oResizeHeaderHandlerId);}if(this._oResizeScrollViewHandlerId){R.deregister(this._oResizeScrollViewHandlerId);}this.destroyAggregation("content");this._oFieldController.destroy();this._sSelectedKey=null;this._oTable=null;this._oScrollView=null;this._oSearchField=null;this._oHeaderLayout=null;if(this._oConverter&&this._oConverter.destroy){this._oConverter.destroy();}this._oConverter=null;if(this._oCreateButton){if(this._oCreateButton.destroy){this._oCreateButton.destroy();}}this._oCreateButton=null;this._oCurrentFieldExtInfo=null;};return h;},true);
