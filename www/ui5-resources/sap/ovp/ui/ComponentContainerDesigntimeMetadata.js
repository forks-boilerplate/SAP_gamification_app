/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["jquery.sap.global","sap/ovp/cards/CommonUtils","sap/ovp/cards/SettingsUtils","sap/ui/dt/plugin/ElementMover","sap/ui/dt/OverlayRegistry",'sap/ui/dt/OverlayUtil','sap/ui/rta/plugin/Plugin','sap/ui/rta/util/BindingsExtractor','sap/ui/dt/MetadataPropagationUtil','sap/ui/rta/Utils'],function(q,C,S,E,O,a,P,B,M,U){"use strict";var A=C.getApp();var r=A&&A._getLibraryResourceBundle();r=r||sap.ui.getCore().getLibraryResourceBundle("sap.ovp");var e=new E(),d,_=function(t){var f=t.getAggregationOverlays();var p=f.filter(function(o){return o.isTargetZone();});if(p.length>0){return p[0];}else{return null;}},b=function(t){var o=e.getMovedOverlay();if(!o){return false;}var R=false;if(!(t.getElement()===o.getElement())){var T=_(t);if(T){R=true;}else if(a.isInTargetZoneAggregation(t)){R=true;}}if(R){o.setSelected(true);setTimeout(function(){o.focus();},0);}return R;};var c=E.prototype.checkTargetZone;E.prototype.checkTargetZone=function(o,f,g){var m=f?f:this.getMovedOverlay();var t=c.apply(this,arguments);if(!t){return false;}var h=m.getElement();var T=o.getParent();var i=m.getRelevantContainer();var j=T.getElement();var k=o.getDesignTimeMetadata();var v=M.getRelevantContainerForPropagation(k.getData(),h);v=v?v:j;if(!i||!v||!P.prototype.hasStableId(T)||i!==v){return false;}if(m.getParent().getElement()!==j){var l=B.getBindings(h,h.getModel());if(Object.keys(l).length>0&&h.getBindingContext()&&j.getBindingContext()){var s=U.getEntityTypeByPath(h.getModel(),h.getBindingContext().getPath());var n=U.getEntityTypeByPath(j.getModel(),j.getBindingContext().getPath());if(!(s===n)){return false;}}}return true;};return{name:{singular:r.getText("Card"),plural:r.getText("Cards")},actions:{remove:{name:r.getText("OVP_KEYUSER_MENU_HIDE_CARD"),changeType:"hideCardContainer",changeOnRelevantContainer:true},reveal:{changeType:"unhideCardContainer",changeOnRelevantContainer:true,getLabel:function(o){var s=this._getCardId(o.getId()),f=this._getCardFromManifest(s);if(f){var g=f.settings;if(g.title){return g.title;}else if(g.category){return(g.category);}else if(g.subTitle){return g.subTitle;}return f.cardId;}else{q.sap.log.error("Card id "+s+" is not present in the manifest");return"";}}.bind(A)},settings:function(){return{"Cut":{icon:"sap-icon://scissors",name:r.getText("OVP_KEYUSER_MENU_CUT_CARD"),isEnabled:function(s){d=this.getDesignTime();return this.getSelectedOverlays().length===1;},changeOnRelevantContainer:true,handler:function(s,g){var o=O.getOverlay(s),f=e.getMovedOverlay();if(f){f.removeStyleClass("sapUiDtOverlayCutted");e.setMovedOverlay(null);e.deactivateAllTargetZones(d);}e.setMovedOverlay(o);o.addStyleClass("sapUiDtOverlayCutted");e.activateAllValidTargetZones(d);return Promise.resolve([]).then(function(){return[];});}},"Paste":{icon:"sap-icon://paste",name:r.getText("OVP_KEYUSER_MENU_PASTE_CARD"),isEnabled:function(s){d=this.getDesignTime();var o=O.getOverlay(s),t=_(o);return(t)||(a.isInTargetZoneAggregation(o));},changeOnRelevantContainer:true,handler:function(s,g){var o=O.getOverlay(s),f=e.getMovedOverlay();if(f){var m=f.getElement(),t=o.getElement(),h=a.getParentInformation(f),T=a.getParentInformation(o),i=s.getComponentInstance().getComponentData().mainComponent,j=i.getLayout(),u=i.getUIModel(),p={},k={},l=[];if(u.getProperty('/containerLayout')==='resizable'){var L=j.getDashboardLayoutModel(),n=i._getCardId(m.getId()),v=i._getCardId(s.getId()),w=L.getCardById(n),x=L.getCardById(v),y=L.getColCount(),z='C'+y,D=[];p.cardId=n;p.dashboardLayout={};p.dashboardLayout[z]={row:x.dashboardLayout.row,oldRow:w.dashboardLayout.row,column:x.dashboardLayout.column,oldColumn:w.dashboardLayout.column};if(x.dashboardLayout.column+w.dashboardLayout.colSpan>y+1){p.dashboardLayout[z].colSpan=x.dashboardLayout.colSpan;p.dashboardLayout[z].oldColSpan=w.dashboardLayout.colSpan;p.dashboardLayout[z].rowSpan=w.dashboardLayout.rowSpan;p.dashboardLayout[z].oldRowSpan=w.dashboardLayout.rowSpan;}l.push({selectorControl:s.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{changeType:"dragOrResize",content:p}});l.push({selectorControl:s.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{runtimeOnly:true,changeType:"dragAndDropUI",content:p}});L._arrangeCards(w,{row:x.dashboardLayout.row,column:x.dashboardLayout.column},'drag',D);L._removeSpaceBeforeCard(D);D.forEach(function(F){var G={};G.dashboardLayout={};G.cardId=F.content.cardId;G.dashboardLayout[z]=F.content.dashboardLayout;l.push({selectorControl:s.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{changeType:"dragOrResize",content:G}});});}else{var V=T.parent.getContent().filter(function(F){return F.getVisible();});p={cardId:i._getCardId(m.getId()),position:V.indexOf(t),oldPosition:V.indexOf(m)};l.push({selectorControl:s.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{changeType:"position",content:p}});k={cardId:i._getCardId(m.getId()),position:T.index,oldPosition:h.index};l.push({selectorControl:s.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{runtimeOnly:true,changeType:"dragAndDropUI",content:k}});}}b(o);if(f){f.removeStyleClass("sapUiDtOverlayCutted");e.setMovedOverlay(null);e.deactivateAllTargetZones(d);return Promise.resolve(l).then(function(F){return F;});}}},"EditCard":{icon:"sap-icon://edit",name:r.getText("OVP_KEYUSER_MENU_EDIT_CARD"),isEnabled:function(s){return true;},changeOnRelevantContainer:true,handler:S.fnEditCardHandler},"CloneCard":{icon:"sap-icon://value-help",name:r.getText("OVP_KEYUSER_MENU_CLONE_CARD"),isEnabled:function(s){return true;},handler:S.fnCloneCardHandler},"AddStaticLinkListCard":{icon:"sap-icon://form",name:r.getText("OVP_KEYUSER_MENU_CREATE_LINK_LIST_CARD"),isEnabled:function(s){return true;},handler:S.fnAddStaticLinkListCardHandler}};}}};},true);
