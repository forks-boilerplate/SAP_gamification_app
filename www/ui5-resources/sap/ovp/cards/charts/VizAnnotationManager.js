sap.ui.define(["jquery.sap.global","sap/ovp/cards/charts/Utils","sap/ui/model/odata/CountMode","sap/ovp/cards/AnnotationHelper","sap/ui/core/format/NumberFormat","sap/ui/core/format/DateFormat","sap/viz/ui5/api/env/Format","sap/viz/ui5/controls/VizTooltip","sap/ovp/cards/CommonUtils","sap/ovp/cards/OVPCardAsAPIUtils","sap/viz/ui5/data/DimensionDefinition","sap/viz/ui5/data/MeasureDefinition","sap/viz/ui5/controls/common/feeds/FeedItem","sap/ui/core/Element"],function(q,U,C,a,N,D,V,b,c,O,e,M,F,g){"use strict";var h={LABEL_KEY:"sap:label",LABEL_KEY_V4:"com.sap.vocabularies.Common.v1.Label",TEXT_KEY:"sap:text",TEXT_KEY_V4:"com.sap.vocabularies.Common.v1.Text",TEXT_ARRANGEMENT_ANNO:"com.sap.vocabularies.UI.v1.TextArrangement",TYPE_KEY:"type",DISPLAY_FORMAT_KEY:"sap:display-format",SEMANTICS_KEY:"sap:semantics",UNIT_KEY:"sap:unit",UNIT_KEY_V4_ISOCurrency:"Org.OData.Measures.V1.ISOCurrency",UNIT_KEY_V4_Unit:"Org.OData.Measures.V1.Unit",CURRENCY_CODE:"currency-code",NAME_KEY:"name",NAME_CAP_KEY:"Name",EDM_TYPE:"type",EDM_INT32:"Edm.Int32",SCATTER_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/Scatter",BUBBLE_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/Bubble",LINE_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/Line",COLUMNSTACKED_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/ColumnStacked",DONUT_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/Donut"};var l={CARD_WARNING:"OVP-AC: Analytic card: Warning: ",CARD_ERROR:"OVP-AC: Analytic card Error: ",DATA_ANNO_ERROR:"OVP-AC: Analytic card Error:",CARD_ANNO_ERROR:"OVP-AC: Analytic card: Error ",CHART_ANNO_ERROR:"OVP-AC: Analytic card: Error ",INVALID_CHART_ANNO:"OVP-AC: Analytic Cards: Invalid Chart Annotation.",ANALYTICAL_CONFIG_ERROR:"Analytic card configuration error",CACHING_ERROR:"no model defined while caching OdataMetaData",INVALID_MAXITEMS:"maxItems is Invalid. ",NO_DATASET:"OVP-AC: Analytic Cards: Could not obtain dataset.",SORTORDER_WARNING:"SortOrder is present in PresentationVariant, but it is empty or not well formed.",BOOLEAN_ERROR:"Boolean value is not present in PresentationVariant.",IS_MANDATORY:"is mandatory.",IS_MISSING:"is missing.",NOT_WELL_FORMED:"is not found or not well formed)",MISSING_CHARTTYPE:"Missing ChartType in ",CHART_ANNO:"Chart Annotation.",DATA_ANNO:"Data Annotation",CARD_ANNO:"card annotation.",CARD_CONFIG:"card configuration.",CARD_CONFIG_ERROR:"Could not obtain configuration for ",CARD_CONTAINER_ERROR:"Could not obtain card container. ",DATA_UNAVAIALABLE:"No data available.",CONFIG_LOAD_ERROR:"Failed to load config.json. Reason: ",INVALID_CHARTTYPE:"Invalid ChartType given for ",INVALID_CONFIG:"No valid configuration given for ",CONFIG_JSON:"in config.json",ENTER_INTEGER:"Please enter an Integer.",NO_CARD_MODEL:"Could not obtain Cards model.",ANNO_REF:"com.sap.vocabularies.UI.v1 annotation.",INVALID_REDUNDANT:"Invalid/redundant role configured for ",CHART_IS:"chart is/are ",CARD_CONFIG_JSON:"card from config.json",ALLOWED_ROLES:"Allowed role(s) for ",DIMENSIONS_MANDATORY:"DimensionAttributes are mandatory.",MEASURES_MANDATORY:"MeasureAttributes are mandatory.",CARD_LEAST:"card: Enter at least ",CARD_MOST:"card: Enter at most ",FEEDS:"feed(s).",MIN_FEEDS:"Minimum number of feeds required for ",FEEDS_OBTAINED:"card is not configured. Obtained ",FEEDS_REQUIRED:"feed(s), Required: ",INVALID_SEMANTIC_MEASURES:"More than one measure is being semantically coloured",INVALID_IMPROVEMENT_DIR:"No Improvement Direction Found",INVALID_CRITICALITY:"Invalid criticality values",INVALID_DIMMEAS:"Invalid number of Measures or Dimensions",INVALID_FORECAST:"Invalid/Redundant Datapoint or Forecast measure",INVALID_TARGET:"Invalid/Redundant Datapoint or Target measure",ERROR_MISSING_AXISSCALES:"Minimum and Maximum values are mandatory for AxisScale MinMax to work"};var G;function n(f,j,v,x,r1,s1,t1){var u1="{";if(!f||!f.getSetting('ovpCardProperties')){q.sap.log.error(l.ANALYTICAL_CONFIG_ERROR);u1+="}";return u1;}var v1=f.getSetting("dataModel");var w1;if(t1&&t1.EnumMember){w1=t1.EnumMember.split("/");if(w1&&(w1[1]==='Donut')){v1.setDefaultCountMode(C.Inline);}if(w1&&(w1[1]!='Donut')&&(r1===undefined)){return null;}}var x1=[];var y1=[];var z1=[];var A1=[];var B1=[];var C1=[];var D1=v&&v.Parameters;var E1=x&&x.SortOrder;var F1=x&&x.MaxItems,G1=null;var H1;var I1;var J1;var K1=null;var L1=h.TEXT_KEY;var M1=h.TEXT_KEY_V4;var N1=h.UNIT_KEY;var O1=h.UNIT_KEY_V4_ISOCurrency;var P1=h.UNIT_KEY_V4_Unit;var Q1={};if(F1){G1=F1.Int32?F1.Int32:F1.Int;}if(G1){if(G1==="0"){q.sap.log.error("OVP-AC: Analytic card Error: maxItems is configured as "+G1);u1+="}";return u1;}if(!/^\d+$/.test(G1)){q.sap.log.error("OVP-AC: Analytic card Error: maxItems is Invalid. "+"Please enter an Integer.");u1+="}";return u1;}}var R1=f.getSetting('ovpCardProperties'),S1=R1.getProperty('/parameters');var T1=R1.getProperty("/metaModel");D1=D1||!!S1;if(D1){var U1=a.resolveParameterizedEntitySet(v1,j,v,S1);u1+="path: '"+U1+"'";}else{u1+="path: '/"+j.name+"'";}var V1=[];K1=f.getSetting('ovpCardProperties').getProperty("/entitySet");if(!v1||!K1){return u1;}var W1=f1(v1,K1);var X1=f.getSetting('ovpCardProperties').getProperty("/cardLayout");var Y1=1,Z1;var $1=J();var _1;var a2;if(r1&&X1&&X1.colSpan&&X1.colSpan>1){Z1=X1.colSpan-Y1;for(var b2 in $1){if((a2=$1[b2].reference)&&$1[a2]){var c2=q.extend(true,{},$1[a2]);$1[b2]=c2;}if(b2===w1[1]||($1[b2].time&&$1[b2].time.type===w1[1].toLowerCase())){_1=$1[b2];break;}}var d2=K(r1,_1,v1,K1);if(d2){_1=_1.time;}else{_1=_1.default;}var e2=f.getSetting('ovpCardProperties').getProperty("/dataStep");if(!e2){if(_1.resize&&_1.resize.hasOwnProperty("dataStep")&&!isNaN(_1.resize.dataStep)){e2=_1.resize.dataStep;}}e2=parseInt(e2,10);if(Z1>0&&e2&&!isNaN(e2)){G1=parseInt(G1,10)+e2*Z1;}}if(v){var R1=f.getSetting('ovpCardProperties');V1=a.getFilters(R1,v);}if(V1.length>0){u1+=", filters: "+JSON.stringify(V1);}if(E1){var f2=x.SortOrder;if(!f2.length){f2=U.getSortAnnotationCollection(v1,x,j);}if(f2.length<1){q.sap.log.warning(l.CARD_WARNING+l.SORTORDER_WARNING);}else{var g2="";var h2;var i2;var j2;for(var i=0;i<f2.length;i++){h2=f2[i];j2=h2.Property.PropertyPath;C1.push(j2);if(typeof h2.Descending==="undefined"){i2='true';}else{var Y=h2.Descending.Bool||h2.Descending.Boolean;if(!Y){q.sap.log.warning(l.CARD_WARNING+l.BOOLEAN_ERROR);i2='true';}else{i2=Y.toLowerCase()==='true'?'true':'false';}}g2=g2+"{path: '"+j2+"',descending: "+i2+"},";}u1+=", sorter: ["+g2.substring(0,g2.length-1)+"]";}}var k2=f.getSetting("ovpCardProperties").getProperty("/entityType");q.each(s1,function(i,m){H1=m.Measure.PropertyPath;if(m.DataPoint&&m.DataPoint.AnnotationPath){var d=k2[m.DataPoint.AnnotationPath.substring(1)];if(d.ForecastValue&&(d.ForecastValue.PropertyPath||d.ForecastValue.Path)){var s=(d.ForecastValue.PropertyPath||d.ForecastValue.Path);B1.push((d.ForecastValue.PropertyPath||d.ForecastValue.Path));if(W1&&W1[s]){var m2;if(W1[s][O1]){m2=W1[s][O1].Path?W1[s][O1].Path:undefined;}else if(W1[s][P1]){m2=W1[s][P1].Path?W1[s][P1].Path:undefined;}else if(W1[s][N1]){m2=W1[s][N1];}if(m2){if(q.inArray(m2,B1)===-1){B1.push(m2);}}}}if(d.TargetValue&&(d.TargetValue.PropertyPath||d.TargetValue.Path)){var n2=(d.TargetValue.PropertyPath||d.TargetValue.Path);B1.push((d.TargetValue.PropertyPath||d.TargetValue.Path));if(W1&&W1[n2]){var m2;if(W1[n2][O1]){m2=W1[n2][O1].Path?W1[n2][O1].Path:undefined;}else if(W1[n2][P1]){m2=W1[n2][P1].Path?W1[n2][P1].Path:undefined;}else if(W1[n2][N1]){m2=W1[n2][N1];}if(m2){if(q.inArray(m2,B1)===-1){B1.push(m2);}}}}}B1.push(H1);if(W1&&W1[H1]){if(W1[H1][M1]){if(W1[H1][M1].String&&H1!=W1[H1][M1].String){B1.push(W1[H1][M1].String?W1[H1][M1].String:H1);}else if(W1[H1][M1].Path&&H1!=W1[H1][M1].Path){B1.push(W1[H1][M1].Path?W1[H1][M1].Path:H1);}}else if(W1[H1][L1]&&H1!=W1[H1][L1]){B1.push(W1[H1][L1]?W1[H1][L1]:H1);}}if(W1&&W1[H1]){var m2;if(W1[H1][O1]){m2=W1[H1][O1].Path?W1[H1][O1].Path:undefined;}else if(W1[H1][P1]){m2=W1[H1][P1].Path?W1[H1][P1].Path:undefined;}else if(W1[H1][N1]){m2=W1[H1][N1];}if(m2){if(q.inArray(m2,B1)===-1){B1.push(m2);}}}});q.each(r1,function(i,d){H1=d.Dimension.PropertyPath;x1.push(H1);if(W1&&W1[H1]){if(W1[H1][M1]){if(W1[H1][M1].String&&H1!=W1[H1][M1].String){x1.push(W1[H1][M1].String?W1[H1][M1].String:H1);}else if(W1[H1][M1].Path&&H1!=W1[H1][M1].Path){J1=W1[H1][M1].Path;var m=J1.split("/");if(m.length>1){I1=o(T1,k2,J1);if(I1!==""){x1.push(J1);y1.push(I1);A1=p(T1,k2,J1);if(A1.length>0){z1=z1.concat(A1);}}}else{x1.push(J1?J1:H1);}}}else if(W1[H1][L1]&&H1!=W1[H1][L1]){x1.push(W1[H1][L1]?W1[H1][L1]:H1);}}});if(z1.length>0){var k=0;while(k<z1.length){if(x1.indexOf(z1[k])!==-1){z1.splice(k,1);}else{k++;}}}if(B1.length>0){q.each(B1,function(i,m){Q1[m]=true;});}if(x1.length>0){q.each(x1,function(i,d){Q1[d]=true;});}u1+=", parameters: {select:'"+[].concat(x1,B1).join(",");if(C1.length>0){var l2=[];q.each(C1,function(i,s){if(!Q1.hasOwnProperty(s)){l2.push(s);}});if(l2.length>0){u1+=","+l2.join(",");}}if(y1.length>0){u1+="'"+","+" expand:'"+y1.join(',');}u1+="'}";if(w1&&(w1[1]==='Donut')&&(r1===undefined)){u1+=", length: 1";}else if(w1&&(w1[1]==='Donut')&&(r1)&&G1){u1+=", length: "+(parseInt(G1,10)+1);}else if(G1){u1+=", length: "+G1;}u1+="}";return u1;}n.requiresIContext=true;function o(m,d,s){var f="";var j=s.split("/");if(j.length>1){for(var i=0;i<(j.length-1);i++){var k=m.getODataAssociationEnd(d,j[i]);if(k){d=m.getODataEntityType(k.type);if(f){f=f+"/";}f=f+j[i];}else{return f;}}}return f;}function p(m,d,s){var f=[];var k=[];var v;var x=s.split("/");if(x.length>1){for(var i=0;i<(x.length-1);i++){var r1=m.getODataAssociationEnd(d,x[i]);if(r1){d=m.getODataEntityType(r1.type);if(d){k=d&&d.key&&d.key.propertyRef;for(var j=0;j<k.length;j++){v=x[i]+"/"+k[j].name;f.push(v);}}}}}return f;}function r(m,d){var f=false;var i;if(m.DataPoint&&m.DataPoint.AnnotationPath){var j=d[m.DataPoint.AnnotationPath.substring(1)];if(j&&j.ForecastValue&&(j.ForecastValue.PropertyPath||j.ForecastValue.Path)){f=true;i=m;}}if(f===true){return i;}else{q.sap.log.warning(l.CARD_WARNING+l.INVALID_FORECAST);return undefined;}}function t(m,d){var f=false;var i;if(m.DataPoint&&m.DataPoint.AnnotationPath){var j=d[m.DataPoint.AnnotationPath.substring(1)];if(j&&j.TargetValue&&(j.TargetValue.PropertyPath||j.TargetValue.Path)){f=true;i=m;}}if(f===true){return i;}else{q.sap.log.warning(l.CARD_WARNING+l.INVALID_TARGET);return undefined;}}function u(m,d){var f;q.each(d,function(i,v){if(v.name===m){if(v["com.sap.vocabularies.Common.v1.Label"]){f=v["com.sap.vocabularies.Common.v1.Label"].String?v["com.sap.vocabularies.Common.v1.Label"].String:v["com.sap.vocabularies.Common.v1.Label"].Path;}else if(v["sap:label"]){f=v["sap:label"];}return false;}});return f;}function w(f,d){var j=true;if(d==="line"||d==="column"){q.each(f,function(i,v){if((v.getUid()==='valueAxis')||(v.getUid()==='categoryAxis')){if(v.getValues().length!=1){j=false;q.sap.log.warning(l.CARD_WARNING+l.INVALID_DIMMEAS);return false;}}});}else if(d==="vertical_bullet"){q.each(f,function(i,v){if((v.getUid()==='actualValues')||(v.getUid()==='categoryAxis')){if(v.getValues().length!=1){j=false;q.sap.log.warning(l.CARD_WARNING+l.INVALID_DIMMEAS);return false;}}});}if(j===true){return true;}}function y(m,s,v){var d=h.TYPE_KEY;if(!m||!m[s]||!m[s][d]){return v;}var f=["Edm.Int","Edmt.Int16","Edm.Int32","Edm.Int64","Edm.Decimal"];var i=m[s][d];if(q.inArray(i,f)!==-1){return Number(v);}return v;}function z(d){if(d){return d;}return"";}function A(){var d={locale:function(){},format:function(v,f){var i="";if(f){i=f.split('/');}if(i.length>0){var m,s;if(i.length===3){m=Number(i[1]);s=Number(i[2]);if(isNaN(m)){m=-1;}if(isNaN(s)){s=0;}}else{m=2;s=0;}if(i[0]==="axisFormatter"||(i[0]==="ShortFloat")){var j;j=N.getFloatInstance({style:'short',minFractionDigits:m,maxFractionDigits:m});if(i[0]==="ShortFloat"){j=N.getFloatInstance({style:'short',minFractionDigits:m,maxFractionDigits:m});}if(m===-1){j=N.getFloatInstance({style:'short'});}return j.format(Number(v));}else if(i[0]==="tooltipNoScaleFormatter"){var k=N.getFloatInstance({style:'short',currencyCode:false,shortRefNumber:s,showScale:false,minFractionDigits:m,maxFractionDigits:m});if(m===-1){k=N.getFloatInstance({minFractionDigits:0,currencyCode:false});}return k.format(Number(v));}else if(i[0]==="CURR"){var x=N.getCurrencyInstance({style:'short',currencyCode:false,minFractionDigits:m,maxFractionDigits:m});if(m===-1){x=N.getCurrencyInstance({style:'short',currencyCode:false});}return x.format(Number(v));}else if(i[0].search("%")!==-1){var r1=N.getPercentInstance({style:'short',minFractionDigits:m,maxFractionDigits:m});if(m===-1){r1=N.getPercentInstance({style:'short',minFractionDigits:1,maxFractionDigits:1});}v=r1.format(Number(v));return v;}}if(v.constructor===Date){var s1=D.getDateTimeInstance({pattern:f});if(f==="YearMonthDay"){s1=D.getDateInstance({style:"medium"});}v=s1.format(new Date(v));}return v;}};V.numericFormatter(d);}function B(v,f){var d=v.getModel();var k=v.getVizType();if(k!="line"&&k!="bubble"){return;}if(!f){f=k==="line"?"categoryAxis":"valueAxis";}var m=v.getModel('ovpCardProperties').getProperty("/entitySet");if(!d||!m){return;}var s=f1(d,m);var x=v.getFeeds();for(var i=0;i<x.length;i++){if(x[i].getUid()===f){var r1=x[i].getValues();if(!r1){return;}for(var j=0;j<r1.length;j++){if(s[r1[j][h.TYPE_KEY]]!="Edm.DateTime"){return;}}v.setVizProperties({categoryAxis:{title:{visible:false}}});return;}}}function E(d,f,i,m,j,k){m=typeof m==="undefined"?false:m;var s=false;var v;if(!d&&m){q.sap.log.error(j+l.CARD_ERROR+i+l.IS_MANDATORY);return s;}if(!d){q.sap.log.warning(j+l.CARD_WARNING+i+l.IS_MISSING);s=true;return s;}v=f[d];if(!v||typeof v!=="object"){var x=m?q.sap.log.error:q.sap.log.warning;x(j+l.CARD_ERROR+"in "+i+". ("+d+" "+l.NOT_WELL_FORMED);return s;}if(k&&k==="sap.ovp.cards.charts.analytical.analyticalChart"&&i==="Chart Annotation"&&(!v.ChartType||!v.ChartType.EnumMember)){q.sap.log.error(j+l.CARD_ERROR+l.MISSING_CHARTTYPE+l.CHART_ANNO);return s;}s=true;return s;}function H(d){var f=false;if(!d){return f;}var s;var i;var j;var k;var m;var v;var x;var r1="";var s1;var t1=d.getView();if(t1){r1="["+t1.getId()+"] ";}if(!(s1=d.getCardPropertiesModel())){q.sap.log.error(r1+l.CARD_ERROR+"in "+l.CARD_CONFIG+l.NO_CARD_MODEL);return f;}x=s1.getProperty("/entityType");if(!x||q.isEmptyObject(x)){q.sap.log.error(r1+l.CARD_ERROR+"in "+l.CARD_ANNO);return f;}s=s1.getProperty("/selectionAnnotationPath");i=s1.getProperty("/chartAnnotationPath");k=s1.getProperty("/presentationAnnotationPath");m=s1.getProperty("/identificationAnnotationPath");v=s1.getProperty("/dataPointAnnotationPath");j=s1.getProperty("/contentFragment");f=E(s,x,"Selection Variant",false,r1);f=E(i,x,"Chart Annotation",true,r1,j)&&f;f=E(k,x,"Presentation Variant",false,r1)&&f;f=E(m,x,"Identification Annotation",true,r1)&&f;f=E(v,x,"Data Point",false,r1)&&f;return f;}function I(d,f,v){}function J(d){return U.getConfig(d);}function K(d,f,i,j){var k=false;var m;var s;var v;var x;var r1;var s1;if(!f.time||q.isEmptyObject(f.time)){return k;}if(!d){return k;}for(var t1=0;t1<d.length;t1++){if(!d[t1].Dimension||!(s=d[t1].Dimension.PropertyPath)){return k;}m=f1(i,j);if(m&&m[s]){v=m[s][h.TYPE_KEY];x=m[s][h.DISPLAY_FORMAT_KEY];r1=m[s][h.SEMANTICS_KEY];s1=m[s]["com.sap.vocabularies.Common.v1.IsCalendarYear"];}if(v&&v.lastIndexOf("Edm.Date",0)===0){if(v.toLowerCase()==="edm.datetime"){if(x&&x.toLowerCase()==="date"){k=true;}}else{k=true;}}if(v==="Edm.String"&&(s1||r1&&r1.lastIndexOf("year",0)===0)){k=true;}if(k){d.unshift(d.splice(t1,1)[0]);break;}}return k;}function L(i,d,f){var j="";var k=J(d);var m,s;if(!k){return j;}j=k.default.type;m=i.getSetting("dataModel");s=i.getSetting('ovpCardProperties').getProperty("/entitySet");if(K(f,k,m,s)){j=k.time.type;}return j;}L.requiresIContext=true;function P(d,j,k){if(!d.length){return;}var m=k==="dimension"?"Dimension":"Measure";var s=[];q.each(d,function(i,f){if(!f||!f[m]||!f[m].PropertyPath){q.sap.log.error(l.INVALID_CHART_ANNO);return false;}s.push(f[m].PropertyPath);});var v=q.map(j.feeds,function(f){if(f.type===k){if(f.role){return f.role.split("|");}return[];}});v=q.grep(v,function(f,i){return q.inArray(f,v)===i;}).join(", ");q.sap.log.error(l.CARD_ERROR+l.INVALID_REDUNDANT+k+"(s) "+s.join(", ")+". "+l.ALLOWED_ROLES+j.type+l.CHART_IS+v);}function Q(v,i){var d;if(v){if(v.String){d=v.String;}else if(v.Boolean||v.Bool){d=R(v);}else{d=S(v,i);}}return d;}function R(v,d){if(v&&v.Boolean){if(v.Boolean.toLowerCase()==="true"){return true;}else if(v.Boolean.toLowerCase()==="false"){return false;}}else if(v&&v.Bool){if(v.Bool.toLowerCase()==="true"){return true;}else if(v.Bool.toLowerCase()==="false"){return false;}}return d;}function S(v,i){var d;if(v){if(v.String){d=Number(v.String);}else if(v.Int){d=Number(v.Int);}else if(v.Decimal){d=Number(v.Decimal);}else if(v.Double){d=Number(v.Double);}else if(v.Single){d=Number(v.Single);}}if(i){var f=N.getFloatInstance({style:'short',minFractionDigits:2,maxFractionDigits:2});if(d){d=f.format(Number(d));}}return d;}function T(i,d){function X(s1){if(s1){if(s1.Path){return"{path:'"+s1.Path+"'}";}else{return Q(s1);}}else{return"";}}var v=i[i.measureNames];if(d&&d.CriticalityCalculation&&d.CriticalityCalculation.ImprovementDirection){var s=d.CriticalityCalculation.ImprovementDirection.EnumMember;var f=X(d.CriticalityCalculation.DeviationRangeLowValue);var j=X(d.CriticalityCalculation.DeviationRangeHighValue);var k=X(d.CriticalityCalculation.ToleranceRangeLowValue);var m=X(d.CriticalityCalculation.ToleranceRangeHighValue);return a._calculateCriticalityState(v,s,f,j,k,m,a.criticalityConstants.StateValues);}else{var x=d.Criticality.EnumMember;var r1=x?x.split("/"):[];if(r1){return r1[1];}}}function W(d,m,f){var j,k;q.each(m,function(i,v){if(v["com.sap.vocabularies.Common.v1.Label"]&&v["com.sap.vocabularies.Common.v1.Label"].String===d.measureNames){j=v.name;return false;}else if(v["com.sap.vocabularies.Common.v1.Label"]&&v["com.sap.vocabularies.Common.v1.Label"].Path===d.measureNames){j=v.name;return false;}else if(v["sap:label"]===d.measureNames){j=v.name;return false;}});q.each(f,function(i,v){if(v.Measure.PropertyPath===j){if(!v.DataPoint||!v.DataPoint.AnnotationPath){return false;}k=v.DataPoint.AnnotationPath;return false;}});return k;}function X(i,d){if(i){if(i.Path){return i.Path;}else{return Q(i,d);}}else{return"";}}function Y(m,d){function f(s,i){return s&&s.indexOf(i,s.length-i.length)!==-1;}var j=false;q.each(m,function(i,v){if(v.DataPoint&&v.DataPoint.AnnotationPath){var k=d[v.DataPoint.AnnotationPath.substring(1)];if(k&&k.CriticalityCalculation&&k.CriticalityCalculation.ImprovementDirection&&k.CriticalityCalculation.ImprovementDirection.EnumMember){var s=k.CriticalityCalculation.ImprovementDirection.EnumMember;var x=X(k.CriticalityCalculation.DeviationRangeLowValue);var r1=X(k.CriticalityCalculation.DeviationRangeHighValue);var s1=X(k.CriticalityCalculation.ToleranceRangeLowValue);var t1=X(k.CriticalityCalculation.ToleranceRangeHighValue);if(f(s,"Minimize")||f(s,"Minimizing")){if(t1&&r1){j=true;return false;}else{q.sap.log.warning(l.CARD_WARNING+l.INVALID_CRITICALITY);}}else if(f(s,"Maximize")||f(s,"Maximizing")){if(s1&&x){j=true;return false;}else{q.sap.log.warning(l.CARD_WARNING+l.INVALID_CRITICALITY);}}else if(f(s,"Target")){if(s1&&x&&t1&&r1){j=true;return false;}else{q.sap.log.warning(l.CARD_WARNING+l.INVALID_CRITICALITY);}}}else if(k&&k.Criticality){j=true;return false;}else{q.sap.log.warning(l.CARD_WARNING+l.INVALID_IMPROVEMENT_DIR);}}});if(j===true&&m.length>1){q.sap.log.warning(l.CARD_WARNING+l.INVALID_SEMANTIC_MEASURES);}return j;}function Z(m,d,f){function i(w1,x1){return w1&&w1.indexOf(x1,w1.length-x1.length)!==-1;}var j=[null,null];var k=true;var s=m.Measure.PropertyPath;if(f[s]){if(f[s][h.LABEL_KEY_V4]){s=f[s][h.LABEL_KEY_V4].String?f[s][h.LABEL_KEY_V4].String:f[s][h.LABEL_KEY_V4].Path;}else if(f[s][h.LABEL_KEY]){s=f[s][h.LABEL_KEY];}else if(s){s=s;}}var v=m.DataPoint.AnnotationPath;var x=d[v.substring(1)];if(!x.CriticalityCalculation||!x.CriticalityCalculation.ImprovementDirection||!x.CriticalityCalculation.ImprovementDirection.EnumMember){return j;}var r1=x.CriticalityCalculation.ImprovementDirection.EnumMember;var s1=X(x.CriticalityCalculation.DeviationRangeLowValue,k);var t1=X(x.CriticalityCalculation.DeviationRangeHighValue,k);var u1=X(x.CriticalityCalculation.ToleranceRangeLowValue,k);var v1=X(x.CriticalityCalculation.ToleranceRangeHighValue,k);if(i(r1,"Minimize")||i(r1,"Minimizing")){if(v1&&t1){j[0]=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("MINIMIZING_LESS",[s,v1]);j[1]=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("MINIMIZING_MORE",[s,t1]);j[2]=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("MINIMIZING_CRITICAL",[v1,s,t1]);}}else if(i(r1,"Maximize")||i(r1,"Maximizing")){if(u1&&s1){j[0]=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("MAXIMISING_MORE",[s,u1]);j[1]=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("MAXIMISING_LESS",[s,s1]);j[2]=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("MAXIMIZING_CRITICAL",[s1,s,u1]);}}else if(i(r1,"Target")){if(u1&&s1&&v1&&t1){j[0]=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("TARGET_BETWEEN",[u1,s,v1]);j[1]=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("TARGET_AROUND",[s,s1,t1]);j[2]=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("TARGET_CRITICAL",[s1,s,u1,v1,t1]);}}return j;}function $(m,v,d){if(v&&v.DataPoint&&v.DataPoint.AnnotationPath){var f=d[v.DataPoint.AnnotationPath.substring(1)];var i,j;if(f&&f.ValueFormat){i=f.ValueFormat;}else if(f&&f.NumberFormat){i=f.NumberFormat;}if(i&&i.NumberOfFractionalDigits&&i.NumberOfFractionalDigits.Int){j=i.NumberOfFractionalDigits.Int;if(m<Number(j)){m=Number(j);}}}return m;}function _(m,v,d){if(v&&v.DataPoint&&v.DataPoint.AnnotationPath){var f=d[v.DataPoint.AnnotationPath.substring(1)];var s,i;if(f&&f.ValueFormat){s=f.ValueFormat;}else if(f&&f.NumberFormat){s=f.NumberFormat;}if(s){if(s.ScaleFactor&&s.ScaleFactor.Decimal){i=Number(s.ScaleFactor.Decimal);}else if(s.ScaleFactor&&s.ScaleFactor.Int){i=Number(s.ScaleFactor.Int);}if(!isNaN(i)){if(m===undefined){m=Number(i);}else if(m>Number(i)){m=Number(i);}}}}return m;}function a1(m,s){if(m&&m[s]&&(m[s]["Org.OData.Measures.V1.ISOCurrency"]||(m[s][h.SEMANTICS_KEY]&&m[s][h.SEMANTICS_KEY]===h.CURRENCY_CODE))){return true;}return false;}function b1(v,d){if(v.DataPoint&&v.DataPoint.AnnotationPath){var f=d[v.DataPoint.AnnotationPath.substring(1)];if(f&&f.ValueFormat&&f.ValueFormat.NumberOfFractionalDigits&&f.ValueFormat.NumberOfFractionalDigits.Int){return true;}else if(f&&f.NumberFormat&&f.NumberFormat.NumberOfFractionalDigits&&f.NumberFormat.NumberOfFractionalDigits.Int){return true;}}return false;}function c1(m,v,f){if(m[v[f].PropertyPath][h.EDM_TYPE]===h.EDM_INT32){return true;}return false;}function d1(d,f,m,s){var x,r1,s1,t1;var u1,v1,w1,x1,y1;var z1;var A1,B1,C1;var D1,E1=[],F1=[];var G1;var H1;var I1=s&&s.getView();var J1,K1;u1=d.getVizType();v1=J();for(var L1 in v1){if((H1=v1[L1].reference)&&v1[H1]){var M1=q.extend(true,{},v1[H1]);v1[L1]=M1;}if(v1[L1].default.type===u1||(v1[L1].time&&v1[L1].time.type===u1)){w1=v1[L1];break;}}if(!w1){q.sap.log.error(l.CARD_ERROR+"in "+l.CARD_CONFIG+l.CARD_CONFIG_ERROR+u1+" "+l.CARD_CONFIG_JSON);return;}if(!(x=d.getModel('ovpCardProperties'))){q.sap.log.error(l.CARD_ERROR+"in "+l.CARD_CONFIG+l.NO_CARD_MODEL);return;}var N1=d.getModel();var O1=x.getProperty("/entitySet");if(!N1||!O1){return;}r1=x.getProperty("/entityType");if(!r1){q.sap.log.error(l.CARD_ANNO_ERROR+"in "+l.CARD_ANNO);return;}var P1=f1(N1,O1);s1=x.getProperty("/chartAnnotationPath");if(!s1||!(t1=r1[s1])){q.sap.log.error(l.CARD_ANNO_ERROR+"in "+l.CARD_ANNO);return;}if(!(x1=t1.DimensionAttributes)||!x1.length){q.sap.log.error(l.CHART_ANNO_ERROR+"in "+l.CHART_ANNO+" "+l.DIMENSIONS_MANDATORY);return;}var Q1;if(!(y1=t1.MeasureAttributes)||!y1.length){q.sap.log.error(l.CHART_ANNO_ERROR+"in "+l.CHART_ANNO+" "+l.MEASURES_MANDATORY);return;}else{var R1=y1[0].DataPoint?r1[y1[0].DataPoint.AnnotationPath.substring(1)]:null;var S1=R1&&R1.NumberFormat&&R1.NumberFormat.NumberOfFractionalDigits&&R1.NumberFormat.NumberOfFractionalDigits.Int;Q1=S1?S1:0;}G1=K(x1,w1,N1,O1);if(G1){w1=w1.time;}else{w1=w1.default;}var T1=x.getProperty("/ChartProperties")||x.getProperty("/chartProperties");if(x&&x.getProperty("/tabs")&&(T1===undefined)){J1=I1.byId("ovp_card_dropdown");K1=parseInt(J1.getSelectedKey(),10);T1=x.getProperty("/tabs")&&x.getProperty("/tabs")[K1-1]&&(x.getProperty("/tabs")[K1-1]["ChartProperties"]||x.getProperty("/tabs")[K1-1]["chartProperties"]);}var U1=false;var V1=Q1>0?"tooltipNoScaleFormatter/"+Q1.toString()+"/":'tooltipNoScaleFormatter/-1/';var W1=new b({formatString:V1});W1.connect(d.getVizUid());W1.connect(d.getVizUid());d._oOvpVizFrameTooltip=W1;[w1.dimensions,w1.measures].forEach(function(j,i){var k=i?y1:x1;var v=i?"measure(s)":"dimension(s)";if(j.min&&k.length<j.min){q.sap.log.error(l.CARD_ERROR+"in "+u1+" "+l.CARD_LEAST+j.min+" "+v);U1=true;}if(j.max&&k.length>j.max){q.sap.log.error(l.CARD_ERROR+"in "+u1+l.CARD_MOST+j.max+" "+v);U1=true;}});if(U1){return;}var X1=true;if(w1.properties&&w1.properties.hasOwnProperty("hideLabel")&&!w1.properties["hideLabel"]){X1=false;}var Y1=true;var Z1=false;if(u1==='donut'){Z1=true;}d.removeAllAggregation();z1={legend:{isScrollable:false},title:{visible:false},interaction:{noninteractiveMode:Y1?false:true,selectability:{legendSelection:false,axisLabelSelection:false,mode:'EXCLUSIVE',plotLassoSelection:false,plotStdSelection:true},zoom:{enablement:'disabled'}},plotArea:{window:{start:'firstDataPoint',end:'lastDataPoint'},dataLabel:{visible:Z1?true:false,type:'value'},dataPoint:{invalidity:'ignore'}},categoryAxis:{label:{truncatedLabelRatio:0.15}},general:{groupData:false,showAsUTC:true}};if(w1.properties&&w1.properties.semanticColor===true&&Y(y1,r1)){var $1=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("GOOD");var _1=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("BAD");var a2=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("CRITICAL");var b2=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("OTHERS");if(y1.length===1){var c2=Z(y1[0],r1,P1);var $1=c2[0]||$1,_1=c2[1]||_1,a2=c2[2]||a2,b2=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("OTHERS");}z1.plotArea.dataPointStyle={rules:[{callback:function(i){var j=W(i,P1,y1);if(!j){return false;}var k=r1[j.substring(1)];var v=T(i,k);if(v===a.criticalityConstants.StateValues.Positive){return true;}else if(v==="Positive"){return true;}},properties:{color:"sapUiChartPaletteSemanticGoodLight1"},"displayName":$1},{callback:function(i){var j=W(i,P1,y1);if(!j){return false;}var k=r1[j.substring(1)];var v=T(i,k);if(v===a.criticalityConstants.StateValues.Critical){return true;}else if(v==="Critical"){return true;}},properties:{color:"sapUiChartPaletteSemanticCriticalLight1"},"displayName":a2},{callback:function(i){var j=W(i,P1,y1);if(!j){return false;}var k=r1[j.substring(1)];var v=T(i,k);if(v===a.criticalityConstants.StateValues.Negative){return true;}else if(v==="Negative"){return true;}},properties:{color:"sapUiChartPaletteSemanticBadLight1"},"displayName":_1},{callback:function(i){var j=W(i,P1,y1);if(!j){return false;}var k=r1[j.substring(1)];var v=T(i,k);if(v===a.criticalityConstants.StateValues.None){return true;}else if(v==="Neutral"){return true;}},properties:{color:"sapUiChartPaletteSemanticNeutralLight1"},"displayName":b2}]};}var d2=x.getProperty("/colorPalette");var e2;if((t1.ChartType.EnumMember===h.COLUMNSTACKED_CHARTTYPE||t1.ChartType.EnumMember===h.DONUT_CHARTTYPE)&&d2&&d2.length===4){q.each(x1,function(i,j){if(j&&j.Role&&j.Role.EnumMember==="com.sap.vocabularies.UI.v1.ChartDimensionRoleType/Series"){e2=j.Dimension&&j.Dimension.PropertyPath;return;}});var f2;if(e2){if(P1&&P1[e2]){if(P1[e2][h.LABEL_KEY_V4]){f2=P1[e2][h.LABEL_KEY_V4].String?P1[e2][h.LABEL_KEY_V4].String:P1[e2][h.LABEL_KEY_V4].Path;}else if(P1[e2][h.LABEL_KEY]){f2=P1[e2][h.LABEL_KEY];}else if(e2){f2=e2;}}var g2=d2.map(function(v){return v.color;});var h2=d2.map(function(v){return v.legendText;});var i2=sap.ui.getCore().getLibraryResourceBundle("sap.ovp");var j2=h2[0]!=undefined?h2[0]:i2.getText("OTHERS");var k2=h2[1]!=undefined?h2[1]:i2.getText("BAD");var l2=h2[2]!=undefined?h2[2]:i2.getText("CRITICAL");var m2=h2[3]!=undefined?h2[3]:i2.getText("GOOD");z1.plotArea.dataPointStyle={rules:[{callback:function(i){if(i&&(i[f2]==="3"||i[f2]===3)){return true;}},properties:{color:g2[3]},"displayName":m2},{callback:function(i){if(i&&(i[f2]==="2"||i[f2]===2)){return true;}},properties:{color:g2[2]},"displayName":l2},{callback:function(i){if(i&&(i[f2]==="1"||i[f2]===1)){return true;}},properties:{color:g2[1]},"displayName":k2},{callback:function(i){if(i&&(i[f2]==="0"||i[f2]===0)){return true;}},properties:{color:g2[0]},"displayName":j2}]};}}var n2=false;if(t1.ChartType.EnumMember===h.SCATTER_CHARTTYPE||t1.ChartType.EnumMember===h.BUBBLE_CHARTTYPE||t1.ChartType.EnumMember===h.LINE_CHARTTYPE){if(t1&&t1.AxisScaling&&t1.AxisScaling.EnumMember){var o2=t1.AxisScaling.EnumMember.substring(t1.AxisScaling.EnumMember.lastIndexOf('/')+1,t1.AxisScaling.EnumMember.length);switch(o2){case"AdjustToDataIncluding0":z1.plotArea.adjustScale=false;n2=true;break;case"AdjustToData":z1.plotArea.adjustScale=true;n2=true;break;case"MinMaxValues":var p2=[];if(t1["MeasureAttributes"][0]&&t1["MeasureAttributes"][0].DataPoint&&t1["MeasureAttributes"][0].DataPoint.AnnotationPath){var q2=t1["MeasureAttributes"][0].DataPoint.AnnotationPath;var r2=q2.substring(q2.lastIndexOf('@')+1,q2.length);if(r1&&r1[r2]){var s2=r1[r2];if(s2&&s2.MaximumValue&&s2.MaximumValue.Decimal&&s2.MinimumValue&&s2.MinimumValue.Decimal){p2.push({feed:"valueAxis",max:s2.MaximumValue.Decimal,min:s2.MinimumValue.Decimal});n2=true;}else{q.sap.log.error(l.ERROR_MISSING_AXISSCALES);}}}if(t1.ChartType.EnumMember!==h.LINE_CHARTTYPE&&t1["MeasureAttributes"][1]&&t1["MeasureAttributes"][1].DataPoint&&t1["MeasureAttributes"][1].DataPoint.AnnotationPath){var q2=t1["MeasureAttributes"][1].DataPoint.AnnotationPath;var r2=q2.substring(q2.lastIndexOf('@')+1,q2.length);if(r1&&r1[r2]){var s2=r1[r2];if(s2&&s2.MaximumValue&&s2.MaximumValue.Decimal&&s2.MinimumValue&&s2.MinimumValue.Decimal){p2.push({feed:"valueAxis2",max:s2.MaximumValue.Decimal,min:s2.MinimumValue.Decimal});n2=true;}else{q.sap.log.error(l.ERROR_MISSING_AXISSCALES);}}}d.setVizScales(p2);break;default:break;}}}B1=x1.slice();C1=y1.slice();var t2=0;var u2=0;var v2;var w2;var x2=false;var y2=false;var z2=false;var A2=false;var B2;var C2=[];var D2=[],E2=[];q.each(w1.feeds,function(i,v){var K2=v.uid;var L2=[];if(v.type){var M2,N2,O2;if(v.type==="dimension"){M2=x1.length;N2="Dimension";O2="dimensions";A1=B1;D1=E1;}else{M2=y1.length;N2="Measure";O2="measures";A1=C1;D1=F1;}var P2=0,Q2=M2;if(v.min){P2=P2>v.min?P2:v.min;}if(v.max){Q2=Q2<v.max?Q2:v.max;}if(!v.role){var R2=A1.length;for(var j=0;j<R2&&L2.length<Q2;++j){var S2=A1[j];A1.splice(j,1);--R2;--j;L2.push(S2);if(P1[S2[N2].PropertyPath][h.UNIT_KEY_V4_ISOCurrency]){B2=P1[S2[N2].PropertyPath][h.UNIT_KEY_V4_ISOCurrency].Path?P1[S2[N2].PropertyPath][h.UNIT_KEY_V4_ISOCurrency].Path:undefined;}else if(P1[S2[N2].PropertyPath][h.UNIT_KEY_V4_Unit]){B2=P1[S2[N2].PropertyPath][h.UNIT_KEY_V4_Unit].Path?P1[S2[N2].PropertyPath][h.UNIT_KEY_V4_Unit].Path:undefined;}else if(P1[S2[N2].PropertyPath][h.UNIT_KEY]){B2=P1[S2[N2].PropertyPath][h.UNIT_KEY];}if(!A2){A2=c1(P1,S2,N2);}if(a1(P1,B2)){x2=true;}else{y2=true;}if(!z2){z2=b1(S2,r1);}if(!x2){t2=$(t2,S2,r1);v2=_(v2,S2,r1);}else{u2=$(u2,S2,r1);w2=_(w2,S2,r1);}}}else{var T2=v.role.split("|");q.each(T2,function(j,k3){if(L2.length===Q2){return false;}var R2=A1.length;for(var k=0;k<R2&&L2.length<Q2;++k){var S2=A1[k];if(S2&&S2.Role&&S2.Role.EnumMember&&S2.Role.EnumMember.split("/")&&S2.Role.EnumMember.split("/")[1]){var l3=S2.Role.EnumMember.split("/")[1];if(l3===k3){A1.splice(k,1);--R2;--k;L2.push(S2);if(P1[S2[N2].PropertyPath][h.UNIT_KEY_V4_ISOCurrency]){B2=P1[S2[N2].PropertyPath][h.UNIT_KEY_V4_ISOCurrency].Path?P1[S2[N2].PropertyPath][h.UNIT_KEY_V4_ISOCurrency].Path:undefined;}else if(P1[S2[N2].PropertyPath][h.UNIT_KEY_V4_Unit]){B2=P1[S2[N2].PropertyPath][h.UNIT_KEY_V4_Unit].Path?P1[S2[N2].PropertyPath][h.UNIT_KEY_V4_Unit].Path:undefined;}else if(P1[S2[N2].PropertyPath][h.UNIT_KEY]){B2=P1[S2[N2].PropertyPath][h.UNIT_KEY];}if(a1(P1,B2)){x2=true;}else{y2=true;}if(!A2){A2=c1(P1,S2,N2);}if(!z2){z2=b1(S2,r1);}if(!x2){t2=$(t2,S2,r1);v2=_(v2,S2,r1);}else{u2=$(u2,S2,r1);w2=_(w2,S2,r1);}}}else if(q.inArray(S2,D1)===-1){D1.push(S2);}}});if(L2.length<Q2){q.each(D1,function(k,S2){var k3;var l3;if((k3=w1[O2].defaultRole)&&(q.inArray(k3,T2)!==-1)&&(l3=q.inArray(S2,A1))!==-1){A1.splice(l3,1);L2.push(S2);if(P1[S2[N2].PropertyPath][h.UNIT_KEY_V4_ISOCurrency]){B2=P1[S2[N2].PropertyPath][h.UNIT_KEY_V4_ISOCurrency].Path?P1[S2[N2].PropertyPath][h.UNIT_KEY_V4_ISOCurrency].Path:undefined;}else if(P1[S2[N2].PropertyPath][h.UNIT_KEY_V4_Unit]){B2=P1[S2[N2].PropertyPath][h.UNIT_KEY_V4_Unit].Path?P1[S2[N2].PropertyPath][h.UNIT_KEY_V4_Unit].Path:undefined;}else if(P1[S2[N2].PropertyPath][h.UNIT_KEY]){B2=P1[S2[N2].PropertyPath][h.UNIT_KEY];}if(a1(P1,B2)){x2=true;}else{y2=true;}if(!A2){A2=c1(P1,S2,N2);}if(!z2){z2=b1(S2,r1);}if(!x2){t2=$(t2,S2,r1);v2=_(v2,S2,r1);}else{u2=$(u2,S2,r1);w2=_(w2,S2,r1);}if(L2.length===Q2){return false;}}});}if(L2.length<P2){q.sap.log.error(l.CARD_ERROR+l.MIN_FEEDS+u1+" "+l.FEEDS_OBTAINED+L2.length+" "+l.FEEDS_REQUIRED+P2+" "+l.FEEDS);return false;}}if(L2.length){var U2=[];var V2;if(!(V2=d.getDataset())){q.sap.log.error(l.NO_DATASET);return false;}G=r1;q.each(L2,function(i,S2){if(!S2||!S2[N2]||!S2[N2].PropertyPath){q.sap.log.error(l.INVALID_CHART_ANNO);return false;}var k=S2[N2].PropertyPath;var f2=k;var k3=k;var l3=null;if(P1&&P1[k]){if(P1[k][h.LABEL_KEY_V4]){if(P1[k][h.LABEL_KEY_V4].String){f2=P1[k][h.LABEL_KEY_V4].String;var m3;var n3;var o3;if(f2.indexOf("{")===0){f2=f2.slice(1,-1);if(f2.indexOf(">")!=-1){o3=f2.split(">");m3=o3[0];n3=o3[1];}else if(f2.indexOf("&gt;")!=-1){o3=f2.split("&gt;");m3=o3[0];n3=o3[1];}f2=d.getModel(m3).getProperty(n3);}}else if(P1[k][h.LABEL_KEY_V4].Path){f2=P1[k][h.LABEL_KEY_V4].Path;}else{f2=k;}}else if(P1[k][h.LABEL_KEY]){f2=P1[k][h.LABEL_KEY];}else if(k){f2=k;}if(P1[k][h.TEXT_KEY_V4]){k3=P1[k][h.TEXT_KEY_V4].String?P1[k][h.TEXT_KEY_V4].String:P1[k][h.TEXT_KEY_V4].Path;}else if(P1[k][h.TEXT_KEY]){k3=P1[k][h.TEXT_KEY];}else if(k){k3=k;}l3=P1[k][h.TYPE_KEY]||null;}var p3;if((l3==="Edm.DateTime"||l3==="Edm.DateTimeOffset")&&k3===k){p3="{path:'"+k+"', formatter: 'sap.ovp.cards.charts.VizAnnotationManager.returnDateFormat'}";}else{if(P1[k]&&P1[k][h.TEXT_KEY_V4]&&P1[k][h.TEXT_KEY_V4][h.TEXT_ARRANGEMENT_ANNO]){var q3,r3;q3=P1[k][h.TEXT_ARRANGEMENT_ANNO];r3=q3&&q3.EnumMember;if(!r3){q3=P1[k][h.TEXT_KEY_V4][h.TEXT_ARRANGEMENT_ANNO];r3=q3&&q3.EnumMember;}if(!r3){var s3=G;q3=s3&&s3[h.TEXT_ARRANGEMENT_ANNO];r3=q3&&q3.EnumMember;}switch(r3){case"com.sap.vocabularies.UI.v1.TextArrangementType/TextFirst":p3="{"+k3+"}"+" "+"("+"{"+k+"}"+")";break;case"com.sap.vocabularies.UI.v1.TextArrangementType/TextLast":p3="{"+k+"}"+" "+"("+"{"+k3+"}"+")";break;case"com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly":p3="{"+k3+"}";break;case"com.sap.vocabularies.UI.v1.TextArrangementType/TextSeperate":p3="{"+k+"}"+" "+"("+"{"+k3+"}"+")";break;default:p3="{"+k+"}";break;}}else{p3="{"+k3+"}";}}U2.push(f2);if(N2==="Dimension"){if(K2==="waterfallType"){var t3=new e({name:f2,value:"{"+k+"}"});}else{var t3=new e({name:f2,value:"{"+k+"}",displayValue:p3});}var u3=P1[k][h.SEMANTICS_KEY];var v3=P1[k]["com.sap.vocabularies.Common.v1.IsCalendarYear"]&&P1[k]["com.sap.vocabularies.Common.v1.IsCalendarYear"].Bool;if(G1&&(l3==="Edm.DateTime"||v3||l3==="Edm.DateTimeOffset"||(u3&&u3.lastIndexOf("year",0)===0))){t3.setDataType("date");}V2.addDimension(t3);if(q.inArray(f2,E2)===-1){E2.push(f2);}}else{V2.addMeasure(new M({name:f2,value:"{"+k+"}"}));if((q.inArray(f2,D2)===-1)&&(K2!="bubbleWidth")){D2.push(f2);}}});d.addFeed(new F({'uid':K2,'type':N2,'values':U2}));if(K2==="categoryAxis"){z1[K2]={title:{visible:X1?false:true,text:U2.join(", ")},label:{formatString:x2?'CURR':'axisFormatter',truncatedLabelRatio:0.15}};}else{z1[K2]={title:{visible:X1?false:true,text:U2.join(", ")},label:{formatString:x2?'CURR':'axisFormatter'}};}C2.push(z1[K2]);if(w1.hasOwnProperty("vizProperties")){var W2=0;var X2=w1.vizProperties.length;var Y2;var Z2;for(;W2<X2;W2++){if(w1.vizProperties[W2].hasOwnProperty("value")){Z2=w1.vizProperties[W2].value;}if(w1.vizProperties[W2].hasOwnProperty("path")){Y2=(w1.vizProperties[W2].path).split(".");var $2=Y2.length;var _2,a3;var b3;for(var c3=0,b3=Y2[0],_2=z1,a3=T1;c3<$2;++c3){if(c3===$2-1){if(a3&&a3.hasOwnProperty(b3)){if(u1==='donut'&&(a3[b3]==="value"||a3[b3]==="percentage")){Z2=a3[b3];}else if(u1!='donut'){Z2=a3[b3];}}if((n2&&(b3!="adjustScale"))||(!n2&&(b3==="adjustScale"))||(!n2&&(b3!="adjustScale"))){_2[b3]=Z2;}break;}_2[b3]=_2[b3]||{};_2=_2[b3];if(a3){a3[b3]=a3[b3]||{};a3=a3[b3];}b3=Y2[c3+1];}}}}if(v.hasOwnProperty("vizProperties")){var i=0;var d3=v.vizProperties.length;var e3;var f3;var g3;for(;i<d3;i++){if(v.vizProperties[i].hasOwnProperty("method")){f3=v.vizProperties[i].method;switch(f3){case'count':e3=U2.length;if(v.vizProperties[i].hasOwnProperty("min")&&e3<=v.vizProperties[i].min){e3=v.vizProperties[i].min;}else if(v.vizProperties[i].hasOwnProperty("max")&&e3>=v.vizProperties[i].max){e3=v.vizProperties[i].max;}break;}}else if(v.vizProperties[i].hasOwnProperty("value")){e3=v.vizProperties[i].value;}if(v.vizProperties[i].hasOwnProperty("path")){g3=(v.vizProperties[i].path).split(".");var h3=g3.length;var i3;var j3;for(var j=0,j3=g3[0],i3=z1;j<h3;++j){if(j===h3-1){i3[j3]=e3;break;}i3[j3]=i3[j3]||{};i3=i3[j3];j3=g3[j+1];}}}}}}});var F2=d.getFeeds();if(w1.properties&&w1.properties.semanticPattern===true&&w(F2,u1)){q.each(F2,function(i,v){if(F2[i].getType()==='Measure'&&((F2[i].getUid()==='valueAxis')||(F2[i].getUid()==='actualValues'))){var j;q.each(y1,function(P2,Q2){var R2=u(Q2.Measure.PropertyPath,P1);if(R2===F2[i].getValues()[0]){j=r(Q2,r1);return false;}});if(j){var k=u(j.Measure.PropertyPath,P1);var K2=(r1[j.DataPoint.AnnotationPath.substring(1)].ForecastValue.PropertyPath||r1[j.DataPoint.AnnotationPath.substring(1)].ForecastValue.Path);var L2=u(K2,P1);var M2=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("ACTUAL",[k]);var N2=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("FORECAST",[L2]);z1.plotArea.dataPointStyle={rules:[{dataContext:{MeasureNamesDimension:k},properties:{color:"sapUiChartPaletteSequentialHue1Light1",lineType:"line",lineColor:"sapUiChartPaletteSequentialHue1Light1"},displayName:M2},{dataContext:{MeasureNamesDimension:L2},properties:{color:"sapUiChartPaletteSequentialHue1Light1",lineType:"dotted",lineColor:"sapUiChartPaletteSequentialHue1Light1",pattern:"diagonalLightStripe"},displayName:N2}]};d.getDataset().addMeasure(new M({name:L2,value:"{"+K2+"}"}));var O2=F2[i].getValues();O2.push(L2);F2[i].setValues(O2);}return false;}});}if(w1.properties&&w1.properties.semanticPattern===true&&w(F2,u1)&&d.getVizType()==="vertical_bullet"){q.each(F2,function(i,v){if(F2[i].getType()==='Measure'&&((F2[i].getUid()==='valueAxis')||(F2[i].getUid()==='actualValues'))){var j;q.each(y1,function(L2,M2){var N2=u(M2.Measure.PropertyPath,P1);if(N2===F2[i].getValues()[0]){j=t(M2,r1);return false;}});if(j){var k=(r1[j.DataPoint.AnnotationPath.substring(1)].TargetValue.PropertyPath||r1[j.DataPoint.AnnotationPath.substring(1)].TargetValue.Path);var K2=u(k,P1);d.getDataset().addMeasure(new M({name:K2,value:"{"+k+"}"}));d.addFeed(new F({'uid':"targetValues",'type':"Measure",'values':[K2]}));}return false;}});}if(x2&&y2){q.sap.log.warning(sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("Currency_non_currency_measure"));}if(A2&&!z2){u2=t2=-1;if(z1&&z1["valueAxis"]){z1["valueAxis"]={label:{allowDecimals:true}};}}else if(!A2&&!z2){u2=t2=-1;}var G2;if(w2===undefined){w2="";}if(v2===undefined){v2="";}if(x2){G2=h1(w2,x2);}else{G2=h1(v2,x2);}if(f){f.setScale(G2);}g1(D2,E2,m);var H2="";q.each(C2,function(i,j){var k=j.label.formatString;H2="";if(x2){if(k==='CURR'){H2='CURR/'+u2.toString()+"/";}else{H2='axisFormatter/'+u2.toString()+"/";}}else{H2='axisFormatter/'+t2.toString()+"/";}j.label.formatString=H2;});if(u1==="vertical_bullet"){z1["valueAxis"]={title:{visible:X1?false:true},label:{formatString:H2}};}var I2="";var J2="";if(x2){I2=u2.toString();J2='CURR/'+u2.toString()+"/";}else{I2=t2.toString();J2='axisFormatter/'+t2.toString()+"/";}if(u1==="donut"){z1.plotArea.dataLabel.formatString=J2;if(z1.plotArea.dataLabel.type==="percentage"){z1.plotArea.dataLabel.formatString="0.0%/"+I2+"/";}}P(B1,w1,"dimension");P(C1,w1,"measure");d.setVizProperties(z1);}function e1(v,d,f){if(v&&(v.getVizType()==="bubble"||v.getVizType()==="scatter")){return;}var j,k,s,x;var r1;var s1=h.UNIT_KEY;var t1=h.UNIT_KEY_V4_ISOCurrency;var u1=h.UNIT_KEY_V4_Unit;var v1;var w1=[];if(!(j=v.getModel('ovpCardProperties'))){q.sap.log.error(l.CARD_ERROR+"in "+l.CARD_CONFIG+l.NO_CARD_MODEL);return;}var x1=v.getModel();var y1=j.getProperty("/entitySet");if(!x1||!y1){return;}k=j.getProperty("/entityType");if(!k){q.sap.log.error(l.CARD_ANNO_ERROR+"in "+l.CARD_ANNO);return;}var z1=f1(x1,y1);s=j.getProperty("/chartAnnotationPath");if(!s||!(x=k[s])){q.sap.log.error(l.CARD_ANNO_ERROR+"in "+l.CARD_ANNO);return;}if(!(r1=x.MeasureAttributes)||!r1.length){q.sap.log.error(l.CHART_ANNO_ERROR+"in "+l.CHART_ANNO+" "+l.MEASURES_MANDATORY);return;}q.each(r1,function(i,m){v1=m.Measure.PropertyPath;if(m.DataPoint&&m.DataPoint.AnnotationPath){var G1=k[m.DataPoint.AnnotationPath.substring(1)];if(G1.ForecastValue&&(G1.ForecastValue.PropertyPath||G1.ForecastValue.Path)){w1.push((G1.ForecastValue.PropertyPath||G1.ForecastValue.Path));}}w1.push(v1);});var A1=d?d.results:null;var B1="";var C1=true;var D1=[];var E1=v.getFeeds();q.each(E1,function(i,m){if(m.getType()==="Measure"){D1=D1.concat(m.getValues());}});if(A1){q.each(w1,function(i,m){var G1="";if(z1&&z1[m]){if(z1[m][h.LABEL_KEY_V4]){G1=z1[m][h.LABEL_KEY_V4].String?z1[m][h.LABEL_KEY_V4].String:z1[m][h.LABEL_KEY_V4].Path;}else if(z1[m][h.LABEL_KEY]){G1=z1[m][h.LABEL_KEY];}else if(m){G1=m;}}if(q.inArray(G1,D1)!=-1){if(z1&&z1[m]){var H1;if(z1[m][t1]){H1=z1[m][t1].Path?z1[m][t1].Path:z1[m][t1].String;}else if(z1[m][u1]){H1=z1[m][u1].Path?z1[m][u1].Path:z1[m][u1].String;}else if(z1[m][s1]){H1=z1[m][s1];}if(!H1){C1=false;return false;}if(H1&&z1[H1]){for(var i=0;i<A1.length;i++){var I1=A1[i];if(C1){if(B1&&I1[H1]&&(I1[H1]!="")&&(B1!="")&&(B1!=I1[H1])){C1=false;break;}}B1=I1[H1];}}}}});}var F1="";if(C1){if(B1!=""){F1=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("IN_NO_SCALE",[B1]);F1=" "+F1;}if(f){f.setText(F1);f.data("aria-label",F1,true);}}}function f1(m,d){var f=U.cacheODataMetadata(m);if(!f){return undefined;}return f[d];}function g1(m,d,f){var j="",k="",s="";if(f){j=f.getText();}if(m&&(m.length>1)){for(var i=0;i<m.length-1;i++){if(k!=""){k+=", ";}k+=m[i];}k=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("MEAS_DIM_TITLE",[k,m[i]]);}else if(m){k=m[0];}if(d&&(d.length>1)){for(var i=0;i<d.length-1;i++){if(s!=""){s+=", ";}s+=d[i];}s=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("MEAS_DIM_TITLE",[s,d[i]]);}else if(d){s=d[0];}if(f&&(j==="")){j=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("NO_CHART_TITLE",[k,s]);f.setText(j);f.data("aria-label",j,true);}}function h1(m,i){var d=1;var s;if(i){var f=N.getCurrencyInstance({style:'short',currencyCode:false,shortRefNumber:m});s=f.format(Number(d));}else{var j=N.getFloatInstance({style:'short',shortRefNumber:m});s=j.format(Number(d));}var k=s.slice(-1);return k;}function i1(v,d){v.attachSelectData(function(f){var m=v.getModel('ovpCardProperties');var s=v.getModel();var r1=m.getProperty("/entitySet");var s1=f1(s,r1);var t1=[],u1=[];var v1={},w1={};var x1=v.getDataset().getDimensions();var y1;for(var i=0;i<x1.length;i++){t1.push(x1[i].getName());}var z1=q.map(v.getDataset().getBinding("data").getCurrentContexts(),function(x){return x.getObject();});if(f.getParameter("data")&&f.getParameter("data")[0]&&f.getParameter("data")[0].data){y1=f.getParameter("data")[0].data._context_row_number;var A1=v.getDataset().getBinding("data").getContexts()[y1];var B1=d.getEntityNavigationEntries(A1)[0];if(z1[y1].$isOthers&&z1[y1].$isOthers===true){var C1={$isOthers:true};var D1={getObject:function(){return C1;}};if(O.checkIfAPIIsUsed(d)){c.onContentClicked(D1);}else{if(B1){d.doNavigation(D1,B1);}}}else{u1=Object.keys(f.getParameter("data")[0].data);for(var j=0;j<t1.length;j++){for(var k=0;k<u1.length;k++){if(t1[j]===u1[k]){for(var E1 in s1){if(s1.hasOwnProperty(E1)){var F1=s1[E1][h.LABEL_KEY]||s1[E1][h.NAME_KEY]||s1[E1][h.NAME_CAP_KEY];if(F1===u1[k]){v1[E1]=z1[y1][E1];}}}}for(var E1 in z1[y1]){if(s1.hasOwnProperty(E1)){w1[E1]=z1[y1][E1];}}}}var D1={getObject:function(){return v1;},getAllData:function(){return w1;}};if(O.checkIfAPIIsUsed(d)){c.onContentClicked(D1);}else{if(B1){d.doNavigation(D1,B1);}}}}});}function j1(d){if(d.EnumMember.endsWith("Bubble")){return true;}else{return false;}}function k1(d){var f=false;if(!d||d.constructor!=Array||d.length<1||d[0].constructor!=Object||!d[0].Dimension||!d[0].Dimension.PropertyPath){q.sap.log.error(l.CHART_ANNO_ERROR+"in "+l.CHART_ANNO+" "+l.DIMENSIONS_MANDATORY);return f;}f=true;return f;}function l1(m){var d=false;if(!m||m.constructor!=Array||m.length<1||m[0].constructor!=Object||!m[0].Measure||!m[0].Measure.PropertyPath){q.sap.log.error(l.CHART_ANNO_ERROR+"in "+l.CHART_ANNO+" "+l.MEASURES_MANDATORY);return d;}d=true;return d;}function m1(d){return d.name;}function n1(d){if(d&&d.indexOf("#")!=-1){var f=d.split("#");if(f.length>1){return f[1];}}return"";}function o1(d,v){var f=v.getModel('ovpCardProperties');var i=p1(v);var m=+i.itemsLength;var j=+f.getProperty("/dataStep");if(m&&j){var k=d.colSpan-1;if(k>=0){m+=j*k;q1(v,m);}}}function p1(v){var d=v.getModel('ovpCardProperties');var f=d.getProperty("/entityType");var i=d.getProperty("/presentationAnnotationPath");var j=f.hasOwnProperty(i)&&f[i];var m=j&&j.MaxItems;if(m){var k=m.Int32?m.Int32:m.Int;return{itemsLength:+k,dataStep:+d.getProperty("/dataStep")};}}function q1(v,d){var f,j={},k=[];var s=v.getVizType();var x=v.getModel('ovpCardProperties');var r1=x.getProperty("/entityType");var s1=x.getProperty("/chartAnnotationPath");var t1=r1[s1];var u1=v.getParent();var v1=u1.getBinding("data");j.path=v1.getPath();j.parameters={};j.parameters.select=v1.mParameters.select;j.filters=v1.aApplicationFilters;j.sorter=v1.aSorters;j.length=(s==="donut")?d+1:d;j.template=new g();u1.bindAggregation("data",j);if(s==="donut"){q.each(t1.MeasureAttributes,function(i,m){k.push(m.Measure.PropertyPath);});f={};f.path=v1.getPath();f.parameters={};f.parameters.select=k.join(",");f.filters=v1.aApplicationFilters;f.sorter=v1.aSorters;f.length=1;f.template=new g();u1.bindAggregation("aggregateData",f);}u1.updateBindingContext();}return{constants:h,errorMessages:l,formatItems:n,formatByType:y,returnDateFormat:z,formatChartAxes:A,hideDateTimeAxis:B,checkExists:E,validateCardConfiguration:H,checkNoData:I,getConfig:J,hasTimeSemantics:K,getChartType:L,getPrimitiveValue:Q,formThePathForCriticalityStateCalculation:T,checkFlag:Y,buildVizAttributes:d1,setChartUoMTitle:e1,getMetadata:f1,getSelectedDataPoint:i1,checkBubbleChart:j1,dimensionAttrCheck:k1,measureAttrCheck:l1,getEntitySet:m1,getAnnotationQualifier:n1,reprioritizeContent:o1,getMaxItems:p1};},true);
