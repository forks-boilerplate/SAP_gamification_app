sap.ui.define(["jquery.sap.global","sap/m/Dialog","sap/m/Button","sap/ovp/cards/PayLoadUtils","sap/ovp/cards/OVPCardAsAPIUtils","sap/ovp/cards/rta/SettingsDialogConstants","sap/ui/Device","sap/m/MessagePopover","sap/m/MessagePopoverItem","sap/m/Link","sap/ovp/cards/AnnotationHelper","sap/ui/core/mvc/ViewType","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel"],function(Q,D,B,P,O,S,a,M,b,L,A,V,J,R){"use strict";var r=sap.ui.getCore().getLibraryResourceBundle("sap.ovp");function c(i,q,N){var T=i.getComponentInstance(),U=T.getComponentData(),W=U.appComponent,X=U.mainComponent,Y=(N)?"":U.cardId,Z=Y+"Dialog",$=(N)?"":U.modelName,a1=(!$)?undefined:W.getModel($),b1=q.getModel().getData(),c1={cards:{}};c1.cards[Z]={template:b1.template,settings:b1};if(a1&&!!$){c1.cards[Z].model=$;q.setModel(a1,$);}c1.cards[Z]=X._getTemplateForChart(c1.cards[Z]);q.getController()._oManifest=c1;O.createCardComponent(q,c1,"dialogCard");}function g(i){if(i.indexOf('#')!==-1){return i.split('#')[1];}else{return"Default";}}function d(i,q){if(i){return i;}else{return q;}}function e(i,q,N,T){if(q[i]&&q[i][N]){return d(q[i][N].String,T);}else{return T;}}function f(i,q){var N=g(q),T=_(),U=T&&T.getText("OVP_KEYUSER_LABEL_DEFAULT_LABEL_WITH_QUALIFIER",[N]);U=(U)?U:N;if(q.indexOf(",")!==-1){q=q.split(",")[0];}if(q.indexOf(".Identification")!==-1){if(i[q]){var W=A.sortCollectionByImportance(i[q]);for(var X=0;X<W.length;X++){var Y=W[X];if(Y.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){if(Y&&Y["Label"]){return d(Y["Label"].String,U);}else{return Y["SemanticObject"].String+"-"+Y["Action"].String;}}if(Y.RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"){if(Y&&Y["Label"]){return d(Y["Label"].String,U);}else{return Y["Url"].String;}}}}return"No Navigation";}else if(q.indexOf(".HeaderInfo")!==-1){if(i[q]&&i[q]["Description"]&&i[q]["Description"].Label){return d(i[q]["Description"].Label.String,U);}else{return U;}}else if(q.indexOf(".PresentationVariant")!==-1||q.indexOf(".SelectionVariant")!==-1||q.indexOf(".SelectionPresentationVariant")!==-1){return e(q,i,"Text",U);}else if(q.indexOf(".DataPoint")!==-1){return e(q,i,"Title",U);}else if(q.indexOf(".Chart")!==-1){return e(q,i,"Description",U);}else if(q.indexOf(".FieldGroup")!==-1){return e(q,i,"Label",U);}else{var Z="";if(N!=="Default"){Z="#"+N;}var $="com.sap.vocabularies.Common.v1.Label"+Z;if(i[q]&&i[q][$]){return d(i[q][$].String,U);}else{return U;}}}function h(T,i){switch(i){case"cardPreview":return(O.getSupportedCardTypes().indexOf(T)!==-1);case"noOfRows":case"noOfColumns":case"stopResizing":var q=["sap.ovp.cards.stack"];return(q.indexOf(T)===-1);case"listType":case"listFlavor":var N=["sap.ovp.cards.list"];return(N.indexOf(T)!==-1);case"listFlavorForLinkList":var U=["sap.ovp.cards.linklist"];return(U.indexOf(T)!==-1);case"isViewSwitchSupportedCard":case"kpiHeader":var W=["sap.ovp.cards.list","sap.ovp.cards.table","sap.ovp.cards.charts.analytical","sap.ovp.cards.charts.smart.chart","sap.ovp.cards.charts.bubble","sap.ovp.cards.charts.donut","sap.ovp.cards.charts.line"];return(W.indexOf(T)!==-1);case"chart":var X=["sap.ovp.cards.charts.analytical","sap.ovp.cards.charts.smart.chart","sap.ovp.cards.charts.bubble","sap.ovp.cards.charts.donut","sap.ovp.cards.charts.line"];return(X.indexOf(T)!==-1);case"sortOrder":case"sortBy":case"lineItem":var Y=["sap.ovp.cards.list","sap.ovp.cards.table"];return(Y.indexOf(T)!==-1);case"identification":var Z=["sap.ovp.cards.stack"];return(Z.indexOf(T)!==-1);default:break;}}function j(i){return!!i.kpiAnnotationPath;}function k(i){return!!i.selectionPresentationAnnotationPath;}function l(i){return k(i)||j(i);}function m(i,q,N,T){var U=true;var W=true;if(N){if(i.mainViewSelected){W=false;}else{U=false;}}switch(q){case"cardPreview":return h(i.template,"cardPreview");case"noOfRows":case"noOfColumns":case"stopResizing":return U&&h(i.template,q);case"title":return U;case"dynamicSwitchSubTitle":return U&&!!i.dynamicSubTitle;case"dynamicSwitchStateSubTitle":return!!i.dynamicSubtitleAnnotationPath;case"subTitle":if(!i.subTitle){i.subTitle=" ";return true;}else{return U&&!i.dynamicSubtitleAnnotationPath;}break;case"dynamicSubTitle":return W&&!!i.dynamicSubtitleAnnotationPath;case"valueSelectionInfo":if(!i.valueSelectionInfo){i.valueSelectionInfo=" ";}return U&&(h(i.template,"kpiHeader")&&!!i.dataPointAnnotationPath);case"dataPoint":return W&&!j(i)&&(h(i.template,"kpiHeader")&&!!i.dataPointAnnotationPath);case"listType":case"listFlavor":case"listFlavorForLinkList":return U&&h(i.template,q);case"sortOrder":return U&&(!i.staticContent)&&h(i.template,q)&&!!i.sortBy;case"sortBy":return U&&(!i.staticContent)&&h(i.template,q);case"identification":return W&&!j(i)&&(!i.staticContent)&&!h(i.template,q);case"selectionPresentationVariant":return W&&k(i)&&!j(i)&&h(i.template,"kpiHeader");case"presentationVariant":case"selectionVariant":return W&&!l(i)&&(!i.staticContent)&&h(i.template,"kpiHeader");case"kpiHeader":return U&&!j(i)&&h(i.template,q);case"lineItem":case"chart":return W&&!l(i)&&h(i.template,q);case"showViewName":return N&&W;case"showDefaultView":if(N&&W){if(i.defaultViewSelected!=i.selectedKey){return true;}}return false;case"showMore":case"removeVisual":case"lineItemSubTitle":case"lineItemTitle":case"staticLink":case"links":var X=(i.template==="sap.ovp.cards.linklist"&&!!i.staticContent);if(q==="staticLink"){return(X&&!!i.staticContent[T].targetUri);}else if(q==="links"){return(X&&!!i.staticContent[T].semanticObject);}else if(q==="removeVisual"){return(X&&(!!i.staticContent[T].targetUri||!!i.staticContent[T].semanticObject));}else{return X;}break;default:break;}}function s(i){var q=false;this.oVisibility.viewSwitchEnabled=false;this.oVisibility.showViewSwitch=false;if(h(i.template,"isViewSwitchSupportedCard")){if(i.tabs&&i.tabs.length){q=true;this.oVisibility.showViewSwitch=true;}this.oVisibility.viewSwitchEnabled=true;}this.oVisibility.cardPreview=m(i,"cardPreview");this.oVisibility.stopResizing=m(i,"stopResizing",q);this.oVisibility.noOfRows=m(i,"noOfRows",q);this.oVisibility.noOfColumns=m(i,"noOfColumns",q);this.oVisibility.title=m(i,"title",q);this.oVisibility.subTitle=m(i,"subTitle",q);this.oVisibility.valueSelectionInfo=m(i,"valueSelectionInfo",q);this.oVisibility.listType=m(i,"listType",q);this.oVisibility.listFlavor=m(i,"listFlavor",q);this.oVisibility.listFlavorForLinkList=m(i,"listFlavorForLinkList",q);this.oVisibility.sortOrder=m(i,"sortOrder",q);this.oVisibility.sortBy=m(i,"sortBy",q);if(i.template==="sap.ovp.cards.linklist"&&!!i.staticContent){var N=i.staticContent,T={},U={},W={},X={};for(var Y=0;Y<N.length;Y++){var Z=N[Y].index;T[Z]=m(i,"staticLink",null,Y);U[Z]=m(i,"links",null,Y);W[Z]=m(i,"removeVisual",null,Y);X[Z]=m(i,"showMore",null,Y);}this.oVisibility.staticLink=T;this.oVisibility.links=U;this.oVisibility.removeVisual=W;this.oVisibility.showMore=X;}this.oVisibility.lineItemTitle=m(i,"lineItemTitle");this.oVisibility.lineItemSubTitle=m(i,"lineItemSubTitle");this.oVisibility.showViewName=m(i,"showViewName",q);this.oVisibility.showDefaultView=m(i,"showDefaultView",q);this.aVariantNames.forEach(function($){this.oVisibility[$.sPath]=m(i,$.sPath,q)&&!!i[$.sPath]&&!!i[$.sPath].length;}.bind(this));this.oVisibility.kpiHeader=m(i,"kpiHeader",q)&&!!i["dataPoint"]&&!!i["dataPoint"].length;this.oVisibility.dynamicSwitchSubTitle=m(i,"dynamicSwitchSubTitle",q);this.oVisibility.dynamicSwitchStateSubTitle=m(i,"dynamicSwitchStateSubTitle",q);this.oVisibility.moveToTheTop=false;this.oVisibility.moveUp=false;this.oVisibility.moveDown=false;this.oVisibility.moveToTheBottom=false;this.oVisibility.delete=false;}function _(){if(r){return r;}r=sap.ui.getCore().getLibraryResourceBundle("sap.ovp");return r;}function n(i){var q=i.getProperty("/staticContent");for(var N=0;N<q.length;N++){q[N].index="Index--"+(N+1);}i.setProperty("/staticContent",q);}function o(q){var N=0;for(var i=q.length-1;i>=0;i--){if(/^\d+$/.test(q[i])){N=parseInt(q[i],10);break;}}return N;}function p(i){if(i.lineItem){i.lineItem.forEach(function(N){if(N.value===i.annotationPath){i.lineItemQualifier=N.name;}});}if(i.tabs&&i.tabs.length&&i.selectedKey){i.viewName=i.tabs[i.selectedKey-1].value;i.isDefaultView=false;if(i.selectedKey===i.defaultViewSelected){i.isDefaultView=true;}}var q=i.sortOrder;i.sortOrder="descending";if(q&&q.toLowerCase()!=="descending"){i.sortOrder="ascending";}i.isExtendedList=false;if(i.listType==="extended"){i.isExtendedList=true;}i.isBarList=false;if(i.listFlavor==="bar"){i.isBarList=true;}i.hasKPIHeader=false;if(i.dataPointAnnotationPath){i.hasKPIHeader=true;}return i;}function t(i){var q=i.entityType;this.aVariantNames.forEach(function(W){var X=[];for(var Y in q){if(q.hasOwnProperty(Y)&&Y.indexOf(W.sVariant)!==-1){if(W.sVariant===".LineItem"){var Z={name:f(q,Y),value:Y,fields:A.sortCollectionByImportance(q[Y])};X.push(Z);}else{X.push({name:f(q,Y),value:Y});}}}if(X.length!==0){i[W.sPath]=X;}});if(i.entityType&&i.entityType.property){i["modelProperties"]=i.entityType.property.map(function(W){return{name:W.name,value:W.name};});}if(!!i.tabs&&i.tabs.length){var N=false,T=i.tabs[i.tabs.length-1].value,U=T.split(' ');i.newViewCounter=o(U);i.defaultViewSelected=i.selectedKey;i.isViewResetEnabled=false;i.aViews=[{text:r&&r.getText("OVP_KEYUSER_LABEL_MAIN_VIEW"),key:0,isLaterAddedView:false,isViewResetEnabled:false}];N=i.tabs.some(function(W){return W.dataPointAnnotationPath;});i.tabs.forEach(function(W,X){var Y=W.value;if(N&&!W.dataPointAnnotationPath&&W.dataPoint&&W.dataPoint.length){W.dataPointAnnotationPath=W.dataPoint[0].value;}if(X+1===i.selectedKey){Y=W.value;if(r){Y+=" ("+r.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";}else{Y+=" (Default view)";}}i.aViews.push({text:Y,key:X+1,initialSelectedKey:X+1,isLaterAddedView:false,isViewResetEnabled:false});});}else if(h(i.template,"isViewSwitchSupportedCard")){i.newViewCounter=0;i.aViews=[{text:r.getText("OVP_KEYUSER_SHOWS_DIFFERENT_VIEWS"),key:0,initialSelectedKey:0,isLaterAddedView:false,isViewResetEnabled:false}];}return i;}function u(q){var N=q.getData();sap.ushell.Container.getService("CrossApplicationNavigation").getLinks().done(function(T){var U=[],W={};for(var i=0;i<T.length;i++){U.push(T[i].intent);W[T[i].intent]=T[i].text;}sap.ushell.Container.getService("CrossApplicationNavigation").isIntentSupported(U).done(function(X){var T=[];for(var Y in X){if(X.hasOwnProperty(Y)&&X[Y].supported===true&&W&&W[Y]){T.push({name:W[Y],value:Y});}}var Z=N;if(T.length!==0||T.length!==0){Z["links"]=T;}q.refresh();}).fail(function(X){Q.sap.log.error(X);});}).fail(function(i){Q.sap.log.error(i);});}function v(i){this.oResetButton.setEnabled(i);}function w(i){this.oSaveButton.setEnabled(i);var q=this.oMessagePopOver.getModel(),N=q.getProperty("/Counter/Error");this.bError=(N>0);}function x(i){var q=new RegExp("((http|https)(:\/\/))?([a-zA-Z0-9]+[.]{1}){2}[a-zA-z0-9]+(\/{1}[a-zA-Z0-9]+)*\/?","i");return q.test(i);}function y(i,q){if(q==="targetUri"){return!x(i)&&(!!i||i==="");}else{return!(i.trim().length);}}function z(q){var N=q.getParameter("path"),T="",U,i,W,X,Y,Z;var $=_();if(N==="/title"||N==="title"||N==="/viewName"||N==="targetUri"||N==="value"){var a1=q.getParameter("value"),b1=y(a1,N),c1,d1=q.getParameter("context");if(N==="/viewName"){c1=q.getSource().getProperty("/selectedKey");T=$&&$.getText("OVP_KEYUSER_INPUT_ERROR_VIEW_NAME");N="/tabs/"+(c1-1)+"/value";}if(N==="value"){T=$&&$.getText("OVP_KEYUSER_INPUT_ERROR_VIEW_NAME");N=d1.getPath()+"/"+N;}if(N.indexOf("/title")!==-1){T=$&&$.getText("OVP_KEYUSER_INPUT_ERROR");}if(d1&&d1.getPath().indexOf("staticContent")!==-1){U=d1.getPath().split("/");if(N==="title"){T=$.getText("OVP_KEYUSER_INPUT_ERROR_RECORD_TITLE")+(parseInt(U[U.length-1],10)+1);}else if(N==="targetUri"){T=$.getText("OVP_KEYUSER_INPUT_ERROR_RECORD_URL")+" "+(parseInt(U[U.length-1],10)+1);}N=d1.getPath()+"/"+N;}W=this.oMessagePopOver.getModel();X=W.getProperty("/Messages");Y=W.getProperty("/Counter/All");Z=W.getProperty("/Counter/Error");if(b1){w.bind(this)(true);for(i=0;i<X.length;i++){if(X[i].fieldName===N){X.splice(i,1);Y--;Z--;i--;}}X.push({"type":"Error","title":T,"fieldName":N,"counter":Z+1});Y++;Z++;}else{w.bind(this)(true);for(i=0;i<X.length;i++){if(X[i].fieldName===N){X.splice(i,1);Y--;Z--;i--;}}}W.setProperty("/Messages",X);W.setProperty("/Counter/All",Y);W.setProperty("/Counter/Error",Z);W.refresh(true);}else if(N==="/staticContent,title"||N==="/staticContent,targetUri"||N==="/tabs,value"){U=N.split(",");W=this.oMessagePopOver.getModel();X=W.getProperty("/Messages");Y=W.getProperty("/Counter/All");Z=W.getProperty("/Counter/Error");w.bind(this)(true);for(i=0;i<X.length;i++){if(X[i].fieldName.indexOf(U[0])!==-1&&X[i].fieldName.indexOf(U[1])!==-1){X.splice(i,1);Y--;Z--;i--;}}W.setProperty("/Messages",X);W.setProperty("/Counter/All",Y);W.setProperty("/Counter/Error",Z);W.refresh(true);}}function C(){var i=this.oMessagePopOver.getModel();i.setProperty("/Messages",[]);i.setProperty("/Counter/All",0);i.setProperty("/Counter/Error",0);i.setProperty("/Counter/Success",0);i.setProperty("/Counter/Warning",0);i.setProperty("/Counter/Information",0);i.refresh(true);}function E(){var i=new L({text:"Show more information",href:"",target:"_blank"});var q=new b({type:"{type}",title:"{title}",description:"{description}",subtitle:"{subtitle}",counter:"{counter}",fieldName:"{fieldName}",link:i});this.oMessagePopOver=new M({items:{path:"/Messages",template:q}});var N={"Counter":{"All":0,"Error":0,"Success":0,"Warning":0,"Information":0},"Messages":[]};var T=new J(N);this.oMessagePopOver.setModel(T);this.oMessagePopOverButton.setModel(T);}function F(i,W){var q=i.byId("sapOvpSettingsForm");if(q){var N=q.getDomRef();if(N){N.style.width=W;}}}function G(i){var q=this.dialogBox.getContent()[0],N=q.getModel(),T=q.getModel("deviceMediaProperties");switch(i.name){case"S":case"M":T.setProperty("/deviceMedia","Column");F(q,"100%");break;case"L":case"XL":default:T.setProperty("/deviceMedia","Row");F(q,"calc(100% - "+(N.getProperty("/dialogBoxWidth")+1)+"rem)");break;}T.refresh(true);}function H(){a.media.detachHandler(G.bind(this),null,"SettingsViewRangeSet");a.media.removeRangeSet("SettingsViewRangeSet");}function I(){a.media.initRangeSet("SettingsViewRangeSet",[520,760,960],"px",["S","M","L","XL"]);a.media.attachHandler(G.bind(this),null,"SettingsViewRangeSet");G.bind(this)(a.media.getCurrentRange("SettingsViewRangeSet"));}var K={oOvpResourceBundle:_(),dialogBox:undefined,oSaveButton:undefined,oResetButton:undefined,oMessagePopOverButton:undefined,oMessagePopOver:undefined,oAppDescriptor:undefined,oOriginalAppDescriptor:undefined,oMainComponent:undefined,sApplicationId:"",iContentHeightForDialog:38,iContentHeightForDialogWithViewSwitch:33,aVariantNames:S.aVariantNames,attachWindowResizeHandler:I,detachWindowResizeHandler:H,settingFormWidth:F,addManifestSettings:p,setVisibilityForFormElements:s,getVisibilityOfElement:m,enableResetButton:v,enableSaveButton:w,resetErrorHandling:C,getQualifier:g,oVisibility:S.oVisibility,bError:false,bNewStaticLinkListCardFlag:false,getDialogBox:function(i,N){return new Promise(function(T,U){if(!this.dialogBox){this.oSaveButton=new B("settingsSaveBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("save"),type:"Emphasized"});var W=new B("settingsCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.oResetButton=new B("settingsResetBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("resetCardBtn")});this.oMessagePopOverButton=new B("settingsMessagePopOverBtn",{text:"{/Counter/All}",type:"Emphasized",icon:"sap-icon://message-popup",visible:"{= ${/Counter/All} === 0 ? false : true}"}).addStyleClass("sapOvpSettingsMessagePopOverBtn");this.dialogBox=new D("settingsDialog",{title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("settingsDialogTitle"),buttons:[this.oMessagePopOverButton,this.oSaveButton,W,this.oResetButton],afterClose:function(x1){var v1=this.dialogBox.getContent()[0],y1=v1.byId("sapOvpSettingsLineItemTitle"),z1=v1.byId("sapOvpSettingsLineItemSubTitle");if(y1){y1.destroy();}if(z1){z1.destroy();}this.dialogBox.destroyContent();this.detachWindowResizeHandler();}.bind(this)});this.dialogBox.setBusyIndicatorDelay(0);W.attachPress(function(x1){this.dialogBox.close();}.bind(this));}E.bind(this)();this.bNewStaticLinkListCardFlag=!!N;var X=i.getComponentInstance(),Y=X.getRootControl().getModel("ovpCardProperties"),Z=(N)?{"title":"New Title","subTitle":"New Subtitle","staticContent":[],"listFlavor":"standard","template":"sap.ovp.cards.linklist","layoutDetail":Y.getProperty("/layoutDetail")}:Y.getData(),$=Q.extend(true,{},Z);$=t.call(this,$);$=this.addManifestSettings($);var a1=new J($),b1=i.getDomRef().offsetHeight,c1=new J(a.system),d1=new J({"deviceMedia":"Row"}),e1=X.getComponentData(),f1=e1.mainComponent,g1=e1.appComponent,h1=(N)?"":e1.cardId;this.oAppDescriptor=f1._getCardFromManifest(h1);this.sApplicationId=f1._getApplicationId();this.oMainComponent=f1;this.oOriginalAppDescriptor=g1._getOvpCardOriginalConfig(h1);c1.setDefaultBindingMode("OneWay");$.dialogBoxHeight=b1;$.dialogBoxWidth=20;if($.template==="sap.ovp.cards.linklist"){a1.setProperty("/listFlavorName",this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_CAROUSEL"));}else{a1.setProperty("/listFlavorName",this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_BARLIST"));}if($.layoutDetail==="resizable"){if(!$.defaultSpan){$.defaultSpan={};a1.setProperty("/defaultSpan/cols",a1.getProperty("/cardLayout/colSpan"));a1.setProperty("/defaultSpan/rows",$.template==="sap.ovp.cards.list"||$.template==="sap.ovp.cards.table"?a1.getProperty("/cardLayout/noOfItems"):a1.getProperty("/cardLayout/rowSpan"));}else{if(!$.defaultSpan.rows){a1.setProperty("/defaultSpan/rows",$.template==="sap.ovp.cards.list"||$.template==="sap.ovp.cards.table"?a1.getProperty("/cardLayout/noOfItems"):a1.getProperty("/cardLayout/rowSpan"));}if(!$.defaultSpan.cols){a1.setProperty("/defaultSpan/cols",a1.getProperty("/cardLayout/colSpan"));}}$.NoOfColumns=[];var i1=1,j1=6;for(var q=i1;q<=j1;q++){$.NoOfColumns.push({value:q});}if(h($.template,'chart')||$.template==='sap.ovp.cards.linklist'){var k1=i.getComponentInstance().getComponentData().mainComponent,l1=k1.getLayout(),m1=l1.getDashboardLayoutUtil(),n1=f1._getCardId(i.getId()),o1=m1.calculateCardProperties(n1),p1=m1._getCardController(n1).getView().byId('bubbleText')?43:0,q1=o1.headerHeight+o1.dropDownHeight+p1+50,r1=Math.ceil(o1.minCardHeight/m1.getRowHeightPx())+1;$.NoOfRows=[];$.NoOfRows.push({name:"None",value:0});$.NoOfRows.push({name:"Small",value:r1});$.NoOfRows.push({name:"Standard",value:Math.ceil((q1+480)/m1.getRowHeightPx())+1});if(N){a1.setProperty("/defaultSpan/cols",1);a1.setProperty("/defaultSpan/rows",r1);}}}if($.template==="sap.ovp.cards.linklist"&&$.staticContent){var s1={};var t1=new J(s1);u(t1);n(a1);a1.setProperty("/lineItemId","linkListItem--1");a1.setProperty("/lineItemIdCounter",$.staticContent.length);}this.setVisibilityForFormElements($);var u1=new J(this.oVisibility);a1.attachPropertyChange(z.bind(this));var v1=new sap.ui.view("settingsView",{viewName:"sap.ovp.cards.rta.SettingsDialog",type:V.XML,preprocessors:{xml:{bindingContexts:{ovpCardProperties:a1.createBindingContext("/")},models:{ovpCardProperties:a1,deviceSystemProperties:c1}}}});if($.template==="sap.ovp.cards.linklist"&&$.staticContent){v1.setModel(t1,"staticCardProperties");}var w1=this.oOvpResourceBundle?new R({bundleUrl:this.oOvpResourceBundle.oUrlInfo.url}):null;v1.setModel(a1);v1.setModel(w1,"ovpResourceModel");v1.setModel(d1,"deviceMediaProperties");v1.setModel(u1,"visibility");this.dialogBox.addContent(v1);this.attachWindowResizeHandler();v1.loaded().then(function(x1){var y1=x1.byId("dialogCard");if(!y1.getVisible()){y1=x1.byId("dialogCardNoPreview");var z1=v1.getModel().getProperty("/template").split("."),A1=z1[z1.length-1],B1=this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_NO_CARD_PREVIEW_MSG",[A1]);y1.setText(B1);}else{y1.setWidth($.dialogBoxWidth+"rem");}c(i,x1,N);this.dialogBox.open();x1.getController().settingsResolve=T;}.bind(this));}.bind(this));}};K.fnEditCardHandler=function(i,q){var N=i.getComponentInstance().getComponentData().mainComponent,T=N.getLayout(),U=N.getUIModel();return K.getDialogBox(i).then(function(W){var X=[{appComponent:i.getComponentInstance().getComponentData().appComponent,changeSpecificData:{appDescriptorChangeType:"appdescr_ovp_changeCard",content:W.appDescriptorChange}},{selectorControl:i.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{runtimeOnly:true,changeType:"editCardSettings",content:W.flexibilityChange}}];if(W.viewSwitchChange){X.push({selectorControl:i.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{changeType:"viewSwitch",content:W.viewSwitchChange}});}if(U.getProperty('/containerLayout')==='resizable'){var Y=T.getDashboardLayoutModel(),Z=T.getDashboardLayoutUtil(),$=N._getCardId(i.getId()),a1=Y.getCardById($),b1=Z.calculateCardProperties($),c1=Y.getColCount(),d1='C'+c1,e1=W.flexibilityChange.newAppDescriptor.settings.defaultSpan,f1,g1=[];if(e1&&e1.cols){X.forEach(function(h1){if(h1.changeSpecificData.changeType==='editCardSettings'){var i1=h1.changeSpecificData.content.oldAppDescriptor;i1.settings.defaultSpan={rowSpan:a1.dashboardLayout.rowSpan,colSpan:a1.dashboardLayout.colSpan,showOnlyHeader:a1.dashboardLayout.showOnlyHeader};}});if(e1.rows===0){a1.dashboardLayout.autoSpan=false;f1=Math.ceil((b1.headerHeight+2*Z.CARD_BORDER_PX)/Z.getRowHeightPx());}else{a1.dashboardLayout.autoSpan=true;if(a1.template==='sap.ovp.cards.list'||a1.template==='sap.ovp.cards.table'){a1.dashboardLayout.noOfItems=e1.rows;}else{f1=e1.rows;}}Y._arrangeCards(a1,{row:f1,column:e1.cols},'resize',g1);Y._removeSpaceBeforeCard(g1);g1.forEach(function(h1){var i1={};i1.dashboardLayout={};i1.cardId=h1.content.cardId;i1.dashboardLayout[d1]=h1.content.dashboardLayout;X.push({selectorControl:i.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{changeType:"dragOrResize",content:i1}});});}}return X;});};K.fnCloneCardHandler=function(i,q){return P.getPayLoadForCloneCard(i).then(function(N){return[{appComponent:i.getComponentInstance().getComponentData().appComponent,changeSpecificData:{appDescriptorChangeType:"appdescr_ovp_addNewCard",content:N.appDescriptorChange}},{selectorControl:i.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{runtimeOnly:true,changeType:"newCardSettings",content:N.flexibilityChange}}];});};K.fnAddStaticLinkListCardHandler=function(i,q){return K.getDialogBox(i,true).then(function(N){return[{appComponent:i.getComponentInstance().getComponentData().appComponent,changeSpecificData:{appDescriptorChangeType:"appdescr_ovp_addNewCard",content:N.appDescriptorChange}},{selectorControl:i.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{runtimeOnly:true,changeType:"newCardSettings",content:N.flexibilityChange}}];});};return K;},true);
