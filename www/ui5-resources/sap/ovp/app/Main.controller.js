sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/library","sap/ui/model/odata/ODataUtils","sap/ovp/cards/generic/Component","sap/ui/generic/app/navigation/service/NavigationHandler","sap/m/MessageBox","sap/ovp/cards/CommonUtils","sap/ovp/cards/PersonalizationUtils","sap/ovp/cards/charts/VizAnnotationManager","sap/m/BusyDialog","sap/ui/model/Filter","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/comp/state/UIState","sap/m/ColumnListItem","sap/m/Text","sap/m/Switch","sap/m/Table","sap/m/Column","sap/m/Button","sap/m/Dialog","sap/ui/model/json/JSONModel","jquery.sap.global","sap/ui/Device","sap/ovp/ui/SmartphoneHeaderToggle","sap/ui/model/odata/v2/ODataModel","sap/ui/model/odata/ODataMetadata","sap/ui/fl/FlexControllerFactory","sap/ui/thirdparty/hasher","sap/m/BackgroundDesign","sap/m/ListSeparators","sap/ui/core/TextAlign"],function(C,S,O,a,N,M,b,P,V,B,F,c,U,d,T,e,f,g,h,D,J,q,m,n,o,p,r,s,t,L,u){"use strict";return C.extend("sap.ovp.app.Main",{getCustomAppStateDataExtension:function(i){},restoreCustomAppStateDataExtension:function(i){},getCustomFilters:function(){},onCustomActionPress:function(i){},onCustomParams:function(i){},oRefreshTimer:null,nRefreshInterval:0,filterItemInFocus:null,bFinishedCardsCreationProcess:false,storeIncomingDeltaChanges:function(i){this.deltaCardsInfo=i?i:[];},appendIncomingDeltaChange:function(i){this.deltaChanges.push(i);},onInit:function(){this.oContainer=sap.ushell.Container;this.aErrorCards=[];this.bDeltaChangesEnabled=false;this.deltaChanges=[];this.oCardsModels={};this.aFilters=[];this.errorHandlingObject={atLeastOneRequestSuccess:false,errorLoadingTimeout:{}};this.sPreviousEntityType="";this.sCurrentEntityType="";this.oLoadedComponents={};this.bGlobalFilterLoaded=false;this.bGoButtonPressed=false;this.bSearchButtonPressed=false;q.sap.measure.start("ovp:GlobalFilter","Main Controller init -> Global Filter loaded","ovp");q.sap.measure.start("ovp:Personalization","Main Controller init -> Personalization loaded","ovp");this.isInitialLoading=true;var i=this.getUIModel();this.bDisableErrorPage=i&&i.getProperty("/disableErrorPage");this.oNavigationHandler=this.oNavigationHandler||new N(this);this._initFlexibilityPersonalization();this.getLayout().addStyleClass("ovpLayoutElement");this.oState={};this.oState.oSmartFilterbar=this.byId("ovpGlobalFilter");this._initGlobalFilter();this._createModelForTile();this._checkJamAuth();b.enable(this,this.oNavigationHandler);},performRecreationOfCard:function(i){this.createLoadingCard(i);i.settings.baseUrl=this._getBaseUrl();this._clearStoredEntities();this._initCardModel(i.model);i=this._getTemplateForChart(i);this._loadCardComponent(i.template);this._createModelViewMap(i);q.when(this.createCard(i)).then(function(){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var j=this.getLayout().getDashboardLayoutUtil();if(j){var k=j.getDashboardLayoutModel();var l=k.getCardById(i.id);j._sizeCard(l);k.extractCurrentLayoutVariant();}}}.bind(this));},recreateCard:function(i){var j=this._getCardFromManifest(i.cardId);if(j.template=="sap.ovp.cards.charts.analytical"||j.template=="sap.ovp.cards.charts.smart.chart"){j.settings.chartAnnotationPath=i.chartAnnotationPath;j.settings.navigation=i.navigation;}j.settings.annotationPath=i.annotationPath;j.settings.dynamicSubtitleAnnotationPath=i.dynamicSubtitleAnnotationPath;j.settings.presentationAnnotationPath=i.presentationAnnotationPath;j.settings.selectionAnnotationPath=i.selectionAnnotationPath;j.settings.selectionPresentationAnnotationPath=i.selectionPresentationAnnotationPath;j.settings.kpiAnnotationPath=i.kpiAnnotationPath;j.settings.dataPointAnnotationPath=i.dataPointAnnotationPath;j.settings.identificationAnnotationPath=i.identificationAnnotationPath;j.settings.headerAnnotationPath=i.headerAnnotationPath;var k=j.settings.selectedKey;j.settings.selectedKey=i.selectedKey;if(j){this.performRecreationOfCard(j);}var l={changeType:"viewSwitch",content:{cardId:i.cardId,selectedKey:i.selectedKey,oldKey:k},isUserDependent:true};this.savePersonalization(l);},recreateRTAClonedCard:function(i){var j=this._getCardFromManifest(i.id);if(j){j.settings=i.settings;this.performRecreationOfCard(j);}},onBeforeRendering:function(){},getErrorCardsAsArray:function(){var k;var E=[];for(k in this.aOrderedCards){if(this.aOrderedCards[k].visibility){var i=this.aOrderedCards[k].id;var j=this.getView().byId(i);var l=j&&j.getComponentInstance();var v=l&&l.getComponentData();var w=v&&v.settings&&v.settings.template;if(w==="sap.ovp.cards.error"){E.push(i);}}}return E;},verifyAndSetErrorCard:function(R){var k;for(k in this.aOrderedCards){var i=this.getView().byId(this.aOrderedCards[k].id);var j=i&&i.getComponentInstance();var l=j&&j.getComponentData();var v=j&&j.getRootControl();var w=v&&v.getController();var x=w&&w.getCardItemsBinding();if(x){var y=R.getParameters().url;var z=x.sCustomParams;var A=x.sFilterParams;var E=x.sPath.replace("/","");var G=x.sRangeParams;var I=x.sCountMode&&x.sCountMode.indexOf("Inline");var H=x.sSortParams;var K=R.getSource().sServiceUrl;var Q=R.oSource&&R.oSource.oMetadata;var W=w.getEntityType();var X=sap.ui.model.odata.ODataUtils.createFilterParams(this.aFilters,Q,W);y=y.split(E).join("").split(z).join("").split(A).join("").split(G).join("").split(H).join("").split(K).join("").split(X).join("").split("?").join("").split("&").join("").split("/").join("");if(!I){y=y.split("$inlinecount=allpages").join("");}var Y=l&&l.cardId;var Z=this._getCardFromManifest(Y);var $=this.getErrorCardsAsArray();if(Z&&$.indexOf(Y)==-1&&!y){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var _=this.getLayout();var a1=_.getDashboardLayoutModel();var b1=a1.getCardById(Z.id);Z=b1;}this.createErrorCard(Z,R);}}}},onAfterRendering:function(){this.oModelViewMap={};this.oAppStatePromise=null;if(this.getView().getModel("ui").getProperty("/refreshIntervalInMinutes")){this.nRefreshInterval=this.getView().getModel("ui").getProperty("/refreshIntervalInMinutes");this.nRefreshInterval=(this.nRefreshInterval<=1?1:this.nRefreshInterval)*60000;}var i=this._getCardsModel();var j=[];var k;for(k in i){if(j.indexOf(i[k].model)==-1){j.push(i[k].model);}}var l=this.getOwnerComponent();if(l){for(k in j){var v=l.getModel(j[k]);if(v){v.attachRequestFailed(this.verifyAndSetErrorCard.bind(this));v.attachRequestSent(this.destroyErrorCardsAndReplaceWithOriginal.bind(this));}}}if(this.initialized){return;}this.initialized=true;this.oFlexibilityPersonalizationPromise.then(function(){q.sap.measure.end("ovp:Personalization");this.persistencyVariantLoaded=true;var w;var x=[],y=[];this.aManifestOrderedCards=this._getCardArrayAsVariantFormat(this.getLayout().getContent());for(var z=0;z<this.aManifestOrderedCards.length;z++){w=this._getCardFromManifest(this.aManifestOrderedCards[z].id);if(w&&w.settings&&w.settings.requireAppAuthorization){x.push({id:w.id,cardIntent:w.settings.requireAppAuthorization});y.push(w.settings.requireAppAuthorization);}}if(y.length>0){this._checkForAuthorization(x,y);}else{this.aOrderedCards=this._mergeLREPContent(this.aManifestOrderedCards);this.organizeCards(this.aOrderedCards);}}.bind(this),function(w){q.sap.log.error("Could not load information from LREP Persistency");q.sap.log.error(w);});if(m.system.phone){n.enable(this);}setTimeout(function(){if(!this.persistencyVariantLoaded){this.busyDialog=new B({text:this._getLibraryResourceBundle().getText("loading_dialog_text")});this.busyDialog.open();this.busyDialog.addStyleClass('sapOVPBusyDialog');}}.bind(this),500);},organizeCards:function(k){var l;var v=[];this._updateLayoutWithOrderedCards();this._updateDashboardLayoutCards(k);if(this.isDragAndDropEnabled()){this._initShowHideCardsButton();}this._clearStoredEntities();for(var i=0;i<this.aOrderedCards.length;i++){if(this.aOrderedCards[i].visibility){l=this._getCardFromManifest(this.aOrderedCards[i].id);if(l){v.push(l);}}}for(var i=0;i<v.length;i++){this._initCardModel(v[i].model);this._loadCardComponent(v[i].template);this._createModelViewMap(v[i]);}q.sap.measure.start("ovp:CreateLoadingCards","Create Loading cards","ovp");for(var i=0;i<v.length;i++){this.createLoadingCard(v[i]);}q.sap.measure.end("ovp:CreateLoadingCards");setTimeout(function(){this.getLayout().addStyleClass("ovpLayoutElementShow");}.bind(this),0);setTimeout(function(){q.sap.measure.start("ovp:CreateCards","Create cards loop","ovp");for(var i=0,j=0;j<v.length;i++,j++){while(v[j].id!==k[i].id){i++;}l=v[j];if(!l.settings.title){q.sap.log.error("title is mandatory for card ID : "+l.id);}if(l.settings.tabs){var I=0;if(this.aOrderedCards[i].selectedKey&&l.settings.tabs.length>=this.aOrderedCards[i].selectedKey){I=this.aOrderedCards[i].selectedKey-1;}this.initializeTabbedCard(l,I);}l=this._getTemplateForChart(l);this._loadCardComponent(l.template);l.settings.baseUrl=this._getBaseUrl();this.createCard(l);}this.bFinishedCardsCreationProcess=true;q.sap.measure.end("ovp:CreateCards");}.bind(this),10);if(this.busyDialog){this.busyDialog.close();}},_getTemplateForChart:function(i){if(i.template==="sap.ovp.cards.charts.smart.chart"){var v=this.getView();var j=v.getModel(i.model);var k=j.getMetaModel();var E=k.getODataEntitySet(i.settings.entitySet);var l=k.getODataEntityType(E.entityType);var w;var x;var y;var z=false;var A;if(i&&i.settings){if(!z&&i.settings.kpiAnnotationPath){var K=l[i.settings.kpiAnnotationPath];A=K.Detail.DefaultPresentationVariant&&K.Detail.DefaultPresentationVariant.Path;if(A){y=this._getTemplateForChartFromVisualization(A,i,j,E,l);z=y.bTemplateUpdated;if(z){i=y.oCard;return i;}}}if(!z&&i.settings.selectionPresentationAnnotationPath){var G=l[i.settings.selectionPresentationAnnotationPath];if(G){A=G.PresentationVariant&&G.PresentationVariant.Path;if(A){y=this._getTemplateForChartFromVisualization(A,i,j,E,l);z=y.bTemplateUpdated;if(z){i=y.oCard;return i;}}}}if(!z&&i.settings.presentationAnnotationPath){A=i.settings.presentationAnnotationPath;y=this._getTemplateForChartFromVisualization(A,i,j,E,l);z=y.bTemplateUpdated;if(z){i=y.oCard;return i;}}if(!z&&i.settings.chartAnnotationPath){w=l[i.settings.chartAnnotationPath];x=w&&w.ChartType&&w.ChartType.EnumMember;if(x&&x.split("/")[1]==="Donut"){i.template="sap.ovp.cards.charts.analytical";}else{i.template="sap.ovp.cards.charts.smart.chart";}}}}return i;},_getTemplateForChartFromVisualization:function(i,j,k,E,l){if(/^@/.test(i)){i=i.slice(1);}j.settings.presentationAnnotationPath=i;var v=l[i]&&l[i].Visualizations;var w;var x;var y;var z=false;if(v&&v.length>0){for(w=0;w<v.length;w++){var A=v[w].AnnotationPath;if(!A){return{oCard:j,bTemplateUpdated:z};}A.trim();if(A.startsWith("@")){A=A.slice(1);}if(A.indexOf("Chart")!=-1){j.settings.chartAnnotationPath=A;x=l[A];y=x&&x.ChartType&&x.ChartType.EnumMember;if(y&&y.split("/")[1]==="Donut"){j.template="sap.ovp.cards.charts.analytical";}else{j.template="sap.ovp.cards.charts.smart.chart";}}z=true;}}return{oCard:j,bTemplateUpdated:z};},_createModelViewMap:function(i){if(!i||!i.settings||!i.model){return;}if(!i.settings.entitySet||i.settings.entitySet===""){return;}if(!(i.template.startsWith("sap.ovp.cards"))){return;}var j=i.model;if(!this.oModelViewMap[j]){this.oModelViewMap[j]={};}this.oModelViewMap[j][i.id]=true;},initializeTabbedCard:function(i,I){if(i.template=="sap.ovp.cards.charts.analytical"||i.template=="sap.ovp.cards.charts.smart.chart"){i.settings.chartAnnotationPath=i.settings.tabs[I].chartAnnotationPath;i.settings.navigation=i.settings.tabs[I].navigation;}i.settings.annotationPath=i.settings.tabs[I].annotationPath;i.settings.dynamicSubtitleAnnotationPath=i.settings.tabs[I].dynamicSubtitleAnnotationPath;i.settings.presentationAnnotationPath=i.settings.tabs[I].presentationAnnotationPath;i.settings.selectionAnnotationPath=i.settings.tabs[I].selectionAnnotationPath;i.settings.selectionPresentationAnnotationPath=i.settings.tabs[I].selectionPresentationAnnotationPath;i.settings.kpiAnnotationPath=i.settings.tabs[I].kpiAnnotationPath;i.settings.dataPointAnnotationPath=i.settings.tabs[I].dataPointAnnotationPath;i.settings.identificationAnnotationPath=i.settings.tabs[I].identificationAnnotationPath;i.settings.params=i.settings.tabs[I].params;i.settings.selectedKey=I+1;},_getLibraryResourceBundle:function(){if(!this.oLibraryResourceBundle){this.oLibraryResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ovp");}return this.oLibraryResourceBundle;},_getOvplibResourceBundle:function(){return this.getOwnerComponent()._getOvpLibResourceBundle();},_getCardsModel:function(){if(!this.oCards){var i=this.getUIModel();this.oCards=i.getProperty("/cards");}return this.oCards;},_getBaseUrl:function(){var i=this.getUIModel();if(!this.sBaseUrl){this.sBaseUrl=i.getProperty("/baseUrl");}return this.sBaseUrl;},_getApplicationId:function(){var i=this.getUIModel();return i.getProperty("/applicationId");},_getCardFromManifest:function(j){var k=this._getCardsModel();for(var i=0;i<k.length;i++){if(k[i].id===j){return k[i];}}return null;},_getCardArrayAsVariantFormat:function(j){var k=[];for(var i=0;i<j.length;i++){var I=this._getCardId(j[i].getId());k.push({id:I,visibility:j[i].getVisible()});var l;if(this.getView()&&this.getView().byId){if(this.getView().byId(I).getComponentInstance()){l=this.getView().byId(I).getComponentInstance().getComponentData().settings.selectedKey;}}if(l){k[k.length-1].selectedKey=l;}}return k;},_checkForAuthorization:function(v,w){if(!this.oContainer){return;}var x=this;var y=[];var z=b.getNavigationHandler();if(z&&z.oCrossAppNavService){z.oCrossAppNavService.isIntentSupported(w).done(function(R){for(var i=0;i<v.length;i++){if(R[v[i].cardIntent].supported===false){y.push(v[i].id);for(var j=0;j<x.aManifestOrderedCards.length;j++){if(v[i].id===x.aManifestOrderedCards[j].id){x.aManifestOrderedCards.splice(j,1);break;}}}}x.aOrderedCards=x._mergeLREPContent(x.aManifestOrderedCards);function A(E,G,H){if(E.id===y[this.unsupportedCardIndex]){H.splice(G,1);}}for(var k=0;k<y.length;k++){for(var l=0;l<x.aOrderedCards.length;l++){if(x.aOrderedCards[l].id==y[k]){x.aOrderedCards.splice(l,1);if(x.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){x.getLayout().dashboardLayoutUtil.aCards.map(A,{unsupportedCardIndex:k});x.getLayout().dashboardLayoutUtil.dashboardLayoutModel.oLayoutVars.map(A,{unsupportedCardIndex:k});}break;}}}x.organizeCards(x.aOrderedCards);}).fail(function(){q.sap.log.error("Could not get authorization from isIntentSupported");x.aOrderedCards=x._mergeLREPContent(x.aOrderedCards);x.organizeCards(x.aOrderedCards);});}},_mergeLREPContent:function(l){var i=[];var j=false;if(this.bDeltaChangesEnabled&&Array.isArray(this.deltaCardsInfo)&&this.deltaCardsInfo.length>0){l=P.addMissingCardsFromManifest(l,this.deltaCardsInfo);j=true;}if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(!j){l=this.getLayout().getLayoutDataJSON();}i=P.mergeChanges(l,this.deltaChanges);this._bDashboardLayoutLrepActive=true;this.getLayout().getDashboardLayoutModel().setLayoutVars(i);}else{i=P.mergeChanges(l,this.deltaChanges);}return i?i:[];},_updateLayoutWithOrderedCards:function(){var l=this.getLayout();var k=this.aOrderedCards;l.removeAllContent();var v,w=false;if(this.getView().getModel("ui")&&this.getView().getModel("ui").getProperty("/cards")){v=this.getView().getModel("ui").getProperty("/cards");for(var i=0;i<v.length;i++){w=false;for(var j=0;j<k.length;j++){if(v[i].id==k[j].id){w=true;break;}}if(!w&&this.getView().byId(v[i].id)){this.getView().byId(v[i].id).destroy();}}}for(var i=0;i<k.length;i++){var x=this.getView().byId(k[i].id);if(x){x.setVisible(k[i].visibility);l.addContent(x);}}},_updateErrorCardsArray:function(i){var j;for(j=0;j<i.length;j++){var k=this.aErrorCards.indexOf(i[j].id);if((k>-1)&&i[j].visibility==false){this.aErrorCards.splice(k,1);}}},_updateDashboardLayoutCards:function(i){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(this.getLayout().getDashboardLayoutUtil()){this.getLayout().getDashboardLayoutUtil().updateCardVisibility(i);}}},_resetDashboardLayout:function(){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(this.getLayout().getDashboardLayoutUtil()){this.getLayout().getDashboardLayoutUtil().resetToManifest();}this.getLayout().rerender();}},_getCardArrayAsVariantFormatDashboard:function(){var i=[];var l=this.getLayout();var j=l.dashboardLayoutUtil.aCards;l.dashboardLayoutUtil.dashboardLayoutModel._sortCardsByRow(j);j.forEach(function(k){i.push({id:k.id,visibility:k.dashboardLayout.visible});});return i;},verifyGlobalFilterLoaded:function(){var G=this.getGlobalFilter();if(G.search()){if(G.validateMandatoryFields()){return true;}}this.getView().byId("ovpMain").setHeaderExpanded(true);return false;},onGlobalFilterChange:function(){this.filterChanged=true;if(this.bGlobalFilterInitialized){var G=this.getGlobalFilter();var l=G.getLiveMode();var i=this.getLayout();if(!l&&i){i.setActive(false);}}},destroyErrorCardsAndReplaceWithOriginal:function(){if(this.isModelRefreshTriggered||this.filterChanged||this.bGoButtonPressed||this.bSearchButtonPressed){var k;var E=this.getErrorCardsAsArray();for(k in E){var i=this.getView().byId(E[k]);var j=i&&i.getComponentInstance();var l=j&&j.getComponentData();var v=l&&l.cardId;var w=this._getCardFromManifest(v);j.destroy();this.createCard(w);}this.isModelRefreshTriggered=false;}},onGlobalFilterSearch:function(){if(this.filterChanged||this.bGoButtonPressed||this.bSearchButtonPressed){var G=this.getGlobalFilter();var E=this.getErrorCardsAsArray();if(E.length>0){this.destroyErrorCardsAndReplaceWithOriginal();}if(G&&!G.isDialogOpen()){this._storeCurrentAppStateAndAdjustURL();}this._clearStoredEntities();var k=[];if(this.oGlobalFilter['_aFields'].length>0){k=this.oGlobalFilter["_aFields"];}else{var l=this.oGlobalFilter['_aFilterBarViewMetadata'];for(var i=0;i<l.length;i++){var v=l[i];for(var j=0;j<v.fields.length;j++){k.push(v.fields[j]);}}}for(var i=0;i<k.length;i++){if(k[i].control){var w=document.getElementById(k[i].control.sId);if(q(w).hasClass('sapMFocus')){this.filterItemInFocus=k[i].control;break;}}}var x="ovp-"+new Date().getTime();for(var y in this.oCardsModels){if(this.oCardsModels.hasOwnProperty(y)){try{this.oCardsModels[y].refresh(false,false,x);}catch(z){q.sap.log.warning(z);}}}this.filterChanged=false;this.bGoButtonPressed=false;this.bSearchButtonPressed=false;this._clearStoredEntities();}},_clearStoredEntities:function(){if(this.sPreviousEntityType){this.sPreviousEntityType="";}if(this.sCurrentEntityType){this.sCurrentEntityType="";}},_processFilters:function(){this.aFilters=[];var G=this.getGlobalFilter();if(!G){return;}var i=G.getFilters();var j=this.getCustomFilters();if(j&&(j instanceof F)){if(j){var k=[];if(i&&i.length>0){k.push(new F([i[0],j],true));}else{k.push(j);}if(k.length>0){i=k;}}}this.aFilters=i;},_processSearch:function(){var i,j;var G=this.getGlobalFilter();if(!G){return;}var k=G.getParameters();var j=k&&k["custom"];if(!j){return;}for(var l in j){i=l+"="+q.sap.encodeURL(j[l]);}return i;},_initGlobalFilter:function(){var G=this.getGlobalFilter();if(!G){this.bGlobalFilterLoaded=true;this._parseNavigationVariant();q.sap.measure.end("ovp:GlobalFilter");return;}G.attachFiltersDialogClosed(this._storeCurrentAppStateAndAdjustURL.bind(this));var v=G.getVariantManagement();if(v){v.attachAfterSave(function(E){this._storeCurrentAppStateAndAdjustURL();}.bind(this));}this.oGlobalFilterLoadedPromise=new Promise(function(i,j){G.attachInitialized(function(){this._parseNavigationVariant();if(this.oParseNavigationPromise){this.oParseNavigationPromise.done(function(A,k,l){if(A){this._setNavigationVariantToGlobalFilter(A,k,l);this.filterChanged=false;}}.bind(this));this.oParseNavigationPromise.fail(function(){q.sap.log.error("Could not parse navigation variant from URL");});this.oParseNavigationPromise.always(function(){this.bGlobalFilterInitialized=true;if(G&&this.verifyGlobalFilterLoaded()){i();}}.bind(this));}else{if(G&&this.verifyGlobalFilterLoaded()){i();}}},this);G.attachSearch(function(){if(!this.bGlobalFilterLoaded){i();this.bGlobalFilterLoaded=true;if(!G.isDialogOpen()){this._storeCurrentAppStateAndAdjustURL();}var k=this.getLayout();if(k){k.setActive(true);}return;}this.onGlobalFilterSearch();},this);G.attachFilterChange(this.onGlobalFilterChange,this);G._oSearchButton&&G._oSearchButton.attachPress(function(){this.bGoButtonPressed=true;var k=this.getLayout();if(k){k.setActive(true);}}.bind(this));}.bind(this));this.oGlobalFilterLoadedPromise.then(function(i){this.bGlobalFilterLoaded=true;q.sap.measure.end("ovp:GlobalFilter");G._oBasicSearchField&&G._oBasicSearchField.attachSearch(function(){this.bSearchButtonPressed=true;}.bind(this));}.bind(this));},onShareButtonPress:function(E){var l=this._getLibraryResourceBundle();var i=this.getUIModel();var j=i&&i.getProperty("/title");if(!this._oShareActionButton){this._oShareActionButton=sap.ui.xmlfragment("sap.ovp.app.SharePage",{shareEmailPressed:function(){S.URLHelper.triggerEmail(null,l.getText("Email_Subject",[j]),document.URL);},shareJamPressed:function(){var k=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:document.URL,share:j}}});k.open();}});this.getView().addDependent(this._oShareActionButton);}this._oShareActionButton.openBy(E.getSource());},_checkJamAuth:function(){var G=q.sap.getObject("sap.ushell.Container.getUser");var i=this.getUIModel();if(i){i.setProperty("/jamVisible",!!G&&G().isJamActive());}},_createModelForTile:function(){var i=this.getUIModel();var H,j=i&&i.getProperty("/title");var k={tileTitle:j,tileCustomURL:function(){H=s.getHash();return H?("#"+H):window.location.href;}};if(i){i.setProperty("/tileInfo",k);}},_loadCardComponent:function(i){if(!this.oLoadedComponents[i]){q.sap.measure.start("ovp:CardComponentLoad:"+i,"Card Component load","ovp");this.oLoadedComponents[i]=sap.ui.component.load({name:i,url:q.sap.getModulePath(i),async:true});this.oLoadedComponents[i].then(function(){q.sap.measure.end("ovp:CardComponentLoad:"+i);});}},_initCardModel:function(i){var j=false;if(this.oCardsModels[i]||!i){return;}this.oCardsModels[i]=this.getView().getModel(i);if(!this.oCardsModels[i].bUseBatch){this.oCardsModels[i].setUseBatch(false);}else{this.oCardsModels[i].setUseBatch(true);}if(this.getGlobalFilter()){j=true;}this._overrideCardModelRead(this.oCardsModels[i],j);},getVisibleCustomFields:function(){var G=this.getGlobalFilter();var i=G.getAllFilterItems(true);var l,I,v=[];if(i){l=i.length;while(l--){I=i[l];if(I&&I.getVisibleInFilterBar()){v.push(I.getName());}}}var j,k,w,x=G.getFilterBarViewMetadata();var y=[];if(x){j=x.length;while(j--){w=x[j].fields;if(w){k=w.length;while(k--){if(w[k].isCustomFilterField&&v.indexOf(w[k].fieldName)>-1){y.push({name:w[k].fieldName});}}}}}return y;},_showErrorPage:function(i){if(this.bDisableErrorPage){return;}var j=this.getView().byId('ovpErrorPage');var k=this.getView().byId('ovpMain');if(i){j.setVisible(true);k.setVisible(false);return;}j.setVisible(false);k.setVisible(true);},_isValueHelpCall:function(j,E){var G=this.getGlobalFilter();if(!j||!G||!G._oFilterProvider){return false;}if(j.getId()!==G.getModel().getId()){return false;}var k=G._oFilterProvider;var v=k.getAssociatedValueHelpProviders().concat(k.getAssociatedValueListProviders());var l;for(var i=0;i<v.length;i++){l=v[i]&&v[i].oPrimaryValueListAnnotation;if(l&&l.valueListEntitySetName===E){return true;}}return false;},_overrideCardModelRead:function(j,k){var l=j.read;var v=this;j.read=function(){var w=arguments[1];if(!w){w={};Array.prototype.push.call(arguments,w);}var E=v._getEntityTypeFromPath(j,arguments[0],w.context,false);var x=v._getEntitySetFromEntityType(j,E);if(v._isValueHelpCall(j,x.name)){return l.apply(j,arguments);}if(k){v._processFilters();var G=v.getGlobalFilter();if(!v.aFilters){v.aFilters=[];}var y=false;var z;var A=x["Org.OData.Capabilities.V1.SearchRestrictions"];if(x["sap:searchable"]==="true"||(A&&A.Searchable&&A.Searchable.Bool&&A.Searchable.Bool==="true")){z=v._processSearch();}v.sCurrentEntityType=E.entityType;if(v.sPreviousEntityType!==v.sCurrentEntityType){v.sPreviousEntityType=v.sCurrentEntityType;y=true;}if(!v.aRelevantFilters){v.aRelevantFilters=[];y=true;}if(y){v.aRelevantFilters=[];if(E){v.aRelevantFilters=v._getEntityRelevantFilters(E,v.aFilters,j,G.getModel());}}var H=w.urlParameters;if(v.aRelevantFilters&&v.aRelevantFilters.length>0){var I=-1;if(H){for(var K=0;K<H.length;K++){if((H[K]).lastIndexOf("$filter=",0)===0){I=K;break;}}}if(I>=0){H[I]=H[I]+"%20and%20"+O.createFilterParams(v.aRelevantFilters,j.oMetadata,E).substr(8);}else{w.filters=v.aRelevantFilters;}}if(z){H[H.length]=z;}if(G&&G.getConsiderAnalyticalParameters()){var Q=G.getAnalyticBindingPath();var R,W,X;if(Q&&Q.length>0){if(E.entityType===G.getEntityType()){W=arguments[0];R=arguments[0].indexOf('$');if(R>0){W=arguments[0].substring(0,R-1);}X=Q;if(W!==X){arguments[0]=arguments[0].replace(W,X);}}else{var Y=v._getParametersFromEntityPath(arguments[0]);var Z=v._getParametersFromEntityPath(Q);var $,_,a1;if(Y&&Y.length>0){var b1=v._getEntityTypeFromPath(j,arguments[0],w.context,true);for(var i=0;i<Z.length;i++){$=v._getPropertyMapping(Y,Z[i].name,b1.name,G.getEntityType(),j,G.getModel());if($){_=$+"=.*?[,\)]";a1=arguments[0].match(new RegExp(_));if(a1&&a1.length>0){W=a1[0].slice(0,-1);X=$+"="+Z[i].sValue;if(W!==X){arguments[0]=arguments[0].replace(W,X);}}}}}}}}}var c1=j.getMetaModel();var d1=c1.getODataEntityType(x.entityType);H=v._getExpandPropertiesForSmartCharts(H,c1,d1);var e1=arguments[1].success;arguments[1].success=(function(g1,v){return function(){if(!v.errorHandlingObject.atLeastOneRequestSuccess){v.errorHandlingObject.atLeastOneRequestSuccess=true;v._showErrorPage(false);}if(v.filterItemInFocus!=null){v.filterItemInFocus.focus();v.filterItemInFocus=null;}if(v.nRefreshInterval!==0){if(v.oRefreshTimer!==null){clearTimeout(v.oRefreshTimer);}v.attachRefreshInterval(v.nRefreshInterval);}return g1.apply(this,arguments);};})(e1,v);var f1=arguments[1].error;arguments[1].error=(function(g1,v){return function(){if(!v.errorHandlingObject.atLeastOneRequestSuccess){clearTimeout(v.errorHandlingObject.errorLoadingTimeout);v.errorHandlingObject.errorLoadingTimeout=setTimeout(function(){if(!v.errorHandlingObject.atLeastOneRequestSuccess){v._showErrorPage(true);}},9000);}return g1.apply(this,arguments);};})(f1,v);return l.apply(j,arguments);};},_getExpandPropertiesForSmartCharts:function(i,v,w){var x;var y="";var z;var A;var E;var G="$expand";var H=false;var I=false;var K;var Q;var R;var W="com.sap.vocabularies.Common.v1.Text";var X=w&&w.property;if(!i||!(i.length>0)){return i;}for(var l=0;l<i.length;l++){if(i[l].indexOf("$expand")>-1){return i;}}for(var Y=0;Y<i.length;Y++){if(i[Y].indexOf("$select")>-1){I=true;Q=i[Y];E=i[Y].split("$select=");if(E&&E[1]){K=decodeURIComponent(E[1]);x=K.split(",");if(!x||!(x.length>1)){return i;}}break;}}if(!I){return i;}if(!x||!(x.length>0)||!X||!(X.length>0)){return i;}for(var j=0;j<x.length;j++){for(var k=0;k<X.length;k++){if(x[j]==(X[k]&&X[k].name)){if(X[k]&&X[k]["sap:aggregation-role"]&&X[k]["sap:aggregation-role"]=="dimension"){if(!X[k][W]||!X[k][W].Path||!(X[k][W].Path.indexOf("/")>0)){break;}y=X[k][W].Path;z=y.split("/");if(!z.length){break;}A=v.getODataAssociationEnd(w,z[0]);if(!A){break;}if(!H){G=G+"="+z[0];H=true;}else if(H){G=G+","+z[0];}R=Q+","+y;}break;}}}if(R&&G){i[Y]=R;i.push(G);}return i;},attachRefreshInterval:function(i){this.oRefreshTimer=setTimeout(function(){var l=this.getLayout();if(l&&l.getActive()){for(var j in this.oCardsModels){this.isModelRefreshTriggered=true;this.oCardsModels[j].refresh(false,false);}}}.bind(this),i);},_getEntityTypeFromPath:function(i,j,k,I){var l=o.prototype._normalizePath.apply(i,[j,k]);if(I){l=j.replace(/^\/|\/$/g,"").split("/")[0];if(l.indexOf("(")!=-1){l=l.substring(0,l.indexOf("("));}}var E=p.prototype._getEntityTypeByPath.apply(i.oMetadata,[l]);return E;},_getEntitySetFromEntityType:function(j,E){if(!j||!E){return;}var k=j.getMetaModel();var l=k&&k.getODataEntityContainer();var v=l&&l.entitySet;if(!v||!q.isArray(v)){return;}var w=v.length;for(var i=0;i<w;i++){if(v[i].entityType===E.entityType){return v[i];}}},_getPropertyMapping:function(E,j,k,l,v,w){var i,x;for(i=0;i<E.length;i++){if(E[i].name===j){x=E[i].name;return x;}if((("P_"+E[i].name)===j)||(E[i].name===("P_"+j))){x=E[i].name;return x;}}if(!k||!l||!v||!w){return;}var y=v.oMetadata._getEntityTypeByName(k);var z=w.oMetadata._getEntityTypeByName(l);if(!y||!z){return;}var A="com.sap.vocabularies.Common.v1.SemanticObject";var G="com.sap.vocabularies.Common.v1.SemanticObjectMapping";var H=v.oAnnotations.getAnnotationsData();if(!H||!H.propertyAnnotations){return;}var I=H.propertyAnnotations[y.namespace+"."+y.name];var K=w.oAnnotations.getAnnotationsData();if(!K||!K.propertyAnnotations){return;}var Q=K.propertyAnnotations[z.namespace+"."+z.name];var R=Q&&Q[j];if(!R||!R[A]){return;}var W,X,Y,Z,$;for(W in I){X=I[W];if(X[A]&&X[A].String===R[A].String){Y=X[G];if(!Y){continue;}Z=Y.length;$="";while(Z--){if(Y[Z].SemanticObjectProperty.String===j){$=Y[Z].LocalProperty.PropertyPath;break;}}if($!==""){for(i=0;i<E.length;i++){if(E[i].name===$){x=E[i].name;return x;}}}}}return x;},_getParametersFromEntityPath:function(E){E=E.split("?")[0];var j=E.match(/\(.*=.*\)/);var k=[];if(!j){return k;}var l=j[0].slice(1,-1).trim().split(/\=|\,/);for(var i=0;i<l.length;i=i+2){k.push({name:l[i],sValue:l[i+1]});}return k;},_checkRelevantFiltersRecursive:function(E,j,k,l,v,w){if(!j._bMultiFilter){j.sPath=j.sPath.split('/').pop();var x=this._getPropertyMapping(E,j.sPath,k,l,v,w);if(x){j.sPath=x;return j;}}else{var y=j.aFilters;var z,A=[];if(y){for(var i=0;i<y.length;i++){z=this._checkRelevantFiltersRecursive(E,y[i],k,l,v,w);if(z){A.push(z);}}if(A.length>0){return(new F(A,j.bAnd));}}}},_getEntityRelevantFilters:function(E,i,j,k){var R=[];if(i.length>0&&E){var l=this._checkRelevantFiltersRecursive(E.property,i[0],E.name,this.getGlobalFilter().getEntityType(),j,k);if(l){R.push(l);}}return R;},_checkIsCardValid:function(i){var j=i+".Component";var k,l;q.sap.require(j);var v=q.sap.getObject(j);if(!v){return false;}if((v!==a)&&!(v.prototype instanceof a)){return false;}if((k=v.getMetadata())&&(l=k.getCustomizing())){if(l["sap.ui.viewReplacements"]&&l["sap.ui.viewReplacements"]["sap.ovp.cards.generic.Card"]){return false;}}if(v.prototype.createContent!=a.prototype.createContent){return false;}if(v.prototype.getPreprocessors!=a.prototype.getPreprocessors){return false;}return true;},_createCardComponent:function(v,i,j){var I="ovp:CreateCard-"+j.template+":"+j.id;q.sap.measure.start(I,"Create Card","ovp");var k=v.getModel("@i18n");if(j.template&&this._checkIsCardValid(j.template)){var l={async:true,name:j.template,componentData:{model:i,modelName:j.model,i18n:k,cardId:j.id,settings:j.settings,appComponent:this.getOwnerComponent(),mainComponent:this}};var G=this.getGlobalFilter();if(j.errorReason){l.componentData.errorReason=j.errorReason;}if(G){l.componentData.globalFilter={getUiState:G.getUiState.bind(G)};}var w=v;sap.ui.component(l).then(function(x){var y=w.byId(x.getComponentData().cardId);y.setPropagateModel(true);var z=y.getComponentInstance();y.setComponent(x);if(z){setTimeout(function(){z.destroy();},0);}});}else{q.sap.log.error("Could not create Card from '"+j.template+"' template. Card is not valid.");}q.sap.measure.end(I);},createErrorCard:function(i,j){var k=q.extend(true,{},i,{template:"sap.ovp.cards.error"});k.errorReason=q.extend({},j);k.settings.oldTemplate=i.template;k.settings.template="sap.ovp.cards.error";this._createCardComponent(this.getView(),undefined,k);},createLoadingCard:function(i){var l=q.extend(true,{},i,{template:"sap.ovp.cards.loading"});this._createCardComponent(this.getView(),undefined,l);},createCard:function(i){var v=this.getView();var j=v.getModel(i.model);Promise.all([j.getMetaModel().loaded(),this.oGlobalFilterLoadedPromise,this.oLoadedComponents[i.template]]).then(function(){this._createCardComponent(v,j,i);}.bind(this),function(k){q.sap.log.error("Can't load card with id:'"+i.id+"' and type:'"+i.template+"', reason:"+k);});},_getCardId:function(i){var j=this.getView().getId()+"--";if(i.indexOf(j)!=-1){var k=i.indexOf(j)+j.length;return i.substr(k);}return i;},_initFlexibilityPersonalization:function(){this.oFlexibilityPersonalizationPromise=new Promise(function(i,j){var l=this.getLayout();this.oFlexController=r.createForControl(l);this.oFlexController.getComponentChanges().then(function(k){if(k.length>0){this.bDeltaChangesEnabled=true;}i();}.bind(this),function(E){i();});}.bind(this));},layoutChanged:function(E){var j=E.getParameter("positionChanges");var k=[],l=[];var v,w;if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var x=this.getLayout().dashboardLayoutUtil.dashboardLayoutModel.iColCount;if(j){for(var i=j.length-1;i>=0;i--){v=j[i];w=v.content.cardId;if(v.content.dashboardLayout.oldRow&&v.content.dashboardLayout.oldRow===v.content.dashboardLayout.row&&v.content.dashboardLayout.oldColumn&&v.content.dashboardLayout.oldColumn===v.content.dashboardLayout.column){continue;}if(l[w]){if(v.content.dashboardLayout.oldRow){l[w].content.dashboardLayout.oldRow=v.content.dashboardLayout.oldRow;}continue;}l[w]=v;}Object.keys(l).forEach(function(K){var v=l[K];if(v.content.dashboardLayout.oldRow&&v.content.dashboardLayout.oldRow===v.content.dashboardLayout.row&&v.content.dashboardLayout.oldColumn&&v.content.dashboardLayout.oldColumn===v.content.dashboardLayout.column){return;}k.push(l[K]);});k.forEach(function(v){var z=v.content.dashboardLayout;v.content.dashboardLayout={};v.content.dashboardLayout["C"+x]=z;});}}else{var y=this.getLayout().getContent();this.aOrderedCards=this._getCardArrayAsVariantFormat(y);k=j;}this.savePersonalization(k);},saveVariant:function(E){var i=this;this.smartVariandManagement.getVariantsInfo(function(v){var j=null;if(v&&v.length>0){j=v[0].key;}var k=j!==null;var l={name:"Personalisation",global:false,overwrite:k,key:j,def:true};i.smartVariandManagement.fireSave(l);});},savePersonalization:function(i){var l=this.getLayout();if(l){if(i){if(!Array.isArray(i)){this.oFlexController.createAndApplyChange(i,l);}else{i.forEach(function(v){this.oFlexController.createAndApplyChange(v,l);}.bind(this));}this.oFlexController.saveAll();return;}var j,k;if(l.getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){j={cards:l.getLayoutDataJSON()};k="manageCardsForDashboardLayout";}else{j=this._getCardArrayAsVariantFormat(l.getContent());k="manageCardsForEasyScanLayout";}this.oFlexController.createAndApplyChange({changeType:k,content:j,isUserDependent:true},l);this.oFlexController.saveAll();}},getLayout:function(){return this.getView()?this.getView().byId("ovpLayout"):null;},_initShowHideCardsButton:function(){var R=sap.ushell.Container.getRenderer("fiori2"),i={controlType:"sap.ushell.ui.launchpad.ActionItem",bCurrentState:false,oControlProperties:{icon:"sap-icon://dimension",text:this._getLibraryResourceBundle().getText("hideCardsBtn_title"),tooltip:this._getLibraryResourceBundle().getText("hideCardsBtn_tooltip"),press:this._onCardMenuButtonPress.bind(this)},bIsVisible:true,aStates:["app"]};R.addUserAction(i);},_onCardMenuButtonPress:function(){var j,l=this.getLayout().getMetadata().getName();this.visibilityChanges=[];function k(H,I){for(var i=0;i<H.length;i++){if(H[i].id==I){return i;}}return-1;}function v(H,I,K){var Q=-1;for(var i=0;i<I.length;i++){if(H[i].id==I[i].id){Q=i;}else{Q=k(H,I[i].id);}var W=this.getView().byId(I[i].id);var X=W.getComponentInstance();if(K){if(X){X.destroy();}}if(I[i].visibility!=H[Q].visibility||K){if(I[i].visibility===true){var Y=this._getCardFromManifest(I[i].id);if(Y){this.createLoadingCard(Y);Y.settings.baseUrl=this._getBaseUrl();this._clearStoredEntities();this._initCardModel(Y.model);Y=this._getTemplateForChart(Y);this._loadCardComponent(Y.template);this._createModelViewMap(Y);if(Y.settings.tabs){var Z=0;if(this.aOrderedCards[i].selectedKey&&Y.settings.tabs.length>=this.aOrderedCards[i].selectedKey){Z=this.aOrderedCards[i].selectedKey-1;}this.initializeTabbedCard(Y,Z);}this.createCard(Y);}}else{if(X){X.destroy();}}}}}function w(i){var H=this._getCardFromManifest(i);if(H){var I=H.settings;if(I.title){return I.title;}else if(I.category){return(I.category);}else if(I.subTitle){return I.subTitle;}return i;}else{q.sap.log.error("Card id "+i+" is not available in the manifest");return"";}}var x=new d({cells:[new T({text:{path:"id",formatter:w.bind(this)}}),new e({state:"{visibility}",customTextOff:" ",customTextOn:" ",change:function(i){var H=i.oSource.getParent();H.toggleStyleClass('sapOVPHideCardsTableItem');H.getCells()[0].toggleStyleClass('sapOVPHideCardsDisabledCell');var I=i.getSource().getBindingContext().getObject();var K=this.visibilityChanges.findIndex(function(Q,W,X){return Q.content.cardId===I.id;});if(K>-1){this.visibilityChanges.splice(K,1);}else{this.visibilityChanges.push({changeType:"visibility",content:{cardId:I.id,visibility:i.getParameter("state")},isUserDependent:true});}}.bind(this),tooltip:this._getLibraryResourceBundle().getText("hideCards_switchTooltip")})]});var y=new f("sapOVPHideCardsTable",{backgroundDesign:t.Transparent,showSeparators:L.Inner,columns:[new g({vAlign:"Middle"}),new g({hAlign:u.Right,vAlign:"Middle",width:"4.94rem"})]});y.addStyleClass('sapOVPHideCardsTable');y.bindItems({path:"/cards",template:x});var z=y.onAfterRendering;y.onAfterRendering=function(H){z.apply(y,arguments);var I=H.srcControl.mAggregations.items;if(I){for(var i=0;i<I.length;i++){if(!I[i].getCells()[1].getState()){I[i].addStyleClass('sapOVPHideCardsTableItem');I[i].getCells()[0].addStyleClass('sapOVPHideCardsDisabledCell');}}}setTimeout(function(){q('.sapMListTblRow').first().focus();},200);};var A=new h("manageCardsokBtn",{text:this._getLibraryResourceBundle().getText("okBtn"),type:"Emphasized",press:function(){var i=this.oDialog.getModel().getProperty('/cards');v.apply(this,[this.aOrderedCards,i,false]);this.aOrderedCards=i;this._updateDashboardLayoutCards(this.aOrderedCards);this._updateLayoutWithOrderedCards();this.savePersonalization(this.visibilityChanges);this.oDialog.close();}.bind(this)});var E=new h("manageCardsCancelBtn",{text:this._getLibraryResourceBundle().getText("cancelBtn"),press:function(){this.oDialog.close();}.bind(this)});var R=new h("manageCardsResetBtn",{text:this._getLibraryResourceBundle().getText("resetBtn"),enabled:((l==="sap.ovp.ui.DashboardLayout")?true:this.isValidForReset()),press:function(){M.show(this._getLibraryResourceBundle().getText("reset_cards_confirmation_msg"),{id:"resetCardsConfirmation",icon:M.Icon.QUESTION,title:this._getLibraryResourceBundle().getText("reset_cards_confirmation_title"),actions:[M.Action.OK,M.Action.CANCEL],onClose:function(i){if(i===M.Action.OK){this.oDialog.setBusy(true);v.apply(this,[this.aOrderedCards,this.aManifestOrderedCards,(l==="sap.ovp.ui.DashboardLayout")?true:false]);this.aOrderedCards=this.aManifestOrderedCards;this._resetDashboardLayout();this._updateDashboardLayoutCards(this.aOrderedCards);this._updateLayoutWithOrderedCards();this.oFlexController.discardChangesForId(this.getLayout().getId(),true).then(function(H){this.oDialog.setBusy(false);this.oDialog.close();}.bind(this));}}.bind(this)});}.bind(this)});this.oDialog=new D({title:this._getLibraryResourceBundle().getText("hideCardsBtn_title"),contentWidth:"29.6rem",contentHeight:"50%",stretch:m.system.phone,content:y,buttons:[A,E,R],afterClose:function(){this.visibilityChanges=[];this.oDialog.destroy();}.bind(this)}).addStyleClass("sapOVPCardsVisibilityDialog");this.oDialog.setBusyIndicatorDelay(0);var G;if(l==="sap.ovp.ui.DashboardLayout"){G=q.extend(true,[],this._getCardArrayAsVariantFormatDashboard());}else{G=q.extend(true,[],this.aOrderedCards);}j=new J({cards:G});this.oDialog.setModel(j);this.oDialog.open();},isValidForReset:function(){for(var i=0;i<this.aManifestOrderedCards.length;i++){if(this.aManifestOrderedCards[i].id!==this.aOrderedCards[i].id||this.aManifestOrderedCards[i].visibility!==this.aOrderedCards[i].visibility){return true;}}return false;},isDragAndDropEnabled:function(){return!m.system.phone;},getGlobalFilter:function(){if(!this.oGlobalFilter){this.oGlobalFilter=this.getView().byId("ovpGlobalFilter");}return this.oGlobalFilter;},getUIModel:function(){if(!this.oUIModel){var i=this.getOwnerComponent();this.oUIModel=i&&i.getModel("ui");}return this.oUIModel;},_parseNavigationVariant:function(){if(!this.oContainer){this.oParseNavigationPromise=q.Deferred().resolve();return;}this.oParseNavigationPromise=this.oNavigationHandler.parseNavigation();},_setNavigationVariantToGlobalFilter:function(A,j,k){var G=this.getGlobalFilter();if(!G){return;}switch(k){case"iAppState":if(A.selectionVariant){var l,v,w,x=false;var y,z,E,H;var I,K,Q;G.clearVariantSelection();l=JSON.parse(A.selectionVariant);G.setCurrentVariantId(l.SelectionVariantID);K=G.getUiState({allFilters:false});z=K&&JSON.stringify(K.getSelectionVariant());H=G.getFilterData()._CUSTOM;H=((typeof H=='undefined')?{}:H);I=new U({selectionVariant:A.oSelectionVariant.toJSONObject()});G.setUiState(I,{replace:true,strictMode:false});v=new c(A.selectionVariant);w=v.getParameterNames().concat(v.getSelectOptionsPropertyNames());for(var i=0;i<w.length;i++){G.addFieldToAdvancedArea(w[i]);}Q=G.getUiState({allFilters:false});y=Q&&JSON.stringify(Q.getSelectionVariant());if(z!==y){x=true;}if(A.customData&&Object.keys(A.customData).length>0){var E=A.customData;this.restoreCustomAppStateDataExtension(E);if(JSON.stringify(H)!==JSON.stringify(E)){x=true;}}G.getSmartVariant().currentVariantSetModified(x);G._updateToolbarText();}break;case"xAppState":case"URLParams":var I,R=[];var W=new c(A.oSelectionVariant.toJSONObject());var X=new c(A.oDefaultedSelectionVariant.toJSONObject());if(!A.bNavSelVarHasDefaultsOnly&&!W.isEmpty()){I=new U({selectionVariant:W.toJSONObject()});G.clearVariantSelection();G.clear();G.setUiState(I,{replace:true,strictMode:false});R=R.concat(W.getParameterNames().concat(W.getSelectOptionsPropertyNames()));}if(A.bNavSelVarHasDefaultsOnly&&!X.isEmpty()&&G.getCurrentVariantId()===""){I=new U({selectionVariant:X.toJSONObject()});G.setUiState(I,{replace:false,strictMode:false});R=R.concat(X.getParameterNames().concat(X.getSelectOptionsPropertyNames()));}var Y;if(R&&R.length>0){Y=R.length;while(Y--){G.addFieldToAdvancedArea(R[Y]);}}if(G.getCurrentVariantId()!==""){this._setDisplayCurrency(X);}break;}},_setDisplayCurrency:function(i){var G=this.getGlobalFilter();if(!G){return;}var l,j;var k=G.getAnalyticalParameters();if(k&&k.length>0){l=k.length;while(l--){if((k[l].name==="P_DisplayCurrency")||(k[l].name==="DisplayCurrency")){j=k[l];break;}}}if(!j){return;}var v=G.getFilters([j.fieldName]);var w=v&&v[0]&&v[0].oValue1;if(w&&w!==" "){return;}var x,y;if(j.name.indexOf("P_")===0){y=j.name;x=j.name.substr(2);}else{y="P_"+j.name;x=j.name;}if(i&&!i.isEmpty()){var z;w=i.getParameter(x);if(!w||w===" "){w=i.getParameter(y);}if(!w||w===" "){z=i.getSelectOption(x);w=z&&z[0]&&z[0].Low;}if(!w||w===" "){z=i.getSelectOption(y);w=z&&z[0]&&z[0].Low;}}if(!w||w===" "){w=j.defaultPropertyValue;}if(!w||w===" "){return;}var A=new c();A.addParameter(j.name,w);var E=new U({selectionVariant:A.toJSONObject()});G.setUiState(E,{replace:false,strictMode:false});},_enhanceVariant:function(v,i,j){var k=v.getParameter(i);var l=v.getSelectOption(i);if(k){v.renameParameter(i,j);}else if(l){var w=l[0]&&l[0].Low;if(w&&w!==""){w+="";v.addParameter(j,w);v.removeSelectOption(i);}}return v;},_getCustomAppState:function(){var i={};var j=this.getCustomAppStateDataExtension(i);if(j){i=j;}return i;},onBeforeSFBVariantSave:function(){this.getGlobalFilter().setFilterData({_CUSTOM:this._getCustomAppState()});},onAfterSFBVariantLoad:function(){var i=this.getGlobalFilter().getFilterData();if(i._CUSTOM){this.restoreCustomAppStateDataExtension(i._CUSTOM);}},onAssignedFiltersChanged:function(E){if(E.getSource()&&this.getView().byId("ovpFilterText")){this.getView().byId("ovpFilterText").setText(E.getSource().retrieveFiltersWithValuesAsText());}},_getCurrentAppState:function(){var G=this.getGlobalFilter();if(!G){return;}var i=G.getUiState({allFilters:false});var j=i&&i.getSelectionVariant();if(G.getSmartVariant().currentVariantGetModified()){j.SelectionVariantID="";}var k=j&&JSON.stringify(j);var l=new c(k);var v=this._getCustomAppState();return{selectionVariant:l.toJSONString(),customData:v};},_storeCurrentAppStateAndAdjustURL:function(E){if(E&&!E.oSource._bDirtyViaDialog){return;}if(!this.bGlobalFilterLoaded){return;}if(!this.oNavigationHandler){return;}if(this.oAppStatePromise){this.rejectPreviousPromise&&this.rejectPreviousPromise("skip");}this.oAppStatePromise=new Promise(function(j,k){this.rejectPreviousPromise=k;var A=this._getCurrentAppState();var l=this.oNavigationHandler.storeInnerAppStateWithImmediateReturn(A);l.promise.then(function(v){j(v);},function(v){k(v.getErrorCode());});}.bind(this));var i=function(A){this.oAppStatePromise=null;if(A&&A.length>0){this.oNavigationHandler.replaceHash(A);return;}throw"AppState key is empty";};var R=function(j){this.oAppStatePromise=null;if(j==="skip"){throw j;}throw("Something went wrong while storing AppState - "+j);};this.oAppStatePromise.then(i.bind(this),R.bind(this)).catch(function(j){if(j==="skip"){return;}q.sap.log.error(j);});}});});
